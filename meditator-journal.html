<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meditator's Journal</title>
    <link href="./css/css.css" rel="stylesheet">
 	<script src="chart.js"></script>
    
    <style>
        :root {
            /* --- DARK THEME PALETTE --- */
            --primary: #818cf8;       
            --primary-dark: #6366f1;
            --secondary: #f472b6;     
            --bg: #111827;            
            --surface: #1f2937;       
            --text: #f3f4f6;          
            --text-light: #9ca3af;    
            --border: #374151;        
            --success: #34d399;
            --warning: #fbbf24;
            --danger: #f87171;
            --zen: #a78bfa; /* Special color for meditation */
        }

        html { color-scheme: dark; } 

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }
        
        body { background-color: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* --- Sidebar --- */
        .sidebar {
            width: 80px;
            background: var(--surface);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            border-right: 1px solid var(--border);
            transition: width 0.3s;
            z-index: 50;
            flex-shrink: 0;
        }
        
        @media (min-width: 769px) {
            .sidebar:hover { width: 200px; }
            .sidebar:hover .nav-text { display: inline; opacity: 1; }
            .nav-item:hover, .nav-item.active { background-color: #374151; color: var(--primary); border-right: 3px solid var(--primary); }
        }
        
        .logo { font-size: 24px; color: var(--primary); margin-bottom: 40px; }
        
        .nav-item {
            width: 100%;
            padding: 15px 20px;
            cursor: pointer;
            color: var(--text-light);
            display: flex;
            align-items: center;
            transition: 0.2s;
            white-space: nowrap;
        }
        
        .nav-item i { font-size: 20px; min-width: 40px; text-align: center; }
        .nav-text { display: none; opacity: 0; transition: opacity 0.2s; margin-left: 10px; font-weight: 500;}

        /* --- Main Content --- */
        .main { flex: 1; overflow-y: auto; padding: 30px; position: relative; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px; }
        h1 { font-size: 24px; font-weight: 700; color: var(--text); }
        
        .btn {
            background: var(--primary);
            color: #111; 
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: 0.2s;
        }
        .btn:hover { background: var(--primary-dark); transform: translateY(-1px); color: white; }
        .btn-secondary { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }

        /* --- Gamification Bar --- */
        .user-stats {
            display: flex;
            gap: 20px;
            background: var(--surface);
            padding: 10px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            align-items: center;
            border: 1px solid var(--border);
        }
        .stat-item { display: flex; flex-direction: column; align-items: center; }
        .stat-val { font-weight: bold; font-size: 14px; }
        .stat-label { font-size: 10px; color: var(--text-light); text-transform: uppercase; }
        
        .stat-item.clickable { cursor: pointer; transition: 0.2s; }
        .stat-item.clickable:hover { opacity: 0.7; }
        .daily-bar-bg { width: 60px; height: 4px; background: #374151; border-radius: 2px; margin-top: 2px; overflow: hidden;}
        .daily-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s ease; }
        .daily-bar-fill.complete { background: var(--success); }

        /* --- Views --- */
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Dashboard Grid --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .card { background: var(--surface); padding: 20px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2); }
        
        /* Goal Cards */
        .goal-card { position: relative; overflow: hidden; border-left: 5px solid var(--primary); display: flex; flex-direction: column; }
        .goal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .goal-title { font-weight: 600; font-size: 18px; }
        .goal-tag { font-size: 12px; background: rgba(99, 102, 241, 0.2); color: var(--primary); padding: 2px 8px; border-radius: 10px; }
        
        .section-label { font-size: 11px; text-transform: uppercase; color: var(--text-light); font-weight: 700; margin-bottom: 5px; letter-spacing: 0.5px; }
        
        .progress-container { height: 8px; background: #374151; border-radius: 4px; margin: 0 0 5px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--secondary); width: 0%; transition: width 0.5s ease; } 
        
        .timer-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);}
        .timer-display { font-family: monospace; font-size: 20px; font-weight: 700; color: var(--text); }
        .btn-icon { width: 36px; height: 36px; border-radius: 50%; border: none; cursor: pointer; display: grid; place-items: center; color: white; transition: 0.2s;}
        .btn-play { background: var(--success); color: #000; }
        .btn-stop { background: var(--secondary); }
        .btn-play:hover { transform: scale(1.1); }

        /* Session List */
        .sessions-list ol { list-style: none; counter-reset: session-counter; padding: 0; }
        .session-item {
            display: flex; justify-content: space-between; align-items: flex-start;
            padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 12px; counter-increment: session-counter;
        }
        .session-item::before { content: counter(session-counter) "."; font-weight: bold; color: var(--primary); margin-right: 8px; min-width: 15px; }
        .session-content { flex: 1; }
        .session-date { font-weight: 600; color: var(--text); }
        .session-notes { color: var(--text-light); font-style: italic; margin-top: 2px; display: block;}

       /* --- Calendar --- */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 20px; }
        
        /* New Header for Weekdays */
        .calendar-header {
            display: contents; /* Allows children to sit in the main grid */
        }
        .cal-head-day {
            text-align: center; font-size: 11px; color: var(--text-light); font-weight: bold; padding-bottom: 5px;
        }

        .calendar-day { 
            aspect-ratio: 1; background: var(--bg); border-radius: 4px; 
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; cursor: pointer; position: relative; border: 1px solid var(--border);
            color: var(--text-light);
        }
        .calendar-day.has-data { background: #4b5563; color: white; border-color: #6b7280; }
        .calendar-day.level-1 { background: rgba(99, 102, 241, 0.4); border-color: var(--primary); color: white;} 
        .calendar-day.level-2 { background: rgba(99, 102, 241, 0.7); border-color: var(--primary); color: white; } 
        .calendar-day.level-3 { background: var(--primary); border-color: var(--primary-dark); color: white; } 
        .calendar-day:hover { transform: scale(1.1); z-index: 2; box-shadow: 0 0 10px var(--primary); border: 1px solid white; }

        /* --- Modal & Inputs --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 100;
            backdrop-filter: blur(2px);
        }
        .modal-content { background: var(--surface); padding: 30px; border-radius: 16px; width: 400px; max-width: 90%; border: 1px solid var(--border); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-light); }
        
        .form-control { 
            width: 100%; padding: 10px; 
            background: var(--bg); color: var(--text);
            border: 1px solid var(--border); border-radius: 8px; 
        }
        .form-control:focus { outline: none; border-color: var(--primary); }
        input[type="color"].form-control { padding: 5px; height: 45px; cursor: pointer; }
        textarea.form-control { resize: vertical; min-height: 60px; }
        
        /* --- Toast --- */
        .toast {
            position: fixed; bottom: 80px; right: 20px; left: 20px;
            background: #373d49; color: white; padding: 12px 24px; border-radius: 8px;
            transform: translateY(200px); transition: transform 0.3s; z-index: 200;
            display: flex; align-items: center; gap: 10px; pointer-events: none;
        }
        .toast.show { transform: translateY(0); }
        .toast.achievement { background: var(--warning); color: #000; }

        /* --- Empty State --- */
        .empty-state { text-align: center; padding: 20px; color: var(--text-light); }

        /* --- Choice Modal --- */
        .choice-btn-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .choice-card {
            background: var(--bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border);
            text-align: center; cursor: pointer; transition: 0.2s;
        }
        .choice-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .choice-card i { font-size: 30px; margin-bottom: 10px; display: block; }

        /* --- Meditation Overlay --- */
        #meditation-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; z-index: 999; display: none;
            flex-direction: column; justify-content: center; align-items: center;
            user-select: none; touch-action: manipulation;
        }
        .meditation-circle {
            width: 250px; height: 250px; border-radius: 50%;
            background: radial-gradient(circle, #818cf8 0%, transparent 70%);
            display: flex; justify-content: center; align-items: center;
            font-size: 60px; font-weight: bold; color: white;
            animation: breathe 6s infinite ease-in-out;
            pointer-events: none; /* Let clicks pass through to container */
        }
        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }
        .med-controls { position: absolute; top: 20px; right: 20px; display: flex; gap: 15px; z-index: 1000; }
        .med-timer-disp { position: absolute; top: 20px; left: 20px; font-size: 24px; font-family: monospace; color: #9ca3af; z-index: 1000;}
        .med-instruction { position: absolute; bottom: 50px; color: #6b7280; font-size: 14px; text-transform: uppercase; letter-spacing: 2px;}

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar {
                width: 100%; height: 65px; position: fixed; bottom: 0; left: 0;
                flex-direction: row; justify-content: space-around; padding: 0;
                border-right: none; border-top: 1px solid var(--border);
                background-color: var(--surface); box-shadow: 0 -4px 10px rgba(0,0,0,0.3);
                overflow-y: auto; min-height: 0;
            }
            .sidebar:hover { width: 100%; }
            .logo { display: none; }
            .nav-item { flex-direction: column; justify-content: center; padding: 5px; font-size: 10px; height: 100%; min-width: 60px; }
            .nav-item i { font-size: 18px; margin-bottom: 3px; }
            .nav-text { display: block; opacity: 1; margin-left: 0; font-size: 10px; }
            .nav-item.active { border-right: none; border-top: 3px solid var(--primary); background: transparent; color: var(--primary); }
            .main { padding: 15px; padding-bottom: 90px; }
            header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .user-stats { width: 100%; padding: 15px; flex-wrap: wrap; justify-content: space-between; }
            .user-stats .btn { width: 100%; margin-top: 10px; justify-content: center; background-color: var(--primary); color: #000; }
            .dashboard-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<nav class="sidebar">
        <div class="logo"><i class="fas fa-hourglass-half"></i></div>
        <div class="nav-item active" onclick="app.switchView('dashboard')">
            <i class="fas fa-spa"></i><span class="nav-text">Journal</span>
        </div>
        <div class="nav-item" onclick="app.switchView('calendar')">
            <i class="fas fa-calendar-alt"></i><span class="nav-text">Calendar</span>
        </div>
        <div class="nav-item" onclick="app.switchView('reports')">
            <i class="fas fa-chart-pie"></i><span class="nav-text">Statistics</span>
        </div>
		<div class="nav-item" onclick="app.switchView('analytics')">
    <i class="fas fa-microscope"></i><span class="nav-text">Analytics</span>
</div>
        <div class="nav-item" onclick="app.switchView('achievements')">
            <i class="fas fa-trophy"></i><span class="nav-text">Achieve</span>
        </div>
        
        <div style="margin-top: auto;" class="desktop-only"></div>
        
        <div class="nav-item" onclick="app.exportData()">
    <i class="fas fa-save"></i><span class="nav-text">Backup</span>
</div>

        <div class="nav-item" onclick="app.resetApp()" style="color: var(--danger);"> <i class="fas fa-trash-alt"></i><span class="nav-text">Reset</span>
        </div>
    </nav>


    <main class="main">
        <header>
            <div>
                <h1 id="page-title">Meditator's Journal</h1>
                <p style="color: var(--text-light); font-size: 14px;" id="current-date"></p>
            </div>
            
            <div class="user-stats">
                <div class="stat-item clickable" onclick="app.setGlobalDailyGoal()" title="Click to edit total daily goal">
                    <span class="stat-val"><span id="daily-current">0</span> / <span id="daily-target">60</span>m</span>
                    <div class="daily-bar-bg"><div id="daily-bar-fill" class="daily-bar-fill"></div></div>
                    <span class="stat-label">Daily Goal</span>
                </div>
                <div class="stat-item">
                    <span class="stat-val" id="streak-disp">0 üî•</span>
                    <span class="stat-label">Streak</span>
                </div>
                <div class="stat-item">
                    <span class="stat-val" id="xp-disp">0 XP</span>
                    <span class="stat-label">Level <span id="level-disp">1</span></span>
                </div>
				 <div class="stat-item clickable" onclick="app.openIntroModal()">
    <span class="stat-val" style="
        border: 2px solid var(--text-light); 
        border-radius: 50%; 
        width: 24px; 
        height: 24px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        font-size: 14px;">?</span>
</div>
                <button class="btn" onclick="app.openChoiceModal()">
                    <i class="fas fa-plus"></i> New Goal
                </button>
            </div>
        </header>

        <section id="view-dashboard" class="view-section active">
            <div id="active-goals-container" class="dashboard-grid"></div>
            <div id="empty-msg" class="empty-state" style="display:none;">
                <i class="fas fa-clipboard-list" style="font-size: 40px; margin-bottom: 10px;"></i>
                <p>No active goals. Create one to start tracking!</p>
            </div>
        </section>

        <section id="view-calendar" class="view-section">
            <div class="card">
                <h2>Activity Calendar</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
                    <button class="btn btn-secondary" onclick="app.changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="cal-month-year">Month Year</h3>
                    <button class="btn btn-secondary" onclick="app.changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-grid" id="calendar-grid"></div>
            </div>
        </section>

        <section id="view-reports" class="view-section">
    <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 25px;">
        <button class="btn" id="btn-rep-time" onclick="app.setReportMode('time')">
            <i class="fas fa-clock"></i> Time
        </button>
        <button class="btn btn-secondary" id="btn-rep-mind" onclick="app.setReportMode('mindfulness')">
            <i class="fas fa-spa"></i> Mindfulness
        </button>
    </div>

    <div class="dashboard-grid" style="grid-template-columns: 1fr;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
            <div class="card">
                <h3 id="breakdown-title">Time Chart</h3>
                <div style="height: 300px; display:flex; justify-content:center;">
                    <canvas id="goalBreakdownChart"></canvas>
                </div>
            </div>
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <button class="btn btn-secondary" style="padding: 5px 10px;" onclick="app.changeReportWeek(-1)"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="weekly-report-title">Weekly Focus</h3>
                    <button class="btn btn-secondary" style="padding: 5px 10px;" onclick="app.changeReportWeek(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div style="height: 300px;">
                    <canvas id="weeklyChart"></canvas>
                </div>
            </div>
            </div>
            
            <div class="card" style="margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <button class="btn btn-secondary" style="padding: 5px 10px;" onclick="app.changeReportMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                <h3 id="monthly-report-title">Monthly Focus</h3>
                <button class="btn btn-secondary" style="padding: 5px 10px;" onclick="app.changeReportMonth(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div style="height: 300px;">
                <canvas id="monthlyChart"></canvas>
            </div>
        </div>
    </div>
</section>
<section id="view-analytics" class="view-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
        <h2 style="margin: 0;">Meditation Analytics</h2>
        <select id="ana-time-range" class="form-control" style="width: auto;" onchange="app.renderAnalytics()">
            <option value="7" selected>Last 7 days</option>
            <option value="30">Last 30 days</option>
            <option value="90">Last 3 months</option>
            <option value="365">All time</option>
        </select>
    </div>

    <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 20px;">
        <div class="card" style="text-align: center; border-left: 4px solid var(--zen);">
            <div style="font-size: 12px; color: var(--text-light); text-transform: uppercase;">Average Quality</div>
            <div style="font-size: 28px; font-weight: bold; margin: 5px 0;" id="ana-avg-quality">0%</div>
            <div style="font-size: 11px; color: var(--text-light);">Mindfulness / Time Ratio</div>
        </div>
        <div class="card" style="text-align: center; border-left: 4px solid var(--primary);">
            <div style="font-size: 12px; color: var(--text-light); text-transform: uppercase;">Mindfulness Quality</div>
            <div style="font-size: 28px; font-weight: bold; margin: 5px 0;" id="ana-avg-density">0</div>
            <div style="font-size: 11px; color: var(--text-light);">Mindfulness per minute</div>
        </div>
        <div class="card" style="text-align: center; border-left: 4px solid var(--danger);">
            <div style="font-size: 12px; color: var(--text-light); text-transform: uppercase;">Total Distraction</div>
            <div style="font-size: 28px; font-weight: bold; margin: 5px 0;" id="ana-total-distracted">0h</div>
            <div style="font-size: 11px; color: var(--text-light);">Wandering Time</div>
        </div>
    </div>

    <div class="dashboard-grid" style="grid-template-columns: 1fr; gap: 20px;">
        <div class="card">
            <h3>üìà Mindfulness Trend</h3>
            <p style="font-size: 12px; color: var(--text-light); margin-bottom: 15px;">Tracking mindfulness ratio across recent sessions.</p>
            <div style="height: 300px;">
                <canvas id="analyticsTrendChart"></canvas>
            </div>
        </div>

        <div class="card">
  <h3>üìä Performance Comparison</h3>
  <div style="margin-top: 15px;">
    <table style="width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed;">
      <thead>
        <tr style="border-bottom: 2px solid var(--border); color: var(--text-light);">
          <th style="text-align: left; padding: 10px;">Period</th>
          <th style="text-align: center; padding: 10px;">Session</th>
          <th style="text-align: center; padding: 10px;">Total Hours</th>
          <th style="text-align: center; padding: 10px;">Quality</th>
          <th style="text-align: center; padding: 10px;">Mindful per min</th>
        </tr>
      </thead>
      <tbody id="ana-comparison-table">
      </tbody>
    </table>
  </div>
</div>

    </div>
</section>
        <section id="view-achievements" class="view-section">
            <div class="card">
                <h2><i class="fas fa-medal"></i> Achievements</h2>
                <div id="achievement-list" style="margin-top: 20px; display: grid; gap: 10px;"></div>
            </div>
        </section>
    </main>

    <div class="modal" id="choice-modal">
        <div class="modal-content">
            <h2 style="text-align:center;">Choose Goal Type</h2>
            <div class="choice-btn-container">
                <div class="choice-card" onclick="app.openModal(null, 'meditation')">
                    <i class="fas fa-spa" style="color: var(--zen);"></i>
                    <h3>Meditate</h3>
                    <p style="font-size:12px; color:var(--text-light); margin-top:5px;">Track Mindfulness</p>
                </div>
                <div class="choice-card" onclick="app.openModal(null, 'standard')">
                    <i class="fas fa-tasks" style="color: var(--primary);"></i>
                    <h3>Activity</h3>
                    <p style="font-size:12px; color:var(--text-light); margin-top:5px;">Track Progress</p>
                </div>
            </div>
            <button class="btn btn-secondary" style="width:100%; margin-top:20px;" onclick="app.closeChoiceModal()">Cancel</button>
        </div>
    </div>

    <div class="modal" id="goal-modal">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-bottom: 20px;">Create New Goal</h2>
            <form onsubmit="app.saveGoal(event)">
                <input type="hidden" id="g-id"> 
                <input type="hidden" id="g-type"> 
                
                <div class="form-group">
                    <label>Goal Name</label>
                    <input type="text" id="g-name" class="form-control" required>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="g-cat" class="form-control">
                            </select>
                    </div>
                    <div class="form-group">
                        <label>Color</label>
                        <input type="color" id="g-color" class="form-control" value="#6366f1">
                    </div>
                </div>
                
                <div class="form-group" style="background: rgba(16, 185, 129, 0.1); padding: 10px; border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.3);">
                    <label style="color: var(--success);">Daily Target</label>
                    <input type="number" id="g-daily-target" class="form-control" min="0" value="30">
                    <small id="g-daily-hint" style="color: var(--success); font-size: 11px;">Minutes per day</small>
                </div>
                
                <div class="form-group">
                    <label>Achieve in</label>
                    <input type="number" id="g-lifetime-target" class="form-control" required min="1" value="1000">
                    <small id="g-life-hint" style="color: var(--text-light); font-size: 11px;">Minutes</small>
                </div>
                
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal()">Cancel</button>
                    <button type="submit" class="btn" id="btn-save-goal">Create Goal</button>
                </div>
            </form>
        </div>
    </div>
<div class="modal" id="backup-modal">
    <div class="modal-content">
        <h2 style="margin-bottom: 10px; text-align: center;">Back up & Restore</h2>
        
        <div class="desktop-actions" style="margin-bottom: 20px;">
            <p style="color: var(--text-light); text-align: center; font-size: 12px; margin-bottom: 10px;">
                <i class="fas fa-box-archive"></i> <strong>Backup & restore data from file:</strong>
            </p>
            <div style="display: flex;  justify-content: center; gap: 10px;">
                <button class="btn"" onclick="app.downloadFile()">
                    <i class="fas fa-download"></i> Backup
                </button>
                <button class="btn btn-secondary";" onclick="document.getElementById('backup-file-input').click()">
                    <i class="fas fa-file-import"></i> Restore
                </button>
                <input type="file" id="backup-file-input" style="display: none;" accept=".json, .txt" onchange="app.handleFileUpload(this)">
            </div>
        </div>

           
        
        <div style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
    <button class="btn btn-secondary" style="border-color: var(--danger); color: var(--danger);" onclick="app.closeBackupModal()">
        Close
    </button>
</div>
</div></div>
    <div class="modal" id="session-modal">
    <div class="modal-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 id="session-title" style="margin: 0;">Log Session</h2>
            <button type="button" id="btn-delete-session" class="btn-icon" 
                style="background: transparent; color: var(--danger); display: none; width: 30px; height: 30px;" 
                onclick="app.deleteSession()"
                title="Delete this session">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <form onsubmit="app.logSessionConfirm(event)">
                <input type="hidden" id="s-goal-id" />
                <input type="hidden" id="s-log-id" />
                
                <div class="form-group">
                    <label>Start Date & Time</label>
                    <input type="datetime-local" id="s-date" class="form-control" required />
                </div>
                
                <div class="form-group">
                    <label>Duration (Minutes)</label>
                    <input type="number" id="s-minutes" class="form-control" required min="1" />
                </div>
<div class="form-group" id="s-mindfulness-group" style="display:none; background: rgba(167, 139, 250, 0.1); padding: 10px; border-radius: 8px; border: 1px solid rgba(167, 139, 250, 0.3);">
    <label style="color: var(--zen);">Mindfulness (Count)</label>
    <input type="number" id="s-mindfulness" class="form-control" min="0" value="0" />
</div>
                <div class="form-group">
                    <label>Notes (Optional)</label>
                    <textarea id="s-notes" class="form-control" placeholder="What did you focus on?"></textarea>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="app.closeSessionModal()">Cancel</button>
                    <button type="submit" class="btn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="meditation-overlay">
        <div class="med-timer-disp" id="med-timer">00:00</div>
        <div class="med-controls">
            <button class="btn btn-secondary" onclick="app.togglePauseMeditation()" id="med-pause-btn"><i class="fas fa-pause"></i></button>
            <button class="btn" style="background-color: var(--danger); color: white;" onclick="app.concludeMeditationSession()"><i class="fas fa-stop"></i></button>
        </div>
        
        <div class="meditation-circle" id="med-counter">0</div>
        
        <div class="med-instruction">Tap Screen for Mindfulness</div>
    </div>

    <div class="modal" id="meditation-finish-modal">
        <div class="modal-content">
            <h2 style="text-align: center; margin-bottom: 10px;">Session Complete üåø</h2>
            <div style="text-align:center; margin: 20px 0; display:flex; justify-content:space-around; align-items:center;">
                <div>
                    <div style="font-size: 30px; font-weight:bold; color:var(--zen)" id="med-finish-count">0</div>
                    <div style="color:var(--text-light); font-size:12px;">Mindful Moments</div>
                </div>
                <div style="height:40px; width:1px; background:var(--border);"></div>
                <div>
                    <div style="font-size: 30px; font-weight:bold; color:var(--text)" id="med-finish-time">0m</div>
                    <div style="color:var(--text-light); font-size:12px;">Time Spent</div>
                </div>
            </div>
            <div class="form-group">
                <label>Journal Notes</label>
                <textarea id="med-finish-notes" class="form-control" placeholder="Any insights or distractions?"></textarea>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
                 <button class="btn btn-secondary" onclick="app.discardMeditation()">Discard</button>
                 <button class="btn" style="background:var(--zen); color:white" onclick="app.saveMeditationLog()">Save to Journal</button>
            </div>
        </div>
    </div>

    <div class="modal" id="graph-modal" style="overflow-y: auto; z-index: 150;">
        <div class="modal-content" style="width: 600px;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 20px;">
                <div>
                    <h2 style="margin-bottom: 5px;">Meditation Session</h2>
                    <p id="graph-date" style="color: var(--text-light); font-size: 14px; margin: 0;"></p>
             </div>
               
            </div>

            <div style="height: 300px; width: 100%;">
                <canvas id="sessionGraph"></canvas>
            </div>
            
            <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
			 <button class="btn btn-secondary" id="btn-export-session" title="Copy JSON Data">
                    <i class="fas fa-file-code"></i>
                </button>
			<select id="graph-type-select" class="form-control" style="width: auto; padding: 5px 5px 5px; height: 36px; font-size: 13px; cursor: pointer;" onchange="app.updateSessionChart()">
                    <option value="intensity">üå± Mindfulness</option>
                    <option value="interval">‚òÅÔ∏è Forgetfulness</option>
                </select>
               <button class="btn btn-secondary" onclick="document.getElementById('graph-modal').style.display='none'" title="Close"><i class="fas fa-xmark"></i></button>
            </div>
        </div>
    </div>

    <div class="modal" id="day-details-modal" style="overflow-y: auto;">
    <div class="modal-content">
        <h2 id="day-modal-title" style="margin-bottom: 10px; font-size: 20px;">Day Details</h2>
        
        <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 15px;">
            <button class="btn" id="btn-modal-time" style="padding: 5px 15px; font-size: 12px;" onclick="app.switchDayChart('time')">
                <i class="fas fa-clock"></i> Time
            </button>
            <button class="btn btn-secondary" id="btn-modal-mind" style="padding: 5px 15px; font-size: 12px;" onclick="app.switchDayChart('mindfulness')">
                <i class="fas fa-spa"></i> Mindfulness
            </button>
        </div>

        <div style="height: 200px; position: relative; margin-bottom: 20px;">
            <canvas id="dayBreakdownChart"></canvas>
        </div>

        <h3 style="font-size: 14px; color: var(--text-light); border-bottom: 1px solid var(--border); padding-bottom: 5px; margin-bottom: 10px;">Activity Log</h3>
        <div id="day-session-list" style="max-height: 150px; overflow-y: auto;"></div>
        
        <div style="display: flex; justify-content: flex-end; margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px;">
            <button class="btn btn-secondary" onclick="app.closeDayModal()">Close</button>
        </div>
    </div>
</div>

    <div id="toast" class="toast">
        <i class="fas fa-info-circle"></i> <span id="toast-msg">Message</span>
    </div>
	<div class="modal" id="intro-modal" style="z-index: 9999;">
    <div class="modal-content" style="max-width: 800px; width: 95%; max-height: 90vh; display: flex; flex-direction: column; padding: 0;">
        
        <div style="padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--surface); border-radius: 16px 16px 0 0;">
            <h2 style="margin: 0;">‚ú® Meditator's Journal</h2>
            <button class="btn-icon" onclick="app.closeIntroModal()" style="color: var(--text-light); background: transparent;"><i class="fas fa-times"></i></button>
        </div>

        <div style="padding: 20px; overflow-y: auto; line-height: 1.6; color: var(--text-light);">
            
            <p><strong>Meditator's Journal</strong> is an application designed to support both spiritual practice and daily work. The app helps practitioners track progress in their professional tasks as well as meditation sessions, recording levels of awareness through "Mindfulness" counts, and visualizing mental states via real-time charts and graphs.</p>
            
            <img src="1en.png" alt="Graph Preview" style="width: 100%; border-radius: 8px; border: 1px solid var(--border); margin: 10px 0;">

            <h3 style="color: var(--text); margin-top: 20px;">‚ú® Core Concepts</h3>
            <p>To use the app effectively, you should understand the following indicators:</p>
            <ul style="padding-left: 20px; margin-bottom: 15px;">
                <li><strong>Mindfulness (Sati):</strong> A unit for measuring awareness. Every time you recognize your breath or mental state and touch the screen, one "Mindfulness" point is recorded.</li>
                <li><strong>Mindful State:</strong> A state where the frequency of recording (Sati) remains stable and regular.</li>
                <li><strong>Unmindful:</strong> A state where the mind is distracted or drowsy, resulting in few or no recordings over a period of time.</li>
                <li><strong>Diligence Streak:</strong> The number of consecutive days you have maintained your practice.</li>
            </ul>

            <h3 style="color: var(--text); margin-top: 20px;">‚ú® Key Features</h3>
            
            <h4 style="color: var(--primary);">1. Diverse Goal Management</h4>
            <ul style="padding-left: 20px;">
                <li><strong>Two main types of goals:</strong>
                    <ul>
                        <li><strong>‡•ê Meditation:</strong> Tracks meditation duration and counts mindfulness ("Sati") recognitions. The interface features a breathing circle to support focus.</li>
                        <li><strong>‚ö° Work:</strong> A traditional countdown timer used for work, study (similar to Pomodoro), or other habits.</li>
                    </ul>
                </li>
                <li><strong>Customization:</strong> Set daily goals (minutes), target completion time, representative colors, and management categories.</li>
            </ul>

            <h4 style="color: var(--primary); margin-top: 15px;">2. Interactive Timer & Recording</h4>
            <ul style="padding-left: 20px;">
                <li><strong>Meditation Mode:</strong>
                    <ul>
                        <li>Visual "breathing" effect (expand/contract) helps regulate breathing rhythm.</li>
                        <li><strong>Tap-to-Track:</strong> Touch the screen (or click) every time you acknowledge your focus returning to the breath. These counts accumulate as Mindfulness (Sati) points.</li>
                    </ul>
                </li>
            </ul>
            <div style="text-align: center; margin: 15px 0;">
                <img src="2en.png" alt="Meditation Mode" style="max-width: 300px; width: 100%; border-radius: 8px; border: 1px solid var(--border);">
            </div>
            <ul style="padding-left: 20px;">
                <li><strong>Focus Mode:</strong> A countdown timer with a visual progress bar.</li>
                <li><strong>Manual Entry:</strong> Forgot to start the timer? You can manually log a session or edit previous records.</li>
            </ul>

            <h4 style="color: var(--primary); margin-top: 15px;">3. Statistics & Data Analysis</h4>
            <ul style="padding-left: 20px;">
                <li><strong>Dashboard:</strong> View today's progress relative to your set goals.</li>
                <li><strong>Practice Calendar:</strong> A grid heatmap showing daily practice intensity. Darker colors represent longer practice durations.</li>
                <li><strong>Visual Charts:</strong>
                    <ul>
                        <li><strong>Session Graph:</strong> Review mindfulness levels <em>within a specific session</em> (line chart).</li>
                        <li><strong>Weekly/Monthly Statistics:</strong> Compare performance over real-time intervals.</li>
                        <li><strong>Distribution:</strong> A pie chart showing the percentage of time or mindfulness spent on different goals.</li>
                    </ul>
                </li>
            </ul>

            <h4 style="color: var(--primary); margin-top: 15px;">4. Privacy & Data Security</h4>
            <ul style="padding-left: 20px;">
                <li><strong>Fully Offline:</strong> 100% of data is stored directly in your browser. No data is sent to any server.</li>
                <li><strong>Backup & Restore:</strong> Easily export data to a <code>.json</code> file for safekeeping or to transfer to another device.</li>
            </ul>

            <hr style="border: 0; border-top: 1px solid var(--border); margin: 25px 0;">
            <h3 style="color: var(--text); margin-top: 20px;">üöÄ Usage Guide</h3>
            
            <strong style="display:block; margin-bottom:10px; color: var(--text);">1. Create a New Goal</strong>
            <ul style="padding-left: 20px; margin-bottom: 15px;">
                <li>Click the <strong>"New Goal"</strong> button on the main screen.</li>
                <li>Select the type: <strong>Meditation</strong> or <strong>Work</strong>.</li>
                <li>Enter a name, choose a color, and set the goal time (e.g., 30 mins/day).</li>
            </ul>

            <strong style="display:block; margin-bottom:10px; color: var(--text);">2. Start a Session</strong>
            <ul style="padding-left: 20px; margin-bottom: 15px;">
                <li>On the goal card, click the <strong>Play (‚ñ∂)</strong> button (for Work) or the <strong>‡•ê</strong> button (for Meditation).</li>
                <li><strong>During Meditation:</strong> Tap the screen whenever you find yourself mindfully returning to the meditation object.</li>
                <li>At the end of the session, a summary panel will appear for you to add journal notes.</li>
            </ul>

            <strong style="display:block; margin-bottom:10px; color: var(--text);">3. View Statistics</strong>
            <ul style="padding-left: 20px; margin-bottom: 15px;">
                <li>Select the <strong>"Statistics"</strong> tab on the sidebar to view charts.</li>
                <li>Select the <strong>"Calendar"</strong> tab to see your history.</li>
            </ul>

            <hr style="border: 0; border-top: 1px solid var(--border); margin: 25px 0;">
            <h3 style="color: var(--text); margin-top: 20px;">‚ú® Practice Achievement System</h3>
            
            <p><strong>Consistency Milestones (Streak):</strong></p>
            <table class="intro-table" style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 13px;">
                <thead>
                    <tr style="background: var(--bg);">
                        <th style="padding: 8px; border: 1px solid var(--border); text-align: left;">Title</th>
                        <th style="padding: 8px; border: 1px solid var(--border); text-align: left;">Condition</th>
                        <th style="padding: 8px; border: 1px solid var(--border); text-align: left;">Meaning</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Effort</td><td style="padding: 8px; border: 1px solid var(--border);">3 days</td><td style="padding: 8px; border: 1px solid var(--border);">Initially overcoming inertia.</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Striving</td><td style="padding: 8px; border: 1px solid var(--border);">10 days</td><td style="padding: 8px; border: 1px solid var(--border);">Starting to form a habit.</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Diligence</td><td style="padding: 8px; border: 1px solid var(--border);">30 days</td><td style="padding: 8px; border: 1px solid var(--border);">Habit is becoming stable.</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Ardor</td><td style="padding: 8px; border: 1px solid var(--border);">60 days</td><td style="padding: 8px; border: 1px solid var(--border);">Practice becomes firm and steady.</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Viriya-sambojjhanga</td><td style="padding: 8px; border: 1px solid var(--border);">365 days</td><td style="padding: 8px; border: 1px solid var(--border);">Extraordinary perseverance.</td></tr>
                </tbody>
            </table>

            <p><strong>Mindfulness Milestones (Sati):</strong></p>
            <table class="intro-table" style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 13px;">
                <thead>
                   <tr style="background: var(--bg);">
                        <th style="padding: 8px; border: 1px solid var(--border); text-align: left;">Level</th>
                        <th style="padding: 8px; border: 1px solid var(--border); text-align: left;">Sati Points</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Beginner</td><td style="padding: 8px; border: 1px solid var(--border);">5,000</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Practitioner</td><td style="padding: 8px; border: 1px solid var(--border);">10,000</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Yogi</td><td style="padding: 8px; border: 1px solid var(--border);">20,000</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Meditator</td><td style="padding: 8px; border: 1px solid var(--border);">50,000</td></tr>
					<tr><td style="padding: 8px; border: 1px solid var(--border);">Clear Mirror</td><td style="padding: 8px; border: 1px solid var(--border);">80,000</td></tr>
					<tr><td style="padding: 8px; border: 1px solid var(--border);">Still Lake</td><td style="padding: 8px; border: 1px solid var(--border);">100,000</td></tr>
					<tr><td style="padding: 8px; border: 1px solid var(--border);">The Mountain</td><td style="padding: 8px; border: 1px solid var(--border);">200,000</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Heir of the Dhamma</td><td style="padding: 8px; border: 1px solid var(--border);">500,000</td></tr>
                </tbody>
            </table>

            <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid var(--warning); padding: 15px; border-radius: 8px; color: #fbbf24; font-size: 13px;">
                <strong>‚ö†Ô∏è Important Data Notice:</strong>
                <ul style="margin: 5px 0 0 15px;">
                    <li>Your data is stored in the browser's <strong>Local Storage</strong>.</li>
                    <li><strong>Do not clear browser history/cache</strong> without backing up, or your data will be lost.</li>
                    <li><strong>How to Backup:</strong> Go to the left sidebar, select <strong>"Backup"</strong> to download the file.</li>
                    <li><strong>How to Restore:</strong> Select <strong>"Restore"</strong> and upload your backup file.</li>
                </ul>
            </div>
            
             <div style="margin-top: 20px; text-align: center; color: var(--text-light); font-size: 12px; border-top: 1px solid var(--border); padding-top: 10px;">
                <strong>Technologies:</strong> HTML5, CSS3, JS (ES6+).<br>
                <strong>Libraries:</strong> <a href="https://www.chartjs.org/" target="_blank" style="color: var(--primary); text-decoration: none;">Chart.js</a>, <a href="https://fontawesome.com/" target="_blank" style="color: var(--primary); text-decoration: none;">FontAwesome</a>.<br>
                Download Link & Source Code: <a href="https://github.com/buddhanussati/meditator-journal/releases"><b>here.</b></a> Wishing you peace and diligence!
            </div>
        </div>
        
        <div style="padding: 15px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; background: var(--surface); border-radius: 0 0 16px 16px;">
            <button class="btn btn-secondary" onclick="app.closeIntroModal()">Close</button>
        </div>
    </div>
</div>
    <audio id="bell" src="bell.mp3" preload="auto"></audio>

    <script>
        // Set Chart defaults
        Chart.defaults.color = '#9ca3af';
        Chart.defaults.borderColor = '#374151';

        class GoalTracker {
            constructor() {
                // LOAD DATA SAFELY
                try {
                    this.data = JSON.parse(localStorage.getItem('chronoData'));
                } catch(e) {
                    console.error("Data corrupted", e);
                    this.data = null;
                }

                // If no data or corrupted structure, init defaults
                if (!this.data || !Array.isArray(this.data.goals)) {
                    this.data = {
                        goals: [],
                        logs: [],
                        xp: 0,
                        streak: 0,
                        globalDailyGoal: 120,
                        achievements: []
                    };
                }
                
                // MIGRATION / SANITY CHECK
                this.data.goals.forEach(goal => {
                    if (!goal.type) goal.type = 'standard'; 
                    if (!goal.sessionTargetSeconds) goal.sessionTargetSeconds = 0;
                    if (!goal.remainingSeconds) goal.remainingSeconds = 0;
                    if (typeof goal.dailyTargetMinutes === 'undefined') goal.dailyTargetMinutes = 30;
                    if (goal.type === 'meditation' && !goal.currentMindfulness) goal.currentMindfulness = 0;
                    if (goal.type === 'meditation' && !goal.totalMindfulness) goal.totalMindfulness = 0;
                });
                
                if (!this.data.globalDailyGoal) this.data.globalDailyGoal = 120;
                if (!this.data.achievements) this.data.achievements = [];
                if (!this.data.logs) this.data.logs = [];

                this.timers = {}; 
                this.today = new Date();
                this.currentMonth = new Date(this.today.getFullYear(), this.today.getMonth(), 1); 
                this.currentWeekStart = this.getStartOfWeek(this.today); 
                this.charts = { weekly: null, breakdown: null, monthly: null, dayChart: null, session: null };
                this.reportMode = 'time'; // M·∫∑c ƒë·ªãnh l√† xem th·ªùi gian
                this.meditationState = {
                    active: false, paused: false, goalId: null, count: 0,
                    startTime: null, timerRef: null, remainingSeconds: 0,
                    totalDurationSeconds: 0, touches: [] 
                };
this.currentViewDate = null; // Bi·∫øn nh·ªõ ng√†y ƒëang xem trong modal
this.dayChartMode = 'time';  // Ch·∫ø ƒë·ªô m·∫∑c ƒë·ªãnh c·ªßa modal
                this.init();
            }
  openIntroModal() {
        const modal = document.getElementById('intro-modal');
        if (modal) modal.style.display = 'flex';
    }

closeIntroModal() {
    document.getElementById('intro-modal').style.display = 'none';
    localStorage.setItem('intro_seen', 'true'); // Save so it doesn't pop up every time
}          
           // Fix: Week starts on Monday
            getStartOfWeek(date) {
                const d = new Date(date);
                const day = d.getDay() || 7; // CN=0 ƒë·ªïi th√†nh 7, T2=1 gi·ªØ nguy√™n
                const diff = d.getDate() - day + 1; // Lui v·ªÅ ng√†y 1 (Th·ª© Hai)
                return new Date(d.getFullYear(), d.getMonth(), diff);
            }
renderAnalytics() {
    const range = parseInt(document.getElementById('ana-time-range').value) || 7;
    const ctxTrend = document.getElementById('analyticsTrendChart').getContext('2d');
    
    // 1. Filter Data
    const now = Date.now();
    const cutoff = now - (range * 24 * 60 * 60 * 1000);
    const medGoalIds = this.data.goals.filter(g => g.type === 'meditation').map(g => g.id);
    
    const logs = this.data.logs
        .filter(l => medGoalIds.includes(l.goalId) && l.timestamp >= cutoff)
        .sort((a, b) => a.timestamp - b.timestamp);

    if (logs.length === 0) {
        if(this.charts.analyticsTrend) this.charts.analyticsTrend.destroy();
        document.getElementById('ana-avg-quality').innerText = "---";
        document.getElementById('ana-avg-density').innerText = "---";
        document.getElementById('ana-total-distracted').innerText = "---";
        // Translated Empty State Message
        document.getElementById('ana-comparison-table').innerHTML = '<tr><td colspan="5" style="padding:20px; text-align:center;">No meditation data found for this period.</td></tr>';
        return;
    }

    // 2. Process Logs
    let totalTimeSec = 0;
    let totalDistractedSec = 0;
    let totalTouches = 0;
    
    const sessionData = logs.map(log => {
        const result = this.analyzeSingleSession(log);
        totalTimeSec += log.minutes * 60;
        totalDistractedSec += result.distractedSec;
        const count = log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0);
        totalTouches += count;
        
        return {
            date: new Date(log.timestamp).toLocaleDateString('en-GB', {day: '2-digit', month:'2-digit'}),
            quality: result.qualityPct,
            density: (count / log.minutes).toFixed(1)
        };
    });

    // 3. Update Summary Cards
    const avgQuality = ((1 - (totalDistractedSec / totalTimeSec)) * 100).toFixed(1);
    const avgDensity = (totalTouches / (totalTimeSec / 60)).toFixed(1);
    const distractedHours = (totalDistractedSec / 3600).toFixed(1);

    document.getElementById('ana-avg-quality').innerText = `${avgQuality}%`;
    document.getElementById('ana-avg-density').innerText = avgDensity;
    document.getElementById('ana-total-distracted').innerText = `${distractedHours}h`;

    // 4. Render Trend Chart
    if (this.charts.analyticsTrend) this.charts.analyticsTrend.destroy();
    
    const chartData = sessionData.slice(-15);

    this.charts.analyticsTrend = new Chart(ctxTrend, {
        type: 'line',
        data: {
            labels: chartData.map(d => d.date),
            datasets: [
                {
                    label: 'Quality (%)', // Translated
                    data: chartData.map(d => d.quality),
                    borderColor: '#34d399',
                    backgroundColor: 'rgba(52, 211, 153, 0.1)',
                    yAxisID: 'y',
                    fill: true,
                    tension: 0.3
                },
                {
                    label: 'Mindfulness', // Translated
                    data: chartData.map(d => d.density),
                    borderColor: '#818cf8',
                    borderDash: [5, 5],
                    yAxisID: 'y1',
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
			plugins: {  
        tooltip: {
            titleColor: '#f3f4f6',
            bodyColor: '#f3f4f6',
            borderColor: '#374151',
            borderWidth: 1,
            padding: 10,
            displayColors: true, // Shows the square box
            
            callbacks: {
                // THIS FIXES THE HOVER BOX COLOR
                labelColor: function(context) {
                    const dataset = context.dataset;
                    return {
                        borderColor: dataset.borderColor,
                        backgroundColor: dataset.borderColor, // FORCES SOLID COLOR IN HOVER BOX
                        borderWidth: 0,
                        borderRadius: 2,
                    };
                }
            }
        }
    },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    min: 0, max: 100,
                    title: { display: true, text: 'Quality %' }, // Translated
                    grid: { color: '#374151' }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: { drawOnChartArea: false },
                    title: { display: true, text: 'Mindfulness / Min' } // Translated
                }
            }
        }
    });

    this.renderComparisonTable(medGoalIds);
}

// Logic: Gap Analysis
// If gap > threshold (20s), assume mind wandered.
analyzeSingleSession(log) {
    // Basic fallback if no touches data
    if (!log.touches || log.touches.length < 2) {
        return { distractedSec: log.minutes * 60 * 0.5, qualityPct: 50 }; // Assume 50% if no data
    }

    const sortedTouches = [...log.touches].sort((a,b) => a - b);
    const thresholdSec = 12; // Seconds before considering it "Distraction"
    let distractedSec = 0;
    
    // Check gap from Start to First Touch
    const startGap = (sortedTouches[0] - log.timestamp) / 1000;
    if (startGap > thresholdSec) distractedSec += (startGap - thresholdSec);

    // Check gaps between touches
    for (let i = 1; i < sortedTouches.length; i++) {
        const gap = (sortedTouches[i] - sortedTouches[i-1]) / 1000;
        if (gap > thresholdSec) {
            distractedSec += (gap - thresholdSec);
        }
    }

    // Check gap from Last Touch to End
    const endTime = log.timestamp + (log.minutes * 60 * 1000);
    const endGap = (endTime - sortedTouches[sortedTouches.length - 1]) / 1000;
    if (endGap > thresholdSec) distractedSec += (endGap - thresholdSec);

    // Cap distracted seconds to total minutes (to avoid calculation errors)
    const totalSec = log.minutes * 60;
    distractedSec = Math.min(distractedSec, totalSec);
    
    const qualityPct = ((totalSec - distractedSec) / totalSec) * 100;
    
    return { distractedSec, qualityPct: parseFloat(qualityPct.toFixed(1)) };
}
renderComparisonTable(medGoalIds) {
    const tbody = document.getElementById('ana-comparison-table');
    tbody.innerHTML = '';

    const now = new Date();
    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
    
    // 1. Yesterday Calculation
    const startOfYesterday = todayStart - (24 * 60 * 60 * 1000);
    
    // 2. Start of This Week (Monday)
    const dayOfWeek = now.getDay(); 
    const diffToMonday = (dayOfWeek === 0 ? 6 : dayOfWeek - 1);
    const startOfThisWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - diffToMonday).getTime();
    const startOfLastWeek = startOfThisWeek - (7 * 24 * 60 * 60 * 1000);

    // 3. Start of This Month
    const startOfThisMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
    const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1).getTime();

    // 4. Period Definitions
    const periods = [
        { label: 'Today', start: todayStart, end: Date.now() },
        { label: 'Yesterday', start: startOfYesterday, end: todayStart },
        { label: 'This Week', start: startOfThisWeek, end: Date.now() },
        { label: 'Last Week', start: startOfLastWeek, end: startOfThisWeek },
        { label: 'This Month', start: startOfThisMonth, end: Date.now() },
        { label: 'Last Month', start: startOfLastMonth, end: startOfThisMonth }
    ];

    periods.forEach(p => {
        const stats = this.getStatsForRange(p.start, p.end, medGoalIds);
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid var(--border)';
        
        let qualityColor = 'var(--text)';
        if(stats.count > 0) {
            if(stats.quality > 80) qualityColor = 'var(--success)';
            else if(stats.quality < 50) qualityColor = 'var(--danger)';
        }

        row.innerHTML = `
            <td style="padding: 12px 10px; font-weight: 500;">${p.label}</td>
            <td style="padding: 12px 10px; text-align: center;">${stats.count}</td>
            <td style="padding: 12px 10px; text-align: center;">${(stats.minutes/60).toFixed(1)}h</td>
            <td style="padding: 12px 10px; text-align: center; color: ${qualityColor}; font-weight:bold;">${stats.count > 0 ? stats.quality + '%' : '-'}</td>
            <td style="padding: 12px 10px; text-align: center;">${stats.count > 0 ? stats.density : '-'}</td>
        `;
        tbody.appendChild(row);
    });
}

// Helper method to filter by exact timestamp range
getStatsForRange(startTime, endTime, goalIds) {
    const logs = this.data.logs.filter(l => 
        goalIds.includes(l.goalId) && 
        l.timestamp >= startTime && 
        l.timestamp < endTime
    );

    if (logs.length === 0) return { count: 0, minutes: 0, quality: 0, density: 0 };

    let totalMinutes = 0;
    let totalTouches = 0;
    let weightedQualitySum = 0;

    logs.forEach(l => {
        totalMinutes += l.minutes;
        const count = l.count !== undefined ? l.count : (l.touches ? l.touches.length : 0);
        totalTouches += count;
        const analysis = this.analyzeSingleSession(l);
        weightedQualitySum += (l.minutes * analysis.qualityPct);
    });

    return {
        count: logs.length,
        minutes: totalMinutes,
        quality: (weightedQualitySum / totalMinutes).toFixed(1),
        density: (totalTouches / totalMinutes).toFixed(1)
    };
}
            init() {
                try {
                    this.renderDate();
                    this.renderGoals();
                    this.updateStats();
                    this.checkAchievements();
                    this.renderCalendar();
                    setInterval(() => this.updateTimerUI(), 1000);

                    const medOverlay = document.getElementById('meditation-overlay');
                    if(medOverlay) {
                        medOverlay.addEventListener('pointerdown', (e) => {
                            if(e.target.closest('.med-controls')) return;
                            this.handleMeditationTouch();
                        });
                    }
                } catch (err) {
                    console.error("Error during init:", err);
                    alert("App failed to initialize. Try resetting data via the sidebar button.");
                }
				if (!localStorage.getItem('intro_seen')) {
        this.openIntroModal();
    }
            }

            save() {
                localStorage.setItem('chronoData', JSON.stringify(this.data));
                this.updateStats();
            }
get totalMindfulnessCounts() {
    return this.data.logs.reduce((sum, log) => {
        // Fix: Check for manual 'count' first, fallback to 'touches' length
        return sum + (log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0));
    }, 0);
}			
            // --- AUDIO HELPER ---
            playBell() {
                const audio = document.getElementById('bell');
                if (audio) {
                    audio.currentTime = 0;
                    audio.play().catch(e => console.log("Audio play failed (autoplay blocked):", e));
                }
            }
            // --- Goal Management ---
            saveGoal(e) {
                e.preventDefault();
                const id = document.getElementById('g-id').value;
                const type = document.getElementById('g-type').value || 'standard';
                const name = document.getElementById('g-name').value;
                const category = document.getElementById('g-cat').value;
                const color = document.getElementById('g-color').value;
                const lifetimeTarget = parseInt(document.getElementById('g-lifetime-target').value);
                const dailyTarget = parseInt(document.getElementById('g-daily-target').value);

                if (id) {
                    const goal = this.data.goals.find(g => g.id === id);
                    if (goal) {
                        goal.name = name; goal.category = category; goal.color = color;
                        goal.lifetimeTargetMinutes = lifetimeTarget; goal.dailyTargetMinutes = dailyTarget;
                        this.showToast('Goal Updated!');
                    }
                } else {
                    const newGoal = {
                        id: Date.now().toString(), type, name, category, color,
                        lifetimeTargetMinutes: lifetimeTarget, dailyTargetMinutes: dailyTarget || 0,
                        totalMinutes: 0, totalMindfulness: 0, sessionTargetSeconds: 0,
                        remainingSeconds: 0, currentSessionStartTime: null, isActive: false
                    };
                    this.data.goals.push(newGoal);
                    this.showToast('Goal Created!');
                }
                this.save();
                this.renderGoals();
                this.closeModal();
            }

            setGlobalDailyGoal() {
                const current = this.data.globalDailyGoal || 120;
                const input = prompt("Enter Total Daily Target (mins):", current);
                if (input && !isNaN(input) && parseInt(input) > 0) {
                    this.data.globalDailyGoal = parseInt(input);
                    this.save();
                    this.showToast("Updated!");
                }
            }

            toggleTimer(id) {
                const goal = this.data.goals.find(g => g.id === id);
                if (!goal) return;

                this.data.goals.forEach(g => {
                    if(g.isActive && g.id !== id && g.type === 'standard') this.toggleTimer(g.id); 
                });

                if (goal.type === 'meditation') {
                    this.startMeditationSetup(goal);
                    return;
                }

                if (goal.isActive) {
                    clearInterval(this.timers[id]);
                    goal.isActive = false;
                    const spentSeconds = goal.sessionTargetSeconds - goal.remainingSeconds;
                    const minutesSpent = Math.floor(spentSeconds / 60);
                    const startTime = goal.currentSessionStartTime || Date.now();
                    goal.sessionTargetSeconds = 0; goal.remainingSeconds = 0; goal.currentSessionStartTime = null;
                    if (minutesSpent > 0) this.openSessionModal(id, minutesSpent, null, startTime);
                    else this.showToast('Session too short.');
                } else {
                    const minStr = prompt('Duration (mins):', '25');
                    if (!minStr) return;
                    const min = parseInt(minStr);
                    if (isNaN(min) || min <= 0) return;

                    goal.sessionTargetSeconds = min * 60;
                    goal.remainingSeconds = goal.sessionTargetSeconds;
                    goal.isActive = true;
                    goal.currentSessionStartTime = Date.now(); 

                    this.timers[id] = setInterval(() => {
                        if (goal.remainingSeconds > 0) {
                            goal.remainingSeconds--;
                        } else {
                            clearInterval(this.timers[id]);
							this.playBell(); // Play sound
                            goal.isActive = false;
                            const minutesSpent = Math.floor(goal.sessionTargetSeconds / 60);
                            const startTime = goal.currentSessionStartTime;
                            goal.sessionTargetSeconds = 0; goal.remainingSeconds = 0; goal.currentSessionStartTime = null;
                            this.openSessionModal(id, minutesSpent, null, startTime);
                            this.showToast('Complete!');
                            this.renderGoals(); 
                        }
                    }, 1000);
                }
                this.renderGoals();
            }
            
            // --- MEDITATION LOGIC ---
            startMeditationSetup(goal) {
                const minStr = prompt('Meditation duration (mins):', '30');
                if (!minStr) return;
                const min = parseInt(minStr);
                if (isNaN(min) || min <= 0) return;
    if (typeof Website2APK !== 'undefined') {
        Website2APK.keepScreenOn(true); // B·∫≠t ch·∫ø ƒë·ªô lu√¥n s√°ng
    }
                this.meditationState = {
                    active: true, paused: false, goalId: goal.id, count: 0,
                    startTime: Date.now(), totalDurationSeconds: min * 60,
                    remainingSeconds: min * 60, touches: []
                };
                document.getElementById('meditation-overlay').style.display = 'flex';
                document.getElementById('med-counter').innerText = '0';
                this.updateMedTimerDisplay();

                this.meditationState.timerRef = setInterval(() => {
                    if (!this.meditationState.paused) {
                        if (this.meditationState.remainingSeconds > 0) {
                            this.meditationState.remainingSeconds--;
                            this.updateMedTimerDisplay();
                        } else {
                            this.concludeMeditationSession('auto');
                        }
                    }
                }, 1000);
            }

            updateMedTimerDisplay() {
                const s = this.meditationState.remainingSeconds;
                const m = Math.floor(s / 60);
                const sec = s % 60;
                document.getElementById('med-timer').innerText = `${m}:${sec.toString().padStart(2, '0')}`;
            }

            handleMeditationTouch() {
                if (!this.meditationState.active || this.meditationState.paused) return;
                this.meditationState.count++;
                this.meditationState.touches.push(Date.now());
                const el = document.getElementById('med-counter');
                el.innerText = this.meditationState.count;
                el.style.transform = 'scale(1.1)';
                setTimeout(() => el.style.transform = 'scale(1)', 100);
            }

            togglePauseMeditation() {
                this.meditationState.paused = !this.meditationState.paused;
                const btn = document.getElementById('med-pause-btn');
                btn.innerHTML = this.meditationState.paused ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';
            }
            
            // NEW: Conclude session and show Notes modal (instead of auto-saving)
concludeMeditationSession(type = 'manual') {
    clearInterval(this.meditationState.timerRef);
    if (typeof Website2APK !== 'undefined') {
        Website2APK.keepScreenOn(false); 
    }
    // Only play the bell if the timer finished on its own
    if (type === 'auto') {
        this.playBell();
    }
    
    document.getElementById('meditation-overlay').style.display = 'none';
    
    const durationSeconds = this.meditationState.totalDurationSeconds - this.meditationState.remainingSeconds;
    const minutes = Math.ceil(durationSeconds / 60);
    
    if (minutes <= 0) {
        this.showToast("Phi√™n qu√° ng·∫Øn");
        this.meditationState.active = false;
        return;
    }
    
    document.getElementById('med-finish-count').innerText = this.meditationState.count;
    document.getElementById('med-finish-time').innerText = minutes + 'm';
    document.getElementById('med-finish-notes').value = '';
    document.getElementById('meditation-finish-modal').style.display = 'flex';
}
            
            discardMeditation() {
                document.getElementById('meditation-finish-modal').style.display = 'none';
                this.meditationState.active = false;
                this.showToast("Session Discarded");
            }

            saveMeditationLog() {
                // Get data from state
                const durationSeconds = this.meditationState.totalDurationSeconds - this.meditationState.remainingSeconds;
                const minutes = Math.ceil(durationSeconds / 60);
                const notes = document.getElementById('med-finish-notes').value;

                const goal = this.data.goals.find(g => g.id === this.meditationState.goalId);
                const log = {
                    goalId: goal.id,
                    date: this.toIsoDate(new Date(this.meditationState.startTime)),
                    timestamp: this.meditationState.startTime,
                    minutes: minutes,
                    notes: `Mindfulness: ${this.meditationState.count}. ${notes}`, // Combine count and notes
                    touches: this.meditationState.touches
                };

                this.data.logs.push(log);
                goal.totalMinutes += minutes;
                if (!goal.totalMindfulness) goal.totalMindfulness = 0;
                goal.totalMindfulness += this.meditationState.count;

                this.meditationState.active = false;
                this.save();
                this.recalculateStreak();
                this.renderGoals();
                this.renderReports();
                this.checkAchievements();
                
                document.getElementById('meditation-finish-modal').style.display = 'none';
                this.showToast(`Session Saved! +${this.meditationState.count} mindfulness.`);
            }

            // --- STANDARD TIMER UI UPDATES ---
            updateTimerUI() {
                const todayStr = this.toIsoDate(new Date());
                this.data.goals.forEach(goal => {
                    if (goal.type === 'meditation') return; 
                    let activeSessionMins = 0;
                    let sessionPctVal = 0;
                    if (goal.isActive) {
                        const display = document.getElementById(`timer-${goal.id}`);
                        if (display) display.innerText = this.formatTime(goal.remainingSeconds);
                        const activeSessionSeconds = goal.sessionTargetSeconds - goal.remainingSeconds;
                        activeSessionMins = Math.floor(activeSessionSeconds / 60);
                        sessionPctVal = goal.sessionTargetSeconds > 0 ? (activeSessionSeconds / goal.sessionTargetSeconds) * 100 : 0;
                    }
                    const sessionBar = document.getElementById(`bar-session-${goal.id}`);
                    const sessionText = document.getElementById(`prog-text-session-${goal.id}`);
                    if (sessionBar) sessionBar.style.width = `${sessionPctVal}%`;
                    if (sessionText) sessionText.innerText = goal.isActive ? `${activeSessionMins} / ${Math.floor(goal.sessionTargetSeconds / 60)} mins` : "Ready";
                });
                this.updateStats(); 
            }

            renderGoals() {
                const container = document.getElementById('active-goals-container');
                const emptyMsg = document.getElementById('empty-msg');
                container.innerHTML = '';
                if (this.data.goals.length === 0) { emptyMsg.style.display = 'block'; return; }
                emptyMsg.style.display = 'none';
                const todayStr = this.toIsoDate(new Date());

                this.data.goals.forEach(goal => {
    const isMeditation = goal.type === 'meditation';
    const unitLabel = isMeditation ? 'mindfulness' : 'mins';
    const targetProp = isMeditation ? 'totalMindfulness' : 'totalMinutes';
    const overallPct = goal.lifetimeTargetMinutes > 0 ? Math.min((goal[targetProp] / goal.lifetimeTargetMinutes) * 100, 100) : 0;

    let todayVal = 0;
    if (isMeditation) {
        // UPDATED LINE: Check l.count first, fallback to l.touches.length
        todayVal = this.data.logs
            .filter(l => l.goalId === goal.id && l.date === todayStr)
            .reduce((sum, l) => sum + (l.count !== undefined ? l.count : (l.touches ? l.touches.length : 0)), 0);
    } else {
        todayVal = this.data.logs.filter(l => l.goalId === goal.id && l.date === todayStr).reduce((sum, l) => sum + l.minutes, 0);
    }
                    
                    const dailyTarget = goal.dailyTargetMinutes || 0;
                    let dailyPct = 0;
                    let dailyBarColor = goal.color;
                    if (dailyTarget > 0) {
                        dailyPct = Math.min((todayVal / dailyTarget) * 100, 100);
                        if (todayVal >= dailyTarget) dailyBarColor = 'var(--success)';
                    }
                    
                    const div = document.createElement('div');
                    div.className = 'card goal-card';
                    div.style.borderLeft = `5px solid ${goal.color}`;
                    
                    let controlsHtml = '', dailySectionHtml = '', sessionSectionHtml = '';
                    if (dailyTarget > 0) {
                        dailySectionHtml = `
                            <div style="margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                                <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px; align-items:center;">
                                    <strong style="color:var(--text);">Today's Goal</strong>
                                    <span style="font-weight:600;">${todayVal} / ${dailyTarget} ${unitLabel}</span>
                                </div>
                                <div class="progress-container" style="height: 6px;"><div class="progress-bar" style="width: ${dailyPct}%; background: ${dailyBarColor}"></div></div>
                            </div>`;
                    }

                    if (isMeditation) {
                        controlsHtml = `
                             <div class="timer-controls">
                                <div style="font-size: 14px; color: var(--text-light); text-transform: uppercase;">Meditation</div>
                                <div style="display:flex; gap: 10px;">
                                    <button class="btn-icon btn-play" style="background: var(--zen); color: white;" onclick="app.toggleTimer('${goal.id}')" title="Start Meditate"><i class="fas fa-om"></i></button>
                                    
                                    <button class="btn-icon" style="background:var(--warning); color:#000;" onclick="app.openSessionModal('${goal.id}')" title="Add Manually"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>`;
                    } else {
                        sessionSectionHtml = `
                            <div class="section-label">Current Session</div>
                            <div class="progress-container"><div id="bar-session-${goal.id}" class="progress-bar" style="background:var(--success); width:0%;"></div></div>
                            <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--text-light);"><span id="prog-text-session-${goal.id}">Ready</span></div>`;
                        controlsHtml = `
                            <div class="timer-controls">
                                <div id="timer-${goal.id}" class="timer-display">00:00</div>
                                <div style="display:flex; gap: 10px;">
                                    <button class="btn-icon ${goal.isActive ? 'btn-stop' : 'btn-play'}" onclick="app.toggleTimer('${goal.id}')"><i class="fas ${goal.isActive ? 'fa-stop' : 'fa-play'}"></i></button>
                                    <button class="btn-icon" style="background:var(--warning); color:#000;" onclick="app.openSessionModal('${goal.id}')"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>`;
                    }

                    div.innerHTML = `
                        <div class="goal-header">
                            <div><div class="goal-title">${goal.name}</div><span class="goal-tag" style="color:#b1b1c9; background: rgba(255,255,255,0.1)">${goal.category}</span></div>
                            <div style="display:flex; gap: 5px;">
                                <button class="btn-icon" style="color: var(--text-light)" onclick="app.openModal('${goal.id}', '${goal.type}')"><i class="fas fa-pencil-alt"></i></button>
                                <button class="btn-icon" style="color: var(--text-light)" onclick="app.deleteGoal('${goal.id}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        ${dailySectionHtml}
                        <div class="section-label">Achievement Progress</div>
                        <div class="progress-container"><div class="progress-bar" style="width: ${overallPct}%; background: ${goal.color}"></div></div>
                        <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--text-light); margin-bottom: 15px;"><span>${goal[targetProp]} / ${goal.lifetimeTargetMinutes} ${unitLabel}</span><span>${(overallPct).toFixed(1)}%</span></div>
                        ${sessionSectionHtml} ${controlsHtml}
                        <div class="sessions-list" style="margin-top: 15px; max-height: 150px; overflow-y: auto;"><div id="sessions-${goal.id}"></div></div>
                    `;
                    container.appendChild(div);
                    this.renderSessions(goal.id, isMeditation);
                });
            }
            
            renderSessions(goalId, isMeditation) {
                const container = document.getElementById(`sessions-${goalId}`);
                if (!container) return;
                container.innerHTML = '';
                
                // S·∫Øp x·∫øp: M·ªõi nh·∫•t l√™n ƒë·∫ßu
                const sessions = this.data.logs.filter(l => l.goalId === goalId).sort((a,b) => b.timestamp - a.timestamp);
                
                if (sessions.length === 0) { 
                    container.innerHTML = '<p style="font-size:12px; color:var(--text-light);">No sessions yet</p>'; 
                    return; 
                }
                
                const ol = document.createElement('ol');
                sessions.forEach((log) => {
                    const sLi = document.createElement('li');
                    sLi.className = 'session-item';
                    
                    const notesDisplay = log.notes ? `<span class="session-notes">"${log.notes}"</span>` : '';
                    
                    // --- PH·∫¶N S·ª¨A ƒê·ªîI CH√çNH ·ªû ƒê√ÇY ---
                    let actionButtons = '<div style="display:flex; gap:5px;">';
                    
                    // 1. N√∫t xem bi·ªÉu ƒë·ªì (Ch·ªâ hi·ªán n·∫øu l√† thi·ªÅn v√† c√≥ d·ªØ li·ªáu ch·∫°m)
                    if (isMeditation && log.touches && log.touches.length > 0) {
                        actionButtons += `<button class="btn-icon" style="background:transparent; color:var(--zen); height:24px; width:24px;" onclick="app.showSessionGraph('${log.timestamp}')" title="Show graph"><i class="fas fa-chart-area" style="font-size:12px;"></i></button>`;
                    }
                    
                    // 2. N√∫t ch·ªânh s·ª≠a (Lu√¥n hi·ªán cho t·∫•t c·∫£ c√°c lo·∫°i)
                    // L∆∞u √Ω: log.timestamp ƒë∆∞·ª£c truy·ªÅn v√†o l√†m ID ƒë·ªÉ s·ª≠a
                    actionButtons += `<button class="btn-icon" style="background:transparent; color:var(--text-light); height:24px; width:24px;" onclick="app.openSessionModal('${goalId}', ${log.minutes}, ${log.timestamp}, ${log.timestamp})" title="Edit details"><i class="fas fa-edit" style="font-size:12px;"></i></button>`;
                    
                    actionButtons += '</div>';
                    // ---------------------------------

                    sLi.innerHTML = `
                        <div class="session-content">
                            <span class="session-date">${this.toDisplayDate(log.timestamp)}</span>: ${log.minutes} minutes 
                            ${notesDisplay}
                        </div>
                        ${actionButtons}
                    `;
                    ol.appendChild(sLi);
                });
                container.appendChild(ol);
            }
            
            showSessionGraph(timestamp) {
    const exportBtn = document.getElementById('btn-export-session');
    if (exportBtn) {
        exportBtn.onclick = () => this.exportSessionData(timestamp);
    }

    const log = this.data.logs.find(l => l.timestamp == timestamp);
    if (!log || !log.touches) {
        this.showToast("No data available for this session");
        return;
    }
    
    // Store current log for switching views
    this.currentGraphLog = log;

    document.getElementById('graph-modal').style.display = 'flex';
    document.getElementById('graph-date').innerText = new Date(log.timestamp).toLocaleString('vi-VN');
    
    // Reset selector to default and render
    document.getElementById('graph-type-select').value = 'intensity';
    this.updateSessionChart();
}

updateSessionChart() {
    if (!this.currentGraphLog) return;
    const type = document.getElementById('graph-type-select').value;
    const ctx = document.getElementById('sessionGraph').getContext('2d');
    
    // Destroy previous instance
    if (this.charts.session) this.charts.session.destroy();

    if (type === 'interval') {
        this.renderIntervalChart(ctx, this.currentGraphLog);
    } else {
        this.renderIntensityChart(ctx, this.currentGraphLog);
    }
}

renderIntensityChart(ctx, log) {
    const startTime = log.timestamp;
    const durationSeconds = (log.minutes * 60) || Math.ceil((Date.now() - startTime) / 1000);
    
    const dataPoints = [];
    const labels = [];
    const totalPoints = 30; 
    const step = durationSeconds / totalPoints; 

    for (let s = 0; s <= durationSeconds; s += step) {
        labels.push(durationSeconds < 120 ? Math.round(s) + 's' : (s / 60).toFixed(0));
        const windowSizeMs = 60000; 
        const windowStart = (s * 1000) - (windowSizeMs / 2);
        const windowEnd = (s * 1000) + (windowSizeMs / 2);

        const intensity = log.touches.filter(t => {
            const touchTime = t - startTime;
            return touchTime >= windowStart && touchTime <= windowEnd;
        }).length;
        dataPoints.push(intensity);
    }

    const chartHeight = ctx.canvas.clientHeight || 300; 
    const gradient = ctx.createLinearGradient(0, 0, 0, chartHeight);
    gradient.addColorStop(0, 'rgba(167, 139, 250, 0.6)'); 
    gradient.addColorStop(0.5, 'rgba(167, 139, 250, 0.3)'); 
    gradient.addColorStop(1, 'rgba(167, 139, 250, 0.05)');   

    this.charts.session = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Mindfulness',
                data: dataPoints,
                borderColor: '#a78bfa', // Purple
                backgroundColor: gradient,
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 5,
                pointBackgroundColor: '#c7b6fc',
                pointBorderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: {
                x: { title: { display: true, text: 'Time (mins)', color: '#9ca3af' }, grid: { display: true }, ticks: { maxTicksLimit: 20, color: '#9ca3af' } },
                y: { beginAtZero: true, title: { display: true, text: 'Density', color: '#9ca3af' }, grid: { color: 'rgba(55, 65, 81, 0.5)' }, ticks: { color: '#9ca3af' } }
            },
            plugins: {
                tooltip: {
                    mode: 'index', intersect: false, displayColors: false,
                    callbacks: { label: (c) => c.raw >= 1 ? "üå± Mindfulness (" + c.raw + ")" : "‚òÅÔ∏è Unmindful" }
                },
                legend: { display: false }
            }
        }
    });
}

renderIntervalChart(ctx, log) {
    const touches = log.touches.sort((a, b) => a - b);
    const startTime = log.timestamp;
    
    // Create Data Points: Y = Gap Duration (seconds), Label = Time of occurrence
    const dataPoints = [];
    const labels = [];
    let previousTime = startTime;

    // Process touches to calculate gaps
    touches.forEach(t => {
        const gapSeconds = (t - previousTime) / 1000;
        const timeFromStartMins = ((t - startTime) / 1000 / 60).toFixed(0);
        
        dataPoints.push(gapSeconds.toFixed(1));
        labels.push(timeFromStartMins);
        previousTime = t;
    });

    // Add final gap (from last touch to end of session)
    const endTime = startTime + (log.minutes * 60 * 1000);
    if (endTime > previousTime) {
        const finalGap = (endTime - previousTime) / 1000;
        dataPoints.push(finalGap.toFixed(1));
        labels.push(log.minutes.toFixed(1));
    }

    // Gradient Red Style
    const chartHeight = ctx.canvas.clientHeight || 300;
    const gradient = ctx.createLinearGradient(0, 0, 0, chartHeight);
    gradient.addColorStop(0, 'rgba(248, 113, 113, 0.6)'); // Red Top
    gradient.addColorStop(0.5, 'rgba(248, 113, 113, 0.3)'); 
    gradient.addColorStop(1, 'rgba(248, 113, 113, 0.05)'); // Red Bottom

    this.charts.session = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels, // X-Axis labels (timestamps of touches)
            datasets: [{
                label: 'Forgetfulness Interval',
                data: dataPoints,
                borderColor: '#f87171', // Red Border
                backgroundColor: gradient,
                borderWidth: 2,
                fill: true,
                tension: 0.2, // Sharper lines for intervals
                pointRadius: 0,
                pointBackgroundColor: '#f87171',
                pointHoverRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: {
                x: { 
                    title: { display: true, text: 'Time (mins)', color: '#9ca3af' }, 
                    grid: { display: true }, // Hide X grid for cleaner look on event-based data
                    ticks: { color: '#9ca3af', maxTicksLimit: 15 } 
                },
                y: { 
                    beginAtZero: true, 
                    title: { display: true, text: 'Delays', color: '#9ca3af' }, 
                    ticks: { color: '#9ca3af' } 
                }
            },
            plugins: {
                tooltip: {
                    displayColors: false,
                    callbacks: {
                        title: (items) => `Minute ${items[0].label}`,
                        label: (c) => `Delay: ${c.raw} secs`
                    }
                },
                legend: { display: false }
            }
        }
    });
}
// --- NEW GRAPH LOGIC END ---
exportSessionData(timestamp) {
    const log = this.data.logs.find(l => l.timestamp == timestamp);
    if (!log) {
        this.showToast('Could not copy text!');
        return;
    }

    const dataStr = JSON.stringify(log);

    // Copy to clipboard logic
    if (navigator.clipboard) {
        navigator.clipboard.writeText(dataStr).then(() => {
            this.showToast('JSON data has been copied!');
        }).catch((err) => {
            console.error('Async: Could not copy text: ', err);
            this.fallbackCopyText(dataStr);
        });
    } else {
        this.fallbackCopyText(dataStr);
    }
}

// Helper for older browsers or webviews
fallbackCopyText(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    
    // Ensure it's not visible but part of DOM
    textArea.style.position = 'fixed';
    textArea.style.left = '-9999px';
    document.body.appendChild(textArea);
    
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if(successful) this.showToast('JSON data has been copied!');
        else this.showToast('Oops, unable to copy');
    } catch (err) {
        console.error('Fallback: Oops, unable to copy', err);
        this.showToast('Oops, unable to copy');
    }

    
    document.body.removeChild(textArea);
}
            openChoiceModal() { document.getElementById('choice-modal').style.display = 'flex'; }
            closeChoiceModal() { document.getElementById('choice-modal').style.display = 'none'; }

            openModal(goalId = null, type = 'standard') { 
                this.closeChoiceModal(); 
                const modal = document.getElementById('goal-modal');
                const title = document.getElementById('modal-title');
                const btn = document.getElementById('btn-save-goal');
                const catSelect = document.getElementById('g-cat');
                catSelect.innerHTML = '';
                const cats = type === 'meditation' ? ['Sitting Meditation', 'Walking Meditation', 'Bhavana'] : ['Work', 'Study', 'Health', 'Creative', 'Merit', 'Other'];
                cats.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.innerText = c; catSelect.appendChild(opt); });

                const dailyHint = document.getElementById('g-daily-hint');
                const lifeHint = document.getElementById('g-life-hint');
                if (type === 'meditation') { dailyHint.innerText = "Mindfulness per day"; lifeHint.innerText = "Mindfulness"; } 
                else { dailyHint.innerText = "Mins per day"; lifeHint.innerText = "Minutes"; }
                document.getElementById('g-type').value = type;

                if (goalId) {
                    const goal = this.data.goals.find(g => g.id === goalId);
                    if (goal) {
                        document.getElementById('g-id').value = goal.id;
                        document.getElementById('g-name').value = goal.name;
                        document.getElementById('g-cat').value = goal.category;
                        document.getElementById('g-color').value = goal.color;
                        document.getElementById('g-lifetime-target').value = goal.lifetimeTargetMinutes;
                        document.getElementById('g-daily-target').value = goal.dailyTargetMinutes;
                        document.getElementById('g-type').value = goal.type || 'standard';
                        title.innerText = 'Edit Goal'; btn.innerText = 'Save';
                    }
                } else {
                    document.getElementById('g-id').value = '';
                    document.getElementById('g-name').value = '';
                    document.getElementById('g-color').value = type === 'meditation' ? '#a78bfa' : '#818cf8';
                    document.getElementById('g-lifetime-target').value = 1000;
                    document.getElementById('g-daily-target').value = 100;
                    title.innerText = type === 'meditation' ? 'New Meditation Goal' : 'New Activity Goal'; btn.innerText = 'Create';
                }
                modal.style.display = 'flex'; 
            }
            closeModal() { document.getElementById('goal-modal').style.display = 'none'; }
            
                        renderCalendar() {
                const grid = document.getElementById('calendar-grid');
                grid.innerHTML = '';
                const y = this.currentMonth.getFullYear(); const m = this.currentMonth.getMonth();
                document.getElementById('cal-month-year').innerText = new Date(y, m).toLocaleString('en-GB', { month: 'long', year: 'numeric' });
                
                // 
                const headerDiv = document.createElement('div');
                headerDiv.className = 'calendar-header';
                ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d => {
                    const h = document.createElement('div'); h.className = 'cal-head-day'; h.innerText = d;
                    grid.appendChild(h);
                });

                // Calculate blanks for Monday start
                // new Date(y, m, 1).getDay() -> 0(Sun), 1(Mon)...
                const firstDayRaw = new Date(y, m, 1).getDay();
                // If Mon(1) -> 0 blanks. If Sun(0) -> 6 blanks.
                const blankSlots = firstDayRaw === 0 ? 6 : firstDayRaw - 1;

                const daysInMonth = new Date(y, m + 1, 0).getDate();
                
                for(let i=0; i<blankSlots; i++) { grid.appendChild(document.createElement('div')); }
                for(let i=1; i<=daysInMonth; i++) {
                    const dStr = `${y}-${String(m+1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day'; dayEl.innerText = i;
                    const totalMins = this.data.logs.filter(l => l.date === dStr).reduce((sum, l) => sum + l.minutes, 0);
                    if(totalMins > 0) {
                        dayEl.classList.add('has-data');
                        if (totalMins > 120) dayEl.classList.add('level-3');
                        else if (totalMins > 60) dayEl.classList.add('level-2');
                        else dayEl.classList.add('level-1');
                    }
                    dayEl.onclick = () => this.openDayStats(dStr);
                    grid.appendChild(dayEl);
                }
            }
switchDayChart(mode) {
    this.dayChartMode = mode;
    
    // C·∫≠p nh·∫≠t giao di·ªán n√∫t
    const btnTime = document.getElementById('btn-modal-time');
    const btnMind = document.getElementById('btn-modal-mind');
    
    if (mode === 'time') {
        btnTime.className = 'btn';
        btnMind.className = 'btn btn-secondary';
    } else {
        btnTime.className = 'btn btn-secondary';
        btnMind.className = 'btn';
    }
    
    // V·∫Ω l·∫°i chart
    if (this.currentViewDate) {
        this.renderDayChartOnly(this.currentViewDate);
    }
}
openDayStats(dateStr) {
    this.currentViewDate = dateStr;
    const modal = document.getElementById('day-details-modal');
    document.getElementById('day-modal-title').innerText = new Date(dateStr).toLocaleDateString('en-GB', {weekday: 'long', day: 'numeric', month: 'numeric'});
    
    // Reset v·ªÅ ch·∫ø ƒë·ªô time khi m·ªõi m·ªü
    this.switchDayChart('time'); 

    // 1. RENDER LIST (Lu√¥n hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß c·∫£ Time v√† Sati)
    const dayLogs = this.data.logs.filter(l => l.date === dateStr).sort((a,b) => b.timestamp - a.timestamp);
    const listContainer = document.getElementById('day-session-list');
    listContainer.innerHTML = dayLogs.length ? '' : '<p class="empty-state">No Activities.</p>';
    
    const ul = document.createElement('ul'); 
    ul.style.listStyle = 'none';
    
    dayLogs.forEach(log => {
        const goal = this.data.goals.find(g => g.id === log.goalId);
        const li = document.createElement('li');
        li.style.cssText = 'padding: 8px 0; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; font-size: 13px; align-items:center;';
        
        // N√∫t xem bi·ªÉu ƒë·ªì s√≥ng n√£o (n·∫øu c√≥ touch data)
        let graphBtnHtml = '';
        if (goal && goal.type === 'meditation' && log.touches && log.touches.length > 0) {
            graphBtnHtml = `<button class="btn-icon" style="background:transparent; color:var(--zen); height:24px; width:24px; margin-right:5px; cursor:pointer;" onclick="app.showSessionGraph('${log.timestamp}')"><i class="fas fa-chart-area" style="font-size:12px;"></i></button>`;
        }

        // Hi·ªÉn th·ªã s·ªë Sati (n·∫øu c√≥)
        const satiCount = log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0);
        const satiInfo = satiCount > 0 ? `<span style="color: var(--zen); font-size: 11px; margin-left: 5px; font-weight:bold;">(${satiCount} mindfulness)</span>` : '';

        const leftSide = `<div>
                           <span style="font-weight:600; color:${goal?goal.color:'#ccc'}">${goal?goal.name:'ƒê√£ x√≥a'}</span>
                           <span style="margin-left:5px;">${log.minutes}p</span>
                           ${satiInfo}
                         </div>`;
        
        const rightSide = `<div style="display:flex; align-items:center;">
                               ${graphBtnHtml}
                               <div style="font-size: 11px; color: var(--text-light); width:35px; text-align:right;">
                                   ${new Date(log.timestamp).toLocaleTimeString('en-GB', {hour: '2-digit', minute:'2-digit'})}
                               </div>
                           </div>`;

        li.innerHTML = leftSide + rightSide;
        ul.appendChild(li);
    });
    listContainer.appendChild(ul);
    
    modal.style.display = 'flex';
}

// H√†m ri√™ng ƒë·ªÉ v·∫Ω chart trong modal
renderDayChartOnly(dateStr) {
    const ctx = document.getElementById('dayBreakdownChart').getContext('2d');
    const isMindfulness = this.dayChartMode === 'mindfulness';
    const unitLabel = isMindfulness ? 'mindfulness' : 'mins';

    const dayLogs = this.data.logs.filter(l => l.date === dateStr);
    const goalStats = {};

    dayLogs.forEach(log => {
        // N·∫øu ƒëang xem mode ch√°nh ni·ªám, ch·ªâ l·∫•y log c√≥ s·ªë li·ªáu ƒë√≥
        if (isMindfulness) {
             const val = log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0);
             if (val === 0) return;
        }

        if(!goalStats[log.goalId]) {
            const goal = this.data.goals.find(g => g.id === log.goalId);
            goalStats[log.goalId] = { 
                name: goal ? goal.name : 'ƒê√£ x√≥a', 
                color: goal ? goal.color : '#ccc', 
                value: 0 
            };
        }
        
        if (isMindfulness) {
            goalStats[log.goalId].value += (log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0));
        } else {
            goalStats[log.goalId].value += log.minutes;
        }
    });

    if(this.charts.dayChart) this.charts.dayChart.destroy();
    
    const dataValues = Object.values(goalStats).map(s => s.value);

    this.charts.dayChart = new Chart(ctx, {
        type: 'doughnut',
        data: { 
            labels: Object.values(goalStats).map(s => s.name), 
            datasets: [{ 
                data: dataValues, 
                backgroundColor: Object.values(goalStats).map(s => s.color), 
                borderWidth: 1, 
                borderColor: '#1f2937' 
            }] 
        },
        options: { 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { position: 'right', labels: { color: '#9ca3af', font: {size: 11} } },
                title: { 
                    display: dataValues.length === 0, 
                    text: isMindfulness ? 'No data' : 'No data', 
                    position: 'bottom', 
                    color: '#6b7280' 
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return ` ${context.raw} ${unitLabel}`;
                        }
                    }
                }
            } 
        }
    });
}
            closeDayModal() { document.getElementById('day-details-modal').style.display = 'none'; }
setReportMode(mode) {
    this.reportMode = mode;
    
    // C·∫≠p nh·∫≠t giao di·ªán n√∫t b·∫•m
    const btnTime = document.getElementById('btn-rep-time');
    const btnMind = document.getElementById('btn-rep-mind');
    
    if (mode === 'time') {
        btnTime.className = 'btn'; // Active styling
        btnMind.className = 'btn btn-secondary';
    } else {
        btnTime.className = 'btn btn-secondary';
        btnMind.className = 'btn'; // Active styling (s·∫Ω l·∫•y m√†u primary)
    }

    this.renderReports();
}
            // --- REPORTING LOGIC ---
renderReports() {
    if(!document.getElementById('weeklyChart')) return;
    
    const isMindfulness = this.reportMode === 'mindfulness';
    const unitLabel = isMindfulness ? 'Mindfulness' : 'Minutes';
    
    // Update Breakdown Title
    document.getElementById('breakdown-title').innerText = isMindfulness ? 'Mindfulness Chart' : 'Time Chart';

    // 1. Setup Week Boundaries (Local Time)
    // weekStart is already set to Monday 00:00:00 by getStartOfWeek
    const weekStartMs = this.currentWeekStart.getTime();
    // weekEnd is exactly 7 days later
    const weekEndMs = weekStartMs + (7 * 24 * 60 * 60 * 1000);

    // Update Week Title UI
    const weekEndDisp = new Date(weekEndMs - 1); // Display Sunday date
    document.getElementById('weekly-report-title').innerText = `Week (${this.currentWeekStart.toLocaleDateString('en-GB', {month:'numeric', day:'numeric'})} - ${weekEndDisp.toLocaleDateString('en-GB', {month:'numeric', day:'numeric'})})`;
    
    // Setup Month Boundaries
    const mYear = this.currentMonth.getFullYear();
    const mMonth = this.currentMonth.getMonth();
    const monthlyLabels = Array.from({length: new Date(mYear, mMonth + 1, 0).getDate()}, (_, i) => i + 1);
    document.getElementById('monthly-report-title').innerText = `Month ${new Date(mYear, mMonth).toLocaleDateString('en-GB', { month: 'numeric', year: 'numeric' })}`;

    const goalDatasets = {};
    const weekDays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    
    // Initialize Datasets
    this.data.goals.forEach(goal => { 
        if (isMindfulness && goal.type !== 'meditation') return;

        goalDatasets[goal.id] = { 
            name: goal.name, 
            color: goal.color, 
            total: 0, 
            weekly: new Array(7).fill(0),
            monthly: new Array(monthlyLabels.length).fill(0) 
        }; 
    });
    
    // PROCESS LOGS
    this.data.logs.forEach(log => {
        if(!goalDatasets[log.goalId]) return;

        // Get value based on mode
        let value = 0;
        if (isMindfulness) {
            value = log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0);
        } else {
            value = log.minutes;
        }

        goalDatasets[log.goalId].total += value;
        
        // Use exact timestamp for accurate comparison
        // Fallback to date string parsing if timestamp is missing (old data compatibility)
        let logTime = log.timestamp;
        let logDateObj;
        
        if (!logTime) {
             // Compatibility fix for very old data without timestamps
             logDateObj = new Date(log.date); 
             logTime = logDateObj.getTime();
        } else {
             logDateObj = new Date(logTime);
        }
        
        // --- WEEKLY LOGIC FIXED ---
        // Check if log is strictly within the 7-day window
        if(logTime >= weekStartMs && logTime < weekEndMs) { 
            let dayIdx = logDateObj.getDay();
            // Convert Sunday(0) to 6, Mon(1) to 0, etc.
            dayIdx = (dayIdx === 0 ? 6 : dayIdx - 1);
            goalDatasets[log.goalId].weekly[dayIdx] += value; 
        }
        
        // --- MONTHLY LOGIC ---
        // Check year and month matches current view
        if(logDateObj.getFullYear() === mYear && logDateObj.getMonth() === mMonth) {
            goalDatasets[log.goalId].monthly[logDateObj.getDate() - 1] += value;
        }
    });
    
    const activeGoals = Object.values(goalDatasets).filter(d => d.total > 0);
    
    // CHART CONFIGURATION
    const commonOptions = { 
        maintainAspectRatio: false, 
        scales: { 
            x: {stacked: true, grid:{color:'#374151'}}, 
            y: {
                stacked: true, 
                grid:{color:'#374151'},
                title: { display: true, text: unitLabel } 
            } 
        }, 
        plugins: {
            legend:{labels:{color:'#9ca3af'}},
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': ' + context.raw + ' ' + unitLabel;
                    }
                }
            }
        } 
    };
    
    // 1. Breakdown Chart (Doughnut)
    const ctxBreakdown = document.getElementById('goalBreakdownChart').getContext('2d');
    if(this.charts.breakdown) this.charts.breakdown.destroy();

    this.charts.breakdown = new Chart(ctxBreakdown, { 
        type: 'doughnut', 
        data: { 
            labels: activeGoals.map(d => d.name), 
            datasets: [{ 
                data: activeGoals.map(d => d.total), 
                backgroundColor: activeGoals.map(d => d.color), 
                borderWidth: 1, 
                borderColor: '#1f2937' 
            }] 
        }, 
        options: { 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { labels: { color: '#9ca3af' } },
                title: { 
                    display: activeGoals.length === 0, 
                    text: 'No data available', 
                    position: 'bottom', 
                    color: '#6b7280' 
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw || 0;
                           return ` ${value} ${unitLabel}`;
                        }
                    }
                }
            } 
        } 
    });
    
    // 2. Weekly Chart
    const ctxWeek = document.getElementById('weeklyChart').getContext('2d');
    if(this.charts.weekly) this.charts.weekly.destroy();
    this.charts.weekly = new Chart(ctxWeek, { 
        type: 'bar', 
        data: { 
            labels: weekDays, 
            datasets: activeGoals.map(g => ({ label: g.name, data: g.weekly, backgroundColor: g.color, stack: '0' })) 
        }, 
        options: commonOptions 
    });
    
    // 3. Monthly Chart
    const ctxMonth = document.getElementById('monthlyChart').getContext('2d');
    if(this.charts.monthly) this.charts.monthly.destroy();
    this.charts.monthly = new Chart(ctxMonth, { 
        type: 'bar', 
        data: { 
            labels: monthlyLabels, 
            datasets: activeGoals.map(g => ({ label: g.name, data: g.monthly, backgroundColor: g.color, stack: '0' })) 
        }, 
        options: commonOptions 
    });
}

changeReportWeek(dir) { this.currentWeekStart.setDate(this.currentWeekStart.getDate() + (dir * 7)); this.renderReports(); }
            changeReportMonth(dir) { this.currentMonth.setMonth(this.currentMonth.getMonth() + dir); this.renderReports(); }
            changeMonth(dir) { this.currentMonth.setMonth(this.currentMonth.getMonth() + dir); this.renderCalendar(); }
            
            // REPLACE THIS BLOCK INSIDE updateStats()
updateStats() {
    this.recalculateStreak();

    // 1. Calculate total mindfulness
    const totalMindfulness = this.data.logs.reduce((sum, log) => {
        // Fix: Check for manual 'count' first, fallback to 'touches' length
        return sum + (log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0));
    }, 0);

    // 2. Update data
    this.data.xp = totalMindfulness; 

    // 3. Display on UI
    document.getElementById('streak-disp').innerText = `${this.data.streak} üî•`;
    document.getElementById('xp-disp').innerText = `${this.data.xp} Sati`;
    document.getElementById('level-disp').innerText = Math.floor(this.data.xp / 1000) + 1;

    // ... (keep the rest of the function: daily goal calculation etc.) ...
    const todayStr = this.toIsoDate(new Date());
    let totalTodayMins = this.data.logs.filter(l => l.date === todayStr).reduce((sum, l) => sum + l.minutes, 0);
    this.data.goals.forEach(g => {
        if (g.isActive && g.type !== 'meditation') {
            const spent = g.sessionTargetSeconds - g.remainingSeconds;
            totalTodayMins += Math.floor(spent / 60);
        }
    });
    const globalTarget = this.data.globalDailyGoal || 120;
    const dailyPct = Math.min((totalTodayMins / globalTarget) * 100, 100);
    document.getElementById('daily-current').innerText = totalTodayMins;
    document.getElementById('daily-target').innerText = globalTarget;
    document.getElementById('daily-bar-fill').style.width = `${dailyPct}%`;
}
            
            recalculateStreak() {
                const activeDates = [...new Set(this.data.logs.filter(l => l.minutes > 0).map(l => l.date))].sort();
                if (activeDates.length === 0) { this.data.streak = 0; return; }
                let streak = 1;
                for (let i = activeDates.length - 2; i >= 0; i--) {
                    const prev = new Date(activeDates[i]);
                    const next = new Date(activeDates[i + 1]);
                    if ((next - prev) < (1000 * 60 * 60 * 48) && (next - prev) > 0) streak++; else break;
                }
                const now = new Date(this.today.getFullYear(), this.today.getMonth(), this.today.getDate());
                const last = new Date(activeDates[activeDates.length - 1]);
                if ((now - last) / (1000 * 60 * 60 * 24) > 1) this.data.streak = 0; else this.data.streak = streak;
            }

            checkAchievements() {
                const list = [
    { id: 'streak_3', title: 'Effort', desc: 'Practice for 3 consecutive days', condition: () => this.data.streak >= 3 },
    { id: 'streak_10', title: 'Striving', desc: 'Practice for 10 consecutive days', condition: () => this.data.streak >= 10 },
    { id: 'streak_30', title: 'Diligence', desc: 'Practice for 30 consecutive days', condition: () => this.data.streak >= 30 },
    { id: 'streak_60', title: 'Ardor', desc: 'Practice for 60 consecutive days', condition: () => this.data.streak >= 60 },
    { id: 'streak_120', title: 'Viriya', desc: 'Practice for 120 consecutive days', condition: () => this.data.streak >= 120 },
    { id: 'streak_365', title: 'Viriya-sambojjhanga', desc: 'Practice for 365 consecutive days', condition: () => this.data.streak >= 365 },

    { id: 'beginner', title: 'Novice', desc: 'Accumulate 5,000 Mindfulness (Sati)', condition: () => this.totalMindfulnessCounts >= 5000 },
    { id: 'practitioner', title: 'Practitioner', desc: 'Accumulate 10,000 Mindfulness (Sati)', condition: () => this.totalMindfulnessCounts >= 10000 },
    { id: 'yogi', title: 'Yogi', desc: 'Accumulate 20,000 Mindfulness (Sati)', condition: () => this.totalMindfulnessCounts >= 20000 },
    { id: 'meditator', title: 'Meditator', desc: 'Accumulate 50,000 Mindfulness (Sati)', condition: () => this.totalMindfulnessCounts >= 50000 },
    { id: 'clear-mirror', title: 'Clear Mirror', desc: 'Accumulate 80.000 Mindfulness (Sati)', condition: () => this.totalMindfulnessCounts >= 80000 },
					{ id: 'still-lake', title: 'Still Lake', desc: 'Accumulate 100.000 Mindfulness (Sati)', condition: () => this.totalMindfulnessCounts >= 100000 },
					{ id: 'mountain', title: 'Mountain', desc: 'Accumulate 200.000 Mindfulness (Sati)', condition: () => this.totalMindfulnessCounts >= 200000 },
					{ id: 'morning-star', title: 'Morning Star', desc: 'Accumulate 300.000 Mindfulness (Sati)', condition: () => this.totalMindfulnessCounts >= 300000 },
					{ id: 'dhammaheir', title: 'Heir of the Dhamma', desc: 'Accumulate 500.000 Mindfulness (Sati)', condition: () => this.totalMindfulnessCounts >= 500000 },
					{ id: 'not-self', title: 'Awareness Itself', desc: 'Accumulate 1.000.000 Mindfulness (Sati)', condition: () => this.totalMindfulnessCounts >= 1000000 }
];
                const container = document.getElementById('achievement-list');
                if (!container) return; container.innerHTML = '';
                list.forEach(ach => {
                    const unlocked = this.data.achievements.includes(ach.id) || ach.condition();
                    if(unlocked && !this.data.achievements.includes(ach.id)) {
                        this.data.achievements.push(ach.id); this.showToast(`Unlocked: ${ach.title}`, true); this.save();
                    }
                    const div = document.createElement('div');
                    div.style.cssText = `padding: 15px; border: 1px solid ${unlocked ? 'var(--success)' : 'var(--border)'}; border-radius: 8px; background: ${unlocked ? 'rgba(16, 185, 129, 0.1)' : 'rgba(255,255,255,0.05)'}; display: flex; align-items: center; gap: 15px; opacity: ${unlocked ? 1 : 0.6}`;
                    div.innerHTML = `<div style="font-size: 24px; width: 40px; text-align: center;">${unlocked ? 'üèÜ' : 'üîí'}</div><div><div style="font-weight: bold; ${unlocked ? 'color: var(--text)' : 'color: var(--text-light)'}">${ach.title}</div><div style="font-size: 12px; color: var(--text-light);">${ach.desc}</div></div>`;
                    container.appendChild(div);
                });
            }

            formatTime(seconds) {
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = seconds % 60;
                return `${h > 0 ? h+':' : ''}${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            }
            toIsoDate(date) {
    const y = date.getFullYear();
    // Th√°ng trong JS b·∫Øt ƒë·∫ßu t·ª´ 0 n√™n ph·∫£i +1
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
}
            toDateTimeInput(timestamp) {
    const date = new Date(timestamp);
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    const hh = String(date.getHours()).padStart(2, '0');
    const mm = String(date.getMinutes()).padStart(2, '0');
    return `${y}-${m}-${d}T${hh}:${mm}`;
}
            toDisplayDate(timestamp) { const d = new Date(timestamp); return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`; }
            showToast(msg, isAchievement = false) {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                t.classList.remove('achievement'); if (isAchievement) t.classList.add('achievement');
                t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000);
            }
            
            switchView(viewName) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById(`view-${viewName}`).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                event.currentTarget.classList.add('active');
                
                const titles = {
                    'dashboard': 'Journal',
                    'calendar': 'Calendar',
                    'reports': 'Statistics',
					'analytics': 'Analytics',
                    'achievements': 'Achievements'
                };
                
                document.getElementById('page-title').innerText = titles[viewName] || 'Journal';
                if (viewName === 'reports') { this.renderReports(); }
                if (viewName === 'calendar') this.renderCalendar();
				if (viewName === 'analytics') this.renderAnalytics();
            }
            
            exportData() {
        // Added null, 2 for pretty printing so it looks better in the textarea
        const dataStr = JSON.stringify(this.data); 
        const modal = document.getElementById('backup-modal');
        
        modal.style.display = 'flex';
    }

    closeBackupModal() {
        document.getElementById('backup-modal').style.display = 'none';
    }

    // --- OPTION 1: FILE (PC) ---
    
    // Download .json file
     downloadFile() {
    const dataStr = JSON.stringify(this.data);

    // Check if Website2APK and shareIntent are available
    if (typeof Website2APK !== 'undefined' && Website2APK.shareIntent) {
        // Share JSON data instead of downloading
        Website2APK.shareIntent(dataStr, "Backup", "");
    } else {
        // Fallback: download as JSON file
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();

        // Cleanup
        setTimeout(() => {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }, 0);

        this.showToast('File downloaded successfully!');
    }
}

    // Handle file selection from computer
    handleFileUpload(inputElement) {
        const file = inputElement.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            // Pass file content to the common processing function
            this.processRestoreData(e.target.result);
        };
        reader.readAsText(file);
        
        // Reset input to allow selecting the same file again if needed
        inputElement.value = '';
    }

  
    // --- COMMON LOGIC ---
    processRestoreData(jsonString) {
        try {
            const json = JSON.parse(jsonString);
            
            // Basic validation
            if (!json.goals || !Array.isArray(json.goals) || !json.logs) {
                throw new Error("Invalid file structure (Missing goals/logs).");
            }

            if (confirm(`Found ${json.goals.length} goals and ${json.logs.length} logs.\nAre you sure you want to overwrite current data?`)) {
                localStorage.setItem('chronoData', JSON.stringify(json));
                location.reload(); // Reload page to apply changes
            }
        } catch (err) {
            alert("Restore error: " + err.message);
        }
    }
            resetApp() {
                if (confirm('Delete ALL data?')) { localStorage.removeItem('chronoData'); location.reload(); }
            }
			deleteSession() {
    const logId = document.getElementById('s-log-id').value;
    const goalId = document.getElementById('s-goal-id').value;

    if (!logId) return; // Safety check

    if (confirm('Permanently delete this session from history?')) {
        // 1. Find the log index
        const logIndex = this.data.logs.findIndex(l => l.timestamp == logId);
        if (logIndex === -1) return;
        
        const log = this.data.logs[logIndex];
        const goal = this.data.goals.find(g => g.id === goalId);

        // 2. Subtract stats from the goal totals
        if (goal) {
            goal.totalMinutes -= log.minutes;
            if (goal.totalMinutes < 0) goal.totalMinutes = 0;

            if (goal.type === 'meditation') {
                const count = log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0);
                goal.totalMindfulness -= count;
                if (goal.totalMindfulness < 0) goal.totalMindfulness = 0;
            }
        }

        // 3. Remove the log
        this.data.logs.splice(logIndex, 1);

        // 4. Save and Update UI
        this.save();
        this.renderGoals();      // Updates the list immediately
        this.renderCalendar();   // Updates calendar colors
        this.renderReports();    // Updates charts
        this.updateStats();      // Updates streaks/XP
        
        this.closeSessionModal();
        this.showToast('Session deleted!');
    }
}
            openSessionModal(goalId, minutes = 0, logId = null, startTime = Date.now()) {
    document.getElementById('session-modal').style.display = 'flex';
    document.getElementById('s-goal-id').value = goalId;
    document.getElementById('s-log-id').value = logId || '';
    document.getElementById('s-date').value = this.toDateTimeInput(startTime);
    document.getElementById('s-minutes').value = minutes;

    // --- NEW: Toggle Delete Button Visibility ---
    const deleteBtn = document.getElementById('btn-delete-session');
    if (logId) {
        deleteBtn.style.display = 'block'; // Show if editing
    } else {
        deleteBtn.style.display = 'none';  // Hide if new
    }
    // --------------------------------------------
    
    // ... (rest of your existing code for mindfulness check) ...
    const goal = this.data.goals.find(g => g.id === goalId);
    const mindGroup = document.getElementById('s-mindfulness-group');
    const mindInput = document.getElementById('s-mindfulness');
    
    if (goal && goal.type === 'meditation') {
        mindGroup.style.display = 'block';
        let currentCount = 0;
        if (logId) {
            const log = this.data.logs.find(l => l.timestamp == logId);
            if (log) currentCount = log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0);
        }
        mindInput.value = currentCount;
    } else {
        mindGroup.style.display = 'none';
        mindInput.value = 0;
    }

    let notes = ''; 
    if(logId) { 
        const log = this.data.logs.find(l => l.timestamp == logId); 
        if(log && log.notes) notes = log.notes; 
    }
    document.getElementById('s-notes').value = notes;
    document.getElementById('session-title').innerText = logId ? 'Update log' : 'Add log';
}
            closeSessionModal() { document.getElementById('session-modal').style.display = 'none'; }
            logSessionConfirm(e) {
    e.preventDefault();
    const goalId = document.getElementById('s-goal-id').value;
    const logId = document.getElementById('s-log-id').value;
    const dateTimeStr = document.getElementById('s-date').value;
    const minutes = parseInt(document.getElementById('s-minutes').value);
    
    // 1. Get Mindfulness and Raw Notes
    const mindfulness = parseInt(document.getElementById('s-mindfulness').value) || 0;
    let notes = document.getElementById('s-notes').value;
    
    if (minutes <= 0) return;
    
    const goal = this.data.goals.find(g => g.id === goalId);
    
    // --- NEW LOGIC: AUTO-FORMAT NOTES ---
    if (goal && goal.type === 'meditation') {
        // A. Remove any existing "Mindfulness: X" string (to prevent duplicates if editing)
        // Regex explains: Starts with "Ch√°nh ni·ªám:", followed by numbers, optional dot/space
        let cleanNotes = notes.replace(/^Mindfulness: \d+(\.\s*)?/, '').trim();
        
        // B. Add the new count if it's greater than 0
        if (mindfulness > 0) {
            notes = `Mindfulness: ${mindfulness}. ${cleanNotes}`;
        } else {
            notes = cleanNotes;
        }
        // Result example: "Ch√°nh ni·ªám: 10. C·∫£m th·∫•y b√¨nh an"
    }
    // ------------------------------------

    const dateObj = new Date(dateTimeStr);
    const timestamp = dateObj.getTime();
    const dateKey = dateTimeStr.split('T')[0]; 
    
    if (logId) {
        // --- EDIT EXISTING LOG ---
        const log = this.data.logs.find(l => l.timestamp == logId);
        if (log) {
            const oldMinutes = log.minutes;
            // Use saved count or fallback to touches length
            const oldMindfulness = log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0);
            
            log.minutes = minutes; 
            log.date = dateKey; 
            log.timestamp = timestamp; 
            log.notes = notes; // Save the formatted notes
            log.count = mindfulness;
            
            if (goal) {
                goal.totalMinutes += (minutes - oldMinutes);
                if (goal.type === 'meditation') {
                    if (!goal.totalMindfulness) goal.totalMindfulness = 0;
                    goal.totalMindfulness = goal.totalMindfulness - oldMindfulness + mindfulness;
                }
            }
        }
    } else {
        // --- CREATE NEW LOG ---
        this.data.logs.push({ 
            goalId, 
            date: dateKey, 
            timestamp, 
            minutes, 
            notes, // Save the formatted notes
            count: mindfulness, 
            touches: [] 
        });
        
        if (goal) {
            goal.totalMinutes += minutes;
            if (goal.type === 'meditation') {
                if (!goal.totalMindfulness) goal.totalMindfulness = 0;
                goal.totalMindfulness += mindfulness;
            }
        }
    }
    
    this.save(); 
    this.renderGoals(); 
    this.renderCalendar(); 
    this.renderReports(); 
    this.checkAchievements();
    this.closeSessionModal(); 
    this.showToast(logId ? 'Session Updated!' : 'Session Logged!');
}
            deleteGoal(id) {
    // 1. Update the confirmation message
    if(confirm('Delete this goal and ALL associated history? This action cannot be undone.')) {
        
        // 2. Remove the goal from the goals list
        this.data.goals = this.data.goals.filter(g => g.id !== id);
        
        // 3. Remove all logs associated with this goalId
        this.data.logs = this.data.logs.filter(log => log.goalId === id ? false : true);
        // Alternative shorter syntax: this.data.logs = this.data.logs.filter(log => log.goalId !== id);
        
        // 4. Save and refresh the UI components
        this.save(); 
        this.renderGoals(); 
        this.renderReports(); 
        this.renderCalendar(); // Refresh the calendar to remove dots/data for this goal
        
        this.showToast('Goal and history deleted!');
    }
}
            renderDate() {
                 document.getElementById('current-date').innerText = new Date().toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }
        }

        const app = new GoalTracker();
    </script>
</body>
</html>