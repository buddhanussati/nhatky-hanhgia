<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meditator's Journal</title>
    <link href="./css/css.css" rel="stylesheet">
 	<script src="chart.js"></script>
    
    <style>
        :root {
            /* --- DARK THEME PALETTE --- */
            --primary: #818cf8;       
            --primary-dark: #6366f1;
            --secondary: #f472b6;     
            --bg: #111827;            
            --surface: #1f2937;       
            --text: #f3f4f6;          
            --text-light: #9ca3af;    
            --border: #374151;        
            --success: #34d399;
            --warning: #fbbf24;
            --danger: #f87171;
            --zen: #a78bfa; /* Special color for meditation */
        }

        html { color-scheme: dark; } 

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }
        
        body { background-color: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* --- Sidebar --- */
        .sidebar {
            width: 80px;
            background: var(--surface);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            border-right: 1px solid var(--border);
            transition: width 0.3s;
            z-index: 50;
            flex-shrink: 0;
        }
        
        @media (min-width: 769px) {
            .sidebar:hover { width: 200px; }
            .sidebar:hover .nav-text { display: inline; opacity: 1; }
            .nav-item:hover, .nav-item.active { background-color: #374151; color: var(--primary); border-right: 3px solid var(--primary); }
        }
        
        .logo { font-size: 24px; color: var(--primary); margin-bottom: 40px; }
        
        .nav-item {
            width: 100%;
            padding: 15px 20px;
            cursor: pointer;
            color: var(--text-light);
            display: flex;
            align-items: center;
            transition: 0.2s;
            white-space: nowrap;
        }
        
        .nav-item i { font-size: 20px; min-width: 40px; text-align: center; }
        .nav-text { display: none; opacity: 0; transition: opacity 0.2s; margin-left: 10px; font-weight: 500;}

        /* --- Main Content --- */
        .main { flex: 1; overflow-y: auto; padding: 30px; position: relative; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px; }
        h1 { font-size: 24px; font-weight: 700; color: var(--text); }
        
        .btn {
            background: var(--primary);
            color: #111; 
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: 0.2s;
        }
        .btn:hover { background: var(--primary-dark); transform: translateY(-1px); color: white; }
        .btn-secondary { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }

        /* --- Gamification Bar --- */
        .user-stats {
            display: flex;
            gap: 20px;
            background: var(--surface);
            padding: 10px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            align-items: center;
            border: 1px solid var(--border);
        }
        .stat-item { display: flex; flex-direction: column; align-items: center; }
        .stat-val { font-weight: bold; font-size: 14px; }
        .stat-label { font-size: 10px; color: var(--text-light); text-transform: uppercase; }
        
        .stat-item.clickable { cursor: pointer; transition: 0.2s; }
        .stat-item.clickable:hover { opacity: 0.7; }
        .daily-bar-bg { width: 60px; height: 4px; background: #374151; border-radius: 2px; margin-top: 2px; overflow: hidden;}
        .daily-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s ease; }
        .daily-bar-fill.complete { background: var(--success); }

        /* --- Views --- */
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Dashboard Grid --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .card { background: var(--surface); padding: 20px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2); }
        
        /* Goal Cards */
        .goal-card { position: relative; overflow: hidden; border-left: 5px solid var(--primary); display: flex; flex-direction: column; }
        .goal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .goal-title { font-weight: 600; font-size: 18px; }
        .goal-tag { font-size: 12px; background: rgba(99, 102, 241, 0.2); color: var(--primary); padding: 2px 8px; border-radius: 10px; }
        
        .section-label { font-size: 11px; text-transform: uppercase; color: var(--text-light); font-weight: 700; margin-bottom: 5px; letter-spacing: 0.5px; }
        
        .progress-container { height: 8px; background: #374151; border-radius: 4px; margin: 0 0 5px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--secondary); width: 0%; transition: width 0.5s ease; } 
        
        .timer-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);}
        .timer-display { font-family: monospace; font-size: 20px; font-weight: 700; color: var(--text); }
        .btn-icon { width: 36px; height: 36px; border-radius: 50%; border: none; cursor: pointer; display: grid; place-items: center; color: white; transition: 0.2s;}
        .btn-play { background: var(--success); color: #000; }
        .btn-stop { background: var(--secondary); }
        .btn-play:hover { transform: scale(1.1); }

        /* Session List */
        .sessions-list ol { list-style: none; counter-reset: session-counter; padding: 0; }
        .session-item {
            display: flex; justify-content: space-between; align-items: flex-start;
            padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 12px; counter-increment: session-counter;
        }
        .session-item::before { content: counter(session-counter) "."; font-weight: bold; color: var(--primary); margin-right: 8px; min-width: 15px; }
        .session-content { flex: 1; }
        .session-date { font-weight: 600; color: var(--text); }
        .session-notes { color: var(--text-light); font-style: italic; margin-top: 2px; display: block;}

       /* --- Calendar --- */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 20px; }
        
        /* New Header for Weekdays */
        .calendar-header {
            display: contents; /* Allows children to sit in the main grid */
        }
        .cal-head-day {
            text-align: center; font-size: 11px; color: var(--text-light); font-weight: bold; padding-bottom: 5px;
        }

        .calendar-day { 
            aspect-ratio: 1; background: var(--bg); border-radius: 4px; 
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; cursor: pointer; position: relative; border: 1px solid var(--border);
            color: var(--text-light);
        }
                    /* Level 1-5: The Foundation (Indigo spectrum) */
.calendar-day.level-1 { background: rgba(99, 102, 241, 0.3); border-color: rgba(99, 102, 241, 0.3); color: white; } 
.calendar-day.level-2 { background: rgba(99, 102, 241, 0.6); border-color: rgba(99, 102, 241, 0.5); color: white; } 
.calendar-day.level-3 { background: rgba(99, 102, 241, 1); border-color: var(--primary); color: white; } 
 .calendar-day.level-4 { 
 
background: #4d5eff ; 
    border: 1px solid rgba(255,255,255,0.2);
    color: white; 
}
.calendar-day.level-5 
{ background: var(--primary); border-color: var(--primary-dark); color: white; } 

.calendar-day.level-6 { 
background:  linear-gradient(135deg, var(--primary), #a78bfa);    box-shadow: inset 0 0 8px rgba(255,255,255,0.3);  border: 1px solid rgba(255,255,255,0.2);
	    color: white; 
			border-color: gold;
box-shadow: 0 0 20px #ffffff, 0 0 40px var(--primary);	}

/* Level 7: Right Mindfulness (Deep Royal Purple with a Soft Glow) */
.calendar-day.level-7 { 
background: linear-gradient(135deg, #a78bfa, #f472b6);
    border: 1px solid rgba(255,255,255,0.4);
box-shadow: 0 0 20px #ffffff, 0 0 40px var(--primary);	    color: white; 

border-color: rgba(251, 191, 36, 1);

}

/* Level 8: Right Concentration (Golden/Sunlight - The Peak) */
.calendar-day.level-8 { 
    background: linear-gradient(135deg, #6d28d9, #8b5cf6);
    border: 1px solid #a78bfa;
	color: white; 
    box-shadow: 0 0 12px rgba(139, 92, 246, 0.6);
	border-color: gold;
	animation: pulse-gold 2s infinite;
}


@keyframes pulse-gold {
    0% { transform: scale(1); }
    50% { box-shadow: 0 0 25px rgba(251, 191, 36, 1); }
    100% { transform: scale(1); }
}
        .calendar-day:hover { transform: scale(1.1); z-index: 2; box-shadow: 0 0 10px var(--primary); border: 1px solid white; }

        /* --- Modal & Inputs --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 100;
            backdrop-filter: blur(2px);
        }
        .modal-content { background: var(--surface); padding: 30px; border-radius: 16px; width: 400px; max-width: 90%; border: 1px solid var(--border); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-light); }
        
        .form-control { 
            width: 100%; padding: 10px; 
            background: var(--bg); color: var(--text);
            border: 1px solid var(--border); border-radius: 8px; 
        }
        .form-control:focus { outline: none; border-color: var(--primary); }
        input[type="color"].form-control { padding: 5px; height: 45px; cursor: pointer; }
        textarea.form-control { resize: vertical; min-height: 60px; }
  /* Style m·∫∑c ƒë·ªãnh cho ƒëi·ªán tho·∫°i (m√†n h√¨nh nh·ªè) */
.med-quote-box {
    position: absolute;
    top: 13%; 
    width: 80%;
    text-align: center;
    pointer-events: none;
    opacity: 0;
    transition: opacity 1s ease-in-out;
	color: #e5e7eb;
}

/* Cho m√†n h√¨nh l·ªõn h∆°n 768px (Tablet, Laptop, Desktop) */
@media (min-width: 768px) {
    .med-quote-box {
        top: 8%;
		color: #b8bdc6;
    }
}  
        /* --- Toast --- */
        .toast {
            position: fixed; bottom: 80px; right: 20px; left: 20px;
            background: #373d49; color: white; padding: 12px 24px; border-radius: 8px;
            transform: translateY(200px); transition: transform 0.3s; z-index: 200;
            display: flex; align-items: center; gap: 10px; pointer-events: none;
        }
        .toast.show { transform: translateY(0); }
        .toast.achievement { background: var(--warning); color: #000; }

        /* --- Empty State --- */
        .empty-state { text-align: center; padding: 20px; color: var(--text-light); }

        /* --- Choice Modal --- */
        .choice-btn-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .choice-card {
            background: var(--bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border);
            text-align: center; cursor: pointer; transition: 0.2s;
        }
        .choice-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .choice-card i { font-size: 30px; margin-bottom: 10px; display: block; }

        /* --- Meditation Overlay --- */
        #meditation-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; z-index: 999; display: none;
            flex-direction: column; justify-content: center; align-items: center;
            user-select: none; touch-action: manipulation;
        }
        .meditation-circle {
            width: 150px; height: 150px; border-radius: 50%;
            background: radial-gradient(circle, #818cf8 0%, transparent 70%);
            display: flex; justify-content: center; align-items: center;
            font-size: 50px; font-weight: bold; color: white;
            pointer-events: none; /* Let clicks pass through to container */
        }

        .med-controls { position: absolute; top: 20px; right: 20px; display: flex; gap: 15px; z-index: 1000; }
        .med-timer-disp { position: absolute; top: 20px; left: 20px; font-size: 24px; font-family: monospace; color: #9ca3af; z-index: 1000;}
        .med-instruction { position: absolute; bottom: 50px; color: #6b7280; font-size: 14px; text-transform: uppercase; letter-spacing: 2px;}

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar {
                width: 100%; height: 65px; position: fixed; bottom: 0; left: 0;
                flex-direction: row; justify-content: space-around; padding: 0;
                border-right: none; border-top: 1px solid var(--border);
                background-color: var(--surface); box-shadow: 0 -4px 10px rgba(0,0,0,0.3);
                overflow-y: auto; min-height: 0;
            }
            .sidebar:hover { width: 100%; }
            .logo { display: none; }
            .nav-item { flex-direction: column; justify-content: center; padding: 5px; font-size: 10px; height: 100%; min-width: 60px; }
            .nav-item i { font-size: 18px; margin-bottom: 3px; }
            .nav-text { display: block; opacity: 1; margin-left: 0; font-size: 10px; }
            .nav-item.active { border-right: none; border-top: 3px solid var(--primary); background: transparent; color: var(--primary); }
            .main { padding: 15px; padding-bottom: 90px; }
            header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .user-stats { width: 100%; padding: 15px; flex-wrap: wrap; justify-content: space-between; }
            .user-stats .btn { width: 100%; margin-top: 10px; justify-content: center; background-color: var(--primary); color: #000; }
            .dashboard-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<nav class="sidebar">
        <div class="logo"><i class="fas fa-hourglass-half"></i></div>
        <div class="nav-item active" onclick="app.switchView('dashboard')">
            <i class="fas fa-spa"></i><span class="nav-text">Journal</span>
        </div>
        <div class="nav-item" onclick="app.switchView('calendar')">
            <i class="fas fa-calendar-alt"></i><span class="nav-text">Calendar</span>
        </div>
        <div class="nav-item" onclick="app.switchView('reports')">
            <i class="fas fa-chart-pie"></i><span class="nav-text">Statistics</span>
        </div>
		<div class="nav-item" onclick="app.switchView('analytics')">
    <i class="fas fa-microscope"></i><span class="nav-text">Analytics</span>
</div>
        <div class="nav-item" onclick="app.switchView('achievements')">
            <i class="fas fa-trophy"></i><span class="nav-text">Achieve</span>
        </div>
        
        <div style="margin-top: auto;" class="desktop-only"></div>
        
        <div class="nav-item" onclick="app.exportData()">
    <i class="fas fa-save"></i><span class="nav-text">Backup</span>
</div>

        <div class="nav-item" onclick="app.resetApp()" style="color: var(--danger);"> <i class="fas fa-trash-alt"></i><span class="nav-text">Reset</span>
        </div>
    </nav>


    <main class="main">
        <header>
            <div>
                <h1 id="page-title">Meditator's Journal</h1>
                <p style="color: var(--text-light); font-size: 14px;" id="current-date"></p>
            </div>
            
            <div class="user-stats">
                <div class="stat-item clickable" onclick="app.setGlobalDailyGoal()" title="Click to edit total daily goal">
                    <span class="stat-val"><span id="daily-current">0</span> / <span id="daily-target">60</span>m</span>
                    <div class="daily-bar-bg"><div id="daily-bar-fill" class="daily-bar-fill"></div></div>
                    <span class="stat-label">Daily Goal</span>
                </div>
                <div class="stat-item">
                    <span class="stat-val" id="streak-disp">0 üî•</span>
                    <span class="stat-label">Streak</span>
                </div>
                <div class="stat-item">
                    <span class="stat-val" id="xp-disp">0 XP</span>
                    <span class="stat-label">Level <span id="level-disp">1</span></span>
                </div>
				 <div class="stat-item clickable" onclick="app.openIntroModal()">
    <span class="stat-val" style="
        border: 2px solid var(--text-light); 
        border-radius: 50%; 
        width: 24px; 
        height: 24px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        font-size: 14px;">?</span>
</div>
                <button class="btn" onclick="app.openChoiceModal()">
                    <i class="fas fa-plus"></i> New Goal
                </button>
            </div>
        </header>

        <section id="view-dashboard" class="view-section active">
            <div id="active-goals-container" class="dashboard-grid"></div>
            <div id="empty-msg" class="empty-state" style="display:none;">
                <i class="fas fa-clipboard-list" style="font-size: 40px; margin-bottom: 10px;"></i>
                <p>No active goals. Create one to start tracking!</p>
            </div>
        </section>

        <section id="view-calendar" class="view-section">
            <div class="card">
                <h2>Activity Calendar</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
                    <button class="btn btn-secondary" onclick="app.changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="cal-month-year">Month Year</h3>
                    <button class="btn btn-secondary" onclick="app.changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-grid" id="calendar-grid"></div>
            </div>
        </section>

        <section id="view-reports" class="view-section">
    <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 25px;">
        <button class="btn" id="btn-rep-time" onclick="app.setReportMode('time')">
            <i class="fas fa-clock"></i> Time
        </button>
        <button class="btn btn-secondary" id="btn-rep-mind" onclick="app.setReportMode('mindfulness')">
            <i class="fas fa-spa"></i> Mindfulness
        </button>
    </div>

    <div class="dashboard-grid" style="grid-template-columns: 1fr;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
            <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 id="breakdown-title" style="margin: 0;">Time</h3>
        
        <select id="report-range-select" class="form-control" style="width: auto; padding: 5px; font-size: 13px; height: 32px;" onchange="app.renderReports()">
            <option value="all">All Time</option>
            <option value="today">Today</option>
            <option value="this_week" selected>This Week</option>
            <option value="last_week">Last Week</option>
            <option value="this_month">This Month</option>
            <option value="last_month">Last Month</option>
        </select>
    </div>
    
    <div style="height: 300px; display:flex; justify-content:center;">
        <canvas id="goalBreakdownChart"></canvas>
    </div>
</div>
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <button class="btn btn-secondary" style="padding: 5px 10px;" onclick="app.changeReportWeek(-1)"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="weekly-report-title">Weekly Focus</h3>
                    <button class="btn btn-secondary" style="padding: 5px 10px;" onclick="app.changeReportWeek(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div style="height: 300px;">
                    <canvas id="weeklyChart"></canvas>
                </div>
            </div>
            </div>
            
            <div class="card" style="margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <button class="btn btn-secondary" style="padding: 5px 10px;" onclick="app.changeReportMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                <h3 id="monthly-report-title">Monthly Focus</h3>
                <button class="btn btn-secondary" style="padding: 5px 10px;" onclick="app.changeReportMonth(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div style="height: 300px;">
                <canvas id="monthlyChart"></canvas>
            </div>
        </div>
    </div>
</section>
<section id="view-analytics" class="view-section">
     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
    <h2 style="margin: 0;">Meditation Analytics</h2>
     <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <select id="ana-goal-select" class="form-control" style="width: auto; min-width: 150px;" onchange="app.renderAnalytics()">
                </select>
   <div id="threshold-config" style="display: flex; align-items: center; gap: 5px; background: var(--surface); padding: 5px 12px; border-radius: 20px; border: 1px solid var(--border);">
    <span style="font-size: 12px; color: var(--text-light); white-space: nowrap;">
        <i class="fas fa-stopwatch"></i> Distraction threshold:
    </span>
    <input type="number" id="ana-threshold" 
           style="width: 45px; 
                  background: rgba(17, 24, 39,0.7); 
                  border: 1px solid var(--border); 
                  border-radius: 4px; 
                  color: var(--primary); 
                  font-weight: bold; 
                  text-align: center; 
                  outline: none;
                  cursor: pointer;" 
           value="12" min="1" onchange="app.saveThreshold(this.value)">
    <span style="font-size: 11px; color: var(--text-light);">secs</span>
</div>

        <select id="ana-time-range" class="form-control" style="width: auto;" onchange="app.renderAnalytics()">
            <option value="7" selected>Last 7 days</option>
            <option value="30">Last 30 days</option>
            <option value="90">Last 3 months</option>
            <option value="365">All time</option>
        </select>
    </div>
</div>
    <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 20px;">
        <div class="card" style="text-align: center; border-left: 4px solid var(--zen);">
            <div style="font-size: 12px; color: var(--text-light); text-transform: uppercase;">Average Quality</div>
            <div style="font-size: 28px; font-weight: bold; margin: 5px 0;" id="ana-avg-quality">0%</div>
            <div style="font-size: 11px; color: var(--text-light);">Mindfulness / Time Ratio</div>
        </div>
        <div class="card" style="text-align: center; border-left: 4px solid var(--primary);">
            <div style="font-size: 12px; color: var(--text-light); text-transform: uppercase;">Mindfulness Quality</div>
            <div style="font-size: 28px; font-weight: bold; margin: 5px 0;" id="ana-avg-density">0</div>
            <div style="font-size: 11px; color: var(--text-light);">Mindfulness per minute</div>
        </div>
        <div class="card" style="text-align: center; border-left: 4px solid var(--danger);">
            <div style="font-size: 12px; color: var(--text-light); text-transform: uppercase;">Total Mindfulness</div>
            <div style="font-size: 28px; font-weight: bold; margin: 5px 0;" id="ana-total-mindful">0h</div>
            <div style="font-size: 11px; color: var(--text-light);">Focused Time</div>
        </div>
    </div>

    <div class="dashboard-grid" style="grid-template-columns: 1fr; gap: 20px;">
        <div class="card">
            <h3>üìà Mindfulness Trend</h3>
            <p style="font-size: 12px; color: var(--text-light); margin-bottom: 15px;">Tracking mindfulness ratio across recent sessions.</p>
            <div style="height: 300px;">
                <canvas id="analyticsTrendChart"></canvas>
            </div>
        </div>

        <div class="card">
  <h3>üìä Performance Comparison</h3>
  <div style="margin-top: 15px;">
    <table style="width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed;">
      <thead>
        <tr style="border-bottom: 2px solid var(--border); color: var(--text-light);">
          <th style="text-align: left; padding: 10px;">Period</th>
          <th style="text-align: center; padding: 10px;">Session</th>
          <th style="text-align: center; padding: 10px;">Total Hours</th>
          <th style="text-align: center; padding: 10px;">Quality</th>
          <th style="text-align: center; padding: 10px;">Mindful per min</th>
        </tr>
      </thead>
      <tbody id="ana-comparison-table">
      </tbody>
    </table>
  </div>
</div>

    </div>
</section>
        <section id="view-achievements" class="view-section">
            <div class="card">
                <h2><i class="fas fa-medal"></i> Achievements</h2>
                <div id="achievement-list" style="margin-top: 20px; display: grid; gap: 10px;"></div>
            </div>
        </section>
    </main>

    <div class="modal" id="choice-modal">
        <div class="modal-content">
            <h2 style="text-align:center;">Choose Goal Type</h2>
            <div class="choice-btn-container">
                <div class="choice-card" onclick="app.openModal(null, 'meditation')">
                    <i class="fas fa-spa" style="color: var(--zen);"></i>
                    <h3>Meditate</h3>
                    <p style="font-size:12px; color:var(--text-light); margin-top:5px;">Track Mindfulness</p>
                </div>
                <div class="choice-card" onclick="app.openModal(null, 'standard')">
                    <i class="fas fa-tasks" style="color: var(--primary);"></i>
                    <h3>Activity</h3>
                    <p style="font-size:12px; color:var(--text-light); margin-top:5px;">Track Progress</p>
                </div>
            </div>
            <button class="btn btn-secondary" style="width:100%; margin-top:20px;" onclick="app.closeChoiceModal()">Cancel</button>
        </div>
    </div>

    <div class="modal" id="goal-modal">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-bottom: 20px;">Create New Goal</h2>
            <form onsubmit="app.saveGoal(event)">
                <input type="hidden" id="g-id"> 
                <input type="hidden" id="g-type"> 
                
                <div class="form-group">
                    <label>Goal Name</label>
                    <input type="text" id="g-name" class="form-control" required>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="g-cat" class="form-control">
                            </select>
                    </div>
                    <div class="form-group">
                        <label>Color</label>
                        <input type="color" id="g-color" class="form-control" value="#6366f1">
                    </div>
                </div>
                
                <div class="form-group" style="background: rgba(16, 185, 129, 0.1); padding: 10px; border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.3);">
                    <label style="color: var(--success);">Daily Target</label>
                    <input type="number" id="g-daily-target" class="form-control" min="0" value="30">
                    <small id="g-daily-hint" style="color: var(--success); font-size: 11px;">Minutes per day</small>
                </div>
                
                <div class="form-group">
                    <label>Achieve in</label>
                    <input type="number" id="g-lifetime-target" class="form-control" required min="1" value="1000">
                    <small id="g-life-hint" style="color: var(--text-light); font-size: 11px;">Minutes</small>
                </div>
                
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal()">Cancel</button>
                    <button type="submit" class="btn" id="btn-save-goal">Create Goal</button>
                </div>
            </form>
        </div>
    </div>
<div class="modal" id="backup-modal">
    <div class="modal-content">
        <h2 style="margin-bottom: 10px; text-align: center;">Back up & Restore</h2>
        
        <div class="desktop-actions" style="margin-bottom: 20px;">
            <p style="color: var(--text-light); text-align: center; font-size: 12px; margin-bottom: 10px;">
                <i class="fas fa-box-archive"></i> <strong>Backup & restore data from file:</strong>
            </p>
            <div style="display: flex;  justify-content: center; gap: 10px;">
                <button class="btn" style="flex: 1;" onclick="app.downloadFile()">
                    <i class="fas fa-download"></i> Backup
                </button>
                <button class="btn btn-secondary"; style="flex: 1;" onclick="document.getElementById('backup-file-input').click()">
                    <i class="fas fa-file-import"></i> Restore
                </button>
                <input type="file" id="backup-file-input" style="display: none;" accept=".json, .txt" onchange="app.handleFileUpload(this)">
            </div>
        </div>
<div style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
    
    <button class="btn btn-secondary" style="flex: 1;" onclick="app.shareBackup()">
        <i class="fas fa-share-alt"></i> Share
    </button>

    <button class="btn btn-secondary" style="flex: 1; border-color: var(--danger); color: var(--danger);" onclick="app.closeBackupModal()">
        Close
    </button>
</div>
</div></div>
    <div class="modal" id="session-modal">
    <div class="modal-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 id="session-title" style="margin: 0;">Log Session</h2>
            <button type="button" id="btn-delete-session" class="btn-icon" 
                style="background: transparent; color: var(--danger); display: none; width: 30px; height: 30px;" 
                onclick="app.deleteSession()"
                title="Delete this session">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <form onsubmit="app.logSessionConfirm(event)">
                <input type="hidden" id="s-goal-id" />
                <input type="hidden" id="s-log-id" />
                
                <div class="form-group">
                    <label>Start Date & Time</label>
                    <input type="datetime-local" id="s-date" class="form-control" required />
                </div>
                
                <div class="form-group">
                    <label>Duration (Minutes)</label>
                    <input type="number" id="s-minutes" class="form-control" required min="1" />
                </div>
<div class="form-group" id="s-mindfulness-group" style="display:none; background: rgba(167, 139, 250, 0.1); padding: 10px; border-radius: 8px; border: 1px solid rgba(167, 139, 250, 0.3);">
    <label style="color: var(--zen);">Mindfulness (Count)</label>
    <input type="number" id="s-mindfulness" class="form-control" min="0" value="0" />
</div>
                <div class="form-group">
                    <label>Notes (Optional)</label>
                    <textarea id="s-notes" class="form-control" placeholder="What did you focus on?"></textarea>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="app.closeSessionModal()">Cancel</button>
                    <button type="submit" class="btn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="meditation-overlay">
        <div class="med-timer-disp" id="med-timer">00:00</div>
        <div class="med-controls">
            <button class="btn btn-secondary" onclick="app.togglePauseMeditation()" id="med-pause-btn"><i class="fas fa-pause"></i></button>
            <button class="btn" style="background-color: var(--danger); color: white;" onclick="app.concludeMeditationSession()"><i class="fas fa-stop"></i></button>
        </div>
        <div id="med-quote-container" class="med-quote-box">
    <div id="med-quote-text" style="font-style: italic; font-size: 14px; margin-bottom: 8px; line-height: 1.4; text-shadow: 0 2px 4px rgba(0,0,0,0.8);"></div>
</div>
        <div class="meditation-circle" id="med-counter">0</div>
        
        <div class="med-instruction">Tap Screen for Mindfulness</div>
    </div>

    <div class="modal" id="meditation-finish-modal">
        <div class="modal-content">
            <h2 style="text-align: center; margin-bottom: 10px;">Session Complete üåø</h2>
            <div style="text-align:center; margin: 20px 0; display:flex; justify-content:space-around; align-items:center;">
                <div>
                    <div style="font-size: 30px; font-weight:bold; color:var(--zen)" id="med-finish-count">0</div>
                    <div style="color:var(--text-light); font-size:12px;">Mindful Moments</div>
                </div>
                <div style="height:40px; width:1px; background:var(--border);"></div>
                <div>
                    <div style="font-size: 30px; font-weight:bold; color:var(--text)" id="med-finish-time">0m</div>
                    <div style="color:var(--text-light); font-size:12px;">Time Spent</div>
                </div>
            </div>
            <div class="form-group">
                <label>Journal Notes</label>
                <textarea id="med-finish-notes" class="form-control" placeholder="Any insights or distractions?"></textarea>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
                 <button class="btn btn-secondary" onclick="app.discardMeditation()">Discard</button>
                 <button class="btn" style="background:var(--zen); color:white" onclick="app.saveMeditationLog()">Save to Journal</button>
            </div>
        </div>
    </div>

    <div class="modal" id="graph-modal" style="overflow-y: auto; z-index: 150;">
        <div class="modal-content" style="width: 600px;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 20px;">
                <div>
                    <h2 style="margin-bottom: 5px;">Meditation Session</h2>
                    <p id="graph-date" style="color: var(--text-light); font-size: 14px; margin: 0;"></p>
             </div>
               
            </div>

            <div style="height: 300px; width: 100%;">
                <canvas id="sessionGraph"></canvas>
            </div>
            
            <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
			 <button class="btn btn-secondary" id="btn-export-session" title="Copy JSON Data">
                    <i class="fas fa-file-code"></i>
                </button>
			<select id="graph-type-select" class="form-control" style="width: auto; padding: 5px 5px 5px; height: 36px; font-size: 13px; cursor: pointer;" onchange="app.updateSessionChart()">
			                    <option value="interval">‚òÅÔ∏è Distraction</option>
                    <option value="intensity">üå± Mindfulness</option>
                </select>
               <button class="btn btn-secondary" onclick="document.getElementById('graph-modal').style.display='none'" title="Close"><i class="fas fa-xmark"></i></button>
            </div>
        </div>
    </div>

    <div class="modal" id="day-details-modal" style="overflow-y: auto;">
    <div class="modal-content">
        <h2 id="day-modal-title" style="margin-bottom: 10px; font-size: 20px;">Day Details</h2>
        
        <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 15px;">
            <button class="btn" id="btn-modal-time" style="padding: 5px 15px; font-size: 12px;" onclick="app.switchDayChart('time')">
                <i class="fas fa-clock"></i> Time
            </button>
            <button class="btn btn-secondary" id="btn-modal-mind" style="padding: 5px 15px; font-size: 12px;" onclick="app.switchDayChart('mindfulness')">
                <i class="fas fa-spa"></i> Mindfulness
            </button>
        </div>

        <div style="height: 200px; position: relative; margin-bottom: 20px;">
            <canvas id="dayBreakdownChart"></canvas>
        </div>

        <h3 style="font-size: 14px; color: var(--text-light); border-bottom: 1px solid var(--border); padding-bottom: 5px; margin-bottom: 10px;">Activity Log</h3>
        <div id="day-session-list" style="max-height: 150px; overflow-y: auto;"></div>
        
        <div style="display: flex; justify-content: flex-end; margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px;">
            <button class="btn btn-secondary" onclick="app.closeDayModal()">Close</button>
        </div>
    </div>
</div>

    <div id="toast" class="toast">
        <i class="fas fa-info-circle"></i> <span id="toast-msg">Message</span>
    </div>
	<div class="modal" id="intro-modal" style="z-index: 9999;">
    <div class="modal-content" style="max-width: 800px; width: 95%; max-height: 90vh; display: flex; flex-direction: column; padding: 0;">
        
        <div style="padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--surface); border-radius: 16px 16px 0 0;">
            <h2 style="margin: 0;">‚ú® Meditator's Journal</h2>
            <button class="btn-icon" onclick="app.closeIntroModal()" style="color: var(--text-light); background: transparent;"><i class="fas fa-times"></i></button>
        </div>

        <div style="padding: 20px; overflow-y: auto; line-height: 1.6; color: var(--text-light);">
            
            <p><strong>Meditator's Journal</strong> is an application designed to support both spiritual practice and daily work. The app helps practitioners track progress in their professional tasks as well as meditation sessions, recording levels of awareness through "Mindfulness" counts, and visualizing mental states via real-time charts and graphs.</p>
            
            <img src="1en.png" alt="Graph Preview" style="width: 100%; border-radius: 8px; border: 1px solid var(--border); margin: 10px 0;">

            <h3 style="color: var(--text); margin-top: 20px;">‚ú® Core Concepts</h3>
            <p>To use the app effectively, you should understand the following indicators:</p>
            <ul style="padding-left: 20px; margin-bottom: 15px;">
                <li><strong>Mindfulness (Sati):</strong> A unit for measuring awareness. Every time you recognize your breath or mental state and touch the screen, one "Mindfulness" point is recorded.</li>
                <li><strong>Mindful State:</strong> A state where the frequency of recording (Sati) remains stable and regular.</li>
                <li><strong>Unmindful:</strong> A state where the mind is distracted or drowsy, resulting in few or no recordings over a period of time.</li>
                <li><strong>Diligence Streak:</strong> The number of consecutive days you have maintained your practice.</li>
            </ul>

            <h3 style="color: var(--text); margin-top: 20px;">‚ú® Key Features</h3>
            
            <h4 style="color: var(--primary);">1. Diverse Goal Management</h4>
            <ul style="padding-left: 20px;">
                <li><strong>Two main types of goals:</strong>
                    <ul>
                        <li><strong>‡•ê Meditation:</strong> Tracks meditation duration and counts mindfulness ("Sati") recognitions.</li>
                        <li><strong>‚ö° Work:</strong> A traditional countdown timer used for work, study (similar to Pomodoro), or other habits.</li>
                    </ul>
                </li>
                <li><strong>Customization:</strong> Set daily goals (minutes), target completion time, representative colors, and management categories.</li>
            </ul>

            <h4 style="color: var(--primary); margin-top: 15px;">2. Interactive Timer & Recording</h4>
            <ul style="padding-left: 20px;">
                <li><strong>Meditation Mode:</strong>
                    <ul>
                        <li><strong>Tap-to-Track:</strong> Touch the screen (or click) every time you acknowledge your focus returning to the breath. These counts accumulate as Mindfulness (Sati) points.</li>
                    </ul>
                </li>
            </ul>
            <div style="text-align: center; margin: 15px 0;">
                <img src="2en.png" alt="Meditation Mode" style="max-width: 300px; width: 100%; border-radius: 8px; border: 1px solid var(--border);">
            </div>
            <ul style="padding-left: 20px;">
                <li><strong>Focus Mode:</strong> A countdown timer with a visual progress bar.</li>
                <li><strong>Manual Entry:</strong> Forgot to start the timer? You can manually log a session or edit previous records.</li>
            </ul>

            <h4 style="color: var(--primary); margin-top: 15px;">3. Statistics & Data Analysis</h4>
            <ul style="padding-left: 20px;">
                <li><strong>Dashboard:</strong> View today's progress relative to your set goals.</li>
                <li><strong>Practice Calendar:</strong> A grid heatmap showing daily practice intensity. Darker colors represent longer practice durations.</li>
                <li><strong>Visual Charts:</strong>
                    <ul>
                        <li><strong>Session Graph:</strong> Review mindfulness levels <em>within a specific session</em> (line chart).</li>
                        <li><strong>Weekly/Monthly Statistics:</strong> Compare performance over real-time intervals.</li>
                        <li><strong>Distribution:</strong> A pie chart showing the percentage of time or mindfulness spent on different goals.</li>
                    </ul>
                </li>
            </ul>
<h4 style="color: var(--primary); margin-top: 15px;">4. Meditation Analytics (New)</h4>
<p>The <strong>"Analytics"</strong> tab helps you reflect on the quality of your mind during meditation sessions with higher precision.</p>
<ul style="padding-left: 20px;">
    <li><strong>Goal-specific analysis:</strong> You can view data for specific goals (e.g., "Sitting Meditation" or "Walking Meditation") to compare the progress of different practices.</li>
    
    <li style="margin-top: 10px;">
        <strong>Distraction Threshold:</strong>
        <p style="font-size: 13px; color: var(--text-light); margin-top: 5px;">
            This is the most important concept for calculating your "Meditation Quality."
        </p>
        <div style="background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 6px; border-left: 3px solid var(--warning); margin: 5px 0;">
            <em>"Distraction Threshold" is the maximum allowed gap between two mindfulness logs; if this time is exceeded, the system considers you were distracted.</em>
        </div>
        <ul style="margin-top: 5px;">
            <li><strong>How it works:</strong> For example, if you set the threshold to <strong>12 seconds</strong>:
                <ul>
                    <li>If you tap after <strong>5 seconds</strong>: The entire duration is counted as Mindful.</li>
                    <li>If you tap after <strong>20 seconds</strong>: The system calculates that you were distracted or drowsy for <strong>8 seconds</strong> (20 - 12 = 8).</li>
                </ul>
            </li>
            <li><strong>Individual Customization:</strong> Different practices require different paces. You can set a low threshold (e.g., 5s) for fast-noting exercises, or a higher threshold (e.g., 30s) for deep concentration. The system remembers these settings for each goal individually.</li>
        </ul>
    </li>
</ul>
            <h4 style="color: var(--primary); margin-top: 15px;">5. Privacy & Data Security</h4>
            <ul style="padding-left: 20px;">
                <li><strong>Fully Offline:</strong> 100% of data is stored directly in your browser. No data is sent to any server.</li>
                <li><strong>Backup & Restore:</strong> Easily export data to a <code>.json</code> file for safekeeping or to transfer to another device.</li>
            </ul>

            <hr style="border: 0; border-top: 1px solid var(--border); margin: 25px 0;">
            <h3 style="color: var(--text); margin-top: 20px;">üöÄ Usage Guide</h3>
            
            <strong style="display:block; margin-bottom:10px; color: var(--text);">1. Create a New Goal</strong>
            <ul style="padding-left: 20px; margin-bottom: 15px;">
                <li>Click the <strong>"New Goal"</strong> button on the main screen.</li>
                <li>Select the type: <strong>Meditation</strong> or <strong>Work</strong>.</li>
                <li>Enter a name, choose a color, and set the goal time (e.g., 30 mins/day).</li>
            </ul>

            <strong style="display:block; margin-bottom:10px; color: var(--text);">2. Start a Session</strong>
            <ul style="padding-left: 20px; margin-bottom: 15px;">
                <li>On the goal card, click the <strong>Play (‚ñ∂)</strong> button (for Work) or the <strong>‡•ê</strong> button (for Meditation).</li>
                <li><strong>During Meditation:</strong> Tap the screen whenever you find yourself mindfully returning to the meditation object.</li>
                <li>At the end of the session, a summary panel will appear for you to add journal notes.</li>
            </ul>

            <strong style="display:block; margin-bottom:10px; color: var(--text);">3. View Statistics</strong>
            <ul style="padding-left: 20px; margin-bottom: 15px;">
                <li>Select the <strong>"Statistics"</strong> tab on the sidebar to view charts.</li>
                <li>Select the <strong>"Calendar"</strong> tab to see your history.</li>
            </ul>

            <hr style="border: 0; border-top: 1px solid var(--border); margin: 25px 0;">
            <h3 style="color: var(--text); margin-top: 20px;">‚ú® Practice Achievement System</h3>
            
            <p><strong>Consistency Milestones (Streak):</strong></p>
            <table class="intro-table" style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 13px;">
                <thead>
                    <tr style="background: var(--bg);">
                        <th style="padding: 8px; border: 1px solid var(--border); text-align: left;">Title</th>
                        <th style="padding: 8px; border: 1px solid var(--border); text-align: left;">Condition</th>
                        <th style="padding: 8px; border: 1px solid var(--border); text-align: left;">Meaning</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Effort</td><td style="padding: 8px; border: 1px solid var(--border);">3 days</td><td style="padding: 8px; border: 1px solid var(--border);">Initially overcoming inertia.</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Striving</td><td style="padding: 8px; border: 1px solid var(--border);">10 days</td><td style="padding: 8px; border: 1px solid var(--border);">Starting to form a habit.</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Diligence</td><td style="padding: 8px; border: 1px solid var(--border);">30 days</td><td style="padding: 8px; border: 1px solid var(--border);">Habit is becoming stable.</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Ardor</td><td style="padding: 8px; border: 1px solid var(--border);">60 days</td><td style="padding: 8px; border: 1px solid var(--border);">Practice becomes firm and steady.</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Viriya-sambojjhanga</td><td style="padding: 8px; border: 1px solid var(--border);">365 days</td><td style="padding: 8px; border: 1px solid var(--border);">Extraordinary perseverance.</td></tr>
                </tbody>
            </table>

            <p><strong>Mindfulness Milestones (Sati):</strong></p>
            <table class="intro-table" style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 13px;">
                <thead>
                   <tr style="background: var(--bg);">
                        <th style="padding: 8px; border: 1px solid var(--border); text-align: left;">Level</th>
                        <th style="padding: 8px; border: 1px solid var(--border); text-align: left;">Sati Points</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Beginner</td><td style="padding: 8px; border: 1px solid var(--border);">5,000</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Practitioner</td><td style="padding: 8px; border: 1px solid var(--border);">10,000</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Yogi</td><td style="padding: 8px; border: 1px solid var(--border);">20,000</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Meditator</td><td style="padding: 8px; border: 1px solid var(--border);">50,000</td></tr>
					<tr><td style="padding: 8px; border: 1px solid var(--border);">Clear Mirror</td><td style="padding: 8px; border: 1px solid var(--border);">80,000</td></tr>
					<tr><td style="padding: 8px; border: 1px solid var(--border);">Still Lake</td><td style="padding: 8px; border: 1px solid var(--border);">100,000</td></tr>
					<tr><td style="padding: 8px; border: 1px solid var(--border);">The Mountain</td><td style="padding: 8px; border: 1px solid var(--border);">200,000</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Heir of the Dhamma</td><td style="padding: 8px; border: 1px solid var(--border);">500,000</td></tr>
                </tbody>
            </table>

            <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid var(--warning); padding: 15px; border-radius: 8px; color: #fbbf24; font-size: 13px;">
                <strong>‚ö†Ô∏è Important Data Notice:</strong>
                <ul style="margin: 5px 0 0 15px;">
                    <li>Your data is stored in the browser's <strong>Local Storage</strong>.</li>
                    <li><strong>Do not clear browser history/cache</strong> without backing up, or your data will be lost.</li>
                    <li><strong>How to Backup:</strong> Go to the left sidebar, select <strong>"Backup"</strong> to download the file.</li>
                    <li><strong>How to Restore:</strong> Select <strong>"Restore"</strong> and upload your backup file.</li>
                </ul>
            </div>
            
             <div style="margin-top: 20px; text-align: center; color: var(--text-light); font-size: 12px; border-top: 1px solid var(--border); padding-top: 10px;">
                <strong>Technologies:</strong> HTML5, CSS3, JS (ES6+).<br>
                <strong>Libraries:</strong> <a href="https://www.chartjs.org/" target="_blank" style="color: var(--primary); text-decoration: none;">Chart.js</a>, <a href="https://fontawesome.com/" target="_blank" style="color: var(--primary); text-decoration: none;">FontAwesome</a>.<br>
                Download Link & Source Code: <a href="https://github.com/buddhanussati/meditator-journal/releases"><b>here.</b></a> Wishing you peace and diligence!
            </div>
        </div>
        
        <div style="padding: 15px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; background: var(--surface); border-radius: 0 0 16px 16px;">
            <button class="btn btn-secondary" onclick="app.closeIntroModal()">Close</button>
        </div>
    </div>
</div>
    <audio id="bell" src="bell.mp3" preload="auto"></audio>

    <script>
        
		const DHAMMAPADA = [
    {t:"\"Intention shapes experiences;<br> intention is first, they‚Äôre made by intention.<br> If with corrupt intent<br> you speak or act,<br> suffering follows you,<br> like a wheel, the ox‚Äôs foot.\""},
 {t:"\"Intention shapes experiences;<br> intention is first, they‚Äôre made by intention.<br> If with pure intent<br> you speak or act,<br> happiness follows you<br> like a shadow that never leaves.\""},
 {t:"\"‚ÄúThey abused me, they hit me!<br> They beat me, they robbed me!‚Äù<br> For those who bear such a grudge,<br> hatred is never laid to rest.\""},
 {t:"\"‚ÄúThey abused me, they hit me!<br> They beat me, they robbed me!‚Äù<br> For those who bear no such grudge,<br> hatred is laid to rest.\""},
 {t:"\"For never is hatred<br> laid to rest by hate,<br> it‚Äôs laid to rest by love:<br> this is an ancient teaching.\""},
 {t:"\"When others do not understand,<br> let us, who do understand this,<br> restrain ourselves in this regard;<br> for that is how conflicts are laid to rest.\""},
 {t:"\"Those who contemplate the beautiful,<br> their faculties unrestrained,<br> immoderate in eating,<br> lazy, lacking energy:<br> MƒÅra strikes them down<br> like the wind, a feeble tree.\""},
 {t:"\"Those who contemplate the ugly,<br> their faculties well-restrained,<br> eating in moderation,<br> faithful and energetic:<br> MƒÅra cannot strike them down,<br> like the wind, a rocky mountain.\""},
 {t:"\"One who, not free of stains themselves,<br> would wear the robe stained in ocher,<br> bereft of self-control and of truth:<br> they are not worthy of the ocher robe.\""},
 {t:"\"One who‚Äôs purged all their stains,<br> steady in ethics,<br> possessed of self-control and of truth,<br> they are truly worthy of the ocher robe.\""},
 {t:"\"Thinking the inessential is essential,<br> seeing the essential as inessential;<br> they don‚Äôt realize the essential,<br> for wrong thoughts are their habitat.\""},
 {t:"\"Having known the essential as essential,<br> and the inessential as inessential;<br> they realize the essential,<br> for right thoughts are their habitat.\""},
 {t:"\"Just as rain seeps into<br> a poorly roofed house,<br> lust seeps into<br> an undeveloped mind.\""},
 {t:"\"Just as rain doesn‚Äôt seep into<br> a well roofed house,<br> lust doesn‚Äôt seep into<br> a well developed mind.\""},
 {t:"\"Here they grieve, hereafter they grieve,<br> an evildoer grieves in both places.<br> They grieve and fret,<br> seeing their own corrupt deeds.\""},
 {t:"\"Here they rejoice, hereafter they rejoice,<br> one who does good rejoices in both places.<br> They rejoice and celebrate,<br> seeing their own pure deeds.\""},
 {t:"\"Here they‚Äôre tormented,<br> hereafter they‚Äôre tormented,<br> an evildoer is tormented in both places.<br> They‚Äôre tormented<br> thinking of bad things they‚Äôve done;<br> when gone to a bad place,<br> they‚Äôre tormented all the more.\""},
 {t:"\"Here they delight, hereafter they delight,<br> one who does good delights in both places.<br> They delight thinking of good things they‚Äôve done;<br> when gone to a good place, they delight all the more.\""},
 {t:"\"Much though they may recite scripture,<br> if a negligent person does not apply them,<br> then, like a cowherd who counts the cattle of others,<br> they miss out on the blessings of the ascetic life.\""},
 {t:"\"Little though they may recite scripture,<br> if they live in line with the teaching,<br> having given up greed, hate, and delusion,<br> with deep understanding and heart well freed,<br> not grasping to this life or the next,<br> they share in the blessings of the ascetic life.\""},
 {t:"\"Heedfulness is the state free of death;<br> heedlessness is the state of death.<br> The heedful do not die,<br> while the heedless are like the dead.\""},
 {t:"\"Understanding this distinction<br> when it comes to heedfulness,<br> the astute rejoice in heedfulness,<br> happy in the noble ones‚Äô domain.\""},
 {t:"\"They who regularly meditate,<br> always staunchly vigorous;<br> the attentive realize extinguishment,<br> the supreme sanctuary from the yoke.\""},
 {t:"\"For the hard-working and mindful,<br> pure of deed and attentive,<br> restrained, living righteously, and diligent,<br> their reputation only grows.\""},
 {t:"\"By hard work and diligence,<br> by restraint and by self-control,<br> a smart person would build an island<br> that the floods cannot overflow.\""},
 {t:"\"Fools and simpletons<br> devote themselves to negligence.<br> But the wise protect diligence<br> as their best treasure.\""},
 {t:"\"Don‚Äôt devote yourself to negligence,<br> or delight in erotic intimacy.<br> For if you‚Äôre diligent and meditate,<br> you‚Äôll attain abundant happiness.\""},
 {t:"\"When the astute dispel negligence<br> by means of diligence,<br> ascending the palace of wisdom,<br> sorrowless, they behold this generation of sorrow,<br> as an attentive one on a mountain top<br> beholds the fools below.\""},
 {t:"\"Heedful among the heedless,<br> wide awake while others sleep‚Äî<br> a true sage leaves them behind,<br> like a swift horse passing a feeble.\""},
 {t:"\"MaghavƒÅ became chief of the gods<br> by means of diligence.<br> People praise diligence,<br> while negligence is always deplored.\""},
 {t:"\"A mendicant who loves to be diligent,<br> seeing fear in negligence‚Äî<br> advances like fire,<br> burning up fetters big and small.\""},
 {t:"\"A mendicant who loves to be diligent,<br> seeing fear in negligence‚Äî<br> such a one can‚Äôt decline,<br> and has drawn near to extinguishment.\""},
 {t:"\"The mind quivers and shakes,<br> hard to guard, hard to curb.<br> The discerning straighten it out,<br> like a fletcher straightens an arrow.\""},
 {t:"\"Like a fish pulled from the sea<br> and cast upon the shore,<br> this mind flounders about,<br> trying to throw off MƒÅra‚Äôs dominion.\""},
 {t:"\"Hard to hold back, flighty,<br> alighting where it will;<br> it‚Äôs good to tame the mind;<br> a tamed mind leads to bliss.\""},
 {t:"\"So hard to see, so subtle,<br> alighting where it will;<br> the discerning protect the mind,<br> a guarded mind leads to bliss.\""},
 {t:"\"The mind travels far, wandering alone;<br> incorporeal, it lies hidden in the heart.<br> Those who will restrain the mind<br> are freed from MƒÅra‚Äôs bonds.\""},
 {t:"\"Those of unsteady mind,<br> who don‚Äôt understand the true teaching,<br> and whose confidence wavers,<br> do not perfect their wisdom.\""},
 {t:"\"One whose mind is not festering,<br> whose heart is undamaged,<br> who‚Äôs given up right and wrong,<br> alert, has nothing to fear.\""},
 {t:"\"Knowing this body breaks like a pot,<br> and fortifying the mind like a citadel,<br> attack MƒÅra with the sword of wisdom,<br> guard your conquest, and never settle.\""},
 {t:"\"All too soon this body<br> will lie upon the earth,<br> bereft of consciousness,<br> tossed aside like a worthless log.\""},
 {t:"\"A wrongly directed mind<br> would do you more harm<br> than a hater to the hated,<br> or an enemy to their foe.\""},
 {t:"\"A rightly directed mind<br> would do you more good<br> than your mother or father<br> or any other relative.\""},
 {t:"\"Who bestirs this earth,<br> and the Yama realm with its gods?<br> Who sets out the well-taught word of truth,<br> as an expert a flower?\""},
 {t:"\"A trainee bestirs this earth,<br> and the Yama realm with its gods.<br> A trainee sets out the well-taught word of truth,<br> as an expert a flower.\""},
 {t:"\"Knowing this body‚Äôs like foam,<br> realizing it‚Äôs all just a mirage,<br> and cutting off MƒÅra‚Äôs blossoming,<br> vanish from the King of Death.\""},
 {t:"\"As a mighty flood sweeps off a sleeping village,<br> death steals away a man<br> even as he gathers flowers,<br> his mind caught up in them.\""},
 {t:"\"The terminator gains control of the man<br> who has not had his fill of pleasures,<br> even as he gathers flowers,<br> his mind caught up in them.\""},
 {t:"\"A bee takes the nectar<br> and moves on, doing no damage<br> to the flower‚Äôs beauty and fragrance;<br> and that‚Äôs how a sage should walk in the village.\""},
 {t:"\"Don‚Äôt find fault with others,<br> with what they‚Äôve done or left undone.<br> You should only watch yourself,<br> what you‚Äôve done or left undone.\""},
 {t:"\"Just like a glorious flower<br> that‚Äôs colorful but lacks fragrance;<br> eloquent speech is fruitless<br> for one who does not act on it.\""},
 {t:"\"Just like a glorious flower<br> that‚Äôs both colorful and fragrant,<br> eloquent speech is fruitful<br> for one who acts on it.\""},
 {t:"\"Just as one would create many garlands<br> from a heap of flowers,<br> when a person has come to be born,<br> they should do many skillful things.\""},
 {t:"\"The fragrance of flowers doesn‚Äôt spread upwind,<br> nor sandalwood, pinwheel, or jasmine;<br> but the fragrance of the good spreads upwind;<br> a true person‚Äôs virtue spreads in every direction.\""},
 {t:"\"Among all the fragrances‚Äî<br> sandalwood or pinwheel<br> or lotus or jasmine‚Äî<br> the fragrance of virtue is supreme.\""},
 {t:"\"Faint is the fragrance<br> of sandal or pinwheel;<br> but the fragrance of the virtuous<br> floats to the highest gods.\""},
 {t:"\"For those accomplished in ethics,<br> meditating diligently,<br> freed through the highest knowledge,<br> MƒÅra cannot find their path.\""},
 {t:"\"From a heap of trash<br> discarded on the highway,<br> a lotus might blossom,<br> fragrant and delightful.\""},
 {t:"\"So too, among those thought of as trash,<br> a disciple of the perfect Buddha<br> outshines with their wisdom<br> the blind ordinary folk.\""},
 {t:"\"Long is the night for the wakeful;<br> long is the league for the weary;<br> long transmigrate the fools<br> who don‚Äôt understand the true teaching.\""},
 {t:"\"If while wandering you find no partner<br> equal or better than yourself,<br> then firmly resolve to wander alone‚Äî<br> there‚Äôs no fellowship with fools.\""},
 {t:"\"‚ÄúSons are mine, wealth is mine‚Äù‚Äî<br> thus the fool frets.<br> For even your self is not your own,<br> let alone your sons or wealth.\""},
 {t:"\"The fool who thinks they‚Äôre a fool<br> is wise at least to that extent.<br> But the true fool is said to be one<br> who imagines that they are wise.\""},
 {t:"\"Though a fool attends to the wise<br> even for the rest of their life,<br> they still don‚Äôt understand the teaching,<br> like a spoon the taste of the soup.\""},
 {t:"\"If a clever person attends to the wise<br> even just for an hour or so,<br> they swiftly understand the teaching,<br> like a tongue the taste of the soup.\""},
 {t:"\"Fools and simpletons behave<br> like their own worst enemies,<br> doing wicked deeds<br> that ripen as bitter fruit.\""},
 {t:"\"It‚Äôs not good to do a deed<br> that plagues you later on,<br> for which you weep and wail,<br> as its effect stays with you.\""},
 {t:"\"It is good to do a deed<br> that doesn‚Äôt plague you later on,<br> that gladdens and cheers,<br> as its effect stays with you.\""},
 {t:"\"The fool imagines that evil is sweet,<br> so long as it has not yet ripened.<br> But as soon as that evil ripens,<br> they fall into suffering.\""},
 {t:"\"Month after month a fool may eat<br> food from a grass-blade‚Äôs tip;<br> but they‚Äôll never be worth a sixteenth part<br> of one who has appraised the teaching.\""},
 {t:"\"For a wicked deed that has been done<br> does not curdle quickly like milk.<br> Smoldering, it follows the fool,<br> like a fire smothered over with ash.\""},
 {t:"\"Whatever fame a fool may get,<br> it only gives rise to harm.<br> Whatever good features they have it ruins,<br> and blows their head into bits.\""},
 {t:"\"They‚Äôd seek the esteem that they lack,<br> and status among the mendicants;<br> authority over monasteries,<br> and honor among other families.\""},
 {t:"\"‚ÄúLet both layfolk and renunciants think<br> the work was done by me alone.<br> In anything at all that‚Äôs to be done,<br> let them fall under my sway alone.‚Äù<br> So thinks the fool,<br> their greed and pride only growing.\""},
 {t:"\"For the means to profit and the path to quenching<br> are two quite different things.<br> A mendicant disciple of the Buddha,<br> understanding what this really means,<br> would never delight in honors,<br> but rather would foster seclusion.\""},
 {t:"\"Regard one who sees your faults<br> as a guide to a hidden treasure.<br> Stay close to one so wise and astute<br> who corrects you when you need it.<br> Sticking close to such an impartial person,<br> things get better, not worse.\""},
 {t:"\"Advise and instruct;<br> curb wickedness:<br> for you shall be loved by the good,<br> and disliked by the bad.\""},
 {t:"\"Don‚Äôt mix with bad friends,<br> nor with the worst of men.<br> Mix with spiritual friends,<br> and with the best of men.\""},
 {t:"\"Through joy in the teaching you sleep at ease,<br> with clear and confident heart.<br> An astute person always delights in the teaching<br> proclaimed by the Noble One.\""},
 {t:"\"Irrigators guide water,<br> fletchers straighten arrows,<br> carpenters carve timber,<br> the astute tame themselves.\""},
 {t:"\"As the wind cannot stir<br> a solid mass of rock,<br> so too blame and praise<br> do not affect the wise.\""},
 {t:"\"Like a deep lake,<br> clear and unclouded,<br> so clear are the astute<br> when they hear the teachings.\""},
 {t:"\"True persons give up everything,<br> they don‚Äôt cajole for the things they desire.<br> Though touched by sadness or happiness,<br> the astute appear neither depressed nor elated.\""},
 {t:"\"Never wish for success by unjust means,<br> for your own sake or that of another,<br> desiring children, wealth, or nation;<br> rather, be virtuous, wise, and just.\""},
 {t:"\"Few are those among humans<br> who cross to the far shore.<br> The rest just run around<br> on the near shore.\""},
 {t:"\"When the teaching is well explained,<br> those who practice accordingly<br> will cross over<br> Death‚Äôs dominion so hard to pass.\""},
 {t:"\"Rid of dark qualities,<br> an astute person should develop the bright.<br> Leaving home behind<br> for the seclusion so hard to enjoy,\""},
 {t:"\"try to find satisfaction there,<br> having left behind sensual pleasures.<br> Owning nothing, an astute person<br> would cleanse themselves of mental corruptions.\""},
 {t:"\"Those whose minds are rightly developed<br> in the awakening factors;<br> who, letting go of attachments,<br> delight in not grasping:<br> with defilements ended, brilliant,<br> they are quenched in this world.\""},
 {t:"\"At journey‚Äôs end, rid of sorrow;<br> everywhere free,<br> all ties given up,<br> no fever is found in them.\""},
 {t:"\"The mindful apply themselves;<br> they delight in no abode.<br> Like a swan gone from the marsh,<br> they leave home after home behind.\""},
 {t:"\"Those with nothing stored up,<br> who have understood their food,<br> whose domain is the liberation<br> of the signless and the empty:<br> their path is hard to trace,<br> like birds in the sky.\""},
 {t:"\"One whose defilements have ended;<br> who‚Äôs not attached to food;<br> whose domain is the liberation<br> of the signless and the empty:<br> their track is hard to trace,<br> like birds in the sky.\""},
 {t:"\"Whose faculties have become serene,<br> like horses tamed by a charioteer,<br> who has abandoned conceit and defilements;<br> the unaffected one is envied by even the gods.\""},
 {t:"\"Undisturbed like the earth,<br> true to their vows, steady as Indra‚Äôs pillar,<br> like a lake clear of mud;<br> such a one does not transmigrate.\""},
 {t:"\"Their mind is peaceful,<br> peaceful are their speech and deeds.<br> Such a one is at peace,<br> rightly freed through enlightenment.\""},
 {t:"\"Lacking faith, a house-breaker,<br> one who acknowledges nothing,<br> purged of hope, they‚Äôve wasted their chance:<br> that is indeed the supreme person!\""},
 {t:"\"Whether in village or wilderness,<br> in a valley or the uplands,<br> wherever the perfected ones live<br> is a delightful place.\""},
 {t:"\"Delightful are the wildernesses<br> where no people delight.<br> Those free of greed will delight there,<br> not those who seek sensual pleasures.\""},
 {t:"\"Better than a thousand<br> meaningless sayings<br> is a single meaningful saying,<br> hearing which brings you peace.\""},
 {t:"\"Better than a thousand<br> meaningless verses<br> is a single meaningful verse,<br> hearing which brings you peace.\""},
 {t:"\"Better than reciting<br> a hundred meaningless verses<br> is a single saying of Dhamma,<br> hearing which brings you peace.\""},
 {t:"\"The supreme conqueror is<br> not he who conquers a million men in battle,<br> but he who conquers a single man:<br> himself.\""},
 {t:"\"It is surely better to conquer oneself<br> than all those other folk.<br> When a person has tamed themselves,<br> always living restrained,\""},
 {t:"\"No god nor angel,<br> nor MƒÅra nor divinity,<br> can undo the victory<br> of such a personage.\""},
 {t:"\"Rather than a thousandfold sacrifice,<br> every month for a full century,<br> it‚Äôs better to honor for a single hour<br> one who has developed themselves.<br> That offering is better<br> than the hundred year sacrifice.\""},
 {t:"\"Rather than serve the sacred flame<br> in the forest for a hundred years,<br> it‚Äôs better to honor for a single hour<br> a personage who has developed themselves.<br> That offering is better<br> than the hundred year sacrifice.\""},
 {t:"\"Whatever sacrifice or offering in the world<br> a seeker of merit may make for a year,<br> none of it is worth a quarter<br> of bowing to the sincere.\""},
 {t:"\"For one in the habit of bowing,<br> always honoring the elders,<br> four blessings grow:<br> lifespan, beauty, happiness, and strength.\""},
 {t:"\"Better to live a single day<br> ethical and absorbed in meditation<br> than to live a hundred years<br> unethical and lacking immersion.\""},
 {t:"\"Better to live a single day<br> wise and absorbed in meditation<br> than to live a hundred years<br> witless and lacking immersion.\""},
 {t:"\"Better to live a single day<br> energetic and strong,<br> than to live a hundred years<br> lazy and lacking energy.\""},
 {t:"\"Better to live a single day<br> seeing rise and fall<br> than to live a hundred years<br> blind to rise and fall.\""},
 {t:"\"Better to live a single day<br> seeing the state free of death<br> than to live a hundred years<br> blind to the state free of death.\""},
 {t:"\"Better to live a single day<br> seeing the supreme teaching<br> than to live a hundred years<br> blind to the supreme teaching.\""},
 {t:"\"Rush to do good,<br> shield your mind from evil;<br> for when you‚Äôre slow to do good,<br> your thoughts delight in wickedness.\""},
 {t:"\"If you do something bad,<br> don‚Äôt do it again and again,<br> don‚Äôt set your heart on it,<br> for piling up evil is suffering.\""},
 {t:"\"If you do something good,<br> do it again and again,<br> set your heart on it,<br> for piling up goodness is joyful.\""},
 {t:"\"Even the wicked see good things,<br> so long as their wickedness has not ripened.<br> But as soon as that wickedness ripens,<br> then the wicked see wicked things.\""},
 {t:"\"Even the good see wicked things,<br> so long as their goodness has not ripened.<br> But as soon as that goodness ripens,<br> then the good see good things.\""},
 {t:"\"Think not lightly of evil,<br> that it won‚Äôt come back to you.<br> The pot is filled with water<br> falling drop by drop;<br> the fool is filled with wickedness<br> piled up bit by bit.\""},
 {t:"\"Think not lightly of goodness,<br> that it won‚Äôt come back to you.<br> The pot is filled with water<br> falling drop by drop;<br> the attentive one is filled with goodness<br> piled up bit by bit.\""},
 {t:"\"Avoid wickedness,<br> as a merchant with rich cargo and small escort<br> would avoid a dangerous road,<br> or one who loves life would avoid drinking poison.\""},
 {t:"\"You can carry poison in your hand<br> if it has no wound,<br> for poison does not infect without a wound;<br> nothing bad happens unless you do bad.\""},
 {t:"\"Whoever wrongs a man who has done no wrong,<br> a pure man who has not a blemish,<br> the evil backfires on the fool,<br> like fine dust thrown upwind.\""},
 {t:"\"Some are born in a womb;<br> evil-doers go to hell;<br> the virtuous go to heaven;<br> the undefiled are fully extinguished.\""},
 {t:"\"Not in midair, nor mid-ocean,<br> nor hiding in a mountain cleft;<br> you‚Äôll find no place on the planet<br> to escape your wicked deeds.\""},
 {t:"\"Not in midair, nor mid-ocean,<br> nor hiding in a mountain cleft;<br> you‚Äôll find no place on the planet<br> where you won‚Äôt be vanquished by death.\""},
 {t:"\"All tremble at the rod,<br> all fear death.<br> Treating others like oneself,<br> neither kill nor incite to kill.\""},
 {t:"\"All tremble at the rod,<br> all love life.<br> Treating others like oneself,<br> neither kill nor incite to kill.\""},
 {t:"\"Creatures love happiness,<br> so if you harm them with a stick<br> in search of your own happiness,<br> after death you won‚Äôt find happiness.\""},
 {t:"\"Creatures love happiness,<br> so if you don‚Äôt harm them with a stick<br> in search of your own happiness,<br> after death you will find happiness.\""},
 {t:"\"Don‚Äôt speak harshly,<br> they may speak harshly back.<br> For aggressive speech is painful,<br> and the rod may spring back on you.\""},
 {t:"\"If you still yourself<br> like a broken gong,<br> you reach extinguishment<br> and know no conflict.\""},
 {t:"\"As a cowherd drives the cows<br> to pasture with the rod,<br> so too old age and death<br> drive life from living beings.\""},
 {t:"\"The fool does not understand<br> the evil that they do.<br> But because of those deeds, that simpleton<br> is tormented as if burnt by fire.\""},
 {t:"\"One who violently attacks<br> the peaceful and the innocent<br> swiftly falls<br> to one of ten bad states:\""},
 {t:"\"Or else their home<br> is consumed by fire.<br> When their body breaks up, that witless person<br> is reborn in hell.\""},
 {t:"\"Not nudity, nor matted hair, nor mud,<br> nor fasting, nor lying on bare ground,<br> nor wearing dust and dirt, or squatting on the heels,<br> will cleanse a mortal not free of doubt.\""},
 {t:"\"Dressed up they may be, but if they live well‚Äî<br> peaceful, tamed, committed to the spiritual path,<br> having laid aside violence towards all creatures‚Äî<br> they are a brahmin, an ascetic, a mendicant.\""},
 {t:"\"Can a person constrained by conscience<br> be found in the world?<br> Who shies away from blame,<br> like a fine horse from the whip?\""},
 {t:"\"Like a fine horse under the whip,<br> be keen and full of urgency.<br> With faith, ethics, and energy,<br> immersion, and investigation of principles,<br> accomplished in knowledge and conduct, mindful,<br> give up this vast suffering.\""},
 {t:"\"While irrigators guide water,<br> fletchers shape arrows,<br> and carpenters carve timber‚Äî<br> those true to their vows tame themselves.\""},
 {t:"\"What is joy, what is laughter,<br> when the flames are ever burning?<br> Shrouded by darkness,<br> would you not seek a light?\""},
 {t:"\"See this fancy puppet,<br> a body built of sores,<br> diseased, obsessed over,<br> in which nothing lasts at all.\""},
 {t:"\"This body is decrepit and frail,<br> a nest of disease.<br> This foul carcass falls apart,<br> for life ends in death.\""},
 {t:"\"These dove-grey bones<br> are tossed away like<br> dried gourds in the autumn‚Äî<br> what joy is there in such a sight?\""},
 {t:"\"In this city built of bones,<br> plastered with flesh and blood,<br> old age and death are stashed away,<br> along with conceit and contempt.\""},
 {t:"\"Fancy chariots of kings wear out,<br> and even this body gets old.<br> But the truth of the good never gets old‚Äî<br> so the good proclaim to the good.\""},
 {t:"\"A person of little learning<br> ages like an ox‚Äî<br> their flesh grows,<br> but not their wisdom.\""},
 {t:"\"Transmigrating through countless rebirths,<br> I‚Äôve journeyed without reward,<br> searching for the house-builder;<br> painful is birth again and again.\""},
 {t:"\"I‚Äôve seen you, house-builder!<br> You won‚Äôt build a house again!<br> Your rafters are all broken,<br> your roof-peak is demolished.<br> My mind, set on demolition,<br> has reached the end of craving.\""},
 {t:"\"When young they spurned the spiritual path<br> and failed to earn any wealth.<br> Now they brood like old cranes<br> in a pond bereft of fish.\""},
 {t:"\"When young they spurned the spiritual path<br> and failed to earn any wealth.<br> Now they lie like spent arrows,<br> bemoaning over things past.\""},
 {t:"\"If you knew your self as beloved,<br> you‚Äôd look after it so well.<br> In one of the night‚Äôs three watches,<br> an astute person would remain alert.\""},
 {t:"\"The astute would avoid being corrupted<br> by first grounding themselves<br> in what is suitable,<br> and then instructing others.\""},
 {t:"\"If one were to treat oneself<br> as one instructs another,<br> the well-tamed indeed would tame:<br> for the self, it seems, is hard to tame.\""},
 {t:"\"One is indeed the lord of oneself,<br> for who else would be one‚Äôs lord?<br> By means of a well-tamed self,<br> one gains a lord that‚Äôs rare indeed.\""},
 {t:"\"For the evil that is done by oneself,<br> born and produced in oneself,<br> grinds down a simpleton,<br> as diamond grinds a lesser gem.\""},
 {t:"\"One choked by immorality,<br> as a sal tree by a creeper,<br> does to themselves<br> what a foe only wishes.\""},
 {t:"\"It‚Äôs easy to do bad things<br> harmful to oneself,<br> but good things that are helpful<br> are the hardest things to do.\""},
 {t:"\"On account of wicked views‚Äî<br> scorning the guidance<br> of the perfected ones,<br> the noble ones living righteously‚Äî<br> the idiot begets their own self‚Äôs demise,<br> like the bamboo bearing fruit.\""},
 {t:"\"For it is by oneself that evil‚Äôs done,<br> one is corrupted by oneself.<br> It‚Äôs by oneself that evil‚Äôs not done,<br> one is purified by oneself.<br> Purity and impurity are personal matters,<br> no one can purify another.\""},
 {t:"\"Never neglect what is good for yourself<br> for the sake of another, however great.<br> Knowing well what is good for yourself,<br> be intent upon your heart‚Äôs goal.\""},
 {t:"\"Don‚Äôt resort to lowly things,<br> don‚Äôt abide in negligence,<br> don‚Äôt resort to wrong views,<br> don‚Äôt perpetuate the world.\""},
 {t:"\"Get up, don‚Äôt be heedless,<br> live by principle, with good conduct.<br> For one of good conduct sleeps at ease,<br> in this world and the next.\""},
 {t:"\"Live by principle, with good conduct,<br> don‚Äôt conduct yourself badly.<br> For one of good conduct sleeps at ease,<br> in this world and the next.\""},
 {t:"\"Look upon the world<br> as a bubble<br> or a mirage,<br> then the King of Death won‚Äôt see you.\""},
 {t:"\"Come, see this world decked out<br> like a fancy royal chariot.<br> Here fools founder,<br> but the discerning are not chained.\""},
 {t:"\"He who once was heedless,<br> but turned to heedfulness,<br> lights up the world<br> like the moon freed from clouds.\""},
 {t:"\"Someone whose bad deed<br> is supplanted by the good,<br> lights up the world,<br> like the moon freed from clouds.\""},
 {t:"\"Blind is the world,<br> few are those who clearly see.<br> Only a handful go to heaven,<br> like a bird freed from a net.\""},
 {t:"\"Swans fly by the sun‚Äôs path,<br> psychic sages fly through space.<br> The attentive leave the world,<br> having vanquished MƒÅra with his legions.\""},
 {t:"\"When a personage, spurning the hereafter,<br> transgresses in just one thing‚Äî<br> lying‚Äî<br> there is no evil they would not do.\""},
 {t:"\"The miserly don‚Äôt ascend to heaven,<br> it takes a fool to not praise giving.<br> The attentive celebrate giving,<br> and so find happiness in the hereafter.\""},
 {t:"\"The fruit of stream-entry is better<br> than being the one king of the earth,<br> than going to heaven,<br> than lordship over all the world.\""},
 {t:"\"He whose victory may not be undone,<br> a victory unrivaled in all the world;<br> by what track would you trace that Buddha,<br> who leaves no track in his infinite range?\""},
 {t:"\"Of craving, the weaver, the clinger, he has none:<br> so where can he be traced?<br> By what track would you trace that Buddha,<br> who leaves no track in his infinite range?\""},
 {t:"\"The attentive intent on absorption,<br> who love the peace of renunciation,<br> the Buddhas, ever mindful,<br> are envied by even the gods.\""},
 {t:"\"It‚Äôs hard to gain a human birth;<br> the life of mortals is hard;<br> it‚Äôs hard to hear the true teaching;<br> the arising of Buddhas is hard.\""},
 {t:"\"Not to do any evil;<br> to embrace the good;<br> to purify one‚Äôs mind:<br> this is the instruction of the Buddhas.\""},
 {t:"\"Patient acceptance is the ultimate fervor.<br> Extinguishment is the ultimate, say the Buddhas.<br> No true renunciate injures another,<br> nor does an ascetic hurt another.\""},
 {t:"\"Not speaking ill nor doing harm;<br> restraint in the monastic code;<br> moderation in eating;<br> staying in remote lodgings;<br> commitment to the higher mind‚Äî<br> this is the instruction of the Buddhas.\""},
 {t:"\"Even if it were raining money,<br> you‚Äôd not be sated in sensual pleasures.<br> An astute person understands that sensual pleasures<br> offer little gratification and much suffering.\""},
 {t:"\"Thus they find no delight<br> even in celestial pleasures.<br> A disciple of the fully awakened Buddha<br> delights in the ending of craving.\""},
 {t:"\"So many go for refuge<br> to mountains and forest groves,<br> to shrines in tended parks;<br> those people are driven by fear.\""},
 {t:"\"But such refuge is no sanctuary,<br> it is no supreme refuge.<br> By going to that refuge,<br> you‚Äôre not released from all suffering.\""},
 {t:"\"One gone for refuge to the Buddha,<br> to his teaching and to the Sa·πÖgha,<br> sees the four noble truths<br> with right understanding:\""},
 {t:"\"Suffering, suffering‚Äôs origin,<br> suffering‚Äôs transcendence,<br> and the noble eightfold path<br> that leads to the stilling of suffering.\""},
 {t:"\"Such refuge is a sanctuary,<br> it is the supreme refuge.<br> By going to that refuge,<br> you‚Äôre released from all suffering.\""},
 {t:"\"It‚Äôs hard to find a thoroughbred man:<br> they‚Äôre not born just anywhere.<br> A family where that attentive one is born<br> prospers in happiness.\""},
 {t:"\"Happy, the arising of Buddhas!<br> Happy, the teaching of Dhamma!<br> Happy is the harmony of the Sa·πÖgha,<br> and the striving of the harmonious is happy.\""},
 {t:"\"When a person venerates the worthy‚Äî<br> the Buddha or his disciple,<br> who have transcended proliferation,<br> and have left behind grief and lamentation,\""},
 {t:"\"Fearing nothing from any quarter‚Äî<br> the merit of one venerating such as these,<br> cannot be calculated by anyone,<br> saying it is just this much.\""},
 {t:"\"Let us live so very happily,<br> loving among the hostile.<br> Among hostile humans,<br> let us live with love.\""},
 {t:"\"Let us live so very happily,<br> healthy among the ailing.<br> Among ailing humans<br> let us live healthily.\""},
 {t:"\"Let us live so very happily,<br> content among the greedy.<br> Among greedy humans,<br> let us live content.\""},
 {t:"\"Let us live so very happily,<br> we who have nothing.<br> We shall feed on rapture,<br> like the gods of streaming radiance.\""},
 {t:"\"Victory breeds enmity;<br> the defeated sleep badly.<br> The peaceful sleep at ease,<br> having left victory and defeat behind.\""},
 {t:"\"There is no fire like greed,<br> no crime like hate,<br> no suffering like the aggregates,<br> no bliss beyond peace.\""},
 {t:"\"Hunger is the worst illness,<br> conditions are the worst suffering.<br> For one who truly knows this,<br> extinguishment is the ultimate happiness.\""},
 {t:"\"Health is the ultimate blessing;<br> contentment, the ultimate wealth;<br> trust is the ultimate family;<br> extinguishment, the ultimate happiness.\""},
 {t:"\"Having drunk the nectar of seclusion<br> and the nectar of peace‚Äî<br> free of stress, free of evil,<br> drink the joyous nectar of truth.\""},
 {t:"\"It‚Äôs good to see the noble ones,<br> staying with them is always good.<br> Were you not to see fools,<br> you‚Äôd always be happy.\""},
 {t:"\"For one who consorts with fools<br> grieves long.<br> Painful is living with fools,<br> like being stuck with your enemy.<br> Happy is living with an attentive one,<br> like meeting with your kin.\""},
 {t:"\"Therefore:<br> An attentive one, wise and learned,<br> a behemoth of virtue, true to their vows, noble:<br> follow a true and intelligent person such as this,<br> as the moon tracks the path of the stars.\""},
 {t:"\"Applying yourself where you ought not,<br> neglecting what you should be doing,<br> forgetting your goal, you cling to what you hold dear,<br> jealous of those devoted to their heart‚Äôs goal.\""},
 {t:"\"Don‚Äôt ever get too close<br> to those you like or dislike.<br> For not seeing the liked is suffering,<br> and so is seeing the disliked.\""},
 {t:"\"Therefore don‚Äôt hold anything dear,<br> for it‚Äôs bad to lose those you love.<br> No ties are found in they who<br> hold nothing loved or loathed.\""},
 {t:"\"Sorrow springs from what we hold dear,<br> fear springs from what we hold dear;<br> one free from holding anything dear<br> has no sorrow, let alone fear.\""},
 {t:"\"Sorrow springs from attachment,<br> fear springs from attachment;<br> one free from attachment<br> has no sorrow, let alone fear.\""},
 {t:"\"Sorrow springs from relishing,<br> fear springs from relishing;<br> one free from relishing<br> has no sorrow, let alone fear.\""},
 {t:"\"Sorrow springs from desire,<br> fear springs from desire;<br> one free from desire<br> has no sorrow, let alone fear.\""},
 {t:"\"Sorrow springs from craving,<br> fear springs from craving;<br> one free from craving<br> has no sorrow, let alone fear.\""},
 {t:"\"One accomplished in virtue and vision,<br> firmly principled, and truthful,<br> doing oneself what ought be done:<br> that‚Äôs who the people love.\""},
 {t:"\"One eager to realize the ineffable<br> would be filled with awareness.<br> Their mind not bound to pleasures of sense,<br> they‚Äôre said to be heading upstream.\""},
 {t:"\"When a man returns safely<br> after a long time spent abroad,<br> family, friends, and loved ones<br> celebrate his return.\""},
 {t:"\"Just so, when one who has done good<br> goes from this world to the next,<br> their good deeds receive them there,<br> as family welcomes home one they love.\""},
 {t:"\"Give up anger, get rid of conceit,<br> and escape every fetter.<br> Sufferings don‚Äôt befall one who has nothing,<br> not clinging to name and form.\""},
 {t:"\"When anger surges like a lurching chariot,<br> keep it in check.<br> That‚Äôs what I call a charioteer;<br> others just hold the reins.\""},
 {t:"\"Defeat anger with kindness,<br> villainy with virtue,<br> stinginess with giving,<br> and lies with truth.\""},
 {t:"\"Speak the truth, do not be angry,<br> and give when asked, if only a little.<br> By these three means,<br> you may enter the presence of the gods.\""},
 {t:"\"Those harmless sages,<br> always restrained in body,<br> go to the state that does not pass,<br> where there is no sorrow.\""},
 {t:"\"Always wakeful,<br> practicing night and day,<br> focused only on extinguishment,<br> their defilements come to an end.\""},
 {t:"\"It‚Äôs always been this way, Atula,<br> it‚Äôs not just today.<br> They blame you when you‚Äôre silent,<br> they blame you when you speak a lot,<br> and even when you speak just right:<br> no-one in the world escapes blame.\""},
 {t:"\"There never was, nor will be,<br> nor is there today,<br> someone who is wholly praised<br> or wholly blamed.\""},
 {t:"\"If, after watching them day in day out,<br> discerning people praise<br> that sage of impeccable conduct,<br> endowed with ethics and wisdom;\""},
 {t:"\"like a pendant of Black Plum River gold,<br> who is worthy to criticize them?<br> Even the gods praise them,<br> and by the Divinity, too, they‚Äôre praised.\""},
 {t:"\"Guard against ill-tempered deeds,<br> be restrained in body.<br> Giving up bad bodily conduct,<br> conduct yourself well in body.\""},
 {t:"\"Guard against ill-tempered words,<br> be restrained in speech.<br> Giving up bad verbal conduct,<br> conduct yourself well in speech.\""},
 {t:"\"Guard against ill-tempered thoughts,<br> be restrained in mind.<br> Giving up bad mental conduct,<br> conduct yourself well in mind.\""},
 {t:"\"An attentive one is restrained in body<br> restrained also in speech,<br> in thought, too, they are restrained:<br> they are restrained in every way.\""},
 {t:"\"Today you‚Äôre like a withered leaf,<br> Yama‚Äôs men await you.<br> You stand at the departure gates,<br> yet you have no supplies for the road.\""},
 {t:"\"Make an island of yourself!<br> Swiftly strive, learn to be wise!<br> Purged of stains, flawless,<br> you‚Äôll go to the heavenly realm of the noble ones.\""},
 {t:"\"You‚Äôve journeyed the stages of life,<br> and now you set out to meet Yama.<br> Along the way there‚Äôs nowhere to stay,<br> yet you have no supplies for the road.\""},
 {t:"\"Make an island of yourself!<br> Swiftly strive, learn to be wise!<br> Purged of stains, flawless,<br> you‚Äôll not come again to rebirth and old age.\""},
 {t:"\"A smart person would purge<br> their own stains gradually,<br> bit by bit, moment by moment,<br> like a smith smelting silver.\""},
 {t:"\"It is the rust born on the iron<br> that eats away the place it arose.<br> And so it is their own deeds<br> that lead the overly-ascetic to a bad place.\""},
 {t:"\"Not rehearsing is the stain of hymns.<br> The stain of houses is neglect.<br> Laziness is the stain of beauty.<br> A guard‚Äôs stain is negligence.\""},
 {t:"\"Misconduct is a woman‚Äôs stain.<br> A giver‚Äôs stain is stinginess.<br> Bad qualities are a stain<br> in this world and the next.\""},
 {t:"\"But a worse stain than these<br> is ignorance, the worst stain of all.<br> Having given up that stain,<br> be without stains, mendicants!\""},
 {t:"\"Life is easy for the shameless.<br> With all the rude courage of a crow,<br> they live pushy,<br> rude, and corrupt.\""},
 {t:"\"Life is hard for the conscientious,<br> always seeking purity,<br> neither clinging nor rude,<br> pure of livelihood and discerning.\""},
 {t:"\"Take anyone in this world<br> who kills living creatures,<br> speaks falsely, steals,<br> commits adultery,\""},
 {t:"\"and indulges in drinking<br> beer and wine.<br> Right here they dig up<br> the root of their own self.\""},
 {t:"\"Know this, good fellow:<br> they are unrestrained and wicked.<br> Don‚Äôt let that greed and unrighteousness<br> inflict pain on you for long.\""},
 {t:"\"The people give according to their faith,<br> according to their confidence.<br> If you get upset over that,<br> over other‚Äôs food and drink,<br> you‚Äôll not, by day or by night,<br> become immersed in samƒÅdhi.\""},
 {t:"\"Those who have cut that out,<br> dug it up at the root, eradicated it,<br> they will, by day or by night,<br> become immersed in samƒÅdhi.\""},
 {t:"\"There is no fire like greed,<br> no crime like hate,<br> no net like delusion,<br> no river like craving.\""},
 {t:"\"It‚Äôs easy to see the faults of others,<br> hard to see one‚Äôs own.<br> For the faults of others<br> are tossed high like hay,<br> while one‚Äôs own are hidden,<br> as a cheat hides a bad hand.\""},
 {t:"\"When you look for the flaws of others,<br> always finding fault,<br> your defilements only grow,<br> you‚Äôre far from ending defilements.\""},
 {t:"\"In the atmosphere there is no track,<br> there‚Äôs no true ascetic outside here.<br> People enjoy proliferation,<br> the Realized Ones are free of proliferation.\""},
 {t:"\"In the atmosphere there is no track,<br> there‚Äôs no true ascetic outside here.<br> No conditions last forever,<br> the Awakened Ones are not shaken.\""},
 {t:"\"You don‚Äôt become just<br> by passing hasty judgment.<br> An astute person evaluates both<br> what is pertinent and what is irrelevant.\""},
 {t:"\"A wise one judges others without haste,<br> justly and impartially;<br> that guardian of the law<br> is said to be just.\""},
 {t:"\"You‚Äôre not an astute scholar<br> just because you speak a lot.<br> One who is secure, free of enmity and fear,<br> is said to be astute.\""},
 {t:"\"You‚Äôre not one who has memorized the teaching<br> just because you recite a lot.<br> Someone who directly sees the teaching<br> after hearing only a little<br> is truly one who has memorized the teaching,<br> for they can never forget it.\""},
 {t:"\"You don‚Äôt become a senior<br> by getting some grey hairs;<br> for one ripe only in age,<br> is said to have aged in vain.\""},
 {t:"\"One who is truthful and principled,<br> harmless, restrained, and self-controlled,<br> attentive, purged of stains,<br> is said to be a senior.\""},
 {t:"\"Not by mere enunciation,<br> or a beautiful complexion<br> does a person become holy,<br> if they‚Äôre jealous, stingy, and devious.\""},
 {t:"\"But if they‚Äôve cut that out,<br> dug it up at the root, eradicated it,<br> that wise one, purged of vice,<br> is said to be holy.\""},
 {t:"\"A liar and breaker of vows is no ascetic<br> just because they shave their head.<br> How on earth can one be an ascetic<br> who‚Äôs full of desire and greed?\""},
 {t:"\"One who stops all wicked deeds,<br> great and small,<br> because of stopping wicked deeds<br> is said to be an ascetic.\""},
 {t:"\"You don‚Äôt become a mendicant<br> just by begging from others.<br> One who has undertaken domestic duties<br> has not yet become a mendicant.\""},
 {t:"\"But one living a spiritual life,<br> who has banished both merit and evil,<br> who wanders having appraised the world,<br> is said to be a mendicant.\""},
 {t:"\"You don‚Äôt become a sage by being sagelike,<br> while still confused and ignorant.<br> The astute one who holds the scales,<br> taking only the best,\""},
 {t:"\"And shunning the bad‚Äî<br> that is a sage,<br> and that is how one becomes a sage.<br> One who sagely weighs both in the world,<br> is thereby said to be a sage.\""},
 {t:"\"You don‚Äôt become a noble one<br> by harming living beings.<br> One harmless towards all living beings<br> is said to be a noble one.\""},
 {t:"\"Not by precepts and observances,<br> nor by much learning,<br> nor by meditative immersion,<br> nor by living in seclusion,\""},
 {t:"\"Do I experience the bliss of renunciation<br> not frequented by ordinary people.<br> A mendicant cannot rest confident<br> without attaining the end of defilements.\""},
 {t:"\"Of paths, the eightfold is the best;<br> of truths, the four statements;<br> dispassion is the best of things,<br> and the Clear-eyed One is the best of humans.\""},
 {t:"\"This is the path, there is no other<br> for the purification of vision.<br> You all must practice this,<br> it is the way to baffle MƒÅra.\""},
 {t:"\"When you all are practicing this,<br> you will make an end of suffering.<br> I have explained the path to you<br> for extracting the thorn with wisdom.\""},
 {t:"\"You yourselves must do the work,<br> the Realized Ones just show the way.<br> Meditators practicing absorption<br> are released from MƒÅra‚Äôs bonds.\""},
 {t:"\"All conditions are impermanent‚Äî<br> when this is seen with wisdom,<br> one grows disillusioned with suffering:<br> this is the path to purity.\""},
 {t:"\"All conditions are suffering‚Äî<br> when this is seen with wisdom,<br> one grows disillusioned with suffering:<br> this is the path to purity.\""},
 {t:"\"All things are not-self‚Äî<br> when this is seen with wisdom,<br> one grows disillusioned with suffering:<br> this is the path to purity.\""},
 {t:"\"They don‚Äôt get going when it‚Äôs time to start;<br> they‚Äôre young and strong, but given to sloth.<br> Their mind depressed in sunken thought,<br> lazy and slothful, they can‚Äôt discern the path.\""},
 {t:"\"Guarded in speech, restrained in mind,<br> doing no unskillful bodily deed.<br> Purify these three ways of performing deeds,<br> and win the path known to seers.\""},
 {t:"\"From meditation springs wisdom,<br> without meditation, wisdom ends.<br> Knowing these two paths‚Äî<br> of progress and decline‚Äî<br> you should conduct yourself<br> so that wisdom grows.\""},
 {t:"\"Cut down the jungle, not just a tree;<br> from the jungle springs fear.<br> Having cut down jungle and snarl,<br> be free of jungles, mendicants!\""},
 {t:"\"So long as the vine, no matter how small,<br> that ties a man to women is not cut,<br> his mind remains trapped,<br> like a calf suckling its mother.\""},
 {t:"\"Cut out affection for oneself,<br> like plucking an autumn lotus.<br> Foster only the path to peace,<br> the extinguishment the Holy One taught.\""},
 {t:"\"‚ÄúHere I will stay for the rains;<br> here for winter, here the summer‚Äù;<br> thus the fool thinks,<br> not realizing the danger.\""},
 {t:"\"As a mighty flood sweeps away a sleeping village,<br> death steals away a man<br> who dotes on children and cattle,<br> his mind caught up in them.\""},
 {t:"\"Children provide you no shelter,<br> nor does father, nor relatives.<br> When you‚Äôre seized by the terminator,<br> there‚Äôs no shelter in family.\""},
 {t:"\"Knowing the reason for this,<br> astute, and ethically restrained,<br> one would quickly clear the path<br> that leads to extinguishment.\""},
 {t:"\"If by giving up material happiness<br> one sees abundant happiness,<br> the attentive would give up material happiness,<br> seeing the abundant happiness.\""},
 {t:"\"Seeking their own happiness<br> by imposing suffering on others,<br> living intimate with enmity,<br> they‚Äôre not freed from enmity.\""},
 {t:"\"They dump what should be done,<br> and do what should not be done.<br> For the insolent and the negligent,<br> their defilements only grow.\""},
 {t:"\"Those that have properly undertaken<br> constant mindfulness of the body,<br> don‚Äôt cultivate what should not be done,<br> but always do what should be done.<br> Mindful and aware,<br> their defilements come to an end.\""},
 {t:"\"Having slain mother and father,<br> and two aristocratic kings,<br> and having wiped out<br> the kingdom with its tax collector,<br> the brahmin walks on untroubled.\""},
 {t:"\"Having slain mother and father,<br> and two prosperous kings,<br> and a tiger as the fifth,<br> the brahmin walks on untroubled.\""},
 {t:"\"The disciples of Gotama<br> always wake up refreshed,<br> who day and night<br> constantly recollect the Buddha.\""},
 {t:"\"The disciples of Gotama<br> always wake up refreshed,<br> who day and night<br> constantly recollect the teaching.\""},
 {t:"\"The disciples of Gotama<br> always wake up refreshed,<br> who day and night<br> constantly recollect the Sa·πÖgha.\""},
 {t:"\"The disciples of Gotama<br> always wake up refreshed,<br> who day and night<br> are constantly mindful of the body.\""},
 {t:"\"The disciples of Gotama<br> always wake up refreshed,<br> whose minds day and night<br> delight in harmlessness.\""},
 {t:"\"The disciples of Gotama<br> always wake up refreshed,<br> whose minds day and night<br> delight in meditation.\""},
 {t:"\"Going forth is hard, it‚Äôs hard to be happy;<br> life at home is hard too, and painful,<br> it‚Äôs painful to stay when you‚Äôve nothing in common.<br> A traveler is a prey to pain,<br> so don‚Äôt be a traveler,<br> don‚Äôt be prey to pain.\""},
 {t:"\"One who is faithful, accomplished in ethics,<br> blessed with fame and wealth,<br> is honored in whatever place<br> they frequent.\""},
 {t:"\"The good shine from afar,<br> like the Himalayan peaks,<br> but the wicked are not seen,<br> like arrows scattered in the night.\""},
 {t:"\"Sitting alone, sleeping alone,<br> tirelessly wandering alone;<br> one who tames themselves alone<br> would delight within a forest.\""},
 {t:"\"A liar goes to hell,<br> as does one who denies what they did.<br> Both are equal in the hereafter,<br> those men of base deeds.\""},
 {t:"\"Many who wear a scrap of ocher cloth<br> are unrestrained and wicked.<br> Being wicked, they are reborn in hell<br> due to their bad deeds.\""},
 {t:"\"It‚Äôd be better for the immoral and unrestrained<br> to eat an iron ball,<br> scorching, like a burning flame,<br> than to eat the nation‚Äôs alms.\""},
 {t:"\"Four things befall a heedless man<br> who sleeps with another‚Äôs wife:<br> wickedness, poor sleep,<br> ill-repute, and rebirth in hell.\""},
 {t:"\"He accrues wickedness and is reborn in a bad place,<br> all so a frightened couple<br> may snatch a moment‚Äôs pleasure,<br> for which rulers impose a heavy punishment.<br> That‚Äôs why a man should not<br> sleep with another‚Äôs wife.\""},
 {t:"\"When kusa grass is wrongly grasped<br> it only cuts the hand.<br> So too, the ascetic life, when wrongly taken,<br> drags you to hell.\""},
 {t:"\"Any lax act,<br> any corrupt observance,<br> or suspicious spiritual life,<br> is not very fruitful.\""},
 {t:"\"If one is to do what should be done,<br> one should staunchly strive.<br> For the life gone forth when laxly led<br> just stirs up dust all the more.\""},
 {t:"\"A bad deed is better left undone,<br> for it will plague you later on.<br> A good deed is better done,<br> one that does not plague you.\""},
 {t:"\"As a frontier city<br> is guarded inside and out,<br> so you should ward yourselves‚Äî<br> don‚Äôt let the moment pass you by.<br> For if you miss your moment<br> you‚Äôll grieve when sent to hell.\""},
 {t:"\"Unashamed of what is shameful,<br> ashamed of what is not shameful;<br> beings who uphold wrong view<br> go to a bad place.\""},
 {t:"\"Seeing danger where there is none,<br> and blind to the actual danger,<br> beings who uphold wrong view<br> go to a bad place.\""},
 {t:"\"Seeing fault where there is none,<br> and blind to the actual fault,<br> beings who uphold wrong view<br> go to a bad place.\""},
 {t:"\"Knowing a fault as a fault<br> and the faultless as faultless,<br> beings who uphold right view<br> go to a good place.\""},
 {t:"\"Like an elephant struck<br> with arrows in battle,<br> I shall withstand abuse,<br> for so many folk are badly behaved.\""},
 {t:"\"The well-tamed beast is the one led to the crowd;<br> the tamed elephant‚Äôs the one the king mounts;<br> the tamed person who withstands abuse<br> is the best of human beings.\""},
 {t:"\"Those who have tamed themselves are better<br> than fine tamed mules,<br> thoroughbreds from Sindh,<br> or giant tuskers.\""},
 {t:"\"For not on those mounts<br> would you go to the untrodden place,<br> whereas, with the help of one<br> whose self is well tamed,<br> you go there, tamed by the tamed.\""},
 {t:"\"The tusker named DhanapƒÅla<br> is musky in rut, hard to control.<br> Bound, he eats not a morsel,<br> for he misses the elephant forest.\""},
 {t:"\"One who gets drowsy from overeating,<br> fond of sleep, rolling round the bed<br> like a great hog stuffed with grain:<br> that dullard returns to the womb again and again.\""},
 {t:"\"In the past my mind wandered<br> how it wished, where it liked, as it pleased.<br> Now I‚Äôll carefully guide it,<br> as a trainer with a hook guides a rutting elephant.\""},
 {t:"\"Delight in diligence!<br> Take good care of your mind!<br> Pull yourself out of this pit,<br> like an elephant sunk in a bog.\""},
 {t:"\"If you find an alert companion,<br> an attentive friend to live happily together,<br> then, overcoming all adversities,<br> wander with them, joyful and mindful.\""},
 {t:"\"If you find no alert companion,<br> no attentive friend to live happily together,<br> then, like a king who flees his conquered realm,<br> wander alone like a tusker in the wilds.\""},
 {t:"\"It‚Äôs better to wander alone,<br> there‚Äôs no fellowship with fools.<br> Wander alone and do no wrong,<br> at ease like a tusker in the wilds.\""},
 {t:"\"A friend in need is a blessing;<br> it‚Äôs a blessing to be content with whatever;<br> good deeds are a blessing at the end of life,<br> and giving up all suffering is a blessing.\""},
 {t:"\"In this world it‚Äôs a blessing to serve<br> one‚Äôs mother and one‚Äôs father.<br> And it‚Äôs a blessing also to serve<br> ascetics and brahmins.\""},
 {t:"\"It‚Äôs a blessing to keep precepts until you grow old;<br> a blessing to be grounded in faith;<br> the getting of wisdom‚Äôs a blessing;<br> and it‚Äôs a blessing to avoid doing wrong.\""},
 {t:"\"When a man lives heedlessly,<br> craving grows in them like a camel‚Äôs foot creeper.<br> They jump from one thing to the next, like a langur<br> greedy for fruit in a forest grove.\""},
 {t:"\"Whoever is beaten by this wretched craving,<br> this attachment to the world,<br> their sorrow grows,<br> like grass in the rain.\""},
 {t:"\"But whoever prevails over this wretched craving,<br> so hard to get over in the world,<br> their sorrows fall from them,<br> like a drop from a lotus-leaf.\""},
 {t:"\"I say this to you, good people,<br> all those who have gathered here:<br> dig up the root of craving,<br> as you‚Äôd dig up grass in search of roots.<br> Don‚Äôt let MƒÅra break you again and again,<br> like a stream breaking a reed.\""},
 {t:"\"A tree grows back even when cut down,<br> so long as its roots are strong and undamaged;<br> suffering springs up again and again,<br> so long as the tendency to craving is not pulled out.\""},
 {t:"\"A person of low views<br> in whom the thirty-six streams<br> that flow to pleasure are mighty,<br> is swept away by lustful thoughts.\""},
 {t:"\"The streams flow everywhere;<br> a weed springs up and remains.<br> Seeing this weed that has been born,<br> cut the root with wisdom.\""},
 {t:"\"A personage‚Äôs joys<br> flow from senses and cravings.<br> Seekers of happiness, bent on pleasure,<br> continue to be reborn and grow old.\""},
 {t:"\"People governed by thirst,<br> crawl about like a trapped rabbit.<br> Bound and fettered, for a long time<br> they return to pain time and again.\""},
 {t:"\"People governed by thirst,<br> crawl about like a trapped rabbit.<br> That‚Äôs why one who longs for dispassion<br> should dispel thirst.\""},
 {t:"\"Unsnarled, they set out for the jungle,<br> then they run right back to the jungle they left behind.<br> Just look at this individual!<br> Freed, they run to bondage.\""},
 {t:"\"The attentive say that shackle is not strong<br> that‚Äôs made of iron, wood, or knots.<br> But obsession with jeweled earrings,<br> concern for your partners and children:\""},
 {t:"\"this, say the attentive, is a strong shackle<br> dragging the indulgent down, hard to escape.<br> Having cut this one too they go forth,<br> unconcerned, having given up sensual pleasures.\""},
 {t:"\"Besotted by lust they fall into the stream,<br> like a spider caught in the web she wove.<br> The attentive proceed, having cut this one too,<br> unconcerned, having given up all suffering.\""},
 {t:"\"Let go of the past, let go of the future,<br> let go of the present, having gone beyond rebirth.<br> With your heart freed in every respect,<br> you‚Äôll not come again to rebirth and old age.\""},
 {t:"\"For a personage churned by thoughts,<br> very lustful, focusing on beauty,<br> their craving grows and grows,<br> tying them with a stout bond.\""},
 {t:"\"But one who loves to calm their thoughts,<br> developing perception of ugliness, ever mindful,<br> will surely eliminate that craving,<br> cutting off the bonds of MƒÅra.\""},
 {t:"\"One who is confident, unafraid,<br> rid of craving, free of blemish,<br> having struck down the arrows flying to future lives,<br> this bag of bones is their last.\""},
 {t:"\"Rid of craving, free of grasping,<br> expert in the definition of terms,<br> knowing the correct<br> structure and sequence of syllables,<br> they are said to be one who bears their final body,<br> one of great wisdom, a great person.\""},
 {t:"\"I am the champion, the knower of all,<br> unsullied in the midst of all things.<br> I‚Äôve given up all, freed in the ending of craving.<br> Since I know for myself, whose follower should I be?\""},
 {t:"\"The gift of the teaching surmounts all other gifts;<br> the taste of the teaching surmounts all other tastes;<br> the joy of the teaching surmounts all other joys;<br> the ending of craving surmounts all suffering.\""},
 {t:"\"Riches ruin a simpleton,<br> but not a seeker of the far shore.<br> From craving for wealth, a simpleton<br> ruins themselves and others.\""},
 {t:"\"Weeds are the bane of crops,<br> but greed is these folk‚Äôs bane.<br> That‚Äôs why a gift to one rid of greed<br> is so very fruitful.\""},
 {t:"\"Weeds are the bane of crops,<br> but hate is these folk‚Äôs bane.<br> That‚Äôs why a gift to one rid of hate<br> is so very fruitful.\""},
 {t:"\"Weeds are the bane of crops,<br> but delusion is these folk‚Äôs bane.<br> That‚Äôs why a gift to one rid of delusion<br> is so very fruitful.\""},
 {t:"\"Weeds are the bane of crops,<br> but desire is these folk‚Äôs bane.<br> That‚Äôs why a gift to one rid of desire<br> is so very fruitful.\""},
 {t:"\"Restraint of the eye is good;<br> good is restraint of the ear;<br> restraint of the nose is good;<br> good is restraint of the tongue.\""},
 {t:"\"Restraint of the body is good;<br> good is restraint of speech;<br> restraint of mind is good;<br> everywhere, restraint is good.<br> The mendicant restrained everywhere<br> is released from all suffering.\""},
 {t:"\"One restrained in hand and foot,<br> and in speech, the supreme restraint;<br> happy inside, serene,<br> solitary, content, I call a mendicant.\""},
 {t:"\"When a mendicant of restrained mouth,<br> thoughtful in counsel, not restless,<br> explains the text and its meaning,<br> their words are sweet.\""},
 {t:"\"Delighting in the teaching, enjoying the teaching,<br> contemplating the teaching,<br> a mendicant who recollects the teaching<br> doesn‚Äôt fall away from the true teaching.\""},
 {t:"\"A well-off mendicant ought not look down<br> on others, nor should they be envious.<br> A mendicant who envies others<br> does not achieve immersion.\""},
 {t:"\"If a mendicant is poor in offerings,<br> the well-to-do ought not look down on them.<br> For the gods indeed praise them,<br> who are tireless and pure of livelihood.\""},
 {t:"\"One who has no sense of ownership<br> in the whole realm of name and form,<br> who does not grieve for that which is not,<br> is said to be a mendicant.\""},
 {t:"\"A mendicant who meditates on love,<br> devoted to the Buddha‚Äôs teaching,<br> would realize the peaceful state,<br> the blissful stilling of conditions.\""},
 {t:"\"Bail out this boat, mendicant!<br> When bailed out it will float lightly.<br> Having cut off desire and hate,<br> you shall reach extinguishment.\""},
 {t:"\"Five to cut, five to drop,<br> and five more to develop.<br> When a mendicant slips five chains<br> they‚Äôre said to have crossed the flood.\""},
 {t:"\"Practice absorption, don‚Äôt be negligent!<br> Don‚Äôt let the mind delight in the senses!<br> Don‚Äôt heedlessly swallow a hot iron ball!<br> And when it burns, don‚Äôt cry, ‚ÄúOh, the pain!‚Äù\""},
 {t:"\"No absorption for one without wisdom,<br> no wisdom for one without absorption.<br> But one with absorption and wisdom‚Äî<br> they have truly drawn near to extinguishment.\""},
 {t:"\"A mendicant who enters an empty hut<br> with mind at peace<br> finds a superhuman delight<br> as they rightly discern the Dhamma.\""},
 {t:"\"Whenever they are mindful<br> of the rise and fall of the aggregates,<br> they feel rapture and joy:<br> that is freedom from death for one who knows.\""},
 {t:"\"This is the very start of the path<br> for a wise mendicant:<br> guarding the senses, contentment,<br> and restraint in the monastic code.\""},
 {t:"\"Mix with spiritual friends,<br> who are tireless and pure of livelihood.<br> Share what you have with others,<br> being skillful in your conduct.<br> And when you‚Äôre full of joy,<br> you‚Äôll make an end to suffering.\""},
 {t:"\"As a jasmine sheds<br> its withered flowers,<br> O mendicants,<br> shed greed and hate.\""},
 {t:"\"Calm in body, calm in speech,<br> peaceful and serene;<br> a mendicant who‚Äôs spat out the world‚Äôs bait<br> is said to be one at peace.\""},
 {t:"\"Urge yourself on,<br> reflect on yourself.<br> A mendicant self-controlled and mindful<br> will always dwell in happiness.\""},
 {t:"\"Self is indeed the lord of self,<br> for who else would be one‚Äôs lord?<br> Self is indeed the home of self,<br> so restrain yourself,<br> as a merchant his thoroughbred steed.\""},
 {t:"\"A monk full of joy<br> trusting in the Buddha‚Äôs teaching,<br> would realize the peaceful state,<br> the blissful stilling of conditions.\""},
 {t:"\"A young mendicant<br> devoted to the Buddha‚Äôs teaching,<br> lights up the world,<br> like the moon freed from clouds.\""},
 {t:"\"Cut the stream, striving!<br> Cast aside sensual pleasures, brahmin.<br> Knowing the ending of conditions,<br> know the uncreated, brahmin.\""},
 {t:"\"When a brahmin has gone beyond<br> dualistic phenomena,<br> then they consciously<br> make an end of all fetters.\""},
 {t:"\"One for whom there is no crossing over<br> or crossing back, or crossing over and back;<br> stress-free, detached,<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"Absorbed, rid of hopes,<br> their task completed, without defilements,<br> arrived at the highest goal:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"The sun blazes by day,<br> the moon radiates at night,<br> the aristocrat shines in armor,<br> and the brahmin shines in absorption.<br> But all day and all night,<br> the Buddha blazes with glory.\""},
 {t:"\"A brahmin‚Äôs so-called<br> since they‚Äôve banished evil,<br> an ascetic‚Äôs so-called<br> since they live a serene life.<br> One who has renounced all stains<br> is said to be a ‚Äúrenunciant‚Äù.\""},
 {t:"\"One should never strike a brahmin,<br> nor should a brahmin retaliate.<br> Woe to the one who hurts a brahmin,<br> and woe for the one who retaliates.\""},
 {t:"\"Nothing is better for a brahmin<br> than to hold their mind back from attachment.<br> From wherever a cruel wish recoils,<br> right there suffering subsides.\""},
 {t:"\"Who does nothing wrong<br> by body, speech or mind,<br> restrained in these three respects,<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"You should graciously honor<br> the one from whom you learn the Dhamma<br> taught by the awakened Buddha,<br> as a brahmin honors the sacred flame.\""},
 {t:"\"Not by matted hair or family,<br> or birth is one a brahmin.<br> Those who are truthful and principled:<br> they are pure, they are brahmins.\""},
 {t:"\"Why the matted hair, you simpleton,<br> and why the skin of deer?<br> The tangle is inside you,<br> yet you polish up your outsides.\""},
 {t:"\"A personage who wears robes of rags,<br> lean, their limbs showing veins,<br> meditating alone in the forest,<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"I don‚Äôt call someone a brahmin<br> after the mother‚Äôs womb they‚Äôre born from.<br> If they still have attachments,<br> they‚Äôre just someone who says ‚Äúworthy‚Äù.<br> Having nothing, taking nothing:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"Having cut off all fetters<br> they have no anxiety.<br> They‚Äôve slipped their chains and are detached:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"They‚Äôve cut the strap and harness,<br> the halter and bridle too,<br> with cross-bar lifted, they‚Äôre awakened:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"Abuse, killing, caging:<br> they withstand these without anger.<br> Patience is their powerful army:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"Not irritable or pretentious,<br> dutiful in precepts and observances,<br> tamed, bearing their final body:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"Like water from a lotus leaf,<br> like a mustard seed off a pin-point,<br> sensual pleasures slip off them:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"They understand for themselves<br> the end of suffering in this life;<br> with burden put down, detached:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"Deep in wisdom, intelligent,<br> expert in the path and what is not the path;<br> arrived at the highest goal:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"Mixing with neither<br> householders nor the homeless;<br> a migrant with no bastion, few in wishes:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"They‚Äôve laid aside violence<br> against creatures firm and frail;<br> not killing or making others kill:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"Not fighting among those who fight,<br> quenched among those who have taken up arms,<br> not grasping among those who grasp:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"They‚Äôve discarded greed and hate,<br> along with conceit and contempt,<br> like a mustard seed off the point of a pin:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"The words they utter<br> are polished, informative, and true,<br> and don‚Äôt offend anyone:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"They don‚Äôt steal anything in the world,<br> long or short,<br> fine or coarse, beautiful or ugly:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"They have no hope<br> in this world or the next;<br> with no need for hope, detached:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"They have no clinging,<br> knowledge has freed them of indecision,<br> they‚Äôve arrived at the objective, freedom from death:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"They‚Äôve escaped clinging<br> to both good and bad deeds;<br> sorrowless, stainless, pure:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"Pure as the spotless moon,<br> clear and undisturbed,<br> they‚Äôve ended relish for rebirth:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"They‚Äôve got past this grueling swamp<br> of delusion, transmigration.<br> Meditating in stillness, free of indecision,<br> they have crossed over to the far shore.<br> They‚Äôre quenched by not grasping:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"They‚Äôve given up sensual stimulations,<br> and have gone forth from lay life;<br> they‚Äôve ended rebirth in the sensual realm:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"They‚Äôve given up craving,<br> and have gone forth from lay life;<br> they‚Äôve ended craving to be reborn:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"They‚Äôve given up craving,<br> and have gone forth from lay life;<br> they‚Äôve ended craving to be reborn:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"They‚Äôve thrown off the human yoke,<br> and slipped out of the heavenly yoke;<br> unyoked from all yokes:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"Giving up desire and discontent,<br> they‚Äôre cooled and free of attachments;<br> a hero, master of the whole world:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"They know the passing away<br> and rebirth of all beings;<br> unattached, holy, awakened:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"Gods, centaurs, and humans<br> don‚Äôt know their destiny;<br> the perfected ones with defilements ended:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"They have nothing before or after,<br> or even in between.<br> Having nothing, taking nothing:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"Captain of the herd, excellent hero,<br> great seer and victor;<br> unstirred, washed, awakened:<br> that‚Äôs who I declare a brahmin.\""},
 {t:"\"One who knows their past lives,<br> sees heaven and places of loss,<br> and has attained the end of rebirth;<br> a sage of perfect insight<br> at the summit of spiritual perfection:<br> that‚Äôs who I declare a brahmin.\""},
];
		
        Chart.defaults.color = '#9ca3af';
        Chart.defaults.borderColor = '#374151';

        class GoalTracker {
            constructor() {
                // LOAD DATA SAFELY
                try {
                    this.data = JSON.parse(localStorage.getItem('chronoData'));
                } catch(e) {
                    console.error("Data corrupted", e);
                    this.data = null;
                }

                // If no data or corrupted structure, init defaults
                if (!this.data || !Array.isArray(this.data.goals)) {
                    this.data = {
                        goals: [],
                        logs: [],
                        xp: 0,
                        streak: 0,
                        globalDailyGoal: 120,
                        achievements: []
                    };
                }
                
                // MIGRATION / SANITY CHECK
                this.data.goals.forEach(goal => {
                    if (!goal.type) goal.type = 'standard'; 
                    if (!goal.sessionTargetSeconds) goal.sessionTargetSeconds = 0;
                    if (!goal.remainingSeconds) goal.remainingSeconds = 0;
                    if (typeof goal.dailyTargetMinutes === 'undefined') goal.dailyTargetMinutes = 30;
                    if (goal.type === 'meditation' && !goal.currentMindfulness) goal.currentMindfulness = 0;
                    if (goal.type === 'meditation' && !goal.totalMindfulness) goal.totalMindfulness = 0;
                });
                
                if (!this.data.globalDailyGoal) this.data.globalDailyGoal = 120;
                if (!this.data.achievements) this.data.achievements = [];
                if (!this.data.logs) this.data.logs = [];

                this.timers = {}; 
                this.today = new Date();
                this.currentMonth = new Date(this.today.getFullYear(), this.today.getMonth(), 1); 
                this.currentWeekStart = this.getStartOfWeek(this.today); 
                this.charts = { weekly: null, breakdown: null, monthly: null, dayChart: null, session: null };
                this.reportMode = 'time'; // M·∫∑c ƒë·ªãnh l√† xem th·ªùi gian
                this.meditationState = {
                    active: false, paused: false, goalId: null, count: 0,
                    startTime: null, timerRef: null, remainingSeconds: 0,
                    totalDurationSeconds: 0, touches: [] 
                };
this.currentViewDate = null; // Bi·∫øn nh·ªõ ng√†y ƒëang xem trong modal
this.dayChartMode = 'time';  // Ch·∫ø ƒë·ªô m·∫∑c ƒë·ªãnh c·ªßa modal
                this.init();
            }
  openIntroModal() {
        const modal = document.getElementById('intro-modal');
        if (modal) modal.style.display = 'flex';
    }

closeIntroModal() {
    document.getElementById('intro-modal').style.display = 'none';
    localStorage.setItem('intro_seen', 'true'); // Save so it doesn't pop up every time
}          
           // Fix: Week starts on Monday
            getStartOfWeek(date) {
                const d = new Date(date);
                const day = d.getDay() || 7; // CN=0 ƒë·ªïi th√†nh 7, T2=1 gi·ªØ nguy√™n
                const diff = d.getDate() - day + 1; // Lui v·ªÅ ng√†y 1 (Th·ª© Hai)
                return new Date(d.getFullYear(), d.getMonth(), diff);
            }
renderAnalytics() {
    const range = parseInt(document.getElementById('ana-time-range').value) || 7;
    const ctxTrend = document.getElementById('analyticsTrendChart').getContext('2d');
    const goalSelect = document.getElementById('ana-goal-select');
    const thresholdInput = document.getElementById('ana-threshold');
	   

	   const medGoals = this.data.goals.filter(g => g.type === 'meditation');
    
    if (medGoals.length === 0) {
        document.getElementById('ana-comparison-table').innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">There is no meditation goals.</td></tr>';
        return;
    }

    // 2. Populate Dropdown (if needed or empty)
    // We rebuild it if the number of options doesn't match data (simple sync check)
    if (goalSelect.options.length !== medGoals.length) {
        const currentVal = goalSelect.value;
        goalSelect.innerHTML = '';
        medGoals.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.id;
            opt.innerText = g.name;
            goalSelect.appendChild(opt);
        });
        // Restore selection or select first
        if (currentVal && medGoals.find(g => g.id === currentVal)) {
            goalSelect.value = currentVal;
        } else {
            goalSelect.value = medGoals[0].id;
        }
    }

    // 3. Get Selected Goal Data
    const selectedGoalId = goalSelect.value;
    const selectedGoal = this.data.goals.find(g => g.id === selectedGoalId);
    
    // 4. Load Specific Threshold
    // Default to 12s if not set in the goal yet
    const currentThreshold = selectedGoal.threshold || 12;
    thresholdInput.value = currentThreshold;
	

    // 5. Filter Logs for THIS GOAL ONLY within Time Range
    const now = Date.now();
    const cutoff = now - (range * 24 * 60 * 60 * 1000);
    
    const logs = this.data.logs
        .filter(l => l.goalId === selectedGoalId && l.timestamp >= cutoff)
        .sort((a, b) => a.timestamp - b.timestamp);

    if (logs.length === 0) {
        if(this.charts.analyticsTrend) this.charts.analyticsTrend.destroy();
        document.getElementById('ana-avg-quality').innerText = "---";
        document.getElementById('ana-avg-density').innerText = "---";
        document.getElementById('ana-total-mindful').innerText = "---";
        // Translated Empty State Message
        document.getElementById('ana-comparison-table').innerHTML = '<tr><td colspan="5" style="padding:20px; text-align:center;">No meditation data found for this period.</td></tr>';
        return;
    }

    // 6. Process Logs using the GOAL SPECIFIC Threshold
    let totalTimeSec = 0;
    let totalDistractedSec = 0;
    let totalTouches = 0;
    
    const sessionData = logs.map(log => {
        // Pass the threshold explicitly
        const result = this.analyzeSingleSession(log, currentThreshold);
        
        totalTimeSec += log.minutes * 60;
        totalDistractedSec += result.distractedSec;
        const count = log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0);
        totalTouches += count;
        
               return {
            date: new Date(log.timestamp).toLocaleDateString('en-GB', {day: '2-digit', month:'2-digit'}),
            quality: result.qualityPct,
            density: log.minutes > 0 ? (count / log.minutes).toFixed(1) : 0
        };
    });

// 7. Update Summary Cards
    // Prevent divide by zero
    const avgQuality = totalTimeSec > 0 ? ((1 - (totalDistractedSec / totalTimeSec)) * 100).toFixed(1) : 0;
    const avgDensity = totalTimeSec > 0 ? (totalTouches / (totalTimeSec / 60)).toFixed(1) : 0;
    const mindfulSeconds = Math.max(0, totalTimeSec - totalDistractedSec);
    const mindfulHours = (mindfulSeconds / 3600).toFixed(1);

    document.getElementById('ana-avg-quality').innerText = `${avgQuality}%`;
    document.getElementById('ana-avg-density').innerText = avgDensity;
    document.getElementById('ana-total-mindful').innerText = `${mindfulHours}h`;

    // 8. Render Trend Chart
    if (this.charts.analyticsTrend) this.charts.analyticsTrend.destroy();

    // Downsampling logic
    let chartData = sessionData;
    const maxPoints = 15;
    if (sessionData.length > maxPoints) {
        chartData = [];
        const step = (sessionData.length - 1) / (maxPoints - 1);
        for (let i = 0; i < maxPoints; i++) {
            const index = Math.round(i * step);
            chartData.push(sessionData[index]);
        }
    }

    this.charts.analyticsTrend = new Chart(ctxTrend, {
        type: 'line',
        data: {
            labels: chartData.map(d => d.date),
            datasets: [
                {
                    label: 'Quality (%)', // Translated
                    data: chartData.map(d => d.quality),
                    borderColor: '#34d399',
                    backgroundColor: 'rgba(52, 211, 153, 0.1)',
                    yAxisID: 'y',
                    fill: true,
                    tension: 0.3
                },
                {
                    label: 'Mindfulness', // Translated
                    data: chartData.map(d => d.density),
                    borderColor: '#818cf8',
                    borderDash: [5, 5],
                    yAxisID: 'y1',
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
			plugins: {  
        tooltip: {
            titleColor: '#f3f4f6',
            bodyColor: '#f3f4f6',
            borderColor: '#374151',
            borderWidth: 1,
            padding: 10,
            displayColors: true, // Shows the square box
            
            callbacks: {
                // THIS FIXES THE HOVER BOX COLOR
                labelColor: function(context) {
                    const dataset = context.dataset;
                    return {
                        borderColor: dataset.borderColor,
                        backgroundColor: dataset.borderColor, // FORCES SOLID COLOR IN HOVER BOX
                        borderWidth: 0,
                        borderRadius: 2,
                    };
                }
            }
        }
    },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    min: 0, max: 100,
                    title: { display: true, text: 'Quality %' }, // Translated
                    grid: { color: '#374151' }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: { drawOnChartArea: false },
                    title: { display: true, text: 'Mindfulness / Min' } // Translated
                }
            }
        }
    });

    this.renderComparisonTable([selectedGoalId], currentThreshold);
}
saveThreshold(val) {
    const goalSelect = document.getElementById('ana-goal-select');
    const selectedGoalId = goalSelect.value;
    
    if (!selectedGoalId) return;

    const goal = this.data.goals.find(g => g.id === selectedGoalId);
    if (goal) {
        goal.threshold = parseInt(val);
        this.save();
        this.renderAnalytics(); // Re-calc with new threshold
        this.showToast("Threshold updated: " + val + "s");
    }
}
// If gap > threshold (20s), assume mind wandered.
analyzeSingleSession(log, thresholdOverride = null) {
    // Basic fallback if no touches data
    if (!log.touches || log.touches.length < 2) {
        return { distractedSec: log.minutes * 60 * 0.5, qualityPct: 50 };
    }

    const sortedTouches = [...log.touches].sort((a,b) => a - b);
    
    // Use override if provided, else check DOM, else default 12
    let thresholdSec;
    if (thresholdOverride) {
        thresholdSec = thresholdOverride;
    } else {
        thresholdSec = parseInt(document.getElementById('ana-threshold').value) || 12; 
    }
    
    let distractedSec = 0;

    // Check gap from Start to First Touch
    const startGap = (sortedTouches[0] - log.timestamp) / 1000;
    if (startGap > thresholdSec) distractedSec += (startGap - thresholdSec/2);

    // Check gaps between touches
    for (let i = 1; i < sortedTouches.length; i++) {
        const gap = (sortedTouches[i] - sortedTouches[i-1]) / 1000;
        if (gap > thresholdSec) {
            distractedSec += (gap - thresholdSec/2);
        }
    }

    // Check gap from Last Touch to End
    const endTime = log.timestamp + (log.minutes * 60 * 1000);
    const endGap = (endTime - sortedTouches[sortedTouches.length - 1]) / 1000;
    if (endGap > thresholdSec) distractedSec += (endGap - thresholdSec/2);

    // Cap distracted seconds to total minutes
    const totalSec = log.minutes * 60;
    distractedSec = Math.min(distractedSec, totalSec);
    
    const qualityPct = ((totalSec - distractedSec) / totalSec) * 100;
    
    return { distractedSec, qualityPct: parseFloat(qualityPct.toFixed(1)) };
}

renderComparisonTable(medGoalIds, threshold) {
    const tbody = document.getElementById('ana-comparison-table');
    tbody.innerHTML = '';

    const now = new Date();
    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
    
    // 1. Yesterday Calculation
    const startOfYesterday = todayStart - (24 * 60 * 60 * 1000);
	const startOfDaybefore = todayStart - (48 * 60 * 60 * 1000);
    
    // 2. Start of This Week (Monday)
    const dayOfWeek = now.getDay(); 
    const diffToMonday = (dayOfWeek === 0 ? 6 : dayOfWeek - 1);
    const startOfThisWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - diffToMonday).getTime();
    const startOfLastWeek = startOfThisWeek - (7 * 24 * 60 * 60 * 1000);
    const startOfWeekBefore = startOfThisWeek - (14 * 24 * 60 * 60 * 1000);
    // 3. Start of This Month
    const startOfThisMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
    const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1).getTime();
	const startOfMonthBefore = new Date(now.getFullYear(), now.getMonth() - 2, 1).getTime();
    // 4. Period Definitions
    const periods = [
        { label: 'Today', start: todayStart, end: Date.now() },
        { label: 'Yester&#8203;day', start: startOfYesterday, end: todayStart },
		{ label: 'Day Before', start: startOfDaybefore, end: startOfYesterday },
        { label: 'This Week', start: startOfThisWeek, end: Date.now() },
        { label: 'Last Week', start: startOfLastWeek, end: startOfThisWeek },
		{ label: 'Week Before', start: startOfWeekBefore, end: startOfLastWeek },
        { label: 'This Month', start: startOfThisMonth, end: Date.now() },
        { label: 'Last Month', start: startOfLastMonth, end: startOfThisMonth },
		{ label: 'Month Before', start: startOfMonthBefore, end: startOfLastMonth }
    ];

    periods.forEach(p => {
        // Pass the threshold to getStatsForRange
        const stats = this.getStatsForRange(p.start, p.end, medGoalIds, threshold);
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid var(--border)';
        
        let qualityColor = 'var(--text)';
        if(stats.count > 0) {
            if(stats.quality > 80) qualityColor = 'var(--success)';
            else if(stats.quality < 50) qualityColor = 'var(--danger)';
        }

        row.innerHTML = `
            <td style="padding: 12px 10px; font-weight: 500;">${p.label}</td>
            <td style="padding: 12px 10px; text-align: center;">${stats.count}</td>
            <td style="padding: 12px 10px; text-align: center;">${(stats.minutes/60).toFixed(1)}h</td>
            <td style="padding: 12px 10px; text-align: center; color: ${qualityColor}; font-weight:bold;">${stats.count > 0 ? stats.quality + '%' : '-'}</td>
            <td style="padding: 12px 10px; text-align: center;">${stats.count > 0 ? stats.density : '-'}</td>
        `;
        tbody.appendChild(row);
    });
}

// Helper method to filter by exact timestamp range
getStatsForRange(startTime, endTime, goalIds, threshold) {
    const logs = this.data.logs.filter(l => 
        goalIds.includes(l.goalId) && 
        l.timestamp >= startTime && 
        l.timestamp < endTime
    );

    if (logs.length === 0) return { count: 0, minutes: 0, quality: 0, density: 0 };

    let totalMinutes = 0;
    let totalTouches = 0;
    let weightedQualitySum = 0;

    logs.forEach(l => {
        totalMinutes += l.minutes;
        const count = l.count !== undefined ? l.count : (l.touches ? l.touches.length : 0);
        totalTouches += count;
        // Pass threshold here
        const analysis = this.analyzeSingleSession(l, threshold);
        weightedQualitySum += (l.minutes * analysis.qualityPct);
    });

    return {
        count: logs.length,
        minutes: totalMinutes,
        quality: (weightedQualitySum / totalMinutes).toFixed(1),
        density: (totalTouches / totalMinutes).toFixed(1)
    };
}
            init() {
                try {
                    this.renderDate();
                    this.renderGoals();
                    this.updateStats();
                    this.checkAchievements();
                    this.renderCalendar();
                    setInterval(() => this.updateTimerUI(), 1000);

                    const medOverlay = document.getElementById('meditation-overlay');
                    if(medOverlay) {
                        medOverlay.addEventListener('pointerdown', (e) => {
                            if(e.target.closest('.med-controls')) return;
                            this.handleMeditationTouch();
                        });
                    }
                } catch (err) {
                    console.error("Error during init:", err);
                    alert("App failed to initialize. Try resetting data via the sidebar button.");
                }
				if (!localStorage.getItem('intro_seen')) {
        this.openIntroModal();
    }
	const savedThreshold = localStorage.getItem('ana_threshold');
if (savedThreshold) {
    document.getElementById('ana-threshold').value = savedThreshold;
}
            }

            save() {
                localStorage.setItem('chronoData', JSON.stringify(this.data));
                this.updateStats();
            }
get totalMindfulnessCounts() {
    return this.data.logs.reduce((sum, log) => {
        // Fix: Check for manual 'count' first, fallback to 'touches' length
        return sum + (log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0));
    }, 0);
}			
            // --- AUDIO HELPER ---
            playBell() {
                const audio = document.getElementById('bell');
                if (audio) {
                    audio.currentTime = 0;
                    audio.play().catch(e => console.log("Audio play failed (autoplay blocked):", e));
                }
            }
            // --- Goal Management ---
            saveGoal(e) {
                e.preventDefault();
                const id = document.getElementById('g-id').value;
                const type = document.getElementById('g-type').value || 'standard';
                const name = document.getElementById('g-name').value;
                const category = document.getElementById('g-cat').value;
                const color = document.getElementById('g-color').value;
                const lifetimeTarget = parseInt(document.getElementById('g-lifetime-target').value);
                const dailyTarget = parseInt(document.getElementById('g-daily-target').value);

                if (id) {
                    const goal = this.data.goals.find(g => g.id === id);
                    if (goal) {
                        goal.name = name; goal.category = category; goal.color = color;
                        goal.lifetimeTargetMinutes = lifetimeTarget; goal.dailyTargetMinutes = dailyTarget;
                        this.showToast('Goal Updated!');
                    }
                } else {
                    const newGoal = {
                        id: Date.now().toString(), type, name, category, color,
                        lifetimeTargetMinutes: lifetimeTarget, dailyTargetMinutes: dailyTarget || 0,
                        totalMinutes: 0, totalMindfulness: 0, sessionTargetSeconds: 0,
                        remainingSeconds: 0, currentSessionStartTime: null, isActive: false
                    };
                    this.data.goals.push(newGoal);
                    this.showToast('Goal Created!');
                }
                this.save();
                this.renderGoals();
                this.closeModal();
            }

            setGlobalDailyGoal() {
                const current = this.data.globalDailyGoal || 120;
                const input = prompt("Enter Total Daily Target (mins):", current);
                if (input && !isNaN(input) && parseInt(input) > 0) {
                    this.data.globalDailyGoal = parseInt(input);
                    this.save();
                    this.showToast("Updated!");
                }
            }

toggleTimer(id) {
    const goal = this.data.goals.find(g => g.id === id);
    if (!goal) return;

    // Stop other timers if running
    this.data.goals.forEach(g => {
        if(g.isActive && g.id !== id && g.type === 'standard') this.toggleTimer(g.id); 
    });

    if (goal.type === 'meditation') {
        this.startMeditationSetup(goal);
        return;
    }

    if (goal.isActive) {
        clearInterval(this.timers[id]);
        goal.isActive = false;
        const spentSeconds = goal.sessionTargetSeconds - goal.remainingSeconds;
        const minutesSpent = Math.floor(spentSeconds / 60);
        const startTime = goal.currentSessionStartTime || Date.now();
        goal.sessionTargetSeconds = 0; goal.remainingSeconds = 0; goal.currentSessionStartTime = null;
        if (minutesSpent > 0) this.openSessionModal(id, minutesSpent, null, startTime);
        else this.showToast('Session too short.');
    } else {
        // --- MODIFIED CODE STARTS HERE ---
        // Use saved duration or default to 20
        const defaultTime = goal.lastDuration || '20'; 
        const minStr = prompt('Duration (mins):', defaultTime);
        
        if (!minStr) return;
        const min = parseInt(minStr);
        if (isNaN(min) || min <= 0) return;

        // Save this duration for next time
        goal.lastDuration = min; 
        this.save(); // Save to local storage immediately
        // --- MODIFIED CODE ENDS HERE ---

        goal.sessionTargetSeconds = min * 60;
        goal.remainingSeconds = goal.sessionTargetSeconds;
        goal.isActive = true;
        goal.currentSessionStartTime = Date.now(); 

        this.timers[id] = setInterval(() => {
            if (goal.remainingSeconds > 0) {
                goal.remainingSeconds--;
            } else {
                // TIMER FINISHED LOGIC
                clearInterval(this.timers[id]);
                this.playBell(); // Play sound
                
                goal.isActive = false;
                const minutesSpent = Math.floor(goal.sessionTargetSeconds / 60);
                const startTime = goal.currentSessionStartTime;
                goal.sessionTargetSeconds = 0; goal.remainingSeconds = 0; goal.currentSessionStartTime = null;
                this.openSessionModal(id, minutesSpent, null, startTime);
                this.showToast('Complete!');
                this.renderGoals(); 
            }
        }, 1000);
    }
    this.renderGoals();
}
            
            // --- MEDITATION LOGIC ---
startMeditationSetup(goal) {
    // --- MODIFIED CODE STARTS HERE ---
    // Use saved duration or default to 20
    const defaultTime = goal.lastDuration || '20';
    const minStr = prompt('Meditation duration (mins):', defaultTime);
    
    if (!minStr) return;
    const min = parseInt(minStr);
    if (isNaN(min) || min <= 0) return;

    // Save this duration for next time
    goal.lastDuration = min;
    this.save(); // Save to local storage immediately
    // --- MODIFIED CODE ENDS HERE ---
    
    if (typeof Website2APK !== 'undefined') {
        Website2APK.keepScreenOn(true); 
    }

    this.meditationState = {
        active: true, paused: false, goalId: goal.id, count: 0,
        startTime: Date.now(), totalDurationSeconds: min * 60,
        remainingSeconds: min * 60, touches: [],
        quoteInterval: null // Initialize quoteInterval
    };

    document.getElementById('meditation-overlay').style.display = 'flex';
    document.getElementById('med-counter').innerText = '0';
    this.updateMedTimerDisplay();

    // --- NEW CODE START: Initial Quote & Interval ---
    this.updateMeditationQuote(true); // Show first quote immediately
    this.meditationState.quoteInterval = setInterval(() => {
        if(!this.meditationState.paused) {
            this.updateMeditationQuote(false);
        }
    }, 8000); // 8 seconds per quote
    // --- NEW CODE END ---

    this.meditationState.timerRef = setInterval(() => {
        if (!this.meditationState.paused) {
            if (this.meditationState.remainingSeconds > 0) {
                this.meditationState.remainingSeconds--;
                this.updateMedTimerDisplay();
            } else {
                this.concludeMeditationSession('auto');
            }
        }
    }, 1000);
}

            updateMedTimerDisplay() {
                const s = this.meditationState.remainingSeconds;
                const m = Math.floor(s / 60);
                const sec = s % 60;
                document.getElementById('med-timer').innerText = `${m}:${sec.toString().padStart(2, '0')}`;
            }

            handleMeditationTouch() {
                if (!this.meditationState.active || this.meditationState.paused) return;
                this.meditationState.count++;
                this.meditationState.touches.push(Date.now());
                const el = document.getElementById('med-counter');
                el.innerText = this.meditationState.count;
            }

            togglePauseMeditation() {
                this.meditationState.paused = !this.meditationState.paused;
                const btn = document.getElementById('med-pause-btn');
                btn.innerHTML = this.meditationState.paused ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';
            }
        updateMeditationQuote(isFirstTime = false) {
    const container = document.getElementById('med-quote-container');
    const txt = document.getElementById('med-quote-text');

    if (isFirstTime) {
        // L·∫ßn ƒë·∫ßu: Hi·ªÉn th·ªã ngay l·∫≠p t·ª©c, kh√¥ng delay
        const randomItem = DHAMMAPADA[Math.floor(Math.random() * DHAMMAPADA.length)];
        txt.innerHTML = randomItem.t;
        container.style.opacity = '1';
    } else {
        // C√°c l·∫ßn sau: Fade out -> Ch·ªù 1s -> ƒê·ªïi ch·ªØ -> Fade in
        container.style.opacity = '0';
        setTimeout(() => {
            const randomItem = DHAMMAPADA[Math.floor(Math.random() * DHAMMAPADA.length)];
            txt.innerHTML = randomItem.t;
            container.style.opacity = '1';
        }, 1000);
    }
}   
            // NEW: Conclude session and show Notes modal (instead of auto-saving)
concludeMeditationSession(type = 'manual') {
    clearInterval(this.meditationState.timerRef);
	
	// --- NEW CODE: Clear Quote Interval ---
    if (this.meditationState.quoteInterval) {
        clearInterval(this.meditationState.quoteInterval);
    }
    // --------------------------------------
    if (typeof Website2APK !== 'undefined') {
        Website2APK.keepScreenOn(false); 
    }
    // Only play the bell if the timer finished on its own
    if (type === 'auto') {
        this.playBell();
    }
    
    document.getElementById('meditation-overlay').style.display = 'none';
    
    const durationSeconds = this.meditationState.totalDurationSeconds - this.meditationState.remainingSeconds;
    const minutes = Math.ceil(durationSeconds / 60);
    
    if (minutes <= 0) {
        this.showToast("Phi√™n qu√° ng·∫Øn");
        this.meditationState.active = false;
        return;
    }
    
    document.getElementById('med-finish-count').innerText = this.meditationState.count;
    document.getElementById('med-finish-time').innerText = minutes + 'm';
    document.getElementById('med-finish-notes').value = '';
    document.getElementById('meditation-finish-modal').style.display = 'flex';
}
            
            discardMeditation() {
                document.getElementById('meditation-finish-modal').style.display = 'none';
                this.meditationState.active = false;
                this.showToast("Session Discarded");
            }

            saveMeditationLog() {
                // Get data from state
                const durationSeconds = this.meditationState.totalDurationSeconds - this.meditationState.remainingSeconds;
                const minutes = Math.ceil(durationSeconds / 60);
                const notes = document.getElementById('med-finish-notes').value;

                const goal = this.data.goals.find(g => g.id === this.meditationState.goalId);
                const log = {
                    goalId: goal.id,
                    date: this.toIsoDate(new Date(this.meditationState.startTime)),
                    timestamp: this.meditationState.startTime,
                    minutes: minutes,
                    notes: `Mindfulness: ${this.meditationState.count}. ${notes}`, // Combine count and notes
                    touches: this.meditationState.touches
                };

                this.data.logs.push(log);
                goal.totalMinutes += minutes;
                if (!goal.totalMindfulness) goal.totalMindfulness = 0;
                goal.totalMindfulness += this.meditationState.count;

                this.meditationState.active = false;
                this.save();
                this.recalculateStreak();
                this.renderGoals();
                this.renderReports();
                this.checkAchievements();
                
                document.getElementById('meditation-finish-modal').style.display = 'none';
                this.showToast(`Session Saved! +${this.meditationState.count} mindfulness.`);
            }

            // --- STANDARD TIMER UI UPDATES ---
            updateTimerUI() {
                const todayStr = this.toIsoDate(new Date());
                this.data.goals.forEach(goal => {
                    if (goal.type === 'meditation') return; 
                    let activeSessionMins = 0;
                    let sessionPctVal = 0;
                    if (goal.isActive) {
                        const display = document.getElementById(`timer-${goal.id}`);
                        if (display) display.innerText = this.formatTime(goal.remainingSeconds);
                        const activeSessionSeconds = goal.sessionTargetSeconds - goal.remainingSeconds;
                        activeSessionMins = Math.floor(activeSessionSeconds / 60);
                        sessionPctVal = goal.sessionTargetSeconds > 0 ? (activeSessionSeconds / goal.sessionTargetSeconds) * 100 : 0;
                    }
                    const sessionBar = document.getElementById(`bar-session-${goal.id}`);
                    const sessionText = document.getElementById(`prog-text-session-${goal.id}`);
                    if (sessionBar) sessionBar.style.width = `${sessionPctVal}%`;
                    if (sessionText) sessionText.innerText = goal.isActive ? `${activeSessionMins} / ${Math.floor(goal.sessionTargetSeconds / 60)} mins` : "Ready";
                });
                this.updateStats(); 
            }

            renderGoals() {
                const container = document.getElementById('active-goals-container');
                const emptyMsg = document.getElementById('empty-msg');
                container.innerHTML = '';
                if (this.data.goals.length === 0) { emptyMsg.style.display = 'block'; return; }
                emptyMsg.style.display = 'none';
                const todayStr = this.toIsoDate(new Date());

                this.data.goals.forEach(goal => {
    const isMeditation = goal.type === 'meditation';
    const unitLabel = isMeditation ? 'mindfulness' : 'mins';
    const targetProp = isMeditation ? 'totalMindfulness' : 'totalMinutes';
    const overallPct = goal.lifetimeTargetMinutes > 0 ? Math.min((goal[targetProp] / goal.lifetimeTargetMinutes) * 100, 100) : 0;

    let todayVal = 0;
    if (isMeditation) {
        // UPDATED LINE: Check l.count first, fallback to l.touches.length
        todayVal = this.data.logs
            .filter(l => l.goalId === goal.id && l.date === todayStr)
            .reduce((sum, l) => sum + (l.count !== undefined ? l.count : (l.touches ? l.touches.length : 0)), 0);
    } else {
        todayVal = this.data.logs.filter(l => l.goalId === goal.id && l.date === todayStr).reduce((sum, l) => sum + l.minutes, 0);
    }
                    
                    const dailyTarget = goal.dailyTargetMinutes || 0;
                    let dailyPct = 0;
                    let dailyBarColor = goal.color;
                    if (dailyTarget > 0) {
                        dailyPct = Math.min((todayVal / dailyTarget) * 100, 100);
                        if (todayVal >= dailyTarget) dailyBarColor = 'var(--success)';
                    }
                    
                    const div = document.createElement('div');
                    div.className = 'card goal-card';
                    div.style.borderLeft = `5px solid ${goal.color}`;
                    
                    let controlsHtml = '', dailySectionHtml = '', sessionSectionHtml = '';
                    if (dailyTarget > 0) {
                        dailySectionHtml = `
                            <div style="margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                                <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px; align-items:center;">
                                    <strong style="color:var(--text);">Today's Goal</strong>
                                    <span style="font-weight:600;">${todayVal} / ${dailyTarget} ${unitLabel}</span>
                                </div>
                                <div class="progress-container" style="height: 6px;"><div class="progress-bar" style="width: ${dailyPct}%; background: ${dailyBarColor}"></div></div>
                            </div>`;
                    }

                    if (isMeditation) {
                        controlsHtml = `
                             <div class="timer-controls">
                                <div style="font-size: 14px; color: var(--text-light); text-transform: uppercase;">Meditation</div>
                                <div style="display:flex; gap: 10px;">
                                    <button class="btn-icon btn-play" style="background: var(--zen); color: white;" onclick="app.toggleTimer('${goal.id}')" title="Start Meditate"><i class="fas fa-om"></i></button>
                                    
                                    <button class="btn-icon" style="background:var(--warning); color:#000;" onclick="app.openSessionModal('${goal.id}')" title="Add Manually"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>`;
                    } else {
                        sessionSectionHtml = `
                            <div class="section-label">Current Session</div>
                            <div class="progress-container"><div id="bar-session-${goal.id}" class="progress-bar" style="background:var(--success); width:0%;"></div></div>
                            <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--text-light);"><span id="prog-text-session-${goal.id}">Ready</span></div>`;
                        controlsHtml = `
                            <div class="timer-controls">
                                <div id="timer-${goal.id}" class="timer-display">00:00</div>
                                <div style="display:flex; gap: 10px;">
                                    <button class="btn-icon ${goal.isActive ? 'btn-stop' : 'btn-play'}" onclick="app.toggleTimer('${goal.id}')"><i class="fas ${goal.isActive ? 'fa-stop' : 'fa-play'}"></i></button>
                                    <button class="btn-icon" style="background:var(--warning); color:#000;" onclick="app.openSessionModal('${goal.id}')"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>`;
                    }

                    div.innerHTML = `
                        <div class="goal-header">
                            <div><div class="goal-title">${goal.name}</div><span class="goal-tag" style="color:#b1b1c9; background: rgba(255,255,255,0.1)">${goal.category}</span></div>
                            <div style="display:flex; gap: 5px;">
                                <button class="btn-icon" style="color: var(--text-light)" onclick="app.openModal('${goal.id}', '${goal.type}')"><i class="fas fa-pencil-alt"></i></button>
                                <button class="btn-icon" style="color: var(--text-light)" onclick="app.deleteGoal('${goal.id}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        ${dailySectionHtml}
                        <div class="section-label">Achievement Progress</div>
                        <div class="progress-container"><div class="progress-bar" style="width: ${overallPct}%; background: ${goal.color}"></div></div>
                        <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--text-light); margin-bottom: 15px;"><span>${goal[targetProp]} / ${goal.lifetimeTargetMinutes} ${unitLabel}</span><span>${(overallPct).toFixed(1)}%</span></div>
                        ${sessionSectionHtml} ${controlsHtml}
                        <div class="sessions-list" style="margin-top: 15px; max-height: 150px; overflow-y: auto;"><div id="sessions-${goal.id}"></div></div>
                    `;
                    container.appendChild(div);
                    this.renderSessions(goal.id, isMeditation);
                });
            }
            
            renderSessions(goalId, isMeditation) {
                const container = document.getElementById(`sessions-${goalId}`);
                if (!container) return;
                container.innerHTML = '';
                
                // S·∫Øp x·∫øp: M·ªõi nh·∫•t l√™n ƒë·∫ßu
                const sessions = this.data.logs.filter(l => l.goalId === goalId).sort((a,b) => b.timestamp - a.timestamp);
                
                if (sessions.length === 0) { 
                    container.innerHTML = '<p style="font-size:12px; color:var(--text-light);">No sessions yet</p>'; 
                    return; 
                }
                
                const ol = document.createElement('ol');
                sessions.forEach((log) => {
                    const sLi = document.createElement('li');
                    sLi.className = 'session-item';
                    
                    const notesDisplay = log.notes ? `<span class="session-notes">"${log.notes}"</span>` : '';
                    
                    // --- PH·∫¶N S·ª¨A ƒê·ªîI CH√çNH ·ªû ƒê√ÇY ---
                    let actionButtons = '<div style="display:flex; gap:5px;">';
                    
                    // 1. N√∫t xem bi·ªÉu ƒë·ªì (Ch·ªâ hi·ªán n·∫øu l√† thi·ªÅn v√† c√≥ d·ªØ li·ªáu ch·∫°m)
                    if (isMeditation && log.touches && log.touches.length > 0) {
                        actionButtons += `<button class="btn-icon" style="background:transparent; color:var(--zen); height:24px; width:24px;" onclick="app.showSessionGraph('${log.timestamp}')" title="Show graph"><i class="fas fa-chart-area" style="font-size:12px;"></i></button>`;
                    }
                    
                    // 2. N√∫t ch·ªânh s·ª≠a (Lu√¥n hi·ªán cho t·∫•t c·∫£ c√°c lo·∫°i)
                    // L∆∞u √Ω: log.timestamp ƒë∆∞·ª£c truy·ªÅn v√†o l√†m ID ƒë·ªÉ s·ª≠a
                    actionButtons += `<button class="btn-icon" style="background:transparent; color:var(--text-light); height:24px; width:24px;" onclick="app.openSessionModal('${goalId}', ${log.minutes}, ${log.timestamp}, ${log.timestamp})" title="Edit details"><i class="fas fa-edit" style="font-size:12px;"></i></button>`;
                    
                    actionButtons += '</div>';
                    // ---------------------------------

                    sLi.innerHTML = `
                        <div class="session-content">
                            <span class="session-date">${this.toDisplayDate(log.timestamp)}</span>: ${log.minutes} minutes 
                            ${notesDisplay}
                        </div>
                        ${actionButtons}
                    `;
                    ol.appendChild(sLi);
                });
                container.appendChild(ol);
            }
            
            showSessionGraph(timestamp) {
    const exportBtn = document.getElementById('btn-export-session');
    if (exportBtn) {
        exportBtn.onclick = () => this.exportSessionData(timestamp);
    }

    const log = this.data.logs.find(l => l.timestamp == timestamp);
    if (!log || !log.touches) {
        this.showToast("No data available for this session");
        return;
    }
    
    // Store current log for switching views
    this.currentGraphLog = log;

    document.getElementById('graph-modal').style.display = 'flex';
    document.getElementById('graph-date').innerText = new Date(log.timestamp).toLocaleString('en-GB');
    
    // Reset selector to default and render
    document.getElementById('graph-type-select').value = 'interval';
    this.updateSessionChart();
}

updateSessionChart() {
    if (!this.currentGraphLog) return;
    const type = document.getElementById('graph-type-select').value;
    const ctx = document.getElementById('sessionGraph').getContext('2d');
    
    // Destroy previous instance
    if (this.charts.session) this.charts.session.destroy();

    if (type === 'interval') {
        this.renderIntervalChart(ctx, this.currentGraphLog);
    } else {
        this.renderIntensityChart(ctx, this.currentGraphLog);
    }
}

renderIntensityChart(ctx, log) {
    const startTime = log.timestamp;
    const durationSeconds = (log.minutes * 60) || Math.ceil((Date.now() - startTime) / 1000);
    
    const dataPoints = [];
    const labels = [];
    const totalPoints = 30; 
    const step = durationSeconds / totalPoints; 

    for (let s = 0; s <= durationSeconds; s += step) {
        labels.push(durationSeconds < 120 ? Math.round(s) + 's' : (s / 60).toFixed(0));
        const windowSizeMs = 60000; 
        const windowStart = (s * 1000) - (windowSizeMs / 2);
        const windowEnd = (s * 1000) + (windowSizeMs / 2);

        const intensity = log.touches.filter(t => {
            const touchTime = t - startTime;
            return touchTime >= windowStart && touchTime <= windowEnd;
        }).length;
        dataPoints.push(intensity);
    }

    const chartHeight = ctx.canvas.clientHeight || 300; 
    const gradient = ctx.createLinearGradient(0, 0, 0, chartHeight);
    gradient.addColorStop(0, 'rgba(167, 139, 250, 0.6)'); 
    gradient.addColorStop(0.5, 'rgba(167, 139, 250, 0.3)'); 
    gradient.addColorStop(1, 'rgba(167, 139, 250, 0.05)');   

    this.charts.session = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Mindfulness',
                data: dataPoints,
                borderColor: '#a78bfa', // Purple
                backgroundColor: gradient,
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 5,
                pointBackgroundColor: '#c7b6fc',
                pointBorderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: {
                x: { title: { display: true, text: 'Time (mins)', color: '#9ca3af' }, grid: { display: true }, ticks: { maxTicksLimit: 20, color: '#9ca3af' } },
                y: { beginAtZero: true, title: { display: true, text: 'Mindfulness counts', color: '#9ca3af' }, grid: { color: 'rgba(55, 65, 81, 0.5)' }, ticks: { color: '#9ca3af' } }
            },
            plugins: {
                tooltip: {
                    mode: 'index', intersect: false, displayColors: false,
                    callbacks: { label: (c) => c.raw >= 1 ? "üå± Mindfulness (" + c.raw + ")" : "‚òÅÔ∏è Unmindful" }
                },
                legend: { display: false }
            }
        }
    });
}

renderIntervalChart(ctx, log) {
    const touches = log.touches.sort((a, b) => a - b);
    const startTime = log.timestamp;
    
    // Create Data Points: Y = Gap Duration (seconds), Label = Time of occurrence
    const dataPoints = [];
    const labels = [];
    let previousTime = startTime;

    // Process touches to calculate gaps
    touches.forEach(t => {
        const gapSeconds = (t - previousTime) / 1000;
        const timeFromStartMins = ((t - startTime) / 1000 / 60).toFixed(0);
        
        dataPoints.push(gapSeconds.toFixed(1));
        labels.push(timeFromStartMins);
        previousTime = t;
    });

    // Add final gap (from last touch to end of session)
    const endTime = startTime + (log.minutes * 60 * 1000);
    if (endTime > previousTime) {
        const finalGap = (endTime - previousTime) / 1000;
        dataPoints.push(finalGap.toFixed(1));
        labels.push(log.minutes.toFixed(1));
    }

    // Gradient Red Style
    const chartHeight = ctx.canvas.clientHeight || 300;
    const gradient = ctx.createLinearGradient(0, 0, 0, chartHeight);
    gradient.addColorStop(0, 'rgba(248, 113, 113, 0.6)'); // Red Top
    gradient.addColorStop(0.5, 'rgba(248, 113, 113, 0.3)'); 
    gradient.addColorStop(1, 'rgba(248, 113, 113, 0.05)'); // Red Bottom

    this.charts.session = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels, // X-Axis labels (timestamps of touches)
            datasets: [{
                label: 'Forgetfulness Interval',
                data: dataPoints,
                borderColor: '#f87171', // Red Border
                backgroundColor: gradient,
                borderWidth: 2,
                fill: true,
                tension: 0.2, // Sharper lines for intervals
                pointRadius: 0,
                pointBackgroundColor: '#f87171',
                pointHoverRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: {
                x: { 
                    title: { display: true, text: 'Time (mins)', color: '#9ca3af' }, 
                    grid: { display: true }, // Hide X grid for cleaner look on event-based data
                    ticks: { color: '#9ca3af', maxTicksLimit: 15 } 
                },
                y: { 
                    beginAtZero: true, 
                    title: { display: true, text: 'Delays', color: '#9ca3af' }, 
                    ticks: { color: '#9ca3af' } 
                }
            },
            plugins: {
                tooltip: {
                    displayColors: false,
                    callbacks: {
                        title: (items) => `Minute ${items[0].label}`,
                        label: (c) => `Delay: ${c.raw} secs`
                    }
                },
                legend: { display: false }
            }
        }
    });
}
// --- NEW GRAPH LOGIC END ---
exportSessionData(timestamp) {
    const log = this.data.logs.find(l => l.timestamp == timestamp);
    if (!log) {
        this.showToast('Could not copy text!');
        return;
    }

    const dataStr = JSON.stringify(log);

    // Copy to clipboard logic
    if (navigator.clipboard) {
        navigator.clipboard.writeText(dataStr).then(() => {
            this.showToast('JSON data has been copied!');
        }).catch((err) => {
            console.error('Async: Could not copy text: ', err);
            this.fallbackCopyText(dataStr);
        });
    } else {
        this.fallbackCopyText(dataStr);
    }
}

// Helper for older browsers or webviews
fallbackCopyText(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    
    // Ensure it's not visible but part of DOM
    textArea.style.position = 'fixed';
    textArea.style.left = '-9999px';
    document.body.appendChild(textArea);
    
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if(successful) this.showToast('JSON data has been copied!');
        else this.showToast('Oops, unable to copy');
    } catch (err) {
        console.error('Fallback: Oops, unable to copy', err);
        this.showToast('Oops, unable to copy');
    }

    
    document.body.removeChild(textArea);
}
            openChoiceModal() { document.getElementById('choice-modal').style.display = 'flex'; }
            closeChoiceModal() { document.getElementById('choice-modal').style.display = 'none'; }

            openModal(goalId = null, type = 'standard') { 
                this.closeChoiceModal(); 
                const modal = document.getElementById('goal-modal');
                const title = document.getElementById('modal-title');
                const btn = document.getElementById('btn-save-goal');
                const catSelect = document.getElementById('g-cat');
                catSelect.innerHTML = '';
                const cats = type === 'meditation' ? ['Sitting Meditation', 'Walking Meditation', 'Bhavana'] : ['Work', 'Study', 'Health', 'Creative', 'Merit', 'Other'];
                cats.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.innerText = c; catSelect.appendChild(opt); });

                const dailyHint = document.getElementById('g-daily-hint');
                const lifeHint = document.getElementById('g-life-hint');
                if (type === 'meditation') { dailyHint.innerText = "Mindfulness per day"; lifeHint.innerText = "Mindfulness"; } 
                else { dailyHint.innerText = "Mins per day"; lifeHint.innerText = "Minutes"; }
                document.getElementById('g-type').value = type;

                if (goalId) {
                    const goal = this.data.goals.find(g => g.id === goalId);
                    if (goal) {
                        document.getElementById('g-id').value = goal.id;
                        document.getElementById('g-name').value = goal.name;
                        document.getElementById('g-cat').value = goal.category;
                        document.getElementById('g-color').value = goal.color;
                        document.getElementById('g-lifetime-target').value = goal.lifetimeTargetMinutes;
                        document.getElementById('g-daily-target').value = goal.dailyTargetMinutes;
                        document.getElementById('g-type').value = goal.type || 'standard';
                        title.innerText = 'Edit Goal'; btn.innerText = 'Save';
                    }
                } else {
                    document.getElementById('g-id').value = '';
                    document.getElementById('g-name').value = '';
                    document.getElementById('g-color').value = type === 'meditation' ? '#a78bfa' : '#818cf8';
                    document.getElementById('g-lifetime-target').value = 1000;
                    document.getElementById('g-daily-target').value = 100;
                    title.innerText = type === 'meditation' ? 'New Meditation Goal' : 'New Activity Goal'; btn.innerText = 'Create';
                }
                modal.style.display = 'flex'; 
            }
            closeModal() { document.getElementById('goal-modal').style.display = 'none'; }
            
                        renderCalendar() {
                const grid = document.getElementById('calendar-grid');
                grid.innerHTML = '';
                const y = this.currentMonth.getFullYear(); const m = this.currentMonth.getMonth();
                document.getElementById('cal-month-year').innerText = new Date(y, m).toLocaleString('en-GB', { month: 'long', year: 'numeric' });
                
                // 
                const headerDiv = document.createElement('div');
                headerDiv.className = 'calendar-header';
                ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d => {
                    const h = document.createElement('div'); h.className = 'cal-head-day'; h.innerText = d;
                    grid.appendChild(h);
                });

                // Calculate blanks for Monday start
                // new Date(y, m, 1).getDay() -> 0(Sun), 1(Mon)...
                const firstDayRaw = new Date(y, m, 1).getDay();
                // If Mon(1) -> 0 blanks. If Sun(0) -> 6 blanks.
                const blankSlots = firstDayRaw === 0 ? 6 : firstDayRaw - 1;

                const daysInMonth = new Date(y, m + 1, 0).getDate();
                
                for(let i=0; i<blankSlots; i++) { grid.appendChild(document.createElement('div')); }
                for(let i=1; i<=daysInMonth; i++) {
                    const dStr = `${y}-${String(m+1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day'; dayEl.innerText = i;
                    const totalMins = this.data.logs.filter(l => l.date === dStr).reduce((sum, l) => sum + l.minutes, 0);
if(totalMins > 0) {
    dayEl.classList.add('has-data');
    
    // The 8-Fold Path Tiers
    if (totalMins >= 240) dayEl.classList.add('level-8');      // 4h+ (Right Concentration)
    else if (totalMins >= 180) dayEl.classList.add('level-7'); // 3h+ (Right Mindfulness)
    else if (totalMins >= 150) dayEl.classList.add('level-6'); // 2.5h+ (Right Effort)
    else if (totalMins >= 120) dayEl.classList.add('level-5'); // 2h+
    else if (totalMins >= 90) dayEl.classList.add('level-4');  // 1.5h
    else if (totalMins >= 60) dayEl.classList.add('level-3');  // 1h
    else if (totalMins >= 30) dayEl.classList.add('level-2');  // 30m
    else dayEl.classList.add('level-1');                     // < 30m
}
     
                    dayEl.onclick = () => this.openDayStats(dStr);
                    grid.appendChild(dayEl);
                }
            }
switchDayChart(mode) {
    this.dayChartMode = mode;
    
    // C·∫≠p nh·∫≠t giao di·ªán n√∫t
    const btnTime = document.getElementById('btn-modal-time');
    const btnMind = document.getElementById('btn-modal-mind');
    
    if (mode === 'time') {
        btnTime.className = 'btn';
        btnMind.className = 'btn btn-secondary';
    } else {
        btnTime.className = 'btn btn-secondary';
        btnMind.className = 'btn';
    }
    
    // V·∫Ω l·∫°i chart
    if (this.currentViewDate) {
        this.renderDayChartOnly(this.currentViewDate);
    }
}
openDayStats(dateStr) {
    this.currentViewDate = dateStr;
    const modal = document.getElementById('day-details-modal');
    document.getElementById('day-modal-title').innerText = new Date(dateStr).toLocaleDateString('en-GB', {weekday: 'long', day: 'numeric', month: 'numeric'});
    
    // Reset v·ªÅ ch·∫ø ƒë·ªô time khi m·ªõi m·ªü
    this.switchDayChart('time'); 

    // 1. RENDER LIST (Lu√¥n hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß c·∫£ Time v√† Sati)
    const dayLogs = this.data.logs.filter(l => l.date === dateStr).sort((a,b) => b.timestamp - a.timestamp);
    const listContainer = document.getElementById('day-session-list');
    listContainer.innerHTML = dayLogs.length ? '' : '<p class="empty-state">No Activities.</p>';
    
    const ul = document.createElement('ul'); 
    ul.style.listStyle = 'none';
    
    dayLogs.forEach(log => {
        const goal = this.data.goals.find(g => g.id === log.goalId);
        const li = document.createElement('li');
        li.style.cssText = 'padding: 8px 0; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; font-size: 13px; align-items:center;';
        
        // N√∫t xem bi·ªÉu ƒë·ªì s√≥ng n√£o (n·∫øu c√≥ touch data)
        let graphBtnHtml = '';
        if (goal && goal.type === 'meditation' && log.touches && log.touches.length > 0) {
            graphBtnHtml = `<button class="btn-icon" style="background:transparent; color:var(--zen); height:24px; width:24px; margin-right:5px; cursor:pointer;" onclick="app.showSessionGraph('${log.timestamp}')"><i class="fas fa-chart-area" style="font-size:12px;"></i></button>`;
        }

        // Hi·ªÉn th·ªã s·ªë Sati (n·∫øu c√≥)
        const satiCount = log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0);
        const satiInfo = satiCount > 0 ? `<span style="color: var(--zen); font-size: 11px; margin-left: 5px; font-weight:bold;">(${satiCount} mindfulness)</span>` : '';

        const leftSide = `<div>
                           <span style="font-weight:600; color:${goal?goal.color:'#ccc'}">${goal?goal.name:'Deleted'}</span>
                           <span style="margin-left:5px;">${log.minutes}m</span>
                           ${satiInfo}
                         </div>`;
        
        const rightSide = `<div style="display:flex; align-items:center;">
                               ${graphBtnHtml}
                               <div style="font-size: 11px; color: var(--text-light); width:35px; text-align:right;">
                                   ${new Date(log.timestamp).toLocaleTimeString('en-GB', {hour: '2-digit', minute:'2-digit'})}
                               </div>
                           </div>`;

        li.innerHTML = leftSide + rightSide;
        ul.appendChild(li);
    });
    listContainer.appendChild(ul);
    
    modal.style.display = 'flex';
}

// H√†m ri√™ng ƒë·ªÉ v·∫Ω chart trong modal
renderDayChartOnly(dateStr) {
    const ctx = document.getElementById('dayBreakdownChart').getContext('2d');
    const isMindfulness = this.dayChartMode === 'mindfulness';
    const unitLabel = isMindfulness ? 'mindfulness' : 'mins';

    const dayLogs = this.data.logs.filter(l => l.date === dateStr);
    const goalStats = {};

    dayLogs.forEach(log => {
        if (isMindfulness) {
             const val = log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0);
             if (val === 0) return;
        }

        if(!goalStats[log.goalId]) {
            const goal = this.data.goals.find(g => g.id === log.goalId);
            goalStats[log.goalId] = { 
                name: goal ? goal.name : 'Deleted', 
                color: goal ? goal.color : '#ccc', 
                value: 0 
            };
        }
        
        if (isMindfulness) {
            goalStats[log.goalId].value += (log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0));
        } else {
            goalStats[log.goalId].value += log.minutes;
        }
    });

    if(this.charts.dayChart) this.charts.dayChart.destroy();
    
    const dataValues = Object.values(goalStats).map(s => s.value);

    // --- FIX: Updated Center Text Plugin ---
    const centerTextPlugin = {
        id: 'centerText',
        beforeDraw: function(chart) {
            const { ctx } = chart;
            const { top, left, width, height } = chart.chartArea; // Get the specific drawing area
            
            ctx.save();
            
            // Calculate Total
            let total = 0;
            const data = chart.data.datasets[0].data;
            if(data.length > 0) {
                data.forEach(val => total += val);
            }
            
            // Format Text
            let text = total;
            if (!isMindfulness) {
                // If 0, show 0h, otherwise show hours (e.g., 2.5h)
                text = (total / 60).toFixed(1) + "h"; 
            } else {
                text = total.toLocaleString(); 
            }
            
            // Calculate Center coordinates relative to the chartArea (not the whole canvas)
            const x = left + width / 2;
            const y = top + height / 2;
            
            // Font Styling
            // Dynamically size font based on chart height so it fits in the hole
            const fontSize = (height / 10).toFixed(2); 
            ctx.font = `bold ${fontSize}px sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = "#f3f4f6"; // White/Light Text
            
            // Draw
            if (dataValues.length > 0) {
                ctx.fillText(text, x, y);
            }
            
            ctx.restore();
        }
    };

    this.charts.dayChart = new Chart(ctx, {
        type: 'doughnut',
        data: { 
            labels: Object.values(goalStats).map(s => s.name), 
            datasets: [{ 
                data: dataValues, 
                backgroundColor: Object.values(goalStats).map(s => s.color), 
                borderWidth: 1, 
                borderColor: '#1f2937' 
            }] 
        },
        options: { 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { 
                    position: 'right', 
                    labels: { color: '#9ca3af', font: {size: 11} } 
                },
                title: { 
                    display: dataValues.length === 0, 
                    text: 'No data', 
                    position: 'bottom', 
                    color: '#6b7280' 
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw || 0;
                            // Display Hours in Tooltip
                            if (!isMindfulness) {
                                return ` ${context.label}: ${value} ${unitLabel}`;
                            }
                            return ` ${context.label}: ${value} ${unitLabel}`;
                        }
                    }
                }
            } 
        },
        plugins: [centerTextPlugin]
    });
}
            closeDayModal() { document.getElementById('day-details-modal').style.display = 'none'; }
setReportMode(mode) {
    this.reportMode = mode;
    
    // C·∫≠p nh·∫≠t giao di·ªán n√∫t b·∫•m
    const btnTime = document.getElementById('btn-rep-time');
    const btnMind = document.getElementById('btn-rep-mind');
    
    if (mode === 'time') {
        btnTime.className = 'btn'; // Active styling
        btnMind.className = 'btn btn-secondary';
    } else {
        btnTime.className = 'btn btn-secondary';
        btnMind.className = 'btn'; // Active styling (s·∫Ω l·∫•y m√†u primary)
    }

    this.renderReports();
}
            // --- REPORTING LOGIC ---
renderReports() {
    if(!document.getElementById('weeklyChart')) return;
    
    const isMindfulness = this.reportMode === 'mindfulness';
    const unitLabel = isMindfulness ? 'Mindfulness' : 'Minutes';
    
    // Update Breakdown Title
    document.getElementById('breakdown-title').innerText = isMindfulness ? 'Mindfulness' : 'Time';

    // --- 1. SETUP DATE RANGES FOR BREAKDOWN CHART (DOUGHNUT) ---
    const rangeSelect = document.getElementById('report-range-select');
    const rangeMode = rangeSelect ? rangeSelect.value : 'all';
    
    const now = new Date();
    // Reset to start of today (00:00:00)
    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
    const currentDay = now.getDay() || 7; // Mon=1 ... Sun=7
    // Start of This Week (Monday)
    const thisWeekStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - currentDay + 1).getTime();
    // Start of This Month (1st)
    const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1).getTime();

    let filterStart = 0;
    let filterEnd = Date.now() + 86400000; // Future buffer

    if (rangeMode === 'today') {
        filterStart = todayStart;
    } else if (rangeMode === 'this_week') {
        filterStart = thisWeekStart;
    } else if (rangeMode === 'last_week') {
        filterEnd = thisWeekStart;
        filterStart = thisWeekStart - (7 * 24 * 60 * 60 * 1000);
    } else if (rangeMode === 'this_month') {
        filterStart = thisMonthStart;
    } else if (rangeMode === 'last_month') {
        filterEnd = thisMonthStart;
        // Set to 1st of previous month
        filterStart = new Date(now.getFullYear(), now.getMonth() - 1, 1).getTime();
    } 
    // 'all' leaves start at 0

    // --- 2. SETUP RANGES FOR BAR CHARTS (Independent of Dropdown) ---
    // weekStart is set by global navigation variables
    const weekStartMs = this.currentWeekStart.getTime();
    const weekEndMs = weekStartMs + (7 * 24 * 60 * 60 * 1000);

    // Update Week Title UI
    const weekEndDisp = new Date(weekEndMs - 1); 
    document.getElementById('weekly-report-title').innerText = `Week (${this.currentWeekStart.toLocaleDateString('en-GB', {month:'numeric', day:'numeric'})} - ${weekEndDisp.toLocaleDateString('en-GB', {month:'numeric', day:'numeric'})})`;
    
    // Setup Month Boundaries
    const mYear = this.currentMonth.getFullYear();
    const mMonth = this.currentMonth.getMonth();
    const monthlyLabels = Array.from({length: new Date(mYear, mMonth + 1, 0).getDate()}, (_, i) => i + 1);
    document.getElementById('monthly-report-title').innerText = `Month ${new Date(mYear, mMonth).toLocaleDateString('en-GB', { month: 'numeric', year: 'numeric' })}`;

    // --- 3. INITIALIZE DATASETS ---
    const goalDatasets = {};
    const weekDays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    
    this.data.goals.forEach(goal => { 
        if (isMindfulness && goal.type !== 'meditation') return;

        goalDatasets[goal.id] = { 
            name: goal.name, 
            color: goal.color, 
            breakdownTotal: 0, // Used for Doughnut (Filtered)
            weekly: new Array(7).fill(0),
            monthly: new Array(monthlyLabels.length).fill(0) 
        }; 
    });
    
    // --- 4. PROCESS LOGS ---
    this.data.logs.forEach(log => {
        if(!goalDatasets[log.goalId]) return;

        // Get value based on mode
        let value = 0;
        if (isMindfulness) {
            value = log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0);
        } else {
            value = log.minutes;
        }

        // Handle timestamps
        let logTime = log.timestamp;
        let logDateObj;
        if (!logTime) {
             logDateObj = new Date(log.date); 
             logTime = logDateObj.getTime();
        } else {
             logDateObj = new Date(logTime);
        }

        // A. DOUGHNUT FILTER LOGIC
        if (logTime >= filterStart && logTime < filterEnd) {
            goalDatasets[log.goalId].breakdownTotal += value;
        }
        
        // B. WEEKLY BAR LOGIC (Independent)
        if(logTime >= weekStartMs && logTime < weekEndMs) { 
            let dayIdx = logDateObj.getDay();
            dayIdx = (dayIdx === 0 ? 6 : dayIdx - 1);
            goalDatasets[log.goalId].weekly[dayIdx] += value; 
        }
        
        // C. MONTHLY BAR LOGIC (Independent)
        if(logDateObj.getFullYear() === mYear && logDateObj.getMonth() === mMonth) {
            goalDatasets[log.goalId].monthly[logDateObj.getDate() - 1] += value;
        }
    });
    
    // Filter active goals based on Breakdown Total (so hidden goals don't show in doughnut)
    const activeGoalsForDoughnut = Object.values(goalDatasets).filter(d => d.breakdownTotal > 0);
    const allGoalsForBars = Object.values(goalDatasets).filter(d => d.weekly.some(v=>v>0) || d.monthly.some(v=>v>0) || d.breakdownTotal > 0);
    
    // CHART CONFIGURATION
    const commonOptions = { 
        maintainAspectRatio: false, 
        scales: { 
            x: {stacked: true, grid:{color:'#374151'}}, 
            y: {
                stacked: true, 
                grid:{color:'#374151'},
                title: { display: true, text: unitLabel } 
            } 
        }, 
        plugins: {
            legend:{labels:{color:'#9ca3af'}},
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': ' + context.raw + ' ' + unitLabel;
                    }
                }
            }
        } 
    };
    
    // 5. RENDER BREAKDOWN CHART (DOUGHNUT)
    const ctxBreakdown = document.getElementById('goalBreakdownChart').getContext('2d');
    if(this.charts.breakdown) this.charts.breakdown.destroy();

    // Center Text Plugin
    const centerTextPlugin = {
        id: 'centerText',
        afterDraw: function(chart) {
            const { ctx, chartArea: { top, bottom, left, right } } = chart;
            ctx.save();
            let total = 0;
            const data = chart.data.datasets[0].data;
            data.forEach(val => total += val);
            
            let text = total;
            const currentUnit = typeof unitLabel !== 'undefined' ? unitLabel.toLowerCase() : '';
            if (currentUnit === 'minutes') {
                text = (total / 60).toFixed(1) + "h"; 
            } else {
                text = total.toLocaleString();
            }
            
            const centerX = (left + right) / 2;
            const centerY = (top + bottom) / 2;
            const fontSize = (chart.chartArea.bottom - chart.chartArea.top) / 15; 
            
            ctx.font = `bold ${fontSize}px sans-serif`;
            ctx.textBaseline = "middle";
            ctx.textAlign = "center";
            ctx.fillStyle = "#FFFFFF"; 
            ctx.fillText(text, centerX, centerY);
            ctx.restore();
        }
    };

    this.charts.breakdown = new Chart(ctxBreakdown, { 
        type: 'doughnut', 
        data: { 
            labels: activeGoalsForDoughnut.map(d => d.name), 
            datasets: [{ 
                data: activeGoalsForDoughnut.map(d => d.breakdownTotal), 
                backgroundColor: activeGoalsForDoughnut.map(d => d.color), 
                borderWidth: 1, 
                borderColor: '#1f2937' 
            }] 
        }, 
        options: { 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { labels: { color: '#9ca3af' } },
                title: { 
                    display: activeGoalsForDoughnut.length === 0, 
                    text: 'No data available', 
                    position: 'bottom', 
                    color: '#6b7280' 
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw || 0;
                            if (unitLabel === 'Minutes') {
                                return ` ${context.label}: ${(value / 60).toFixed(1)}h`;
                            }
                            return ` ${context.label}: ${value} ${unitLabel}`;
                        }
                    }
                }
            } 
        },
        plugins: [centerTextPlugin] 
    });
    
    // 6. RENDER WEEKLY CHART
    const ctxWeek = document.getElementById('weeklyChart').getContext('2d');
    if(this.charts.weekly) this.charts.weekly.destroy();
    this.charts.weekly = new Chart(ctxWeek, { 
        type: 'bar', 
        data: { 
            labels: weekDays, 
            datasets: allGoalsForBars.map(g => ({ label: g.name, data: g.weekly, backgroundColor: g.color, stack: '0' })) 
        }, 
        options: commonOptions 
    });
    
    // 7. RENDER MONTHLY CHART
    const ctxMonth = document.getElementById('monthlyChart').getContext('2d');
    if(this.charts.monthly) this.charts.monthly.destroy();
    this.charts.monthly = new Chart(ctxMonth, { 
        type: 'bar', 
        data: { 
            labels: monthlyLabels, 
            datasets: allGoalsForBars.map(g => ({ label: g.name, data: g.monthly, backgroundColor: g.color, stack: '0' })) 
        }, 
        options: commonOptions 
    });
}

changeReportWeek(dir) { this.currentWeekStart.setDate(this.currentWeekStart.getDate() + (dir * 7)); this.renderReports(); }
            changeReportMonth(dir) { this.currentMonth.setMonth(this.currentMonth.getMonth() + dir); this.renderReports(); }
            changeMonth(dir) { this.currentMonth.setMonth(this.currentMonth.getMonth() + dir); this.renderCalendar(); }
            
            // REPLACE THIS BLOCK INSIDE updateStats()
updateStats() {
    this.recalculateStreak();

    // 1. Calculate total mindfulness
    const totalMindfulness = this.data.logs.reduce((sum, log) => {
        // Fix: Check for manual 'count' first, fallback to 'touches' length
        return sum + (log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0));
    }, 0);

    // 2. Update data
    this.data.xp = totalMindfulness; 

    // 3. Display on UI
    document.getElementById('streak-disp').innerText = `${this.data.streak} üî•`;
    document.getElementById('xp-disp').innerText = `${this.data.xp} Sati`;
    document.getElementById('level-disp').innerText = Math.floor(this.data.xp / 1000) + 1;

    // ... (keep the rest of the function: daily goal calculation etc.) ...
    const todayStr = this.toIsoDate(new Date());
    let totalTodayMins = this.data.logs.filter(l => l.date === todayStr).reduce((sum, l) => sum + l.minutes, 0);
    this.data.goals.forEach(g => {
        if (g.isActive && g.type !== 'meditation') {
            const spent = g.sessionTargetSeconds - g.remainingSeconds;
            totalTodayMins += Math.floor(spent / 60);
        }
    });
    const globalTarget = this.data.globalDailyGoal || 120;
    const dailyPct = Math.min((totalTodayMins / globalTarget) * 100, 100);
    document.getElementById('daily-current').innerText = totalTodayMins;
    document.getElementById('daily-target').innerText = globalTarget;
    document.getElementById('daily-bar-fill').style.width = `${dailyPct}%`;
}
            
            recalculateStreak() {
                const activeDates = [...new Set(this.data.logs.filter(l => l.minutes > 0).map(l => l.date))].sort();
                if (activeDates.length === 0) { this.data.streak = 0; return; }
                let streak = 1;
                for (let i = activeDates.length - 2; i >= 0; i--) {
                    const prev = new Date(activeDates[i]);
                    const next = new Date(activeDates[i + 1]);
                    if ((next - prev) < (1000 * 60 * 60 * 48) && (next - prev) > 0) streak++; else break;
                }
                const now = new Date(this.today.getFullYear(), this.today.getMonth(), this.today.getDate());
                const last = new Date(activeDates[activeDates.length - 1]);
                if ((now - last) / (1000 * 60 * 60 * 24) > 1) this.data.streak = 0; else this.data.streak = streak;
            }

            checkAchievements() {
                const list = [
    { id: 'streak_3', title: 'Effort', desc: 'Practice for 3 consecutive days', condition: () => this.data.streak >= 3 },
    { id: 'streak_10', title: 'Striving', desc: 'Practice for 10 consecutive days', condition: () => this.data.streak >= 10 },
    { id: 'streak_30', title: 'Diligence', desc: 'Practice for 30 consecutive days', condition: () => this.data.streak >= 30 },
    { id: 'streak_60', title: 'Ardor', desc: 'Practice for 60 consecutive days', condition: () => this.data.streak >= 60 },
    { id: 'streak_120', title: 'Viriya', desc: 'Practice for 120 consecutive days', condition: () => this.data.streak >= 120 },
    { id: 'streak_365', title: 'Viriya-sambojjhanga', desc: 'Practice for 365 consecutive days', condition: () => this.data.streak >= 365 },

    { id: 'beginner', title: 'Novice', desc: 'Accumulate 5,000 Mindfulness (Sati)', condition: () => this.totalMindfulnessCounts >= 5000 },
    { id: 'practitioner', title: 'Practitioner', desc: 'Accumulate 10,000 Mindfulness (Sati)', condition: () => this.totalMindfulnessCounts >= 10000 },
    { id: 'yogi', title: 'Yogi', desc: 'Accumulate 20,000 Mindfulness (Sati)', condition: () => this.totalMindfulnessCounts >= 20000 },
    { id: 'meditator', title: 'Meditator', desc: 'Accumulate 50,000 Mindfulness (Sati)', condition: () => this.totalMindfulnessCounts >= 50000 },
    { id: 'clear-mirror', title: 'Clear Mirror', desc: 'Accumulate 80,000 Mindfulness (Sati)', condition: () => this.totalMindfulnessCounts >= 80000 },
					{ id: 'still-lake', title: 'Still Lake', desc: 'Accumulate 100,000 Mindfulness (Sati)', condition: () => this.totalMindfulnessCounts >= 100000 },
					{ id: 'mountain', title: 'Mountain', desc: 'Accumulate 200,000 Mindfulness (Sati)', condition: () => this.totalMindfulnessCounts >= 200000 },
					{ id: 'morning-star', title: 'Morning Star', desc: 'Accumulate 300,000 Mindfulness (Sati)', condition: () => this.totalMindfulnessCounts >= 300000 },
					{ id: 'dhammaheir', title: 'Heir of the Dhamma', desc: 'Accumulate 500,000 Mindfulness (Sati)', condition: () => this.totalMindfulnessCounts >= 500000 },
					{ id: 'bodhi', title: 'Ancient Bodhi', desc: 'Accumulate 1,000,000 Mindfulness (Sati)', condition: () => this.totalMindfulnessCounts >= 1000000 }
];
                const container = document.getElementById('achievement-list');
                if (!container) return; container.innerHTML = '';
                list.forEach(ach => {
                    const unlocked = this.data.achievements.includes(ach.id) || ach.condition();
                    if(unlocked && !this.data.achievements.includes(ach.id)) {
                        this.data.achievements.push(ach.id); this.showToast(`Unlocked: ${ach.title}`, true); this.save();
                    }
                    const div = document.createElement('div');
                    div.style.cssText = `padding: 15px; border: 1px solid ${unlocked ? 'var(--success)' : 'var(--border)'}; border-radius: 8px; background: ${unlocked ? 'rgba(16, 185, 129, 0.1)' : 'rgba(255,255,255,0.05)'}; display: flex; align-items: center; gap: 15px; opacity: ${unlocked ? 1 : 0.6}`;
                    div.innerHTML = `<div style="font-size: 24px; width: 40px; text-align: center;">${unlocked ? 'üèÜ' : 'üîí'}</div><div><div style="font-weight: bold; ${unlocked ? 'color: var(--text)' : 'color: var(--text-light)'}">${ach.title}</div><div style="font-size: 12px; color: var(--text-light);">${ach.desc}</div></div>`;
                    container.appendChild(div);
                });
            }

            formatTime(seconds) {
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = seconds % 60;
                return `${h > 0 ? h+':' : ''}${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            }
            toIsoDate(date) {
    const y = date.getFullYear();
    // Th√°ng trong JS b·∫Øt ƒë·∫ßu t·ª´ 0 n√™n ph·∫£i +1
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
}
            toDateTimeInput(timestamp) {
    const date = new Date(timestamp);
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    const hh = String(date.getHours()).padStart(2, '0');
    const mm = String(date.getMinutes()).padStart(2, '0');
    return `${y}-${m}-${d}T${hh}:${mm}`;
}
            toDisplayDate(timestamp) { const d = new Date(timestamp); return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`; }
            showToast(msg, isAchievement = false) {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                t.classList.remove('achievement'); if (isAchievement) t.classList.add('achievement');
                t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000);
            }
            
            switchView(viewName) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById(`view-${viewName}`).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                event.currentTarget.classList.add('active');
                
                const titles = {
                    'dashboard': 'Journal',
                    'calendar': 'Calendar',
                    'reports': 'Statistics',
					'analytics': 'Analytics',
                    'achievements': 'Achieve'
                };
                
                document.getElementById('page-title').innerText = titles[viewName] || 'Journal';
                if (viewName === 'reports') { this.renderReports(); }
                if (viewName === 'calendar') this.renderCalendar();
				if (viewName === 'analytics') this.renderAnalytics();
            }
            
            exportData() {
        // Added null, 2 for pretty printing so it looks better in the textarea
        const dataStr = JSON.stringify(this.data); 
        const modal = document.getElementById('backup-modal');
        
        modal.style.display = 'flex';
    }

    closeBackupModal() {
        document.getElementById('backup-modal').style.display = 'none';
    }

    shareBackup() {
    const dataStr = JSON.stringify(this.data);
    const now = new Date();
    const datePart = now.toISOString().split('T')[0];
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const fileName = `backup_${datePart}-${hours}h${minutes}.txt`;

    // 1. ∆Øu ti√™n Android App (Website2APK)
    if (typeof Website2APK !== 'undefined' && Website2APK.shareIntent) {
        Website2APK.shareIntent(dataStr, "Backup", "");
        return;
    }

    // 2. Web Share API (D√†nh cho iOS Safari, Chrome Android...)
    if (navigator.share) {
        const file = new File([dataStr], fileName, { type: "application/json" });
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            navigator.share({
                files: [file],
                title: 'Meditator Journal Backup',
                text: 'Backup data file.'
            })
            .then(() => this.showToast('Shared successfully!'))
            .catch((error) => {
                // N·∫øu ng∆∞·ªùi d√πng h·ªßy (AbortError), kh√¥ng l√†m g√¨ c·∫£, 
                // nh∆∞ng n·∫øu l·ªói kh√°c th√¨ copy v√†o clipboard
                if (error.name !== 'AbortError') this.copyToClipboard(dataStr);
            });
            return;
        } 
    } 

    // 3. Fallback cu·ªëi c√πng: T·ª± ƒë·ªông copy v√†o Clipboard (D√†nh cho PC/Tr√¨nh duy·ªát c≈©)
    this.copyToClipboard(dataStr);
}

// H√†m h·ªó tr·ª£ Copy
copyToClipboard(text) {
    // Th·ª≠ d√πng API hi·ªán ƒë·∫°i tr∆∞·ªõc
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
            this.showToast('Data copied to clipboard!');
        }).catch(err => {
            this.fallbackCopyText(text);
        });
    } else {
        this.fallbackCopyText(text);
    }
}

// C√°ch copy c≈© n·∫øu tr√¨nh duy·ªát qu√° h·∫°n ch·∫ø
fallbackCopyText(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed"; // Tr√°nh l√†m nh·∫£y trang
    textArea.style.left = "-9999px";
    textArea.style.top = "0";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            this.showToast('Backup data copied!');
        } else {
            this.showToast('Copy failed. Please use the Backup button to download the file.');
        }
    } catch (err) {
        this.showToast('Error copying data.');
    }
    document.body.removeChild(textArea);
}
    
    // T·∫£i xu·ªëng file .json
   downloadFile() {
    const dataStr = JSON.stringify(this.data);
    const now = new Date();
    const datePart = now.toISOString().split('T')[0];
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const fileName = `backup_${datePart}-${hours}h${minutes}.txt`;

    // N·∫øu ƒëang ch·∫°y tr√™n App Android (c√≥ interface Website2APK)
    if (typeof Website2APK !== 'undefined') {
        // Ki·ªÉm tra xem h√†m saveBackup m√¨nh s·∫Øp th√™m c√≥ t·ªìn t·∫°i kh√¥ng
        if (Website2APK.saveBackup) {
            // Convert sang Base64 ƒë·ªÉ tr√°nh l·ªói k√Ω t·ª± ƒë·∫∑c bi·ªát
            // D√πng btoa (binary to ascii) - c·∫ßn encodeURIComponent ƒë·ªÉ x·ª≠ l√Ω ti·∫øng Vi·ªát
            const base64 = btoa(unescape(encodeURIComponent(dataStr)));
            
            // G·ªçi xu·ªëng Java/Smali
            Website2APK.saveBackup(base64, fileName);
            this.showToast('Saving file to Download...');
        } 
    } else {
        // Code ch·∫°y tr√™n m√°y t√≠nh (nh∆∞ c≈©)
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }, 0);
        this.showToast('File downloaded successfully!');
    }
}

    // Handle file selection from computer
    handleFileUpload(inputElement) {
        const file = inputElement.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            // Pass file content to the common processing function
            this.processRestoreData(e.target.result);
        };
        reader.readAsText(file);
        
        // Reset input to allow selecting the same file again if needed
        inputElement.value = '';
    }

  
    // --- COMMON LOGIC ---
    processRestoreData(jsonString) {
        try {
            const json = JSON.parse(jsonString);
            
            // Basic validation
            if (!json.goals || !Array.isArray(json.goals) || !json.logs) {
                throw new Error("Invalid file structure (Missing goals/logs).");
            }

            if (confirm(`Found ${json.goals.length} goals and ${json.logs.length} logs.\nAre you sure you want to overwrite current data?`)) {
                localStorage.setItem('chronoData', JSON.stringify(json));
                location.reload(); // Reload page to apply changes
            }
        } catch (err) {
            alert("Restore error: " + err.message);
        }
    }
            resetApp() {
                if (confirm('Delete ALL data?')) { localStorage.removeItem('chronoData'); location.reload(); }
            }
			deleteSession() {
    const logId = document.getElementById('s-log-id').value;
    const goalId = document.getElementById('s-goal-id').value;

    if (!logId) return; // Safety check

    if (confirm('Permanently delete this session from history?')) {
        // 1. Find the log index
        const logIndex = this.data.logs.findIndex(l => l.timestamp == logId);
        if (logIndex === -1) return;
        
        const log = this.data.logs[logIndex];
        const goal = this.data.goals.find(g => g.id === goalId);

        // 2. Subtract stats from the goal totals
        if (goal) {
            goal.totalMinutes -= log.minutes;
            if (goal.totalMinutes < 0) goal.totalMinutes = 0;

            if (goal.type === 'meditation') {
                const count = log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0);
                goal.totalMindfulness -= count;
                if (goal.totalMindfulness < 0) goal.totalMindfulness = 0;
            }
        }

        // 3. Remove the log
        this.data.logs.splice(logIndex, 1);

        // 4. Save and Update UI
        this.save();
        this.renderGoals();      // Updates the list immediately
        this.renderCalendar();   // Updates calendar colors
        this.renderReports();    // Updates charts
        this.updateStats();      // Updates streaks/XP
        
        this.closeSessionModal();
        this.showToast('Session deleted!');
    }
}
            openSessionModal(goalId, minutes = 0, logId = null, startTime = Date.now()) {
    document.getElementById('session-modal').style.display = 'flex';
    document.getElementById('s-goal-id').value = goalId;
    document.getElementById('s-log-id').value = logId || '';
    document.getElementById('s-date').value = this.toDateTimeInput(startTime);
    document.getElementById('s-minutes').value = minutes;

    // --- NEW: Toggle Delete Button Visibility ---
    const deleteBtn = document.getElementById('btn-delete-session');
    if (logId) {
        deleteBtn.style.display = 'block'; // Show if editing
    } else {
        deleteBtn.style.display = 'none';  // Hide if new
    }
    // --------------------------------------------
    
    // ... (rest of your existing code for mindfulness check) ...
    const goal = this.data.goals.find(g => g.id === goalId);
    const mindGroup = document.getElementById('s-mindfulness-group');
    const mindInput = document.getElementById('s-mindfulness');
    
    if (goal && goal.type === 'meditation') {
        mindGroup.style.display = 'block';
        let currentCount = 0;
        if (logId) {
            const log = this.data.logs.find(l => l.timestamp == logId);
            if (log) currentCount = log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0);
        }
        mindInput.value = currentCount;
    } else {
        mindGroup.style.display = 'none';
        mindInput.value = 0;
    }

    let notes = ''; 
    if(logId) { 
        const log = this.data.logs.find(l => l.timestamp == logId); 
        if(log && log.notes) notes = log.notes; 
    }
    document.getElementById('s-notes').value = notes;
    document.getElementById('session-title').innerText = logId ? 'Update log' : 'Add log';
}
            closeSessionModal() { document.getElementById('session-modal').style.display = 'none'; }
            logSessionConfirm(e) {
    e.preventDefault();
    const goalId = document.getElementById('s-goal-id').value;
    const logId = document.getElementById('s-log-id').value;
    const dateTimeStr = document.getElementById('s-date').value;
    const minutes = parseInt(document.getElementById('s-minutes').value);
    
    // 1. Get Mindfulness and Raw Notes
    const mindfulness = parseInt(document.getElementById('s-mindfulness').value) || 0;
    let notes = document.getElementById('s-notes').value;
    
    if (minutes <= 0) return;
    
    const goal = this.data.goals.find(g => g.id === goalId);
    
    // --- NEW LOGIC: AUTO-FORMAT NOTES ---
    if (goal && goal.type === 'meditation') {
        // A. Remove any existing "Mindfulness: X" string (to prevent duplicates if editing)
        // Regex explains: Starts with "Ch√°nh ni·ªám:", followed by numbers, optional dot/space
        let cleanNotes = notes.replace(/^Mindfulness: \d+(\.\s*)?/, '').trim();
        
        // B. Add the new count if it's greater than 0
        if (mindfulness > 0) {
            notes = `Mindfulness: ${mindfulness}. ${cleanNotes}`;
        } else {
            notes = cleanNotes;
        }
        // Result example: "Ch√°nh ni·ªám: 10. C·∫£m th·∫•y b√¨nh an"
    }
    // ------------------------------------

    const dateObj = new Date(dateTimeStr);
    const timestamp = dateObj.getTime();
    const dateKey = dateTimeStr.split('T')[0]; 
    
    if (logId) {
        // --- EDIT EXISTING LOG ---
        const log = this.data.logs.find(l => l.timestamp == logId);
        if (log) {
            const oldMinutes = log.minutes;
            // Use saved count or fallback to touches length
            const oldMindfulness = log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0);
            
            log.minutes = minutes; 
            log.date = dateKey; 
            log.timestamp = timestamp; 
            log.notes = notes; // Save the formatted notes
            log.count = mindfulness;
            
            if (goal) {
                goal.totalMinutes += (minutes - oldMinutes);
                if (goal.type === 'meditation') {
                    if (!goal.totalMindfulness) goal.totalMindfulness = 0;
                    goal.totalMindfulness = goal.totalMindfulness - oldMindfulness + mindfulness;
                }
            }
        }
    } else {
        // --- CREATE NEW LOG ---
        this.data.logs.push({ 
            goalId, 
            date: dateKey, 
            timestamp, 
            minutes, 
            notes, // Save the formatted notes
            count: mindfulness, 
            touches: [] 
        });
        
        if (goal) {
            goal.totalMinutes += minutes;
            if (goal.type === 'meditation') {
                if (!goal.totalMindfulness) goal.totalMindfulness = 0;
                goal.totalMindfulness += mindfulness;
            }
        }
    }
    
    this.save(); 
    this.renderGoals(); 
    this.renderCalendar(); 
    this.renderReports(); 
    this.checkAchievements();
    this.closeSessionModal(); 
    this.showToast(logId ? 'Session Updated!' : 'Session Logged!');
}
            deleteGoal(id) {
    // 1. Update the confirmation message
    if(confirm('Delete this goal and ALL associated history? This action cannot be undone.')) {
        
        // 2. Remove the goal from the goals list
        this.data.goals = this.data.goals.filter(g => g.id !== id);
        
        // 3. Remove all logs associated with this goalId
        this.data.logs = this.data.logs.filter(log => log.goalId === id ? false : true);
        // Alternative shorter syntax: this.data.logs = this.data.logs.filter(log => log.goalId !== id);
        
        // 4. Save and refresh the UI components
        this.save(); 
        this.renderGoals(); 
        this.renderReports(); 
        this.renderCalendar(); // Refresh the calendar to remove dots/data for this goal
        
        this.showToast('Goal and history deleted!');
    }
}
            renderDate() {
                 document.getElementById('current-date').innerText = new Date().toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }
        }

        const app = new GoalTracker();
    </script>
</body>
</html>