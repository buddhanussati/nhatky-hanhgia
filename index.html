<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nh·∫≠t K√Ω H√†nh Gi·∫£</title>
    <link href="./css/css.css" rel="stylesheet">
 	<script src="chart.js"></script>
    
    <style>
        :root {
            /* --- DARK THEME PALETTE --- */
            --primary: #818cf8;       
            --primary-dark: #6366f1;
            --secondary: #f472b6;     
            --bg: #111827;            
            --surface: #1f2937;       
            --text: #f3f4f6;          
            --text-light: #9ca3af;    
            --border: #374151;        
            --success: #34d399;
            --warning: #fbbf24;
            --danger: #f87171;
            --zen: #a78bfa; 
        }

        html { color-scheme: dark; } 

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }
        
        body { background-color: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* --- Sidebar --- */
        .sidebar {
            width: 80px;
            background: var(--surface);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            border-right: 1px solid var(--border);
            transition: width 0.3s;
            z-index: 50;
            flex-shrink: 0;
        }
        
        @media (min-width: 769px) {
            .sidebar:hover { width: 200px; }
            .sidebar:hover .nav-text { display: inline; opacity: 1; }
            .nav-item:hover, .nav-item.active { background-color: #374151; color: var(--primary); border-right: 3px solid var(--primary); }
        }
        
        .logo { font-size: 24px; color: var(--primary); margin-bottom: 40px; }
        
        .nav-item {
            width: 100%;
            padding: 15px 20px;
            cursor: pointer;
            color: var(--text-light);
            display: flex;
            align-items: center;
            transition: 0.2s;
            white-space: nowrap;
        }
        
        .nav-item i { font-size: 20px; min-width: 40px; text-align: center; }
        .nav-text { display: none; opacity: 0; transition: opacity 0.2s; margin-left: 10px; font-weight: 500;}

        /* --- Main Content --- */
        .main { flex: 1; overflow-y: auto; padding: 30px; position: relative; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px; }
        h1 { font-size: 24px; font-weight: 700; color: var(--text); }
        
        .btn {
            background: var(--primary);
            color: #111; 
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: 0.2s;
        }
        .btn:hover { background: var(--primary-dark); transform: translateY(-1px); color: white; }
        .btn-secondary { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }

        /* --- Gamification Bar --- */
        .user-stats {
            display: flex;
            gap: 20px;
            background: var(--surface);
            padding: 10px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            align-items: center;
            border: 1px solid var(--border);
        }
        .stat-item { display: flex; flex-direction: column; align-items: center; }
        .stat-val { font-weight: bold; font-size: 14px; }
        .stat-label { font-size: 10px; color: var(--text-light); text-transform: uppercase; }
        
        .stat-item.clickable { cursor: pointer; transition: 0.2s; }
        .stat-item.clickable:hover { opacity: 0.7; }
        .daily-bar-bg { width: 60px; height: 4px; background: #374151; border-radius: 2px; margin-top: 2px; overflow: hidden;}
        .daily-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s ease; }
        .daily-bar-fill.complete { background: var(--success); }

        /* --- Views --- */
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Dashboard Grid --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .card { background: var(--surface); padding: 20px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2); }
        
        /* Goal Cards */
        .goal-card { position: relative; overflow: hidden; border-left: 5px solid var(--primary); display: flex; flex-direction: column; }
        .goal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .goal-title { font-weight: 600; font-size: 18px; }
        .goal-tag { font-size: 12px; background: rgba(99, 102, 241, 0.2); color: var(--primary); padding: 2px 8px; border-radius: 10px; }
        
        .section-label { font-size: 11px; text-transform: uppercase; color: var(--text-light); font-weight: 700; margin-bottom: 5px; letter-spacing: 0.5px; }
        
        .progress-container { height: 8px; background: #374151; border-radius: 4px; margin: 0 0 5px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--secondary); width: 0%; transition: width 0.5s ease; } 
        
        .timer-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);}
        .timer-display { font-family: monospace; font-size: 20px; font-weight: 700; color: var(--text); }
        .btn-icon { width: 36px; height: 36px; border-radius: 50%; border: none; cursor: pointer; display: grid; place-items: center; color: white; transition: 0.2s;}
        .btn-play { background: var(--success); color: #000; }
        .btn-stop { background: var(--secondary); }
        .btn-play:hover { transform: scale(1.1); }

        /* Session List */
        .sessions-list ol { list-style: none; counter-reset: session-counter; padding: 0; }
        .session-item {
            display: flex; justify-content: space-between; align-items: flex-start;
            padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 12px; counter-increment: session-counter;
        }
        .session-item::before { content: counter(session-counter) "."; font-weight: bold; color: var(--primary); margin-right: 8px; min-width: 15px; }
        .session-content { flex: 1; }
        .session-date { font-weight: 600; color: var(--text); }
        .session-notes { color: var(--text-light); font-style: italic; margin-top: 2px; display: block;}

        /* --- Calendar --- */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 20px; }
        
        /* New Header for Weekdays */
        .calendar-header {
            display: contents; /* Allows children to sit in the main grid */
        }
        .cal-head-day {
            text-align: center; font-size: 11px; color: var(--text-light); font-weight: bold; padding-bottom: 5px;
        }

        .calendar-day { 
            aspect-ratio: 1; background: var(--bg); border-radius: 4px; 
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; cursor: pointer; position: relative; border: 1px solid var(--border);
            color: var(--text-light);
        }
       /* Level 1-5: The Foundation (Indigo spectrum) */
.calendar-day.level-1 { background: rgba(99, 102, 241, 0.3); border-color: rgba(99, 102, 241, 0.3); color: white; } 
.calendar-day.level-2 { background: rgba(99, 102, 241, 0.6); border-color: rgba(99, 102, 241, 0.5); color: white; } 
.calendar-day.level-3 { background: rgba(99, 102, 241, 1); border-color: var(--primary); color: white; } 
 .calendar-day.level-4 { 
 
background: #4d5eff ; 
    border: 1px solid rgba(255,255,255,0.2);
    color: white; 
}
.calendar-day.level-5 
{ background: var(--primary); border-color: var(--primary-dark); color: white; } 

.calendar-day.level-6 { 
background:  linear-gradient(135deg, var(--primary), #a78bfa);    box-shadow: inset 0 0 8px rgba(255,255,255,0.3);  border: 1px solid rgba(255,255,255,0.2);
	    color: white; 
			border-color: gold;
box-shadow: 0 0 20px #ffffff, 0 0 40px var(--primary);	}

/* Level 7: Right Mindfulness (Deep Royal Purple with a Soft Glow) */
.calendar-day.level-7 { 
background: linear-gradient(135deg, #a78bfa, #f472b6);
    border: 1px solid rgba(255,255,255,0.4);
box-shadow: 0 0 20px #ffffff, 0 0 40px var(--primary);	    color: white; 

border-color: rgba(251, 191, 36, 1);

}

/* Level 8: Right Concentration (Golden/Sunlight - The Peak) */
.calendar-day.level-8 { 
    background: linear-gradient(135deg, #6d28d9, #8b5cf6);
    border: 1px solid #a78bfa;
	color: white; 
    box-shadow: 0 0 12px rgba(139, 92, 246, 0.6);
	border-color: gold;
	animation: pulse-gold 2s infinite;
}


@keyframes pulse-gold {
    0% { transform: scale(1); }
    50% { box-shadow: 0 0 25px rgba(251, 191, 36, 1); }
    100% { transform: scale(1); }
}
        .calendar-day:hover { transform: scale(1.1); z-index: 2; box-shadow: 0 0 10px var(--primary); border: 1px solid white; }

        /* --- Modal & Inputs --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 100;
            backdrop-filter: blur(2px);
        }
        .modal-content { background: var(--surface); padding: 30px; border-radius: 16px; width: 400px; max-width: 90%; border: 1px solid var(--border); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-light); }
        
        .form-control { 
            width: 100%; padding: 10px; 
            background: var(--bg); color: var(--text);
            border: 1px solid var(--border); border-radius: 8px; 
        }
        .form-control:focus { outline: none; border-color: var(--primary); }
        input[type="color"].form-control { padding: 5px; height: 45px; cursor: pointer; }
        textarea.form-control { resize: vertical; min-height: 60px; }
        
        /* --- Toast --- */
        .toast {
            position: fixed; bottom: 80px; right: 20px; left: 20px;
            background: #373d49; color: white; padding: 12px 24px; border-radius: 8px;
            transform: translateY(200px); transition: transform 0.3s; z-index: 200;
            display: flex; align-items: center; gap: 10px; pointer-events: none;
        }
        .toast.show { transform: translateY(0); }
        .toast.achievement { background: var(--warning); color: #000; }

        /* --- Empty State --- */
        .empty-state { text-align: center; padding: 20px; color: var(--text-light); }

        /* --- Choice Modal --- */
        .choice-btn-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .choice-card {
            background: var(--bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border);
            text-align: center; cursor: pointer; transition: 0.2s;
        }
        .choice-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .choice-card i { font-size: 30px; margin-bottom: 10px; display: block; }

        /* --- Meditation Overlay --- */
        #meditation-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; z-index: 999; display: none;
            flex-direction: column; justify-content: center; align-items: center;
            user-select: none; touch-action: manipulation;
        }
        .meditation-circle {
            width: 250px; height: 250px; border-radius: 50%;
            background: radial-gradient(circle, #818cf8 0%, transparent 70%);
            display: flex; justify-content: center; align-items: center;
            font-size: 60px; font-weight: bold; color: white;
            pointer-events: none; /* Let clicks pass through to container */
        }

        .med-controls { position: absolute; top: 20px; right: 20px; display: flex; gap: 15px; z-index: 1000; }
        .med-timer-disp { position: absolute; top: 20px; left: 20px; font-size: 24px; font-family: monospace; color: #9ca3af; z-index: 1000;}
        .med-instruction { position: absolute; bottom: 50px; color: #6b7280; font-size: 14px; text-transform: uppercase; letter-spacing: 2px;}

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar {
                width: 100%; height: 65px; position: fixed; bottom: 0; left: 0;
                flex-direction: row; justify-content: space-around; padding: 0;
                border-right: none; border-top: 1px solid var(--border);
                background-color: var(--surface); box-shadow: 0 -4px 10px rgba(0,0,0,0.3);
                overflow-y: auto; min-height: 0;
            }
            .sidebar:hover { width: 100%; }
            .logo { display: none; }
            .nav-item { flex-direction: column; justify-content: center; padding: 5px; font-size: 10px; height: 100%; min-width: 60px; }
            .nav-item i { font-size: 18px; margin-bottom: 3px; }
            .nav-text { display: block; opacity: 1; margin-left: 0; font-size: 10px; }
            .nav-item.active { border-right: none; border-top: 3px solid var(--primary); background: transparent; color: var(--primary); }
            .main { padding: 15px; padding-bottom: 90px; }
            header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .user-stats { width: 100%; padding: 15px; flex-wrap: wrap; justify-content: space-between; }
            .user-stats .btn { width: 100%; margin-top: 10px; justify-content: center; background-color: var(--primary); color: #000; }
            .dashboard-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<nav class="sidebar">
        <div class="logo"><i class="fas fa-hourglass-half"></i></div>
        <div class="nav-item active" onclick="app.switchView('dashboard')">
            <i class="fas fa-spa"></i><span class="nav-text">Nh·∫≠t K√Ω</span>
        </div>
        <div class="nav-item" onclick="app.switchView('calendar')">
            <i class="fas fa-calendar-alt"></i><span class="nav-text">L·ªãch</span>
        </div>
        <div class="nav-item" onclick="app.switchView('reports')">
            <i class="fas fa-chart-pie"></i><span class="nav-text">T·ªïng h·ª£p</span>
        </div>
		<div class="nav-item" onclick="app.switchView('analytics')">
    <i class="fas fa-microscope"></i><span class="nav-text">Ph√¢n t√≠ch</span>
</div>
        <div class="nav-item" onclick="app.switchView('achievements')">
            <i class="fas fa-trophy"></i><span class="nav-text">Th√†nh t·ª±u</span>
        </div>
        
        <div style="margin-top: auto;" class="desktop-only"></div>
        
        <div class="nav-item" onclick="app.exportData()">
    <i class="fas fa-save"></i><span class="nav-text">Sao l∆∞u</span>
</div>
        <div class="nav-item" onclick="app.resetApp()" style="color: var(--danger);"> <i class="fas fa-trash-alt"></i><span class="nav-text">ƒê·∫∑t l·∫°i</span>
        </div>
    </nav>


    <main class="main">
        <header>
            <div>
                <h1 id="page-title">Nh·∫≠t K√Ω H√†nh Gi·∫£</h1>
                <p style="color: var(--text-light); font-size: 14px;" id="current-date"></p>
            </div>
            
            <div class="user-stats">
    <div class="stat-item clickable" onclick="app.setGlobalDailyGoal()" title="Nh·∫•n ƒë·ªÉ s·ª≠a m·ª•c ti√™u ng√†y">
        <span class="stat-val"><span id="daily-current">0</span> / <span id="daily-target">60</span>m</span>
        <div class="daily-bar-bg"><div id="daily-bar-fill" class="daily-bar-fill"></div></div>
        <span class="stat-label">H√†ng ng√†y</span>
    </div>
    <div class="stat-item">
        <span class="stat-val" id="streak-disp">0 üî•</span>
        <span class="stat-label">Li√™n t·ª•c</span>
    </div>

    <div class="stat-item">
        <span class="stat-val" id="xp-disp">0 XP</span>
        <span class="stat-label">C·∫•p ƒë·ªô <span id="level-disp">1</span></span>
    </div>

 <div class="stat-item clickable" onclick="app.openIntroModal()">
    <span class="stat-val" style="
        border: 2px solid var(--text-light); 
        border-radius: 50%; 
        width: 24px; 
        height: 24px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        font-size: 14px;">?</span>
</div>

    <button class="btn" onclick="app.openChoiceModal()">
        <i class="fas fa-plus"></i> M·ª•c ti√™u m·ªõi
    </button>
</div>
        </header>

        <section id="view-dashboard" class="view-section active">
            <div id="active-goals-container" class="dashboard-grid"></div>
            <div id="empty-msg" class="empty-state" style="display:none;">
                <i class="fas fa-clipboard-list" style="font-size: 40px; margin-bottom: 10px;"></i>
                <p>Ch∆∞a c√≥ m·ª•c ti√™u n√†o. H√£y t·∫°o ƒë·ªÉ b·∫Øt ƒë·∫ßu!</p>
            </div>
        </section>

        <section id="view-calendar" class="view-section">
            <div class="card">
                <h2>L·ªãch Tu T·∫≠p</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
                    <button class="btn btn-secondary" onclick="app.changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="cal-month-year">Th√°ng NƒÉm</h3>
                    <button class="btn btn-secondary" onclick="app.changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-grid" id="calendar-grid"></div>
            </div>
        </section>

        <section id="view-reports" class="view-section">
    <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 25px;">
        <button class="btn" id="btn-rep-time" onclick="app.setReportMode('time')">
            <i class="fas fa-clock"></i> Th·ªùi gian
        </button>
        <button class="btn btn-secondary" id="btn-rep-mind" onclick="app.setReportMode('mindfulness')">
            <i class="fas fa-spa"></i> Ch√°nh ni·ªám
        </button>
    </div>

    <div class="dashboard-grid" style="grid-template-columns: 1fr;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
            <div class="card">
                <h3 id="breakdown-title">Bi·ªÉu ƒë·ªì Th·ªùi gian</h3>
                <div style="height: 300px; display:flex; justify-content:center;">
                    <canvas id="goalBreakdownChart"></canvas>
                </div>
            </div>
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <button class="btn btn-secondary" style="padding: 5px 10px;" onclick="app.changeReportWeek(-1)"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="weekly-report-title">Ti√™u ƒëi·ªÉm tu·∫ßn</h3>
                    <button class="btn btn-secondary" style="padding: 5px 10px;" onclick="app.changeReportWeek(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div style="height: 300px;">
                    <canvas id="weeklyChart"></canvas>
                </div>
            </div>
            </div>
            
            <div class="card" style="margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <button class="btn btn-secondary" style="padding: 5px 10px;" onclick="app.changeReportMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                <h3 id="monthly-report-title">Ti√™u ƒëi·ªÉm th√°ng</h3>
                <button class="btn btn-secondary" style="padding: 5px 10px;" onclick="app.changeReportMonth(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div style="height: 300px;">
                <canvas id="monthlyChart"></canvas>
            </div>
        </div>
    </div>
</section>
<section id="view-analytics" class="view-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
        <h2 style="margin: 0;">Ph√¢n t√≠ch Thi·ªÅn t·∫≠p</h2>

        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <select id="ana-goal-select" class="form-control" style="width: auto; min-width: 150px;" onchange="app.renderAnalytics()">
                </select>

            <div id="threshold-config" style="display: flex; align-items: center; gap: 5px; background: var(--surface); padding: 5px 12px; border-radius: 8px; border: 1px solid var(--border);">
                <span style="font-size: 12px; color: var(--text-light); white-space: nowrap;">
                    <i class="fas fa-stopwatch"></i> Ng∆∞·ª°ng m·∫•t t·∫≠p trung:
                </span>
                <input type="number" id="ana-threshold" 
                       style="width: 45px; 
                              background: rgba(17, 24, 39, 0.7); 
                              border: 1px solid var(--border); 
                              border-radius: 4px; 
                              color: var(--primary); 
                              font-weight: bold; 
                              text-align: center; 
                              outline: none;" 
                       value="12" min="1" onchange="app.saveThreshold(this.value)">
                <span style="font-size: 11px; color: var(--text-light);">s</span>
            </div>

            <select id="ana-time-range" class="form-control" style="width: auto;" onchange="app.renderAnalytics()">
                <option value="7" selected>7 ng√†y qua</option>
                <option value="30">30 ng√†y qua</option>
                <option value="90">3 th√°ng qua</option>
                <option value="365">To√†n b·ªô</option>
            </select>
        </div>
    </div>

    <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 20px;">
        <div class="card" style="text-align: center; border-left: 4px solid var(--zen);">
            <div style="font-size: 12px; color: var(--text-light); text-transform: uppercase;">Ch·∫•t l∆∞·ª£ng trung b√¨nh</div>
            <div style="font-size: 28px; font-weight: bold; margin: 5px 0;" id="ana-avg-quality">0%</div>
            <div style="font-size: 11px; color: var(--text-light);">T·ª∑ l·ªá t·ªânh th·ª©c/th·ªùi gian</div>
        </div>
        <div class="card" style="text-align: center; border-left: 4px solid var(--primary);">
            <div style="font-size: 12px; color: var(--text-light); text-transform: uppercase;">Ch·∫•t l∆∞·ª£ng Ch√°nh ni·ªám</div>
            <div style="font-size: 28px; font-weight: bold; margin: 5px 0;" id="ana-avg-density">0</div>
            <div style="font-size: 11px; color: var(--text-light);">Ch√°nh ni·ªám / ph√∫t</div>
        </div>
        <div class="card" style="text-align: center; border-left: 4px solid var(--danger);">
            <div style="font-size: 12px; color: var(--text-light); text-transform: uppercase;">T·ªïng th·∫•t ni·ªám</div>
            <div style="font-size: 28px; font-weight: bold; margin: 5px 0;" id="ana-total-distracted">0h</div>
            <div style="font-size: 11px; color: var(--text-light);">Th·ªùi gian m·∫•t ch√°nh ni·ªám</div>
        </div>
    </div>

    <div class="dashboard-grid" style="grid-template-columns: 1fr; gap: 20px;">
        <div class="card">
            <h3>üìà Chi·ªÅu h∆∞·ªõng T·ªânh th·ª©c</h3>
            <p style="font-size: 12px; color: var(--text-light); margin-bottom: 15px;">So s√°nh t·ª∑ l·ªá ch√°nh ni·ªám gi·ªØa c√°c th·ªùi thi·ªÅn g·∫ßn ƒë√¢y.</p>
            <div style="height: 300px;">
                <canvas id="analyticsTrendChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h3>üìä So s√°nh K·∫øt qu·∫£</h3>
            <div style="margin-top: 15px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border); color: var(--text-light);">
                            <th style="text-align: left; padding: 10px;">Th·ªùi gian</th>
                            <th style="text-align: center; padding: 10px;">Th·ªùi thi·ªÅn</th>
                            <th style="text-align: center; padding: 10px;">T·ªïng gi·ªù</th>
                            <th style="text-align: center; padding: 10px;">Ch·∫•t l∆∞·ª£ng</th>
                            <th style="text-align: center; padding: 10px;">Ch√°nh ni·ªám&#8203;/&#8203;ph√∫t</th>
                        </tr>
                    </thead>
                    <tbody id="ana-comparison-table">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</section>
        <section id="view-achievements" class="view-section">
            <div class="card">
                <h2><i class="fas fa-medal"></i> Th√†nh t·ª±u</h2>
                <div id="achievement-list" style="margin-top: 20px; display: grid; gap: 10px;"></div>
            </div>
        </section>
    </main>

    <div class="modal" id="choice-modal">
        <div class="modal-content">
            <h2 style="text-align:center;">Ch·ªçn lo·∫°i m·ª•c ti√™u</h2>
            <div class="choice-btn-container">
                <div class="choice-card" onclick="app.openModal(null, 'meditation')">
                    <i class="fas fa-spa" style="color: var(--zen);"></i>
                    <h3>Thi·ªÅn ƒê·ªãnh</h3>
                    <p style="font-size:12px; color:var(--text-light); margin-top:5px;">Theo d√µi ch√°nh ni·ªám</p>
                </div>
                <div class="choice-card" onclick="app.openModal(null, 'standard')">
                    <i class="fas fa-tasks" style="color: var(--primary);"></i>
                    <h3>C√¥ng Vi·ªác</h3>
                    <p style="font-size:12px; color:var(--text-light); margin-top:5px;">Theo d√µi ti·∫øn ƒë·ªô</p>
                </div>
            </div>
            <button class="btn btn-secondary" style="width:100%; margin-top:20px;" onclick="app.closeChoiceModal()">H·ªßy</button>
        </div>
    </div>

    <div class="modal" id="goal-modal">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-bottom: 20px;">T·∫°o m·ª•c ti√™u m·ªõi</h2>
            <form onsubmit="app.saveGoal(event)">
                <input type="hidden" id="g-id"> 
                <input type="hidden" id="g-type"> 
                
                <div class="form-group">
                    <label>T√™n m·ª•c ti√™u</label>
                    <input type="text" id="g-name" class="form-control" required>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Danh m·ª•c</label>
                        <select id="g-cat" class="form-control">
                            </select>
                    </div>
                    <div class="form-group">
                        <label>M√†u s·∫Øc</label>
                        <input type="color" id="g-color" class="form-control" value="#6366f1">
                    </div>
                </div>
                
                <div class="form-group" style="background: rgba(16, 185, 129, 0.1); padding: 10px; border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.3);">
                    <label style="color: var(--success);">M·ª•c ti√™u h√†ng ng√†y</label>
                    <input type="number" id="g-daily-target" class="form-control" min="0" value="30">
                    <small id="g-daily-hint" style="color: var(--success); font-size: 11px;">Ph√∫t m·ªói ng√†y</small>
                </div>
                
                <div class="form-group">
                    <label>Th√†nh t·ª±u trong</label>
                    <input type="number" id="g-lifetime-target" class="form-control" required min="1" value="1000">
                    <small id="g-life-hint" style="color: var(--text-light); font-size: 11px;">T·ªïng s·ªë ph√∫t</small>
                </div>
                
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal()">H·ªßy</button>
                    <button type="submit" class="btn" id="btn-save-goal">T·∫°o m·ª•c ti√™u</button>
                </div>
            </form>
        </div>
    </div>
<div class="modal" id="backup-modal">
    <div class="modal-content">
        <h2 style="margin-bottom: 10px; text-align: center;">Sao l∆∞u & Kh√¥i ph·ª•c</h2>
        
        <div class="desktop-actions" style="margin-bottom: 20px;">
            <p style="color: var(--text-light); text-align: center; font-size: 12px; margin-bottom: 10px;">
                <i class="fas fa-box-archive"></i> <strong>T·ª± ƒë·ªông sao l∆∞u & kh√¥i ph·ª•c d·ªØ li·ªáu:</strong>
            </p>
            <div style="display: flex;  justify-content: center; gap: 10px;">
                <button class="btn" style="flex: 1;" onclick="app.downloadFile()">
                    <i class="fas fa-download"></i> Sao l∆∞u
                </button>
                <button class="btn btn-secondary"; style="flex: 1;" " onclick="document.getElementById('backup-file-input').click()">
                    <i class="fas fa-file-import"></i> Kh√¥i&nbsp;ph·ª•c
                </button>
                <input type="file" id="backup-file-input" style="display: none;" accept=".json, .txt" onchange="app.handleFileUpload(this)">
            </div>
        </div>
<div style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
    
    <button class="btn btn-secondary" style="flex: 1;" onclick="app.shareBackup()">
        <i class="fas fa-share-alt"></i> Chia&nbsp;s·∫ª
    </button>

    <button class="btn btn-secondary" style="flex: 1; border-color: var(--danger); color: var(--danger);" onclick="app.closeBackupModal()">
        ƒê√≥ng
    </button>
</div>
</div></div>
    <div class="modal" id="session-modal">
    <div class="modal-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 id="session-title" style="margin: 0;">Ghi nh·∫≠n phi√™n</h2>
            <button type="button" id="btn-delete-session" class="btn-icon" 
                style="background: transparent; color: var(--danger); display: none; width: 30px; height: 30px;" 
                onclick="app.deleteSession()"
                title="X√≥a phi√™n n√†y">
                <i class="fas fa-trash"></i>
            </button>
        </div>
            <form onsubmit="app.logSessionConfirm(event)">
                <input type="hidden" id="s-goal-id" />
                <input type="hidden" id="s-log-id" />
                
                <div class="form-group">
                    <label>Ng√†y & Gi·ªù b·∫Øt ƒë·∫ßu</label>
                    <input type="datetime-local" id="s-date" class="form-control" required />
                </div>
                
                <div class="form-group">
                    <label>Th·ªùi l∆∞·ª£ng (Ph√∫t)</label>
                    <input type="number" id="s-minutes" class="form-control" required min="1" />
                </div>
                <div class="form-group" id="s-mindfulness-group" style="display:none; background: rgba(167, 139, 250, 0.1); padding: 10px; border-radius: 8px; border: 1px solid rgba(167, 139, 250, 0.3);">
    <label style="color: var(--zen);">S·ªë l·∫ßn ch√°nh ni·ªám</label>
    <input type="number" id="s-mindfulness" class="form-control" min="0" value="0" />
</div>
                <div class="form-group">
                    <label>Ghi ch√∫ (T√πy ch·ªçn)</label>
                    <textarea id="s-notes" class="form-control" placeholder="B·∫°n ƒë√£ t·∫≠p trung v√†o ƒëi·ªÅu g√¨?"></textarea>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="app.closeSessionModal()">H·ªßy</button>
                    <button type="submit" class="btn">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <div id="meditation-overlay">
        <div class="med-timer-disp" id="med-timer">00:00</div>
        <div class="med-controls">
            <button class="btn btn-secondary" onclick="app.togglePauseMeditation()" id="med-pause-btn"><i class="fas fa-pause"></i></button>
            <button class="btn" style="background-color: var(--danger); color: white;" onclick="app.concludeMeditationSession()"><i class="fas fa-stop"></i></button>
        </div>
        
        <div class="meditation-circle" id="med-counter">0</div>
        
        <div class="med-instruction" style="text-align: center;">Ch·∫°m m√†n h√¨nh ƒë·ªÉ ghi&nbsp;nh·∫≠n&nbsp;ch√°nh&nbsp;ni·ªám</div>
    </div>

    <div class="modal" id="meditation-finish-modal">
        <div class="modal-content">
            <h2 style="text-align: center; margin-bottom: 10px;">Th·ªùi thi·ªÅn ho√†n t·∫•t üåø</h2>
            <div style="text-align:center; margin: 20px 0; display:flex; justify-content:space-around; align-items:center;">
                <div>
                    <div style="font-size: 30px; font-weight:bold; color:var(--zen)" id="med-finish-count">0</div>
                    <div style="color:var(--text-light); font-size:12px;">Ch√°nh ni·ªám</div>
                </div>
                <div style="height:40px; width:1px; background:var(--border);"></div>
                <div>
                    <div style="font-size: 30px; font-weight:bold; color:var(--text)" id="med-finish-time">0m</div>
                    <div style="color:var(--text-light); font-size:12px;">Th·ªùi gian</div>
                </div>
            </div>
            <div class="form-group">
                <label>Nh·∫≠t k√Ω</label>
                <textarea id="med-finish-notes" class="form-control" placeholder="Ch√°nh ni·ªám c·ªßa b·∫°n c√≥ t·ªët kh√¥ng?"></textarea>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
                 <button class="btn btn-secondary" onclick="app.discardMeditation()">H·ªßy b·ªè</button>
                 <button class="btn" style="background:var(--zen); color:white" onclick="app.saveMeditationLog()">L∆∞u nh·∫≠t k√Ω</button>
            </div>
        </div>
    </div>
    <div class="modal" id="graph-modal" style="overflow-y: auto; z-index: 150;">
        <div class="modal-content" style="width: 600px;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 20px;">
                <div>
                    <h2 style="margin-bottom: 5px;">Th·ªùi thi·ªÅn</h2>
                    <p id="graph-date" style="color: var(--text-light); font-size: 14px; margin: 0;"></p>
                </div>
               
            </div>

            <div style="height: 300px; width: 100%;">
                <canvas id="sessionGraph"></canvas>
            </div>
            
            <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
			<button class="btn btn-secondary" id="btn-export-session" title="Sao ch√©p d·ªØ li·ªáu JSON">
                    <i class="fas fa-file-code"></i>
                </button>
			<select id="graph-type-select" class="form-control" style="width: auto; padding: 5px 5px 5px; height: 36px; font-size: 13px; cursor: pointer;" onchange="app.updateSessionChart()">
			                    <option value="interval">‚òÅÔ∏è Th·∫•t ni·ªám</option>
                    <option value="intensity">üå± Ch√°nh ni·ªám</option>
                </select>
                
                <button class="btn btn-secondary" onclick="document.getElementById('graph-modal').style.display='none'" title="ƒê√≥ng"><i class="fas fa-xmark"></i></button>
				 
            </div>
        </div>
    </div>

    <div class="modal" id="day-details-modal" style="overflow-y: auto;">
    <div class="modal-content">
        <h2 id="day-modal-title" style="margin-bottom: 10px; font-size: 20px;">Chi ti·∫øt ng√†y</h2>
        
        <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 15px;">
            <button class="btn" id="btn-modal-time" style="padding: 5px 15px; font-size: 12px;" onclick="app.switchDayChart('time')">
                <i class="fas fa-clock"></i> Th·ªùi gian
            </button>
            <button class="btn btn-secondary" id="btn-modal-mind" style="padding: 5px 15px; font-size: 12px;" onclick="app.switchDayChart('mindfulness')">
                <i class="fas fa-spa"></i> Ch√°nh ni·ªám
            </button>
        </div>

        <div style="height: 200px; position: relative; margin-bottom: 20px;">
            <canvas id="dayBreakdownChart"></canvas>
        </div>

        <h3 style="font-size: 14px; color: var(--text-light); border-bottom: 1px solid var(--border); padding-bottom: 5px; margin-bottom: 10px;">Nh·∫≠t k√Ω ho·∫°t ƒë·ªông</h3>
        <div id="day-session-list" style="max-height: 150px; overflow-y: auto;"></div>
        
        <div style="display: flex; justify-content: flex-end; margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px;">
            <button class="btn btn-secondary" onclick="app.closeDayModal()">ƒê√≥ng</button>
        </div>
    </div>
</div>

    <div id="toast" class="toast">
        <i class="fas fa-info-circle"></i> <span id="toast-msg">Th√¥ng b√°o</span>
    </div>
<div class="modal" id="intro-modal" style="z-index: 9999;">
    <div class="modal-content" style="max-width: 800px; width: 95%; max-height: 90vh; display: flex; flex-direction: column; padding: 0;">
        
        <div style="padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--surface); border-radius: 16px 16px 0 0;">
            <h2 style="margin: 0;">‚ú® Nh·∫≠t K√Ω H√†nh Gi·∫£</h2>
            <button class="btn-icon" onclick="app.closeIntroModal()" style="color: var(--text-light); background: transparent;"><i class="fas fa-times"></i></button>
        </div>

        <div style="padding: 20px; overflow-y: auto; line-height: 1.6; color: var(--text-light);">
            
            <p><strong>Nh·∫≠t K√Ω H√†nh Gi·∫£</strong> l√† ·ª©ng d·ª•ng h·ªó tr·ª£ tu t·∫≠p v√† l√†m vi·ªác. ·ª®ng d·ª•ng gi√∫p h√†nh gi·∫£ theo d√µi ti·∫øn tr√¨nh trong c√¥ng vi·ªác c≈©ng nh∆∞ trong h√†nh thi·ªÅn, ghi nh·∫≠n m·ª©c ƒë·ªô t·ªânh gi√°c th√¥ng qua s·ªë l·∫ßn "Ch√°nh Ni·ªám", v√† tr·ª±c quan h√≥a tr·∫°ng th√°i t√¢m tr√≠ qua bi·ªÉu ƒë·ªì & ƒë·ªì th·ªã theo th·ªùi gian th·ª±c.</p>
            
            <img src="1vi.png" alt="Dashboard Preview" style="width: 100%; border-radius: 8px; border: 1px solid var(--border); margin: 10px 0;">

            <h3 style="color: var(--text); margin-top: 20px;">‚ú® C√°c Kh√°i Ni·ªám C·ªët L√µi</h3>
            <p>ƒê·ªÉ s·ª≠ d·ª•ng ·ª©ng d·ª•ng hi·ªáu qu·∫£, b·∫°n c·∫ßn n·∫Øm r√µ c√°c ch·ªâ s·ªë sau:</p>
            <ul style="padding-left: 20px; margin-bottom: 15px;">
                <li><strong>Ch√°nh Ni·ªám:</strong> ƒê∆°n v·ªã ƒëo l∆∞·ªùng s·ª± t·ªânh gi√°c. M·ªói l·∫ßn b·∫°n nh·∫≠n bi·∫øt ƒë∆∞·ª£c h∆°i th·ªü ho·∫∑c tr·∫°ng th√°i t√¢m tr√≠ v√† ch·∫°m v√†o m√†n h√¨nh, m·ªôt "Ch√°nh Ni·ªám" s·∫Ω ƒë∆∞·ª£c ghi l·∫°i.</li>
                <li><strong>Ch√°nh ni·ªám t·ªët:</strong> Tr·∫°ng th√°i khi t·∫ßn su·∫•t ghi nh·∫≠n (Ni·ªám) duy tr√¨ ·ªü m·ª©c ·ªïn ƒë·ªãnh v√† ƒë·ªÅu ƒë·∫∑n.</li>
                <li><strong>Th·∫•t ni·ªám:</strong> Tr·∫°ng th√°i khi t√¢m tr√≠ b·ªã xao nh√£ng ho·∫∑c bu·ªìn ng·ªß, d·∫´n ƒë·∫øn vi·ªác kh√¥ng c√≥ ho·∫∑c c√≥ r·∫•t √≠t ghi nh·∫≠n trong m·ªôt kho·∫£ng th·ªùi gian.</li>
                <li><strong>Chu·ªói Tinh T·∫•n:</strong> S·ªë ng√†y li√™n ti·∫øp b·∫°n th·ª±c hi·ªán tu t·∫≠p.</li>
            </ul>

            <h3 style="color: var(--text); margin-top: 20px;">‚ú® T√≠nh NƒÉng N·ªïi B·∫≠t</h3>
            
            <h4 style="color: var(--primary);">1. Qu·∫£n L√Ω M·ª•c Ti√™u ƒêa D·∫°ng</h4>
            <ul style="padding-left: 20px;">
                <li><strong>Hai lo·∫°i m·ª•c ti√™u ch√≠nh:</strong>
                    <ul>
                        <li><strong>‡•ê Thi·ªÅn ƒê·ªãnh:</strong> Theo d√µi th·ªùi gian ng·ªìi thi·ªÅn v√† ƒë·∫øm s·ªë l·∫ßn ghi nh·∫≠n ch√°nh ni·ªám ("Sati").</li>
                        <li><strong>‚ö° C√¥ng Vi·ªác:</strong> ƒê·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c truy·ªÅn th·ªëng d√πng cho c√¥ng vi·ªác, h·ªçc t·∫≠p (Pomodoro) ho·∫∑c c√°c th√≥i quen kh√°c.</li>
                    </ul>
                </li>
                <li><strong>T√πy bi·∫øn:</strong> T·ª± ƒë·∫∑t m·ª•c ti√™u h√†ng ng√†y (s·ªë ph√∫t), th·ªùi gian c·∫ßn d√†nh ƒë·ªÉ ho√†n th√†nh m·ª•c ti√™u, m√†u s·∫Øc ƒë·∫°i di·ªán v√† danh m·ª•c qu·∫£n l√Ω.</li>
            </ul>

            <h4 style="color: var(--primary); margin-top: 15px;">2. ƒê·ªìng H·ªì & Ghi Nh·∫≠n T∆∞∆°ng T√°c</h4>
            <ul style="padding-left: 20px;">
                <li><strong>Ch·∫ø ƒë·ªô Thi·ªÅn:</strong>
                    <ul>
                        <li><strong>Ch·∫°m ƒë·ªÉ ƒë·∫øm:</strong> Ch·∫°m v√†o m√†n h√¨nh (ho·∫∑c click chu·ªôt) m·ªói khi b·∫°n ghi nh·∫≠n ƒë∆∞·ª£c s·ª± ch√∫ t√¢m quay v·ªÅ h∆°i th·ªü. S·ªë ƒë·∫øm n√†y ƒë∆∞·ª£c t√≠ch l≈©y th√†nh ƒëi·ªÉm Ch√°nh ni·ªám (Sati).</li>
                    </ul>
                </li>
            </ul>
            <div style="text-align: center; margin: 15px 0;">
                <img src="2vi.png" alt="Meditation Mode" style="max-width: 300px; width: 100%; border-radius: 8px; border: 1px solid var(--border);">
            </div>
            <ul style="padding-left: 20px;">
                <li><strong>Ch·∫ø ƒë·ªô T·∫≠p trung:</strong> ƒê·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c v·ªõi thanh ti·∫øn tr√¨nh tr·ª±c quan.</li>
                <li><strong>Nh·∫≠p li·ªáu th·ªß c√¥ng:</strong> Qu√™n b·∫•m gi·ªù? B·∫°n c√≥ th·ªÉ t·ª± nh·∫≠p l·∫°i phi√™n thi·ªÅn ho·∫∑c s·ª≠a ƒë·ªïi c√°c ghi ch√©p c≈©.</li>
            </ul>

            <h4 style="color: var(--primary); margin-top: 15px;">3. B√°o C√°o & Ph√¢n T√≠ch S·ªë Li·ªáu</h4>
            <ul style="padding-left: 20px;">
                <li><strong>B·∫£ng nh·∫≠t k√Ω:</strong> Xem ti·∫øn ƒë·ªô ng√†y h√¥m nay so v·ªõi m·ª•c ti√™u ƒë·ªÅ ra.</li>
                <li><strong>L·ªãch tu t·∫≠p:</strong> Bi·ªÉu ƒë·ªì d·∫°ng l∆∞·ªõi hi·ªÉn th·ªã m·ª©c ƒë·ªô tu t·∫≠p theo ng√†y. M√†u c√†ng ƒë·∫≠m th·ªÉ hi·ªán th·ªùi gian tu t·∫≠p c√†ng nhi·ªÅu.</li>
                <li><strong>Bi·ªÉu ƒë·ªì tr·ª±c quan:</strong>
                    <ul>
                        <li><strong>Bi·ªÉu ƒë·ªì phi√™n:</strong> Xem l·∫°i m·ª©c ƒë·ªô ch√°nh ni·ªám <em>trong t·ª´ng th·ªùi thi·ªÅn</em> (bi·ªÉu ƒë·ªì ƒë∆∞·ªùng).</li>
                        <li><strong>B√°o c√°o Tu·∫ßn/Th√°ng:</strong> So s√°nh hi·ªáu su·∫•t theo th·ªùi gian th·ª±c.</li>
                        <li><strong>Ph√¢n b·ªï:</strong> Bi·ªÉu ƒë·ªì tr√≤n xem t·ª∑ l·ªá th·ªùi gian d√†nh cho c√°c m·ª•c ti√™u kh√°c nhau.</li>
                    </ul>
                </li>
            </ul>
<h4 style="color: var(--primary); margin-top: 15px;">4. Ph√¢n T√≠ch Thi·ªÅn T·∫≠p (M·ªõi)</h4>
            <p>Tab <strong>"Ph√¢n t√≠ch"</strong> gi√∫p b·∫°n soi chi·∫øu l·∫°i ch·∫•t l∆∞·ª£ng t√¢m trong c√°c th·ªùi thi·ªÅn v·ªõi ƒë·ªô ch√≠nh x√°c cao h∆°n.</p>
            <ul style="padding-left: 20px;">
                <li><strong>Ph√¢n t√≠ch theo t·ª´ng m·ª•c ti√™u:</strong> B·∫°n c√≥ th·ªÉ ch·ªçn xem s·ªë li·ªáu c·ªßa ri√™ng "Thi·ªÅn T·ªça" hay "Thi·ªÅn H√†nh" ƒë·ªÉ so s√°nh s·ª± ti·∫øn b·ªô c·ªßa t·ª´ng ph∆∞∆°ng ph√°p tu t·∫≠p.</li>
                
                <li style="margin-top: 10px;">
                    <strong> Ng∆∞·ª°ng m·∫•t t·∫≠p trung:</strong>
                    <p style="font-size: 13px; color: var(--text-light); margin-top: 5px;">
                        ƒê√¢y l√† kh√°i ni·ªám quan tr·ªçng nh·∫•t ƒë·ªÉ t√≠nh to√°n "Ch·∫•t l∆∞·ª£ng thi·ªÅn".
                    </p>
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 6px; border-left: 3px solid var(--warning); margin: 5px 0;">
                        <em>"Ng∆∞·ª°ng m·∫•t t·∫≠p trung" l√† kho·∫£ng c√°ch t·ªëi ƒëa cho ph√©p gi·ªØa hai l·∫ßn ghi nh·∫≠n; n·∫øu v∆∞·ª£t qu√° th·ªùi gian n√†y, h·ªá th·ªëng s·∫Ω xem l√† b·∫°n ƒëang m·∫•t t·∫≠p trung.</em>
                    </div>
                    <ul style="margin-top: 5px;">
                        <li><strong>C∆° ch·∫ø ho·∫°t ƒë·ªông:</strong> V√≠ d·ª• b·∫°n ƒë·∫∑t ng∆∞·ª°ng l√† <strong>12 gi√¢y</strong>.
                            <ul>
                                <li>N·∫øu b·∫°n ch·∫°m m√†n h√¨nh sau <strong>5 gi√¢y</strong>: To√†n b·ªô th·ªùi gian ƒë√≥ l√† T·ªânh th·ª©c.</li>
                                <li>N·∫øu b·∫°n ch·∫°m sau <strong>20 gi√¢y</strong>: H·ªá th·ªëng hi·ªÉu r·∫±ng b·∫°n ƒë√£ l∆° l√† ho·∫∑c h√¥n tr·∫ßm m·∫•t <strong>8 gi√¢y</strong> (20 - 12 = 8).</li>
                            </ul>
                        </li>
                        <li><strong>T√πy ch·ªânh ri√™ng bi·ªát:</strong> M·ªói lo·∫°i thi·ªÅn c·∫ßn m·ªôt nh·ªãp ƒë·ªô kh√°c nhau. B·∫°n c√≥ th·ªÉ c√†i ƒë·∫∑t ng∆∞·ª°ng th·∫•p (v√≠ d·ª• 5s) cho c√°c b√†i t·∫≠p ghi nh·∫≠n nhanh, ho·∫∑c ng∆∞·ª°ng cao (30s) cho c√°c b√†i t·∫≠p ƒë·ªãnh t√¢m s√¢u. H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông nh·ªõ c√†i ƒë·∫∑t n√†y cho t·ª´ng m·ª•c ti√™u.</li>
                    </ul>
                </li>
            </ul>
            <h4 style="color: var(--primary); margin-top: 15px;">5. Ri√™ng T∆∞ & An To√†n D·ªØ Li·ªáu</h4>
            <ul style="padding-left: 20px;">
                <li><strong>Offline Ho√†n To√†n:</strong> 100% d·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u tr·ªØ tr·ª±c ti·∫øp tr√™n tr√¨nh duy·ªát v√† thi·∫øt b·ªã c·ªßa b·∫°n. Kh√¥ng c√≥ d·ªØ li·ªáu n√†o ƒë∆∞·ª£c g·ª≠i v·ªÅ m√°y ch·ªß.</li>
                <li><strong>Sao l∆∞u & Kh√¥i ph·ª•c:</strong> D·ªÖ d√†ng xu·∫•t d·ªØ li·ªáu ra file <code>.json</code> ƒë·ªÉ c·∫•t gi·ªØ ho·∫∑c chuy·ªÉn sang thi·∫øt b·ªã kh√°c.</li>
            </ul>

            <hr style="border: 0; border-top: 1px solid var(--border); margin: 25px 0;">
            <h3 style="color: var(--text); margin-top: 20px;">üöÄ H∆∞·ªõng D·∫´n S·ª≠ D·ª•ng</h3>
            
            <strong style="display:block; margin-bottom:10px; color: var(--text);">1. T·∫°o M·ª•c Ti√™u M·ªõi</strong>
            <ul style="padding-left: 20px; margin-bottom: 15px;">
                <li>Nh·∫•n n√∫t <strong>"M·ª•c ti√™u m·ªõi"</strong> tr√™n m√†n h√¨nh ch√≠nh.</li>
                <li>Ch·ªçn lo·∫°i: <strong>Thi·ªÅn ƒê·ªãnh</strong> ho·∫∑c <strong>C√¥ng Vi·ªác</strong>.</li>
                <li>ƒêi·ªÅn t√™n, ch·ªçn m√†u s·∫Øc v√† ƒë·∫∑t th·ªùi gian m·ª•c ti√™u (v√≠ d·ª•: 30 ph√∫t/ng√†y).</li>
            </ul>

            <strong style="display:block; margin-bottom:10px; color: var(--text);">2. B·∫Øt ƒê·∫ßu M·ªôt Phi√™n</strong>
            <ul style="padding-left: 20px; margin-bottom: 15px;">
                <li>T·∫°i th·∫ª m·ª•c ti√™u, nh·∫•n n√∫t <strong>Play (‚ñ∂)</strong> (v·ªõi C√¥ng vi·ªác) ho·∫∑c n√∫t <strong>‡•ê</strong> (v·ªõi Thi·ªÅn).</li>
                <li><strong>Trong l√∫c thi·ªÅn:</strong> Ch·∫°m v√†o m√†n h√¨nh m·ªói khi b·∫°n th·∫•y m√¨nh t·ªânh th·ª©c quay v·ªÅ ƒë·ªëi t∆∞·ª£ng thi·ªÅn.</li>
                <li>K·∫øt th√∫c phi√™n, ·ª©ng d·ª•ng s·∫Ω hi·ªán b·∫£ng t·ªïng k·∫øt ƒë·ªÉ b·∫°n ghi th√™m nh·∫≠t k√Ω.</li>
            </ul>

            <strong style="display:block; margin-bottom:10px; color: var(--text);">3. Xem B√°o C√°o</strong>
            <ul style="padding-left: 20px; margin-bottom: 15px;">
                <li>Ch·ªçn tab <strong>"T·ªïng h·ª£p"</strong> ·ªü thanh b√™n ƒë·ªÉ xem bi·ªÉu ƒë·ªì.</li>
                <li>Ch·ªçn tab <strong>"L·ªãch"</strong> ƒë·ªÉ xem l·ªãch s·ª≠ chi ti·∫øt.</li>
            </ul>

            <hr style="border: 0; border-top: 1px solid var(--border); margin: 25px 0;">
            <h3 style="color: var(--text); margin-top: 20px;">‚ú® H·ªá Th·ªëng Ghi Nh·∫≠n</h3>
            
            <p><strong>M·ªëc Li√™n T·ª•c:</strong></p>
            <table class="intro-table" style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 13px;">
                <thead>
                    <tr style="background: var(--bg);">
                        <th style="padding: 8px; border: 1px solid var(--border); text-align: left;">Danh hi·ªáu</th>
                        <th style="padding: 8px; border: 1px solid var(--border); text-align: left;">ƒêi·ªÅu ki·ªán</th>
                        <th style="padding: 8px; border: 1px solid var(--border); text-align: left;">√ù nghƒ©a</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">C·ªë G·∫Øng</td><td style="padding: 8px; border: 1px solid var(--border);">3 ng√†y</td><td style="padding: 8px; border: 1px solid var(--border);">B∆∞·ªõc ƒë·∫ßu v∆∞·ª£t qua s·ª©c ·ª≥.</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">N·ªó L·ª±c</td><td style="padding: 8px; border: 1px solid var(--border);">10 ng√†y</td><td style="padding: 8px; border: 1px solid var(--border);">B·∫Øt ƒë·∫ßu h√¨nh th√†nh th√≥i quen.</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Tinh C·∫ßn</td><td style="padding: 8px; border: 1px solid var(--border);">30 ng√†y</td><td style="padding: 8px; border: 1px solid var(--border);">Th√≥i quen ƒë√£ d·∫ßn ·ªïn ƒë·ªãnh.</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Nhi·ªát T√¢m</td><td style="padding: 8px; border: 1px solid var(--border);">60 ng√†y</td><td style="padding: 8px; border: 1px solid var(--border);">S·ª± tu t·∫≠p tr·ªü n√™n v·ªØng ch√£i.</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Tinh T·∫•n Gi√°c Chi</td><td style="padding: 8px; border: 1px solid var(--border);">365 ng√†y</td><td style="padding: 8px; border: 1px solid var(--border);">S·ª± ki√™n tr√¨ phi th∆∞·ªùng.</td></tr>
                </tbody>
            </table>

            <p><strong>M·ªëc Ch√°nh Ni·ªám (Sati):</strong></p>
            <table class="intro-table" style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 13px;">
                <thead>
                   <tr style="background: var(--bg);">
                        <th style="padding: 8px; border: 1px solid var(--border); text-align: left;">C·∫•p ƒë·ªô</th>
                        <th style="padding: 8px; border: 1px solid var(--border); text-align: left;">ƒêi·ªÉm Sati</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">S∆° C∆°</td><td style="padding: 8px; border: 1px solid var(--border);">5,000</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Thi·ªÅn Sinh</td><td style="padding: 8px; border: 1px solid var(--border);">10,000</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">H√†nh Gi·∫£</td><td style="padding: 8px; border: 1px solid var(--border);">20,000</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Thi·ªÅn Gi·∫£</td><td style="padding: 8px; border: 1px solid var(--border);">50,000</td></tr>
					<tr><td style="padding: 8px; border: 1px solid var(--border);">G∆∞∆°ng S√°ng</td><td style="padding: 8px; border: 1px solid var(--border);">80,000</td></tr>
					<tr><td style="padding: 8px; border: 1px solid var(--border);">M·∫∑t H·ªì Tƒ©nh L·∫∑ng</td><td style="padding: 8px; border: 1px solid var(--border);">100,000</td></tr>
					<tr><td style="padding: 8px; border: 1px solid var(--border);">N√∫i ƒê√°</td><td style="padding: 8px; border: 1px solid var(--border);">200,000</td></tr>
                    <tr><td style="padding: 8px; border: 1px solid var(--border);">Th·ª´a t·ª± Ph√°p</td><td style="padding: 8px; border: 1px solid var(--border);">500,000</td></tr>
					
                </tbody>
            </table>

            <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid var(--warning); padding: 15px; border-radius: 8px; color: #fbbf24; font-size: 13px;">
                <strong>‚ö†Ô∏è L∆∞u √ù Quan Tr·ªçng V·ªÅ D·ªØ Li·ªáu:</strong>
                <ul style="margin: 5px 0 0 15px;">
                    <li>D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u trong <strong>Local Storage</strong> c·ªßa tr√¨nh duy·ªát.</li>
                    <li><strong>Kh√¥ng x√≥a l·ªãch s·ª≠/cache tr√¨nh duy·ªát</strong> n·∫øu ch∆∞a sao l∆∞u, d·ªØ li·ªáu s·∫Ω b·ªã m·∫•t.</li>
                    <li><strong>C√°ch Sao L∆∞u:</strong> V√†o menu b√™n tr√°i, ch·ªçn <strong>"Sao l∆∞u"</strong> ƒë·ªÉ t·∫£i file v·ªÅ m√°y.</li>
                    <li><strong>C√°ch Kh√¥i Ph·ª•c:</strong> Ch·ªçn <strong>"Kh√¥i ph·ª•c"</strong> v√† t·∫£i l√™n file backup ƒë√£ c√≥.</li>
                </ul>
            </div>
            
             <div style="margin-top: 20px; text-align: center; color: var(--text-light); font-size: 12px; border-top: 1px solid var(--border); padding-top: 10px;">
                <strong>C√¥ng ngh·ªá:</strong> HTML5, CSS3, JS (ES6+).<br>
                <strong>Th∆∞ vi·ªán:</strong> <a href="https://www.chartjs.org/" target="_blank" style="color: var(--primary); text-decoration: none;">Chart.js</a>, <a href="https://fontawesome.com/" target="_blank" style="color: var(--primary); text-decoration: none;">FontAwesome</a>.<br>
                Link T·∫£i & M√£ Ngu·ªìn: <a href="https://github.com/buddhanussati/nhatky-hanhgia/releases"><b>t·∫°i ƒë√¢y.</b></a> Ch√∫c b·∫°n an l·∫°c v√† tinh t·∫•n!
            </div>
        </div>
        
        <div style="padding: 15px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; background: var(--surface); border-radius: 0 0 16px 16px;">
            <button class="btn btn-secondary" onclick="app.closeIntroModal()">ƒê√≥ng</button>
        </div>
    </div>
</div>
    <audio id="bell" src="bell.mp3" preload="auto"></audio>

    <script>
        // Set Chart defaults
        Chart.defaults.color = '#9ca3af';
        Chart.defaults.borderColor = '#374151';

        class GoalTracker {
            constructor() {
                // LOAD DATA SAFELY
                try {
                    this.data = JSON.parse(localStorage.getItem('chronoData'));
                } catch(e) {
                    console.error("D·ªØ li·ªáu h·ªèng", e);
                    this.data = null;
                }

                // If no data or corrupted structure, init defaults
                if (!this.data || !Array.isArray(this.data.goals)) {
                    this.data = {
                        goals: [],
                        logs: [],
                        xp: 0,
                        streak: 0,
                        globalDailyGoal: 120,
                        achievements: []
                    };
                }
                
                // MIGRATION / SANITY CHECK
                this.data.goals.forEach(goal => {
                    if (!goal.type) goal.type = 'standard'; 
                    if (!goal.sessionTargetSeconds) goal.sessionTargetSeconds = 0;
                    if (!goal.remainingSeconds) goal.remainingSeconds = 0;
                    if (typeof goal.dailyTargetMinutes === 'undefined') goal.dailyTargetMinutes = 30;
                    if (goal.type === 'meditation' && !goal.currentMindfulness) goal.currentMindfulness = 0;
                    if (goal.type === 'meditation' && !goal.totalMindfulness) goal.totalMindfulness = 0;
                });
                
                if (!this.data.globalDailyGoal) this.data.globalDailyGoal = 120;
                if (!this.data.achievements) this.data.achievements = [];
                if (!this.data.logs) this.data.logs = [];

                this.timers = {}; 
                this.today = new Date();
                this.currentMonth = new Date(this.today.getFullYear(), this.today.getMonth(), 1); 
                // Fix: Calculate start of week as MONDAY
                this.currentWeekStart = this.getStartOfWeek(this.today); 
                this.charts = { weekly: null, breakdown: null, monthly: null, dayChart: null, session: null };
                this.reportMode = 'time';
                this.meditationState = {
                    active: false, paused: false, goalId: null, count: 0,
                    startTime: null, timerRef: null, remainingSeconds: 0,
                    totalDurationSeconds: 0, touches: [] 
                };
this.currentViewDate = null; // Bi·∫øn nh·ªõ ng√†y ƒëang xem trong modal
this.dayChartMode = 'time'; 
                this.init();
            }
openIntroModal() {
        const modal = document.getElementById('intro-modal');
        if (modal) modal.style.display = 'flex';
    }

closeIntroModal() {
    document.getElementById('intro-modal').style.display = 'none';
    localStorage.setItem('intro_seen', 'true'); // Save so it doesn't pop up every time
}

// Trong constructor()
 // Ch·∫ø ƒë·ªô m·∫∑c ƒë·ªãnh c·ªßa modal
            // Fix: Week starts on Monday
            getStartOfWeek(date) {
                const d = new Date(date);
                const day = d.getDay() || 7; // CN=0 ƒë·ªïi th√†nh 7, T2=1 gi·ªØ nguy√™n
                const diff = d.getDate() - day + 1; // Lui v·ªÅ ng√†y 1 (Th·ª© Hai)
                return new Date(d.getFullYear(), d.getMonth(), diff);
            }
// --- ANALYTICS MODULE START ---

renderAnalytics() {
    const range = parseInt(document.getElementById('ana-time-range').value) || 7;
    const ctxTrend = document.getElementById('analyticsTrendChart').getContext('2d');
    const goalSelect = document.getElementById('ana-goal-select');
    const thresholdInput = document.getElementById('ana-threshold');

    // 1. Filter only Meditation Goals
    const medGoals = this.data.goals.filter(g => g.type === 'meditation');
    
    if (medGoals.length === 0) {
        document.getElementById('ana-comparison-table').innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Ch∆∞a c√≥ m·ª•c ti√™u thi·ªÅn n√†o.</td></tr>';
        return;
    }

    // 2. Populate Dropdown (if needed or empty)
    // We rebuild it if the number of options doesn't match data (simple sync check)
    if (goalSelect.options.length !== medGoals.length) {
        const currentVal = goalSelect.value;
        goalSelect.innerHTML = '';
        medGoals.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.id;
            opt.innerText = g.name;
            goalSelect.appendChild(opt);
        });
        // Restore selection or select first
        if (currentVal && medGoals.find(g => g.id === currentVal)) {
            goalSelect.value = currentVal;
        } else {
            goalSelect.value = medGoals[0].id;
        }
    }

    // 3. Get Selected Goal Data
    const selectedGoalId = goalSelect.value;
    const selectedGoal = this.data.goals.find(g => g.id === selectedGoalId);
    
    // 4. Load Specific Threshold
    // Default to 12s if not set in the goal yet
    const currentThreshold = selectedGoal.threshold || 12;
    thresholdInput.value = currentThreshold;

    // 5. Filter Logs for THIS GOAL ONLY within Time Range
    const now = Date.now();
    const cutoff = now - (range * 24 * 60 * 60 * 1000);
    
    const logs = this.data.logs
        .filter(l => l.goalId === selectedGoalId && l.timestamp >= cutoff)
        .sort((a, b) => a.timestamp - b.timestamp);

    if (logs.length === 0) {
        if(this.charts.analyticsTrend) this.charts.analyticsTrend.destroy();
        document.getElementById('ana-avg-quality').innerText = "---";
        document.getElementById('ana-avg-density').innerText = "---";
        document.getElementById('ana-total-distracted').innerText = "---";
        document.getElementById('ana-comparison-table').innerHTML = '<tr><td colspan="5" style="padding:20px; text-align:center;">Ch∆∞a c√≥ d·ªØ li·ªáu cho m·ª•c ti√™u n√†y trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn.</td></tr>';
        return;
    }

    // 6. Process Logs using the GOAL SPECIFIC Threshold
    let totalTimeSec = 0;
    let totalDistractedSec = 0;
    let totalTouches = 0;
    
    const sessionData = logs.map(log => {
        // Pass the threshold explicitly
        const result = this.analyzeSingleSession(log, currentThreshold);
        
        totalTimeSec += log.minutes * 60;
        totalDistractedSec += result.distractedSec;
        const count = log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0);
        totalTouches += count;
        
        return {
            date: new Date(log.timestamp).toLocaleDateString('vi-VN', {day: '2-digit', month:'2-digit'}),
            quality: result.qualityPct,
            density: log.minutes > 0 ? (count / log.minutes).toFixed(1) : 0
        };
    });

    // 7. Update Summary Cards
    // Prevent divide by zero
    const avgQuality = totalTimeSec > 0 ? ((1 - (totalDistractedSec / totalTimeSec)) * 100).toFixed(1) : 0;
    const avgDensity = totalTimeSec > 0 ? (totalTouches / (totalTimeSec / 60)).toFixed(1) : 0;
    const distractedHours = (totalDistractedSec / 3600).toFixed(1);

    document.getElementById('ana-avg-quality').innerText = `${avgQuality}%`;
    document.getElementById('ana-avg-density').innerText = avgDensity;
    document.getElementById('ana-total-distracted').innerText = `${distractedHours}h`;

    // 8. Render Trend Chart
    if (this.charts.analyticsTrend) this.charts.analyticsTrend.destroy();

    // Downsampling logic
    let chartData = sessionData;
    const maxPoints = 15;
    if (sessionData.length > maxPoints) {
        chartData = [];
        const step = (sessionData.length - 1) / (maxPoints - 1);
        for (let i = 0; i < maxPoints; i++) {
            const index = Math.round(i * step);
            chartData.push(sessionData[index]);
        }
    }

    this.charts.analyticsTrend = new Chart(ctxTrend, {
        type: 'line',
        data: {
            labels: chartData.map(d => d.date),
            datasets: [
                {
                    label: 'Ch·∫•t l∆∞·ª£ng (%)',
                    data: chartData.map(d => d.quality),
                    borderColor: '#34d399',
                    backgroundColor: 'rgba(52, 211, 153, 0.1)',
                    yAxisID: 'y',
                    fill: true,
                    tension: 0.3
                },
                {
                    label: 'Ch√°nh ni·ªám/ph√∫t',
                    data: chartData.map(d => d.density),
                    borderColor: '#818cf8',
                    borderDash: [5, 5],
                    yAxisID: 'y1',
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {  
                tooltip: {
                    titleColor: '#f3f4f6',
                    bodyColor: '#f3f4f6',
                    borderColor: '#374151',
                    borderWidth: 1,
                    padding: 10,
                    displayColors: true,
                    callbacks: {
                        labelColor: function(context) {
                            const dataset = context.dataset;
                            return {
                                borderColor: dataset.borderColor,
                                backgroundColor: dataset.borderColor,
                                borderWidth: 0,
                                borderRadius: 2,
                            };
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear', display: true, position: 'left', min: 0, max: 100,
                    title: { display: true, text: 'Ch·∫•t l∆∞·ª£ng %' },
                    grid: { color: '#374151' }
                },
                y1: {
                    type: 'linear', display: true, position: 'right',
                    grid: { drawOnChartArea: false },
                    title: { display: true, text: 'Ch√°nh ni·ªám / ph√∫t' }
                }
            }
        }
    });

    // 9. Render Comparison Table (Pass specific Goal ID)
    this.renderComparisonTable([selectedGoalId], currentThreshold);
}
saveThreshold(val) {
    const goalSelect = document.getElementById('ana-goal-select');
    const selectedGoalId = goalSelect.value;
    
    if (!selectedGoalId) return;

    const goal = this.data.goals.find(g => g.id === selectedGoalId);
    if (goal) {
        goal.threshold = parseInt(val);
        this.save();
        this.renderAnalytics(); // Re-calc with new threshold
        this.showToast("ƒê√£ c·∫≠p nh·∫≠t ng∆∞·ª°ng: " + val + "s");
    }
}
// Logic: Gap Analysis
// If gap > threshold (20s), assume mind wandered.
analyzeSingleSession(log, thresholdOverride = null) {
    // Basic fallback if no touches data
    if (!log.touches || log.touches.length < 2) {
        return { distractedSec: log.minutes * 60 * 0.5, qualityPct: 50 };
    }

    const sortedTouches = [...log.touches].sort((a,b) => a - b);
    
    // Use override if provided, else check DOM, else default 12
    let thresholdSec;
    if (thresholdOverride) {
        thresholdSec = thresholdOverride;
    } else {
        thresholdSec = parseInt(document.getElementById('ana-threshold').value) || 12; 
    }
    
    let distractedSec = 0;

    // Check gap from Start to First Touch
    const startGap = (sortedTouches[0] - log.timestamp) / 1000;
    if (startGap > thresholdSec) distractedSec += (startGap - thresholdSec/2);

    // Check gaps between touches
    for (let i = 1; i < sortedTouches.length; i++) {
        const gap = (sortedTouches[i] - sortedTouches[i-1]) / 1000;
        if (gap > thresholdSec) {
            distractedSec += (gap - thresholdSec/2);
        }
    }

    // Check gap from Last Touch to End
    const endTime = log.timestamp + (log.minutes * 60 * 1000);
    const endGap = (endTime - sortedTouches[sortedTouches.length - 1]) / 1000;
    if (endGap > thresholdSec) distractedSec += (endGap - thresholdSec/2);

    // Cap distracted seconds to total minutes
    const totalSec = log.minutes * 60;
    distractedSec = Math.min(distractedSec, totalSec);
    
    const qualityPct = ((totalSec - distractedSec) / totalSec) * 100;
    
    return { distractedSec, qualityPct: parseFloat(qualityPct.toFixed(1)) };
}

renderComparisonTable(medGoalIds, threshold) {
    const tbody = document.getElementById('ana-comparison-table');
    tbody.innerHTML = '';

    const now = new Date();
    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
    
    // 1. Yesterday Calculation
    const startOfYesterday = todayStart - (24 * 60 * 60 * 1000);
	const startOfDaybefore = todayStart - (48 * 60 * 60 * 1000);
    
    // 2. Start of This Week (Monday)
    const dayOfWeek = now.getDay(); 
    const diffToMonday = (dayOfWeek === 0 ? 6 : dayOfWeek - 1);
    const startOfThisWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - diffToMonday).getTime();
    const startOfLastWeek = startOfThisWeek - (7 * 24 * 60 * 60 * 1000);
	const startOfWeekBefore = startOfThisWeek - (14 * 24 * 60 * 60 * 1000);

    // 3. Start of This Month
    const startOfThisMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
    const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1).getTime();
	const startOfMonthBefore = new Date(now.getFullYear(), now.getMonth() - 2, 1).getTime();

    // 4. Period Definitions
    const periods = [
        { label: 'H√¥m nay', start: todayStart, end: Date.now() },
        { label: 'H√¥m qua', start: startOfYesterday, end: todayStart },
		{ label: 'H√¥m kia', start: startOfDaybefore, end: startOfYesterday },
        { label: 'Tu·∫ßn n√†y', start: startOfThisWeek, end: Date.now() },
        { label: 'Tu·∫ßn tr∆∞·ªõc', start: startOfLastWeek, end: startOfThisWeek },
		{ label: 'Tu·∫ßn tr∆∞·ªõc n·ªØa', start: startOfWeekBefore, end: startOfLastWeek },
        { label: 'Th√°ng n√†y', start: startOfThisMonth, end: Date.now() },
        { label: 'Th√°ng tr∆∞·ªõc', start: startOfLastMonth, end: startOfThisMonth },
		{ label: 'Th√°ng tr∆∞·ªõc n·ªØa', start: startOfMonthBefore, end: startOfLastMonth }
    ];

    periods.forEach(p => {
        // Pass the threshold to getStatsForRange
        const stats = this.getStatsForRange(p.start, p.end, medGoalIds, threshold);
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid var(--border)';
        
        let qualityColor = 'var(--text)';
        if(stats.count > 0) {
            if(stats.quality > 80) qualityColor = 'var(--success)';
            else if(stats.quality < 50) qualityColor = 'var(--danger)';
        }

        row.innerHTML = `
            <td style="padding: 12px 10px; font-weight: 500;">${p.label}</td>
            <td style="padding: 12px 10px; text-align: center;">${stats.count}</td>
            <td style="padding: 12px 10px; text-align: center;">${(stats.minutes/60).toFixed(1)}h</td>
            <td style="padding: 12px 10px; text-align: center; color: ${qualityColor}; font-weight:bold;">${stats.count > 0 ? stats.quality + '%' : '-'}</td>
            <td style="padding: 12px 10px; text-align: center;">${stats.count > 0 ? stats.density : '-'}</td>
        `;
        tbody.appendChild(row);
    });
}

// Helper method to filter by exact timestamp range
getStatsForRange(startTime, endTime, goalIds, threshold) {
    const logs = this.data.logs.filter(l => 
        goalIds.includes(l.goalId) && 
        l.timestamp >= startTime && 
        l.timestamp < endTime
    );

    if (logs.length === 0) return { count: 0, minutes: 0, quality: 0, density: 0 };

    let totalMinutes = 0;
    let totalTouches = 0;
    let weightedQualitySum = 0;

    logs.forEach(l => {
        totalMinutes += l.minutes;
        const count = l.count !== undefined ? l.count : (l.touches ? l.touches.length : 0);
        totalTouches += count;
        // Pass threshold here
        const analysis = this.analyzeSingleSession(l, threshold);
        weightedQualitySum += (l.minutes * analysis.qualityPct);
    });

    return {
        count: logs.length,
        minutes: totalMinutes,
        quality: (weightedQualitySum / totalMinutes).toFixed(1),
        density: (totalTouches / totalMinutes).toFixed(1)
    };
}
// --- ANALYTICS MODULE END ---
            init() {
                try {
                    this.renderDate();
                    this.renderGoals();
                    this.updateStats();
                    this.checkAchievements();
                    this.renderCalendar();
                    setInterval(() => this.updateTimerUI(), 1000);

                    const medOverlay = document.getElementById('meditation-overlay');
                    if(medOverlay) {
                        medOverlay.addEventListener('pointerdown', (e) => {
                            if(e.target.closest('.med-controls')) return;
                            this.handleMeditationTouch();
                        });
                    }
                } catch (err) {
                    console.error("L·ªói kh·ªüi t·∫°o:", err);
                    alert("·ª®ng d·ª•ng kh·ªüi t·∫°o th·∫•t b·∫°i. H√£y th·ª≠ ƒë·∫∑t l·∫°i d·ªØ li·ªáu qua thanh ƒëi·ªÅu h∆∞·ªõng.");
                }
				if (!localStorage.getItem('intro_seen')) {
        this.openIntroModal();
    }
	// Add this where you initialize the app
const savedThreshold = localStorage.getItem('ana_threshold');
if (savedThreshold) {
    document.getElementById('ana-threshold').value = savedThreshold;
}
            }

            save() {
                localStorage.setItem('chronoData', JSON.stringify(this.data));
                this.updateStats();
            }
get totalMindfulnessCounts() {
    return this.data.logs.reduce((sum, log) => {
        // Fix: Check for manual 'count' first, fallback to 'touches' length
        return sum + (log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0));
    }, 0);
}
            // --- AUDIO HELPER ---
            playBell() {
                const audio = document.getElementById('bell');
                if (audio) {
                    audio.currentTime = 0;
                    audio.play().catch(e => console.log("Audio play failed (autoplay blocked):", e));
                }
            }

            // --- Goal Management ---
            saveGoal(e) {
                e.preventDefault();
                const id = document.getElementById('g-id').value;
                const type = document.getElementById('g-type').value || 'standard';
                const name = document.getElementById('g-name').value;
                const category = document.getElementById('g-cat').value;
                const color = document.getElementById('g-color').value;
                const lifetimeTarget = parseInt(document.getElementById('g-lifetime-target').value);
                const dailyTarget = parseInt(document.getElementById('g-daily-target').value);

                if (id) {
                    const goal = this.data.goals.find(g => g.id === id);
                    if (goal) {
                        goal.name = name; goal.category = category; goal.color = color;
                        goal.lifetimeTargetMinutes = lifetimeTarget; goal.dailyTargetMinutes = dailyTarget;
                        this.showToast('ƒê√£ c·∫≠p nh·∫≠t m·ª•c ti√™u!');
                    }
                } else {
                    const newGoal = {
                        id: Date.now().toString(), type, name, category, color,
                        lifetimeTargetMinutes: lifetimeTarget, dailyTargetMinutes: dailyTarget || 0,
                        totalMinutes: 0, totalMindfulness: 0, sessionTargetSeconds: 0,
                        remainingSeconds: 0, currentSessionStartTime: null, isActive: false
                    };
                    this.data.goals.push(newGoal);
                    this.showToast('ƒê√£ t·∫°o m·ª•c ti√™u!');
                }
                this.save();
                this.renderGoals();
                this.closeModal();
            }

            setGlobalDailyGoal() {
                const current = this.data.globalDailyGoal || 120;
                const input = prompt("Nh·∫≠p m·ª•c ti√™u h√†ng ng√†y (ph√∫t):", current);
                if (input && !isNaN(input) && parseInt(input) > 0) {
                    this.data.globalDailyGoal = parseInt(input);
                    this.save();
                    this.showToast("ƒê√£ c·∫≠p nh·∫≠t!");
                }
            }

            toggleTimer(id) {
                const goal = this.data.goals.find(g => g.id === id);
                if (!goal) return;

                this.data.goals.forEach(g => {
                    if(g.isActive && g.id !== id && g.type === 'standard') this.toggleTimer(g.id); 
                });

                if (goal.type === 'meditation') {
                    this.startMeditationSetup(goal);
                    return;
                }

                if (goal.isActive) {
                    clearInterval(this.timers[id]);
                    goal.isActive = false;
                    const spentSeconds = goal.sessionTargetSeconds - goal.remainingSeconds;
                    const minutesSpent = Math.floor(spentSeconds / 60);
                    const startTime = goal.currentSessionStartTime || Date.now();
                    goal.sessionTargetSeconds = 0; goal.remainingSeconds = 0; goal.currentSessionStartTime = null;
                    if (minutesSpent > 0) this.openSessionModal(id, minutesSpent, null, startTime);
                    else this.showToast('Phi√™n qu√° ng·∫Øn.');
                } else {
                    const minStr = prompt('Th·ªùi l∆∞·ª£ng (ph√∫t):', '25');
                    if (!minStr) return;
                    const min = parseInt(minStr);
                    if (isNaN(min) || min <= 0) return;

                    goal.sessionTargetSeconds = min * 60;
                    goal.remainingSeconds = goal.sessionTargetSeconds;
                    goal.isActive = true;
                    goal.currentSessionStartTime = Date.now(); 

                    this.timers[id] = setInterval(() => {
                        if (goal.remainingSeconds > 0) {
                            goal.remainingSeconds--;
                        } else {
                            // TIMER FINISHED LOGIC
                            clearInterval(this.timers[id]);
                            this.playBell(); // Play sound
                            
                            goal.isActive = false;
                            const minutesSpent = Math.floor(goal.sessionTargetSeconds / 60);
                            const startTime = goal.currentSessionStartTime;
                            goal.sessionTargetSeconds = 0; goal.remainingSeconds = 0; goal.currentSessionStartTime = null;
                            this.openSessionModal(id, minutesSpent, null, startTime);
                            this.showToast('Ho√†n th√†nh!');
                            this.renderGoals(); 
                        }
                    }, 1000);
                }
                this.renderGoals();
            }
            
            // -// --- TH√äM ƒêO·∫†N N√ÄY V√ÄO ƒê√ÇY ---
    // Ki·ªÉm tra xem c√≥ ƒëang ch·∫°y tr√™n App Android kh√¥ng ƒë·ªÉ tr√°nh l·ªói tr√™n tr√¨nh duy·ªát web

    // ------------------------------- MEDITATION LOGIC ---
            startMeditationSetup(goal) {
                const minStr = prompt('Th·ªùi gian thi·ªÅn (ph√∫t):', '30');
                if (!minStr) return;
                const min = parseInt(minStr);
                if (isNaN(min) || min <= 0) return;
    if (typeof Website2APK !== 'undefined') {
        Website2APK.keepScreenOn(true); // B·∫≠t ch·∫ø ƒë·ªô lu√¥n s√°ng
    }
                this.meditationState = {
                    active: true, paused: false, goalId: goal.id, count: 0,
                    startTime: Date.now(), totalDurationSeconds: min * 60,
                    remainingSeconds: min * 60, touches: []
                };
                document.getElementById('meditation-overlay').style.display = 'flex';
                document.getElementById('med-counter').innerText = '0';
                this.updateMedTimerDisplay();

                this.meditationState.timerRef = setInterval(() => {
                    if (!this.meditationState.paused) {
                        if (this.meditationState.remainingSeconds > 0) {
                            this.meditationState.remainingSeconds--;
                            this.updateMedTimerDisplay();
                        } else {
                            this.concludeMeditationSession('auto');
                        }
                    }
                }, 1000);
            }

            updateMedTimerDisplay() {
                const s = this.meditationState.remainingSeconds;
                const m = Math.floor(s / 60);
                const sec = s % 60;
                document.getElementById('med-timer').innerText = `${m}:${sec.toString().padStart(2, '0')}`;
            }

            handleMeditationTouch() {
                if (!this.meditationState.active || this.meditationState.paused) return;
                this.meditationState.count++;
                this.meditationState.touches.push(Date.now());
                const el = document.getElementById('med-counter');
                el.innerText = this.meditationState.count;
            }

            togglePauseMeditation() {
                this.meditationState.paused = !this.meditationState.paused;
                const btn = document.getElementById('med-pause-btn');
                btn.innerHTML = this.meditationState.paused ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';
            }
            
            // NEW: Conclude session and show Notes modal (instead of auto-saving)
            concludeMeditationSession(type = 'manual') {
    clearInterval(this.meditationState.timerRef);
    // --- TH√äM ƒêO·∫†N N√ÄY V√ÄO ƒê√ÇY ---
    // Cho ph√©p m√†n h√¨nh t·∫Øt b√¨nh th∆∞·ªùng tr·ªü l·∫°i khi xong phi√™n
    if (typeof Website2APK !== 'undefined') {
        Website2APK.keepScreenOn(false); 
    }
    // Only play the bell if the timer finished on its own
    if (type === 'auto') {
        this.playBell();
    }
    
    document.getElementById('meditation-overlay').style.display = 'none';
    
    const durationSeconds = this.meditationState.totalDurationSeconds - this.meditationState.remainingSeconds;
    const minutes = Math.ceil(durationSeconds / 60);
    
    if (minutes <= 0) {
        this.showToast("Phi√™n qu√° ng·∫Øn");
        this.meditationState.active = false;
        return;
    }
    
    document.getElementById('med-finish-count').innerText = this.meditationState.count;
    document.getElementById('med-finish-time').innerText = minutes + 'm';
    document.getElementById('med-finish-notes').value = '';
    document.getElementById('meditation-finish-modal').style.display = 'flex';
}
            
            discardMeditation() {
                document.getElementById('meditation-finish-modal').style.display = 'none';
                this.meditationState.active = false;
                this.showToast("ƒê√£ ng∆∞ng th·ªùi thi·ªÅn");
            }

            saveMeditationLog() {
                // Get data from state
                const durationSeconds = this.meditationState.totalDurationSeconds - this.meditationState.remainingSeconds;
                const minutes = Math.ceil(durationSeconds / 60);
                const notes = document.getElementById('med-finish-notes').value;

                const goal = this.data.goals.find(g => g.id === this.meditationState.goalId);
                const log = {
                    goalId: goal.id,
                    date: this.toIsoDate(new Date(this.meditationState.startTime)),
                    timestamp: this.meditationState.startTime,
                    minutes: minutes,
                    notes: `Ch√°nh ni·ªám: ${this.meditationState.count}. ${notes}`, // Combine count and notes
                    touches: this.meditationState.touches
                };

                this.data.logs.push(log);
                goal.totalMinutes += minutes;
                if (!goal.totalMindfulness) goal.totalMindfulness = 0;
                goal.totalMindfulness += this.meditationState.count;

                this.meditationState.active = false;
                this.save();
                this.recalculateStreak();
                this.renderGoals();
                this.renderReports();
                this.checkAchievements();
                
                document.getElementById('meditation-finish-modal').style.display = 'none';
                this.showToast(`ƒê√£ l∆∞u th·ªùi thi·ªÅn! +${this.meditationState.count} ƒëi·ªÉm.`);
            }

            // --- STANDARD TIMER UI UPDATES ---
            updateTimerUI() {
                const todayStr = this.toIsoDate(new Date());
                this.data.goals.forEach(goal => {
                    if (goal.type === 'meditation') return; 
                    let activeSessionMins = 0;
                    let sessionPctVal = 0;
                    if (goal.isActive) {
                        const display = document.getElementById(`timer-${goal.id}`);
                        if (display) display.innerText = this.formatTime(goal.remainingSeconds);
                        const activeSessionSeconds = goal.sessionTargetSeconds - goal.remainingSeconds;
                        activeSessionMins = Math.floor(activeSessionSeconds / 60);
                        sessionPctVal = goal.sessionTargetSeconds > 0 ? (activeSessionSeconds / goal.sessionTargetSeconds) * 100 : 0;
                    }
                    const sessionBar = document.getElementById(`bar-session-${goal.id}`);
                    const sessionText = document.getElementById(`prog-text-session-${goal.id}`);
                    if (sessionBar) sessionBar.style.width = `${sessionPctVal}%`;
                    if (sessionText) sessionText.innerText = goal.isActive ? `${activeSessionMins} / ${Math.floor(goal.sessionTargetSeconds / 60)} ph√∫t` : "S·∫µn s√†ng";
                });
                this.updateStats(); 
            }

            renderGoals() {
                const container = document.getElementById('active-goals-container');
                const emptyMsg = document.getElementById('empty-msg');
                container.innerHTML = '';
                if (this.data.goals.length === 0) { emptyMsg.style.display = 'block'; return; }
                emptyMsg.style.display = 'none';
                const todayStr = this.toIsoDate(new Date());

                this.data.goals.forEach(goal => {
    const isMeditation = goal.type === 'meditation';
    const unitLabel = isMeditation ? 'ch√°nh ni·ªám' : 'ph√∫t';
    const targetProp = isMeditation ? 'totalMindfulness' : 'totalMinutes';
    const overallPct = goal.lifetimeTargetMinutes > 0 ? Math.min((goal[targetProp] / goal.lifetimeTargetMinutes) * 100, 100) : 0;

    let todayVal = 0;
    if (isMeditation) {
        // UPDATED LINE: Check l.count first, fallback to l.touches.length
        todayVal = this.data.logs
            .filter(l => l.goalId === goal.id && l.date === todayStr)
            .reduce((sum, l) => sum + (l.count !== undefined ? l.count : (l.touches ? l.touches.length : 0)), 0);
    } else {
        todayVal = this.data.logs.filter(l => l.goalId === goal.id && l.date === todayStr).reduce((sum, l) => sum + l.minutes, 0);
    }
                    
                    const dailyTarget = goal.dailyTargetMinutes || 0;
                    let dailyPct = 0;
                    let dailyBarColor = goal.color;
                    if (dailyTarget > 0) {
                        dailyPct = Math.min((todayVal / dailyTarget) * 100, 100);
                        if (todayVal >= dailyTarget) dailyBarColor = 'var(--success)';
                    }
                    
                    const div = document.createElement('div');
                    div.className = 'card goal-card';
                    div.style.borderLeft = `5px solid ${goal.color}`;
                    
                    let controlsHtml = '', dailySectionHtml = '', sessionSectionHtml = '';
                    if (dailyTarget > 0) {
                        dailySectionHtml = `
                            <div style="margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                                <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px; align-items:center;">
                                    <strong style="color:var(--text);">H√¥m nay</strong>
                                    <span style="font-weight:600;">${todayVal} / ${dailyTarget} ${unitLabel}</span>
                                </div>
                                <div class="progress-container" style="height: 6px;"><div class="progress-bar" style="width: ${dailyPct}%; background: ${dailyBarColor}"></div></div>
                            </div>`;
                    }

                    if (isMeditation) {
                        controlsHtml = `
                             <div class="timer-controls">
                                <div style="font-size: 14px; color: var(--text-light); text-transform: uppercase;">H√†nh Thi·ªÅn</div>
                                <div style="display:flex; gap: 10px;">
                                    <button class="btn-icon btn-play" style="background: var(--zen); color: white;" onclick="app.toggleTimer('${goal.id}')" title="H√†nh thi·ªÅn"><i class="fas fa-om"></i></button>
                                    
                                    <button class="btn-icon" style="background:var(--warning); color:#000;" onclick="app.openSessionModal('${goal.id}')" title="Nh·∫≠p th·ªß c√¥ng"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>`;
                    } else {
                        sessionSectionHtml = `
                            <div class="section-label">Phi√™n hi·ªán t·∫°i</div>
                            <div class="progress-container"><div id="bar-session-${goal.id}" class="progress-bar" style="background:var(--success); width:0%;"></div></div>
                            <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--text-light);"><span id="prog-text-session-${goal.id}">S·∫µn s√†ng</span></div>`;
                        controlsHtml = `
                            <div class="timer-controls">
                                <div id="timer-${goal.id}" class="timer-display">00:00</div>
                                <div style="display:flex; gap: 10px;">
                                    <button class="btn-icon ${goal.isActive ? 'btn-stop' : 'btn-play'}" onclick="app.toggleTimer('${goal.id}')"><i class="fas ${goal.isActive ? 'fa-stop' : 'fa-play'}"></i></button>
                                    <button class="btn-icon" style="background:var(--warning); color:#000;" onclick="app.openSessionModal('${goal.id}')"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>`;
                    }

                    div.innerHTML = `
                        <div class="goal-header">
                            <div><div class="goal-title">${goal.name}</div><span class="goal-tag" style="color:#b1b1c9 ; background: rgba(255,255,255,0.1)">${goal.category}</span></div>
                            <div style="display:flex; gap: 5px;">
                                <button class="btn-icon" style="color: var(--text-light)" onclick="app.openModal('${goal.id}', '${goal.type}')"><i class="fas fa-pencil-alt"></i></button>
                                <button class="btn-icon" style="color: var(--text-light)" onclick="app.deleteGoal('${goal.id}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        ${dailySectionHtml}
                        <div class="section-label">M·ª©c ƒë·ªô th√†nh t·ª±u</div>
                        <div class="progress-container"><div class="progress-bar" style="width: ${overallPct}%; background: ${goal.color}"></div></div>
                        <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--text-light); margin-bottom: 15px;"><span>${goal[targetProp]} / ${goal.lifetimeTargetMinutes} ${unitLabel}</span><span>${(overallPct).toFixed(1)}%</span></div>
                        ${sessionSectionHtml} ${controlsHtml}
                        <div class="sessions-list" style="margin-top: 15px; max-height: 150px; overflow-y: auto;"><div id="sessions-${goal.id}"></div></div>
                    `;
                    container.appendChild(div);
                    this.renderSessions(goal.id, isMeditation);
                });
            }
            
            renderSessions(goalId, isMeditation) {
                const container = document.getElementById(`sessions-${goalId}`);
                if (!container) return;
                container.innerHTML = '';
                
                // S·∫Øp x·∫øp: M·ªõi nh·∫•t l√™n ƒë·∫ßu
                const sessions = this.data.logs.filter(l => l.goalId === goalId).sort((a,b) => b.timestamp - a.timestamp);
                
                if (sessions.length === 0) { 
                    container.innerHTML = '<p style="font-size:12px; color:var(--text-light);">Ch∆∞a c√≥ phi√™n n√†o</p>'; 
                    return; 
                }
                
                const ol = document.createElement('ol');
                sessions.forEach((log) => {
                    const sLi = document.createElement('li');
                    sLi.className = 'session-item';
                    
                    const notesDisplay = log.notes ? `<span class="session-notes">"${log.notes}"</span>` : '';
                    
                    // --- PH·∫¶N S·ª¨A ƒê·ªîI CH√çNH ·ªû ƒê√ÇY ---
                    let actionButtons = '<div style="display:flex; gap:5px;">';
                    
                    // 1. N√∫t xem bi·ªÉu ƒë·ªì (Ch·ªâ hi·ªán n·∫øu l√† thi·ªÅn v√† c√≥ d·ªØ li·ªáu ch·∫°m)
                    if (isMeditation && log.touches && log.touches.length > 0) {
                        actionButtons += `<button class="btn-icon" style="background:transparent; color:var(--zen); height:24px; width:24px;" onclick="app.showSessionGraph('${log.timestamp}')" title="Xem bi·ªÉu ƒë·ªì"><i class="fas fa-chart-area" style="font-size:12px;"></i></button>`;
                    }
                    
                    // 2. N√∫t ch·ªânh s·ª≠a (Lu√¥n hi·ªán cho t·∫•t c·∫£ c√°c lo·∫°i)
                    // L∆∞u √Ω: log.timestamp ƒë∆∞·ª£c truy·ªÅn v√†o l√†m ID ƒë·ªÉ s·ª≠a
                    actionButtons += `<button class="btn-icon" style="background:transparent; color:var(--text-light); height:24px; width:24px;" onclick="app.openSessionModal('${goalId}', ${log.minutes}, ${log.timestamp}, ${log.timestamp})" title="S·ª≠a chi ti·∫øt"><i class="fas fa-edit" style="font-size:12px;"></i></button>`;
                    
                    actionButtons += '</div>';
                    // ---------------------------------

                    sLi.innerHTML = `
                        <div class="session-content">
                            <span class="session-date">${this.toDisplayDate(log.timestamp)}</span>: ${log.minutes} ph√∫t 
                            ${notesDisplay}
                        </div>
                        ${actionButtons}
                    `;
                    ol.appendChild(sLi);
                });
                container.appendChild(ol);
            }
            
           // --- NEW GRAPH LOGIC START ---

showSessionGraph(timestamp) {
    const exportBtn = document.getElementById('btn-export-session');
    if (exportBtn) {
        exportBtn.onclick = () => this.exportSessionData(timestamp);
    }

    const log = this.data.logs.find(l => l.timestamp == timestamp);
    if (!log || !log.touches) {
        this.showToast("Kh√¥ng c√≥ d·ªØ li·ªáu chi ti·∫øt cho phi√™n n√†y");
        return;
    }
    
    // Store current log for switching views
    this.currentGraphLog = log;

    document.getElementById('graph-modal').style.display = 'flex';
    document.getElementById('graph-date').innerText = new Date(log.timestamp).toLocaleString('vi-VN');
    
    // Reset selector to default and render
    document.getElementById('graph-type-select').value = 'interval';
    this.updateSessionChart();
}

updateSessionChart() {
    if (!this.currentGraphLog) return;
    const type = document.getElementById('graph-type-select').value;
    const ctx = document.getElementById('sessionGraph').getContext('2d');
    
    // Destroy previous instance
    if (this.charts.session) this.charts.session.destroy();

    if (type === 'interval') {
        this.renderIntervalChart(ctx, this.currentGraphLog);
    } else {
        this.renderIntensityChart(ctx, this.currentGraphLog);
    }
}

renderIntensityChart(ctx, log) {
    const startTime = log.timestamp;
    const durationSeconds = (log.minutes * 60) || Math.ceil((Date.now() - startTime) / 1000);
    
    const dataPoints = [];
    const labels = [];
    const totalPoints = 30; 
    const step = durationSeconds / totalPoints; 

    for (let s = 0; s <= durationSeconds; s += step) {
        labels.push(durationSeconds < 120 ? Math.round(s) + 's' : (s / 60).toFixed(0));
        const windowSizeMs = 60000; 
        const windowStart = (s * 1000) - (windowSizeMs / 2);
        const windowEnd = (s * 1000) + (windowSizeMs / 2);

        const intensity = log.touches.filter(t => {
            const touchTime = t - startTime;
            return touchTime >= windowStart && touchTime <= windowEnd;
        }).length;
        dataPoints.push(intensity);
    }

    const chartHeight = ctx.canvas.clientHeight || 300; 
    const gradient = ctx.createLinearGradient(0, 0, 0, chartHeight);
    gradient.addColorStop(0, 'rgba(167, 139, 250, 0.6)'); 
    gradient.addColorStop(0.5, 'rgba(167, 139, 250, 0.3)'); 
    gradient.addColorStop(1, 'rgba(167, 139, 250, 0.05)');   

    this.charts.session = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Ch√°nh ni·ªám',
                data: dataPoints,
                borderColor: '#a78bfa', // Purple
                backgroundColor: gradient,
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 5,
                pointBackgroundColor: '#c7b6fc',
                pointBorderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: {
                x: { title: { display: true, text: 'Th·ªùi ƒëi·ªÉm (ph√∫t)', color: '#9ca3af' }, grid: { display: true }, ticks: { maxTicksLimit: 20, color: '#9ca3af' } },
                y: { beginAtZero: true, title: { display: true, text: 'M·∫≠t ƒë·ªô', color: '#9ca3af' }, grid: { color: 'rgba(55, 65, 81, 0.5)' }, ticks: { color: '#9ca3af' } }
            },
            plugins: {
                tooltip: {
                    mode: 'index', intersect: false, displayColors: false,
                    callbacks: { label: (c) => c.raw >= 1 ? "üå± Ch√°nh ni·ªám (" + c.raw + ")" : "‚òÅÔ∏è Th·∫•t ni·ªám" }
                },
                legend: { display: false }
            }
        }
    });
}

renderIntervalChart(ctx, log) {
    const touches = log.touches.sort((a, b) => a - b);
    const startTime = log.timestamp;
    
    // Create Data Points: Y = Gap Duration (seconds), Label = Time of occurrence
    const dataPoints = [];
    const labels = [];
    let previousTime = startTime;

    // Process touches to calculate gaps
    touches.forEach(t => {
        const gapSeconds = (t - previousTime) / 1000;
        const timeFromStartMins = ((t - startTime) / 1000 / 60).toFixed(0);
        
        dataPoints.push(gapSeconds.toFixed(1));
        labels.push(timeFromStartMins);
        previousTime = t;
    });

    // Add final gap (from last touch to end of session)
    const endTime = startTime + (log.minutes * 60 * 1000);
    if (endTime > previousTime) {
        const finalGap = (endTime - previousTime) / 1000;
        dataPoints.push(finalGap.toFixed(1));
        labels.push(log.minutes.toFixed(1));
    }

    // Gradient Red Style
    const chartHeight = ctx.canvas.clientHeight || 300;
    const gradient = ctx.createLinearGradient(0, 0, 0, chartHeight);
    gradient.addColorStop(0, 'rgba(248, 113, 113, 0.6)'); // Red Top
    gradient.addColorStop(0.5, 'rgba(248, 113, 113, 0.3)'); 
    gradient.addColorStop(1, 'rgba(248, 113, 113, 0.05)'); // Red Bottom

    this.charts.session = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels, // X-Axis labels (timestamps of touches)
            datasets: [{
                label: 'Kho·∫£ng c√°ch th·∫•t ni·ªám',
                data: dataPoints,
                borderColor: '#f87171', // Red Border
                backgroundColor: gradient,
                borderWidth: 2,
                fill: true,
                tension: 0.2, // Sharper lines for intervals
                pointRadius: 0,
                pointBackgroundColor: '#f87171',
                pointHoverRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: {
                x: { 
                    title: { display: true, text: 'Th·ªùi ƒëi·ªÉm (ph√∫t)', color: '#9ca3af' }, 
                    grid: { display: true }, // Hide X grid for cleaner look on event-based data
                    ticks: { color: '#9ca3af', maxTicksLimit: 15 } 
                },
                y: { 
                    beginAtZero: true, 
                    title: { display: true, text: 'ƒê·ªô tr·ªÖ', color: '#9ca3af' }, 
                    ticks: { color: '#9ca3af' } 
                }
            },
            plugins: {
                tooltip: {
                    displayColors: false,
                    callbacks: {
                        title: (items) => `Ph√∫t th·ª© ${items[0].label}`,
                        label: (c) => `ƒê·ªô tr·ªÖ: ${c.raw} gi√¢y`
                    }
                },
                legend: { display: false }
            }
        }
    });
}
// --- NEW GRAPH LOGIC END ---
exportSessionData(timestamp) {
    const log = this.data.logs.find(l => l.timestamp == timestamp);
    if (!log) {
        this.showToast('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu!');
        return;
    }

    const dataStr = JSON.stringify(log);

    // Copy to clipboard logic
    if (navigator.clipboard) {
        navigator.clipboard.writeText(dataStr).then(() => {
            this.showToast('ƒê√£ sao ch√©p d·ªØ li·ªáu JSON!');
        }).catch((err) => {
            console.error('Async: Could not copy text: ', err);
            this.fallbackCopyText(dataStr);
        });
    } else {
        this.fallbackCopyText(dataStr);
    }
}

// Helper for older browsers or webviews
fallbackCopyText(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    
    // Ensure it's not visible but part of DOM
    textArea.style.position = 'fixed';
    textArea.style.left = '-9999px';
    document.body.appendChild(textArea);
    
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if(successful) this.showToast('ƒê√£ sao ch√©p d·ªØ li·ªáu JSON!');
        else this.showToast('Kh√¥ng th·ªÉ sao ch√©p');
    } catch (err) {
        console.error('Fallback: Oops, unable to copy', err);
        this.showToast('L·ªói sao ch√©p');
    }
    
    document.body.removeChild(textArea);
}
            openChoiceModal() { document.getElementById('choice-modal').style.display = 'flex'; }
            closeChoiceModal() { document.getElementById('choice-modal').style.display = 'none'; }

            openModal(goalId = null, type = 'standard') { 
                this.closeChoiceModal(); 
                const modal = document.getElementById('goal-modal');
                const title = document.getElementById('modal-title');
                const btn = document.getElementById('btn-save-goal');
                const catSelect = document.getElementById('g-cat');
                catSelect.innerHTML = '';
                const cats = type === 'meditation' ? ['Thi·ªÅn To·∫°', 'Thi·ªÅn H√†nh', 'Tu T·∫≠p'] : ['C√¥ng vi·ªác', 'H·ªçc t·∫≠p', 'S·ª©c kh·ªèe', 'S√°ng t·∫°o', 'T·∫°o ph∆∞·ªõc', 'Kh√°c'];
                cats.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.innerText = c; catSelect.appendChild(opt); });

                const dailyHint = document.getElementById('g-daily-hint');
                const lifeHint = document.getElementById('g-life-hint');
                if (type === 'meditation') { dailyHint.innerText = "ch√°nh ni·ªám"; lifeHint.innerText = "ch√°nh ni·ªám"; } 
                else { dailyHint.innerText = "ph√∫t"; lifeHint.innerText = "ph√∫t"; }
                document.getElementById('g-type').value = type;

                if (goalId) {
                    const goal = this.data.goals.find(g => g.id === goalId);
                    if (goal) {
                        document.getElementById('g-id').value = goal.id;
                        document.getElementById('g-name').value = goal.name;
                        document.getElementById('g-cat').value = goal.category;
                        document.getElementById('g-color').value = goal.color;
                        document.getElementById('g-lifetime-target').value = goal.lifetimeTargetMinutes;
                        document.getElementById('g-daily-target').value = goal.dailyTargetMinutes;
                        document.getElementById('g-type').value = goal.type || 'standard';
                        title.innerText = 'S·ª≠a m·ª•c ti√™u'; btn.innerText = 'L∆∞u';
                    }
                } else {
                    document.getElementById('g-id').value = '';
                    document.getElementById('g-name').value = '';
                    document.getElementById('g-color').value = type === 'meditation' ? '#a78bfa' : '#818cf8';
                    document.getElementById('g-lifetime-target').value = 1000;
                    document.getElementById('g-daily-target').value = 100;
                    title.innerText = type === 'meditation' ? 'M·ª•c ti√™u M·ªõi' : 'M·ª•c ti√™u M·ªõi'; btn.innerText = 'T·∫°o';
                }
                modal.style.display = 'flex'; 
            }
            closeModal() { document.getElementById('goal-modal').style.display = 'none'; }
            
            renderCalendar() {
                const grid = document.getElementById('calendar-grid');
                grid.innerHTML = '';
                const y = this.currentMonth.getFullYear(); const m = this.currentMonth.getMonth();
                document.getElementById('cal-month-year').innerText = new Date(y, m).toLocaleString('vi-VN', { month: 'long', year: 'numeric' });
                
                // 
                const headerDiv = document.createElement('div');
                headerDiv.className = 'calendar-header';
                ['T2','T3','T4','T5','T6','T7','CN'].forEach(d => {
                    const h = document.createElement('div'); h.className = 'cal-head-day'; h.innerText = d;
                    grid.appendChild(h);
                });

                // Calculate blanks for Monday start
                // new Date(y, m, 1).getDay() -> 0(Sun), 1(Mon)...
                const firstDayRaw = new Date(y, m, 1).getDay();
                // If Mon(1) -> 0 blanks. If Sun(0) -> 6 blanks.
                const blankSlots = firstDayRaw === 0 ? 6 : firstDayRaw - 1;

                const daysInMonth = new Date(y, m + 1, 0).getDate();
                
                for(let i=0; i<blankSlots; i++) { grid.appendChild(document.createElement('div')); }
                for(let i=1; i<=daysInMonth; i++) {
                    const dStr = `${y}-${String(m+1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day'; dayEl.innerText = i;
                    const totalMins = this.data.logs.filter(l => l.date === dStr).reduce((sum, l) => sum + l.minutes, 0);
if(totalMins > 0) {
    dayEl.classList.add('has-data');
    
    // The 8-Fold Path Tiers
    if (totalMins >= 240) dayEl.classList.add('level-8');      // 4h+ (Right Concentration)
    else if (totalMins >= 180) dayEl.classList.add('level-7'); // 3h+ (Right Mindfulness)
    else if (totalMins >= 150) dayEl.classList.add('level-6'); // 2.5h+ (Right Effort)
    else if (totalMins >= 120) dayEl.classList.add('level-5'); // 2h+
    else if (totalMins >= 90) dayEl.classList.add('level-4');  // 1.5h
    else if (totalMins >= 60) dayEl.classList.add('level-3');  // 1h
    else if (totalMins >= 30) dayEl.classList.add('level-2');  // 30m
    else dayEl.classList.add('level-1');                     // < 30m
}
                    dayEl.onclick = () => this.openDayStats(dStr);
                    grid.appendChild(dayEl);
                }
            }

            openDayStats(dateStr) {
    this.currentViewDate = dateStr;
    const modal = document.getElementById('day-details-modal');
    document.getElementById('day-modal-title').innerText = new Date(dateStr).toLocaleDateString('vi-VN', {weekday: 'long', day: 'numeric', month: 'numeric'});
    
    // Reset v·ªÅ ch·∫ø ƒë·ªô time khi m·ªõi m·ªü
    this.switchDayChart('time'); 

    // 1. RENDER LIST (Lu√¥n hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß c·∫£ Time v√† Sati)
    const dayLogs = this.data.logs.filter(l => l.date === dateStr).sort((a,b) => b.timestamp - a.timestamp);
    const listContainer = document.getElementById('day-session-list');
    listContainer.innerHTML = dayLogs.length ? '' : '<p class="empty-state">Kh√¥ng c√≥ ho·∫°t ƒë·ªông.</p>';
    
    const ul = document.createElement('ul'); 
    ul.style.listStyle = 'none';
    
    dayLogs.forEach(log => {
        const goal = this.data.goals.find(g => g.id === log.goalId);
        const li = document.createElement('li');
        li.style.cssText = 'padding: 8px 0; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; font-size: 13px; align-items:center;';
        
        // N√∫t xem bi·ªÉu ƒë·ªì s√≥ng n√£o (n·∫øu c√≥ touch data)
        let graphBtnHtml = '';
        if (goal && goal.type === 'meditation' && log.touches && log.touches.length > 0) {
            graphBtnHtml = `<button class="btn-icon" style="background:transparent; color:var(--zen); height:24px; width:24px; margin-right:5px; cursor:pointer;" onclick="app.showSessionGraph('${log.timestamp}')"><i class="fas fa-chart-area" style="font-size:12px;"></i></button>`;
        }

        // Hi·ªÉn th·ªã s·ªë Sati (n·∫øu c√≥)
        const satiCount = log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0);
        const satiInfo = satiCount > 0 ? `<span style="color: var(--zen); font-size: 11px; margin-left: 5px; font-weight:bold;">(${satiCount} Ch√°nh Ni·ªám)</span>` : '';

        const leftSide = `<div>
                           <span style="font-weight:600; color:${goal?goal.color:'#ccc'}">${goal?goal.name:'ƒê√£ x√≥a'}</span>
                           <span style="margin-left:5px;">${log.minutes}p</span>
                           ${satiInfo}
                         </div>`;
        
        const rightSide = `<div style="display:flex; align-items:center;">
                               ${graphBtnHtml}
                               <div style="font-size: 11px; color: var(--text-light); width:35px; text-align:right;">
                                   ${new Date(log.timestamp).toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'})}
                               </div>
                           </div>`;

        li.innerHTML = leftSide + rightSide;
        ul.appendChild(li);
    });
    listContainer.appendChild(ul);
    
    modal.style.display = 'flex';
}

// H√†m ri√™ng ƒë·ªÉ v·∫Ω chart trong modal
renderDayChartOnly(dateStr) {
    const ctx = document.getElementById('dayBreakdownChart').getContext('2d');
    const isMindfulness = this.dayChartMode === 'mindfulness';
    const unitLabel = isMindfulness ? 'ch√°nh ni·ªám' : 'ph√∫t';

    const dayLogs = this.data.logs.filter(l => l.date === dateStr);
    const goalStats = {};

    dayLogs.forEach(log => {
        // N·∫øu ƒëang xem mode ch√°nh ni·ªám, ch·ªâ l·∫•y log c√≥ s·ªë li·ªáu ƒë√≥
        if (isMindfulness) {
             const val = log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0);
             if (val === 0) return;
        }

        if(!goalStats[log.goalId]) {
            const goal = this.data.goals.find(g => g.id === log.goalId);
            goalStats[log.goalId] = { 
                name: goal ? goal.name : 'ƒê√£ x√≥a', 
                color: goal ? goal.color : '#ccc', 
                value: 0 
            };
        }
        
        if (isMindfulness) {
            goalStats[log.goalId].value += (log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0));
        } else {
            goalStats[log.goalId].value += log.minutes;
        }
    });

    if(this.charts.dayChart) this.charts.dayChart.destroy();
    
    const dataValues = Object.values(goalStats).map(s => s.value);

    this.charts.dayChart = new Chart(ctx, {
        type: 'doughnut',
        data: { 
            labels: Object.values(goalStats).map(s => s.name), 
            datasets: [{ 
                data: dataValues, 
                backgroundColor: Object.values(goalStats).map(s => s.color), 
                borderWidth: 1, 
                borderColor: '#1f2937' 
            }] 
        },
        options: { 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { position: 'right', labels: { color: '#9ca3af', font: {size: 11} } },
                title: { 
                    display: dataValues.length === 0, 
                    text: isMindfulness ? 'Ch∆∞a c√≥ d·ªØ li·ªáu' : 'Ch∆∞a c√≥ d·ªØ li·ªáu', 
                    position: 'bottom', 
                    color: '#6b7280' 
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return ` ${context.raw} ${unitLabel}`;
                        }
                    }
                }
            } 
        }
    });
}
switchDayChart(mode) {
    this.dayChartMode = mode;
    
    // C·∫≠p nh·∫≠t giao di·ªán n√∫t
    const btnTime = document.getElementById('btn-modal-time');
    const btnMind = document.getElementById('btn-modal-mind');
    
    if (mode === 'time') {
        btnTime.className = 'btn';
        btnMind.className = 'btn btn-secondary';
    } else {
        btnTime.className = 'btn btn-secondary';
        btnMind.className = 'btn';
    }
    
    // V·∫Ω l·∫°i chart
    if (this.currentViewDate) {
        this.renderDayChartOnly(this.currentViewDate);
    }
}
            closeDayModal() { document.getElementById('day-details-modal').style.display = 'none'; }
setReportMode(mode) {
    this.reportMode = mode;
    
    // C·∫≠p nh·∫≠t giao di·ªán n√∫t b·∫•m
    const btnTime = document.getElementById('btn-rep-time');
    const btnMind = document.getElementById('btn-rep-mind');
    
    if (mode === 'time') {
        btnTime.className = 'btn'; // Active styling
        btnMind.className = 'btn btn-secondary';
    } else {
        btnTime.className = 'btn btn-secondary';
        btnMind.className = 'btn'; // Active styling (s·∫Ω l·∫•y m√†u primary)
    }

    this.renderReports();
}
            // --- REPORTING LOGIC ---
renderReports() {
    if(!document.getElementById('weeklyChart')) return;
    
    const isMindfulness = this.reportMode === 'mindfulness';
    const unitLabel = isMindfulness ? 'Ch√°nh Ni·ªám' : 'Ph√∫t';
    
    // Update Breakdown Title
    document.getElementById('breakdown-title').innerText = isMindfulness ? 'Bi·ªÉu ƒë·ªì Ch√°nh ni·ªám' : 'Bi·ªÉu ƒë·ªì Th·ªùi gian';

    // 1. Setup Week Boundaries (Local Time)
    // weekStart is already set to Monday 00:00:00 by getStartOfWeek
    const weekStartMs = this.currentWeekStart.getTime();
    // weekEnd is exactly 7 days later
    const weekEndMs = weekStartMs + (7 * 24 * 60 * 60 * 1000);

    // Update Week Title UI
    const weekEndDisp = new Date(weekEndMs - 1); // Display Sunday date
    document.getElementById('weekly-report-title').innerText = `Tu·∫ßn (${this.currentWeekStart.toLocaleDateString('vi-VN', {month:'numeric', day:'numeric'})} - ${weekEndDisp.toLocaleDateString('vi-VN', {month:'numeric', day:'numeric'})})`;
    
    // Setup Month Boundaries
    const mYear = this.currentMonth.getFullYear();
    const mMonth = this.currentMonth.getMonth();
    const monthlyLabels = Array.from({length: new Date(mYear, mMonth + 1, 0).getDate()}, (_, i) => i + 1);
    document.getElementById('monthly-report-title').innerText = `Th√°ng ${new Date(mYear, mMonth).toLocaleDateString('vi-VN', { month: 'numeric', year: 'numeric' })}`;

    const goalDatasets = {};
    const weekDays = ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'];
    
    // Initialize Datasets
    this.data.goals.forEach(goal => { 
        if (isMindfulness && goal.type !== 'meditation') return;

        goalDatasets[goal.id] = { 
            name: goal.name, 
            color: goal.color, 
            total: 0, 
            weekly: new Array(7).fill(0),
            monthly: new Array(monthlyLabels.length).fill(0) 
        }; 
    });
    
    // PROCESS LOGS
    this.data.logs.forEach(log => {
        if(!goalDatasets[log.goalId]) return;

        // Get value based on mode
        let value = 0;
        if (isMindfulness) {
            value = log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0);
        } else {
            value = log.minutes;
        }

        goalDatasets[log.goalId].total += value;
        
        // Use exact timestamp for accurate comparison
        // Fallback to date string parsing if timestamp is missing (old data compatibility)
        let logTime = log.timestamp;
        let logDateObj;
        
        if (!logTime) {
             // Compatibility fix for very old data without timestamps
             logDateObj = new Date(log.date); 
             logTime = logDateObj.getTime();
        } else {
             logDateObj = new Date(logTime);
        }
        
        // --- WEEKLY LOGIC FIXED ---
        // Check if log is strictly within the 7-day window
        if(logTime >= weekStartMs && logTime < weekEndMs) { 
            let dayIdx = logDateObj.getDay();
            // Convert Sunday(0) to 6, Mon(1) to 0, etc.
            dayIdx = (dayIdx === 0 ? 6 : dayIdx - 1);
            goalDatasets[log.goalId].weekly[dayIdx] += value; 
        }
        
        // --- MONTHLY LOGIC ---
        // Check year and month matches current view
        if(logDateObj.getFullYear() === mYear && logDateObj.getMonth() === mMonth) {
            goalDatasets[log.goalId].monthly[logDateObj.getDate() - 1] += value;
        }
    });
    
    const activeGoals = Object.values(goalDatasets).filter(d => d.total > 0);
    
    // CHART CONFIGURATION
    const commonOptions = { 
        maintainAspectRatio: false, 
        scales: { 
            x: {stacked: true, grid:{color:'#374151'}}, 
            y: {
                stacked: true, 
                grid:{color:'#374151'},
                title: { display: true, text: unitLabel } 
            } 
        }, 
        plugins: {
            legend:{labels:{color:'#9ca3af'}},
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': ' + context.raw + ' ' + unitLabel;
                    }
                }
            }
        } 
    };
    
    // 1. Breakdown Chart (Doughnut)
    const ctxBreakdown = document.getElementById('goalBreakdownChart').getContext('2d');
    if(this.charts.breakdown) this.charts.breakdown.destroy();

    this.charts.breakdown = new Chart(ctxBreakdown, { 
        type: 'doughnut', 
        data: { 
            labels: activeGoals.map(d => d.name), 
            datasets: [{ 
                data: activeGoals.map(d => d.total), 
                backgroundColor: activeGoals.map(d => d.color), 
                borderWidth: 1, 
                borderColor: '#1f2937' 
            }] 
        }, 
        options: { 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { labels: { color: '#9ca3af' } },
                title: { 
                    display: activeGoals.length === 0, 
                    text: 'Ch∆∞a c√≥ d·ªØ li·ªáu', 
                    position: 'bottom', 
                    color: '#6b7280' 
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw || 0;
                           return ` ${value} ${unitLabel}`;
                        }
                    }
                }
            } 
        } 
    });
    
    // 2. Weekly Chart
    const ctxWeek = document.getElementById('weeklyChart').getContext('2d');
    if(this.charts.weekly) this.charts.weekly.destroy();
    this.charts.weekly = new Chart(ctxWeek, { 
        type: 'bar', 
        data: { 
            labels: weekDays, 
            datasets: activeGoals.map(g => ({ label: g.name, data: g.weekly, backgroundColor: g.color, stack: '0' })) 
        }, 
        options: commonOptions 
    });
    
    // 3. Monthly Chart
    const ctxMonth = document.getElementById('monthlyChart').getContext('2d');
    if(this.charts.monthly) this.charts.monthly.destroy();
    this.charts.monthly = new Chart(ctxMonth, { 
        type: 'bar', 
        data: { 
            labels: monthlyLabels, 
            datasets: activeGoals.map(g => ({ label: g.name, data: g.monthly, backgroundColor: g.color, stack: '0' })) 
        }, 
        options: commonOptions 
    });
}
changeReportWeek(dir) { this.currentWeekStart.setDate(this.currentWeekStart.getDate() + (dir * 7)); this.renderReports(); }
            changeReportMonth(dir) { this.currentMonth.setMonth(this.currentMonth.getMonth() + dir); this.renderReports(); }
            changeMonth(dir) { this.currentMonth.setMonth(this.currentMonth.getMonth() + dir); this.renderCalendar(); }
            
            // REPLACE THIS BLOCK INSIDE updateStats()
updateStats() {
    this.recalculateStreak();

    // 1. Calculate total mindfulness
    const totalMindfulness = this.data.logs.reduce((sum, log) => {
        // Fix: Check for manual 'count' first, fallback to 'touches' length
        return sum + (log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0));
    }, 0);

    // 2. Update data
    this.data.xp = totalMindfulness; 

    // 3. Display on UI
    document.getElementById('streak-disp').innerText = `${this.data.streak} üî•`;
    document.getElementById('xp-disp').innerText = `${this.data.xp} Sati`;
    document.getElementById('level-disp').innerText = Math.floor(this.data.xp / 1000) + 1;

    // ... (keep the rest of the function: daily goal calculation etc.) ...
    const todayStr = this.toIsoDate(new Date());
    let totalTodayMins = this.data.logs.filter(l => l.date === todayStr).reduce((sum, l) => sum + l.minutes, 0);
    this.data.goals.forEach(g => {
        if (g.isActive && g.type !== 'meditation') {
            const spent = g.sessionTargetSeconds - g.remainingSeconds;
            totalTodayMins += Math.floor(spent / 60);
        }
    });
    const globalTarget = this.data.globalDailyGoal || 120;
    const dailyPct = Math.min((totalTodayMins / globalTarget) * 100, 100);
    document.getElementById('daily-current').innerText = totalTodayMins;
    document.getElementById('daily-target').innerText = globalTarget;
    document.getElementById('daily-bar-fill').style.width = `${dailyPct}%`;
}
            
            recalculateStreak() {
                const activeDates = [...new Set(this.data.logs.filter(l => l.minutes > 0).map(l => l.date))].sort();
                if (activeDates.length === 0) { this.data.streak = 0; return; }
                let streak = 1;
                for (let i = activeDates.length - 2; i >= 0; i--) {
                    const prev = new Date(activeDates[i]);
                    const next = new Date(activeDates[i + 1]);
                    if ((next - prev) < (1000 * 60 * 60 * 48) && (next - prev) > 0) streak++; else break;
                }
                const now = new Date(this.today.getFullYear(), this.today.getMonth(), this.today.getDate());
                const last = new Date(activeDates[activeDates.length - 1]);
                if ((now - last) / (1000 * 60 * 60 * 24) > 1) this.data.streak = 0; else this.data.streak = streak;
            }

            checkAchievements() {
                const list = [
                    { id: 'streak_3', title: 'C·ªë G·∫Øng', desc: 'H√†nh tr√¨ 3 ng√†y li√™n t·ª•c', condition: () => this.data.streak >= 3 },
					{ id: 'streak_10', title: 'N·ªó L·ª±c', desc: 'H√†nh tr√¨ 10 ng√†y li√™n t·ª•c', condition: () => this.data.streak >= 10 },
					{ id: 'streak_30', title: 'Tinh C·∫ßn', desc: 'H√†nh tr√¨ 30 ng√†y li√™n t·ª•c', condition: () => this.data.streak >= 30 },
					{ id: 'streak_60', title: 'Tinh T·∫•n', desc: 'H√†nh tr√¨ 60 ng√†y li√™n t·ª•c', condition: () => this.data.streak >= 60 },
					{ id: 'streak_120', title: 'Nhi·ªát T√¢m', desc: 'H√†nh tr√¨ 120 ng√†y li√™n t·ª•c', condition: () => this.data.streak >= 120 },
					{ id: 'streak_365', title: 'Tinh T·∫•n Gi√°c Chi', desc: 'H√†nh tr√¨ 365 ng√†y li√™n t·ª•c', condition: () => this.data.streak >= 365 },

					{ id: 'beginner', title: 'S∆° C∆°', desc: 'T√≠ch lu·ªπ 5.000 Ch√°nh ni·ªám (Sati)', condition: () => this.totalMindfulnessCounts >= 5000 },
					{ id: 'level2', title: 'Thi·ªÅn Sinh', desc: 'T√≠ch lu·ªπ 10.000 Ch√°nh ni·ªám (Sati)', condition: () => this.totalMindfulnessCounts >= 10000 },
					{ id: 'practitioner', title: 'H√†nh Gi·∫£', desc: 'T√≠ch lu·ªπ 20.000 Ch√°nh ni·ªám (Sati)', condition: () => this.totalMindfulnessCounts >= 20000 },
					{ id: 'meditator', title: 'Thi·ªÅn Gi·∫£', desc: 'T√≠ch lu·ªπ 50.000 Ch√°nh ni·ªám (Sati)', condition: () => this.totalMindfulnessCounts >= 50000 },
					{ id: 'clear-mirror', title: 'G∆∞∆°ng S√°ng', desc: 'T√≠ch lu·ªπ 80.000 Ch√°nh ni·ªám (Sati)', condition: () => this.totalMindfulnessCounts >= 80000 },
					{ id: 'still-lake', title: 'M·∫∑t H·ªì Tƒ©nh L·∫∑ng', desc: 'T√≠ch lu·ªπ 100.000 Ch√°nh ni·ªám (Sati)', condition: () => this.totalMindfulnessCounts >= 100000 },
					{ id: 'mountain', title: 'N√∫i ƒê√°', desc: 'T√≠ch lu·ªπ 200.000 Ch√°nh ni·ªám (Sati)', condition: () => this.totalMindfulnessCounts >= 200000 },
					{ id: 'morning-star', title: 'Sao Mai', desc: 'T√≠ch lu·ªπ 300.000 Ch√°nh ni·ªám (Sati)', condition: () => this.totalMindfulnessCounts >= 300000 },
					{ id: 'dhammaheir', title: 'Th·ª´a T·ª± Ph√°p', desc: 'T√≠ch lu·ªπ 500.000 Ch√°nh ni·ªám (Sati)', condition: () => this.totalMindfulnessCounts >= 500000 },
					{ id: 'bodhi', title: 'C·ªôi B·ªì ƒê·ªÅ', desc: 'T√≠ch lu·ªπ 1.000.000 Ch√°nh ni·ªám (Sati)', condition: () => this.totalMindfulnessCounts >= 1000000 }
                ];
                const container = document.getElementById('achievement-list');
                if (!container) return; container.innerHTML = '';
                list.forEach(ach => {
                    const unlocked = this.data.achievements.includes(ach.id) || ach.condition();
                    if(unlocked && !this.data.achievements.includes(ach.id)) {
                        this.data.achievements.push(ach.id); this.showToast(`M·ªü kh√≥a: ${ach.title}`, true); this.save();
                    }
                    const div = document.createElement('div');
                    div.style.cssText = `padding: 15px; border: 1px solid ${unlocked ? 'var(--success)' : 'var(--border)'}; border-radius: 8px; background: ${unlocked ? 'rgba(16, 185, 129, 0.1)' : 'rgba(255,255,255,0.05)'}; display: flex; align-items: center; gap: 15px; opacity: ${unlocked ? 1 : 0.6}`;
                    div.innerHTML = `<div style="font-size: 24px; width: 40px; text-align: center;">${unlocked ? 'üèÜ' : 'üîí'}</div><div><div style="font-weight: bold; ${unlocked ? 'color: var(--text)' : 'color: var(--text-light)'}">${ach.title}</div><div style="font-size: 12px; color: var(--text-light);">${ach.desc}</div></div>`;
                    container.appendChild(div);
                });
            }

            formatTime(seconds) {
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = seconds % 60;
                return `${h > 0 ? h+':' : ''}${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            }
            toIsoDate(date) {
    const y = date.getFullYear();
    // Th√°ng trong JS b·∫Øt ƒë·∫ßu t·ª´ 0 n√™n ph·∫£i +1
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
}
            toDateTimeInput(timestamp) {
    const date = new Date(timestamp);
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    const hh = String(date.getHours()).padStart(2, '0');
    const mm = String(date.getMinutes()).padStart(2, '0');
    return `${y}-${m}-${d}T${hh}:${mm}`;
}
            toDisplayDate(timestamp) { const d = new Date(timestamp); return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`; }
            showToast(msg, isAchievement = false) {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                t.classList.remove('achievement'); if (isAchievement) t.classList.add('achievement');
                t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000);
            }
            
            switchView(viewName) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById(`view-${viewName}`).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                event.currentTarget.classList.add('active');
                
                const titles = {
                    'dashboard': 'Nh·∫≠t k√Ω',
                    'calendar': 'L·ªãch',
                    'reports': 'T·ªïng h·ª£p',
					'analytics': 'Ph√¢n t√≠ch',
                    'achievements': 'Th√†nh t·ª±u'
                };
                
                document.getElementById('page-title').innerText = titles[viewName] || 'Nh·∫≠t k√Ω';
                if (viewName === 'reports') { this.renderReports(); }
                if (viewName === 'calendar') this.renderCalendar();
				if (viewName === 'analytics') this.renderAnalytics();
            }
            
            // --- KHU V·ª∞C BACKUP / RESTORE ---

    // 1. M·ªü Modal v√† ƒëi·ªÅn d·ªØ li·ªáu v√†o khung text (ƒë·ªÉ s·∫µn s√†ng cho c·∫£ 2 ph∆∞∆°ng √°n)
    exportData() {
        const dataStr = JSON.stringify(this.data);
        const modal = document.getElementById('backup-modal');
        modal.style.display = 'flex';
    }

    closeBackupModal() {
        document.getElementById('backup-modal').style.display = 'none';
    }

  shareBackup() {
    const dataStr = JSON.stringify(this.data);
    // Create custom filename with date and time
    const now = new Date();
    const datePart = now.toISOString().split('T')[0];
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const fileName = `backup_${datePart}-${hours}h${minutes}.txt`;

    // 1. ∆Øu ti√™n Android App (Website2APK)
    if (typeof Website2APK !== 'undefined' && Website2APK.shareIntent) {
        Website2APK.shareIntent(dataStr, "Backup", "");
        return;
    }

    // 2. Web Share API (D√†nh cho iOS Safari, Chrome Android...)
    if (navigator.share) {
        const file = new File([dataStr], fileName, { type: "application/json" });
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            navigator.share({
                files: [file],
                title: 'Sao l∆∞u Nh·∫≠t K√Ω H√†nh Gi·∫£',
                text: 'File d·ªØ li·ªáu sao l∆∞u.'
            })
            .then(() => this.showToast('ƒê√£ chia s·∫ª th√†nh c√¥ng!'))
            .catch((error) => {
                // N·∫øu ng∆∞·ªùi d√πng h·ªßy (AbortError), kh√¥ng l√†m g√¨ c·∫£, 
                // nh∆∞ng n·∫øu l·ªói kh√°c th√¨ copy v√†o clipboard
                if (error.name !== 'AbortError') this.copyToClipboard(dataStr);
            });
            return;
        } 
    } 

    // 3. Fallback cu·ªëi c√πng: T·ª± ƒë·ªông copy v√†o Clipboard (D√†nh cho PC/Tr√¨nh duy·ªát c≈©)
    this.copyToClipboard(dataStr);
}

// H√†m h·ªó tr·ª£ Copy
copyToClipboard(text) {
    // Th·ª≠ d√πng API hi·ªán ƒë·∫°i tr∆∞·ªõc
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
            this.showToast('ƒê√£ ch√©p d·ªØ li·ªáu v√†o b·ªô nh·ªõ t·∫°m!');
        }).catch(err => {
            this.fallbackCopyText(text);
        });
    } else {
        this.fallbackCopyText(text);
    }
}

// C√°ch copy c≈© n·∫øu tr√¨nh duy·ªát qu√° h·∫°n ch·∫ø
fallbackCopyText(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed"; // Tr√°nh l√†m nh·∫£y trang
    textArea.style.left = "-9999px";
    textArea.style.top = "0";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            this.showToast('ƒê√£ ch√©p d·ªØ li·ªáu sao l∆∞u!');
        } else {
            this.showToast('Kh√¥ng th·ªÉ ch√©p, h√£y d√πng n√∫t Sao l∆∞u t·∫£i file.');
        }
    } catch (err) {
        this.showToast('L·ªói khi sao ch√©p d·ªØ li·ªáu.');
    }
    document.body.removeChild(textArea);
}
    
    // T·∫£i xu·ªëng file .json
   downloadFile() {
    const dataStr = JSON.stringify(this.data);
    // Create custom filename with date and time
    const now = new Date();
    const datePart = now.toISOString().split('T')[0];
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const fileName = `backup_${datePart}-${hours}h${minutes}.txt`;

    // N·∫øu ƒëang ch·∫°y tr√™n App Android (c√≥ interface Website2APK)
    if (typeof Website2APK !== 'undefined') {
        // Ki·ªÉm tra xem h√†m saveBackup m√¨nh s·∫Øp th√™m c√≥ t·ªìn t·∫°i kh√¥ng
        if (Website2APK.saveBackup) {
            // Convert sang Base64 ƒë·ªÉ tr√°nh l·ªói k√Ω t·ª± ƒë·∫∑c bi·ªát
            // D√πng btoa (binary to ascii) - c·∫ßn encodeURIComponent ƒë·ªÉ x·ª≠ l√Ω ti·∫øng Vi·ªát
            const base64 = btoa(unescape(encodeURIComponent(dataStr)));
            
            // G·ªçi xu·ªëng Java/Smali
            Website2APK.saveBackup(base64, fileName);
            this.showToast('ƒêang l∆∞u file v√†o th∆∞ m·ª•c Download...');
        } 
    } else {
        // Code ch·∫°y tr√™n m√°y t√≠nh (nh∆∞ c≈©)
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }, 0);
        this.showToast('ƒê√£ t·∫£i xu·ªëng file!');
    }
}

    // X·ª≠ l√Ω khi ng∆∞·ªùi d√πng ch·ªçn file t·ª´ m√°y t√≠nh
    handleFileUpload(inputElement) {
        const file = inputElement.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            // ƒê∆∞a n·ªôi dung file v√†o h√†m x·ª≠ l√Ω chung
            this.processRestoreData(e.target.result);
        };
        reader.readAsText(file);
        
        // Reset input ƒë·ªÉ c√≥ th·ªÉ ch·ªçn l·∫°i c√πng 1 file n·∫øu mu·ªën
        inputElement.value = '';
    }

    

    // --- H√ÄM X·ª¨ L√ù CHUNG (CORE LOGIC) ---
    processRestoreData(jsonString) {
        try {
            const json = JSON.parse(jsonString);
            
            // Ki·ªÉm tra t√≠nh h·ª£p l·ªá c∆° b·∫£n
            if (!json.goals || !Array.isArray(json.goals) || !json.logs) {
                throw new Error("C·∫•u tr√∫c file kh√¥ng h·ª£p l·ªá (Thi·∫øu goals/logs).");
            }

            if (confirm(`T√¨m th·∫•y ${json.goals.length} m·ª•c ti√™u v√† ${json.logs.length} nh·∫≠t k√Ω.\nB·∫°n c√≥ ch·∫Øc mu·ªën ghi ƒë√® d·ªØ li·ªáu hi·ªán t·∫°i kh√¥ng?`)) {
                localStorage.setItem('chronoData', JSON.stringify(json));
                location.reload(); // T·∫£i l·∫°i trang ƒë·ªÉ √°p d·ª•ng
            }
        } catch (err) {
            alert("L·ªói kh√¥i ph·ª•c: " + err.message);
        }
    }


            resetApp() {
                if (confirm('X√≥a T·∫§T C·∫¢ d·ªØ li·ªáu?')) { localStorage.removeItem('chronoData'); location.reload(); }
            }
			
deleteSession() {
    const logId = document.getElementById('s-log-id').value;
    const goalId = document.getElementById('s-goal-id').value;

    if (!logId) return; // Safety check

    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a vƒ©nh vi·ªÖn phi√™n n√†y kh·ªèi l·ªãch s·ª≠?')) {
        // 1. Find the log index
        const logIndex = this.data.logs.findIndex(l => l.timestamp == logId);
        if (logIndex === -1) return;
        
        const log = this.data.logs[logIndex];
        const goal = this.data.goals.find(g => g.id === goalId);

        // 2. Subtract stats from the goal totals
        if (goal) {
            goal.totalMinutes -= log.minutes;
            if (goal.totalMinutes < 0) goal.totalMinutes = 0;

            if (goal.type === 'meditation') {
                const count = log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0);
                goal.totalMindfulness -= count;
                if (goal.totalMindfulness < 0) goal.totalMindfulness = 0;
            }
        }

        // 3. Remove the log
        this.data.logs.splice(logIndex, 1);

        // 4. Save and Update UI
        this.save();
        this.renderGoals();      // Updates the list immediately
        this.renderCalendar();   // Updates calendar colors
        this.renderReports();    // Updates charts
        this.updateStats();      // Updates streaks/XP
        
        this.closeSessionModal();
        this.showToast('ƒê√£ x√≥a phi√™n!');
    }
}			
openSessionModal(goalId, minutes = 0, logId = null, startTime = Date.now()) {
    document.getElementById('session-modal').style.display = 'flex';
    document.getElementById('s-goal-id').value = goalId;
    document.getElementById('s-log-id').value = logId || '';
    document.getElementById('s-date').value = this.toDateTimeInput(startTime);
    document.getElementById('s-minutes').value = minutes;

    // --- NEW: Toggle Delete Button Visibility ---
    const deleteBtn = document.getElementById('btn-delete-session');
    if (logId) {
        deleteBtn.style.display = 'block'; // Show if editing
    } else {
        deleteBtn.style.display = 'none';  // Hide if new
    }
    // --------------------------------------------
    
    // ... (rest of your existing code for mindfulness check) ...
    const goal = this.data.goals.find(g => g.id === goalId);
    const mindGroup = document.getElementById('s-mindfulness-group');
    const mindInput = document.getElementById('s-mindfulness');
    
    if (goal && goal.type === 'meditation') {
        mindGroup.style.display = 'block';
        let currentCount = 0;
        if (logId) {
            const log = this.data.logs.find(l => l.timestamp == logId);
            if (log) currentCount = log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0);
        }
        mindInput.value = currentCount;
    } else {
        mindGroup.style.display = 'none';
        mindInput.value = 0;
    }

    let notes = ''; 
    if(logId) { 
        const log = this.data.logs.find(l => l.timestamp == logId); 
        if(log && log.notes) notes = log.notes; 
    }
    document.getElementById('s-notes').value = notes;
    document.getElementById('session-title').innerText = logId ? 'Ch·ªânh s·ª≠a' : 'Nh·∫≠p th·ªß c√¥ng';
}
            closeSessionModal() { document.getElementById('session-modal').style.display = 'none'; }
logSessionConfirm(e) {
    e.preventDefault();
    const goalId = document.getElementById('s-goal-id').value;
    const logId = document.getElementById('s-log-id').value;
    const dateTimeStr = document.getElementById('s-date').value;
    const minutes = parseInt(document.getElementById('s-minutes').value);
    
    // 1. Get Mindfulness and Raw Notes
    const mindfulness = parseInt(document.getElementById('s-mindfulness').value) || 0;
    let notes = document.getElementById('s-notes').value;
    
    if (minutes <= 0) return;
    
    const goal = this.data.goals.find(g => g.id === goalId);
    
    // --- NEW LOGIC: AUTO-FORMAT NOTES ---
    if (goal && goal.type === 'meditation') {
        // A. Remove any existing "Ch√°nh ni·ªám: X" string (to prevent duplicates if editing)
        // Regex explains: Starts with "Ch√°nh ni·ªám:", followed by numbers, optional dot/space
        let cleanNotes = notes.replace(/^Ch√°nh ni·ªám: \d+(\.\s*)?/, '').trim();
        
        // B. Add the new count if it's greater than 0
        if (mindfulness > 0) {
            notes = `Ch√°nh ni·ªám: ${mindfulness}. ${cleanNotes}`;
        } else {
            notes = cleanNotes;
        }
        // Result example: "Ch√°nh ni·ªám: 10. C·∫£m th·∫•y b√¨nh an"
    }
    // ------------------------------------

    const dateObj = new Date(dateTimeStr);
    const timestamp = dateObj.getTime();
    const dateKey = dateTimeStr.split('T')[0]; 
    
    if (logId) {
        // --- EDIT EXISTING LOG ---
        const log = this.data.logs.find(l => l.timestamp == logId);
        if (log) {
            const oldMinutes = log.minutes;
            // Use saved count or fallback to touches length
            const oldMindfulness = log.count !== undefined ? log.count : (log.touches ? log.touches.length : 0);
            
            log.minutes = minutes; 
            log.date = dateKey; 
            log.timestamp = timestamp; 
            log.notes = notes; // Save the formatted notes
            log.count = mindfulness;
            
            if (goal) {
                goal.totalMinutes += (minutes - oldMinutes);
                if (goal.type === 'meditation') {
                    if (!goal.totalMindfulness) goal.totalMindfulness = 0;
                    goal.totalMindfulness = goal.totalMindfulness - oldMindfulness + mindfulness;
                }
            }
        }
    } else {
        // --- CREATE NEW LOG ---
        this.data.logs.push({ 
            goalId, 
            date: dateKey, 
            timestamp, 
            minutes, 
            notes, // Save the formatted notes
            count: mindfulness, 
            touches: [] 
        });
        
        if (goal) {
            goal.totalMinutes += minutes;
            if (goal.type === 'meditation') {
                if (!goal.totalMindfulness) goal.totalMindfulness = 0;
                goal.totalMindfulness += mindfulness;
            }
        }
    }
    
    this.save(); 
    this.renderGoals(); 
    this.renderCalendar(); 
    this.renderReports(); 
    this.checkAchievements();
    this.closeSessionModal(); 
    this.showToast(logId ? 'ƒê√£ c·∫≠p nh·∫≠t!' : 'ƒê√£ ghi!');
}
         deleteGoal(id) {
    // 1. Change the message to warn that history will also be deleted
    if(confirm('X√≥a m·ª•c ti√™u n√†y v√† TO√ÄN B·ªò l·ªãch s·ª≠ li√™n quan? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) {
        
        // 2. Remove the goal from the goals list
        this.data.goals = this.data.goals.filter(g => g.id !== id);
        
        // 3. Remove all logs associated with this goalId
        this.data.logs = this.data.logs.filter(log => log.goalId !== id);
        
        // 4. Save and refresh all UI components
        this.save(); 
        this.renderGoals(); 
        this.renderReports(); 
        this.renderCalendar(); // Added this to refresh the calendar view
        
        this.showToast('ƒê√£ x√≥a m·ª•c ti√™u v√† l·ªãch s·ª≠!');
    }
}
            renderDate() {
                 document.getElementById('current-date').innerText = new Date().toLocaleDateString('vi-VN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }
        }

        const app = new GoalTracker();
    </script>
</body>
</html>